var chatting=!1,aPlayers=[],aPlaces=[],aScores=[],aTeams=[],aPseudos=[],aControllers=[],aTracksHist=[],iRaceCount=0,customDecorData={},customBgData={},isFirstLoad=!0,selectedCc=localStorage.getItem("cc")||"150",selectedMirror=!!localStorage.getItem("mirror"),selectedNbTeams=localStorage.getItem("nbTeams")||"2",selectedFriendlyFire=!!localStorage.getItem("friendlyFire"),selectedTeamOpts=0,selectedDoubleItems=0!=localStorage.getItem("doubleitems"),pause,fInfos,formulaire,baseCp,baseCp0,pUnlockMap,nBasePersos,customPersos,selectedDifficulty,updateCtnFullScreen;if("undefined"==typeof edittingCircuit)var edittingCircuit=!1;if("undefined"==typeof cupOpts)var cupOpts={};else if(cupOpts.keyid){try{cupOpts=JSON.parse(sessionStorage.getItem("cupopt."+cupOpts.keyid))}catch(t){}cupOpts||(cupOpts={})}if("undefined"==typeof dCircuits)var dCircuits=lCircuits;var isOnline="OL"==page,isMCups=isCup&&4<NBCIRCUITS,clRuleVars={},clGlobalVars;function xhr(e,t,i,n){n||(n=1e3);var l;if(window.XMLHttpRequest||window.ActiveXObject)if(window.ActiveXObject)try{l=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){l=new ActiveXObject("Microsoft.XMLHTTP")}else l=new XMLHttpRequest;l.open("POST","api/"+e,!0),l.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),l.setRequestHeader("If-Modified-Since","Wed, 15 Nov 1995 00:00:00 GMT");try{l.onload=function(){200==l.status?!i(l.responseText)&&setTimeout(function(){xhr(e,t,i,2*n)},n):l.onerror()},l.onerror=function(){setTimeout(function(){xhr(e,t,i,2*n)},n)}}catch(o){l.onreadystatechange=function(){4!=l.readyState||i(l.responseText)||setTimeout(function(){xhr(e,t,i,2*n)},n)}}l.send(t)}var selectPerso;if("undefined"==typeof selectedTeams)var selectedTeams=0;if("undefined"==typeof challenges)var challenges={mcup:[],cup:[],track:[]},clRewards=[];if("undefined"==typeof cupPayloads)var cupPayloads=[];var cupIDs=cupPayloads.map(function(e){return e.id}),challengesForCircuit,onlineSpectatorId,gamepadMenuEventsHandler,updateVolumeSettings;function MarioKart(){function setQuality(e){iRendering=e,baseOptions.quality=e,resetQuality(),5==iQuality?localStorage.removeItem("iQuality"):localStorage.setItem("iQuality",e)}function resetQuality(){5==iRendering?(iQuality=1,iSmooth=!1):(iQuality=iRendering,iSmooth=!0)}function setFps(e){if(-2==e){function e(){var e=15*i.value;t.querySelector(".customOptionDialog-textValue").innerHTML=e+" FPS"}function l(){document.body.removeChild(t)}function o(){var e=+i.value;addFpsOption(e),setFps(e),l()}formulaire.fps.value=iFps;var t=document.createElement("div");t.className="customOptionDialog",t.innerHTML="<form class=\"customOptionDialog-content\"><div class=\"customOptionDialog-title\">"+toLanguage("Custom FPS...","Choix des FPS...")+"</div><input type=\"range\" min=\"1\" max=\"16\" step=\"1\" class=\"customOptionDialog-cursor\" /><div class=\"customOptionDialog-textValue\"></div><div class=\"customOptionDialog-submit\"><input type=\"submit\" value=\""+toLanguage("Validate","Valider")+"\" /><a href=\"#null\" class=\"customOptionDialog-cancel\">"+toLanguage("Cancel","Annuler")+"</a></div></form>";var i=t.querySelector(".customOptionDialog-cursor"),n=t.querySelector(".customOptionDialog-content");return i.value=iFps,e(),i.oninput=function(){e()},t.onclick=function(){o()},n.style.bottom="5px",n.onclick=function(t){t.stopPropagation()},n.onsubmit=function(){return o(),!1},t.querySelector(".customOptionDialog-submit a").onclick=function(){return l(),!1},void document.body.appendChild(t)}return localStorage.setItem("nbFrames",e),formulaire&&formulaire.dataset.disabled?showParamChangeDisclaimer():void(iFps=e)}function openFullscreen(e){return e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():void 0}function updateHudFullScreen(){for(var e=0;e<hudScreens.length;e++)hudScreens[e].style.left=oContainers[e].style.left,hudScreens[e].style.top=oContainers[e].style.top}function removeHUD(){for(var e=0;e<hudScreens.length;e++)$mkScreen.removeChild(hudScreens[e]);hudScreens.length=0}function updatePlanFullScreen(){if(oPlanDiv2){var e=$mkScreen.dataset.fs;e&&oPlanDiv2.parentNode!==oContainers[0]?(oPlanDiv2.parentNode&&oPlanDiv2.parentNode.removeChild(oPlanDiv2),oPlanDiv2.style.left="",oPlanDiv2.style.right=Math.round(.5*iScreenScale)+"px",oPlanDiv2.style.top=Math.round(iScreenScale*($speedometers.length?4.8:2.5))+"px",oContainers[0].appendChild(oPlanDiv2)):!e&&oPlanDiv2.parentNode!==document.body&&(oPlanDiv2.parentNode&&oPlanDiv2.parentNode.removeChild(oPlanDiv2),oPlanDiv2.style.left=15+80*iScreenScale+"px",oPlanDiv2.style.right="",oPlanDiv2.style.top=10+Math.round(iScreenScale/4)+oPlanWidth+"px",document.body.appendChild(oPlanDiv2))}}function setScreenScale(e,t){if(e!==iScreenScale){var i=iScreenScale;if(-1==e){formulaire.screenscale.value=i;var n=openFullscreen($mkScreen);return void(n.then&&n.catch?n.then(function(){updateCtnFullScreen(!0),document.onfullscreenchange=function(){updateCtnFullScreen(document.fullscreenElement===$mkScreen)}}).catch(function(){updateCtnFullScreen(!0)}):updateCtnFullScreen(!0))}if(-2==e){function e(){var e=+o.value;l.querySelector(".customOptionDialog-textValue").innerHTML=80*e+"&times;"+39*e}function t(){document.body.removeChild(l)}function n(){var e=+o.value;addScreenScaleOption(e),setScreenScale(e),t()}formulaire.screenscale.value=i;var l=document.createElement("div");l.className="customOptionDialog",l.innerHTML="<form class=\"customOptionDialog-content\"><div class=\"customOptionDialog-title\">"+toLanguage("Custom size...","Taille personnalis\xE9e...")+"</div><input type=\"range\" min=\"2\" max=\"36\" step=\"2\" class=\"customOptionDialog-cursor\" /><div class=\"customOptionDialog-textValue\"></div><div class=\"customOptionDialog-submit\"><input type=\"submit\" value=\""+toLanguage("Validate","Valider")+"\" /><a href=\"#null\" class=\"customOptionDialog-cancel\">"+toLanguage("Cancel","Annuler")+"</a></div></form>";var o=l.querySelector(".customOptionDialog-cursor"),a=l.querySelector(".customOptionDialog-content");return o.value=i,e(),o.oninput=function(){var t=+o.value;formulaire.dataset.disabled||previewScreenScale(i,t),e()},l.onclick=function(){n()},a.style.bottom="80px",a.onclick=function(t){t.stopPropagation()},a.onsubmit=function(){return n(),!1},l.querySelector(".customOptionDialog-submit a").onclick=function(){return formulaire.dataset.disabled||previewScreenScale(i,i),t(),!1},void document.body.appendChild(l)}if(t||localStorage.setItem("iScreenScale",e),formulaire&&formulaire.dataset.disabled)return showParamChangeDisclaimer();iScreenScale=e,bRunning&&resetScreen(),previewScreenScale(i,iScreenScale),setSRest()}}function addCustomOption(e,t,i,n){n=n||1;var l=e.querySelector("option[value=\""+t+"\"]");if(!l){var o=document.createElement("option");o.value=t,o.innerHTML=i,e.insertBefore(o,e.childNodes[e.childNodes.length-n])}e.value=t}function addScreenScaleOption(e){addCustomOption(formulaire.screenscale,e,80*e+"&times;"+39*e,2)}function addFpsOption(e){addCustomOption(formulaire.fps,e,15*e+" FPS")}function previewScreenScale(e,t){for(var n=0,l;n<oContainers.length;n++)l=oContainers[n].firstChild,l&&(!l.aScreenScale&&(l.aScreenScale=e),l.style.width=80*t+"px",l.style.height=39*t+"px",l.style.transformOrigin=l.style.WebkitTransformOrigin=l.style.MozTransformOrigin="top left",l.style.transform=l.style.WebkitTransform=l.style.MozTransform="scale("+t/l.aScreenScale+")")}function showParamChangeDisclaimer(){var e=document.createElement("div");e.className="modes-change-disclaimer",e.innerHTML=toLanguage("Your settings have been saved.<br />They'll apply to your next race.","Les param\xE8tres ont \xE9t\xE9 sauvegard\xE9s.<br />Ils s'appliqueront \xE0 la prochaine course"),document.body.appendChild(e),setTimeout(function(){e.classList.add("modes-change-fadeout"),setTimeout(function(){document.body.removeChild(e)},1e3)},3e3)}function setMusic(e){if(e?localStorage.setItem("bMusic",1):localStorage.removeItem("bMusic"),formulaire&&formulaire.dataset.disabled){if(e)return showParamChangeDisclaimer();removeIfExists(mapMusic),removeIfExists(lastMapMusic),removeIfExists(endingMusic)}bMusic=!!e,-1!=gameMenu&&updateMenuMusic(gameMenu,!0)}function setSfx(e){if(e?localStorage.setItem("iSfx",1):localStorage.removeItem("iSfx"),formulaire&&formulaire.dataset.disabled){if(e)return showParamChangeDisclaimer();removeSoundEffects(),oMusicEmbed&&unpauseMusic(mapMusic),removeGameMusics([mapMusic,lastMapMusic,endingMusic])}iSfx=!!e}function removeMenuMusic(e){clearTimeout(oMusicHandler),oMusicEmbed&&document.body.contains(oMusicEmbed)&&(e?document.body.removeChild(oMusicEmbed):fadeOutMusic(oMusicEmbed,1,.8,null,vMusic),oMusicEmbed=void 0),muteOnBlur&&(window.removeEventListener("blur",muteOnBlur),muteOnBlur=void 0),unmuteOnResume&&(window.removeEventListener("focus",unmuteOnResume),unmuteOnResume=void 0)}function removeIfExists(e){e&&(e.yt&&(e.yt.destroy&&(e.yt.isDetroyed=!0,e.yt.destroy()),delete e.yt,delete e.tasks,delete e.opts),document.body.contains(e)&&document.body.removeChild(e),oMusicEmbed==e&&(oMusicEmbed=void 0))}function removeGameMusics(e){if(bMusic||iSfx){for(var t=document.getElementsByClassName("gamemusic"),n=t.length-1,l;0<=n;n--)l=t[n],e&&-1!==e.indexOf(l)||document.body.removeChild(l);oMusicEmbed=void 0}}function removeSoundEffects(){playingCarEngine=void 0,removeIfExists(carEngine),carEngine=void 0,removeIfExists(carEngine2),carEngine2=void 0,removeIfExists(carEngine3),carEngine3=void 0,removeIfExists(carDrift),carDrift=void 0,removeIfExists(carSpark),carSpark=void 0}function clearResources(){oMapImg&&oMapImg.clear&&oMapImg.clear()}function resetEvents(){document.onmousedown=void 0,document.onkeydown=void 0,document.onkeyup=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0,window.removeEventListener("deviceorientation",window.turnOnRotate),window.turnOnRotate=void 0,hideVirtualKeyboard()}function pauseSounds(){if(bMusic||iSfx){if(!clLocalVars.forcePause){var e=playSoundEffect("musics/events/pause.mp3");e.className=""}for(var t=document.getElementsByClassName("gamemusic"),n=0;n<t.length;n++)muteSound(t[n])}}function unpauseSounds(){if(bMusic||iSfx){var e=playSoundEffect("musics/events/pause.mp3");e.className="",setTimeout(function(){if(!pause)for(var e=document.getElementsByClassName("gamemusic"),t=0;t<e.length;t++)unmuteSound(e[t])},300)}}function setMusicVolume(e,t){isOriginalEmbed(e)?e.volume=t*vMusic:onPlayerReady(e,function(e){e.setVolume(Math.round(100*(t*vMusic)))})}function updateMusicVolume(e,t,i){isOriginalEmbed(e)?e.volume===i&&(e.volume=t):onPlayerReady(e,function(e){Math.round(e.getVolume())===Math.round(100*i)&&e.setVolume(Math.round(100*t))})}function fadeInMusic(e,t,i){e.fadingOut||(e.fadingIn=!0,t/=i,1>t?(setMusicVolume(e,t),e.fadingIn=!1,setTimeout(function(){fadeInMusic(e,t,i)},100)):setMusicVolume(e,1))}function fadeOutMusic(e,t,i,n,l){e.fadingIn||(e.fadingOut=!0,t*=i,.2<t?(setMusicVolume(e,t*l),setTimeout(function(){fadeOutMusic(e,t,i,n,l)},100)):(e.fadingOut=!1,!1===n?(pauseMusic(e),setMusicVolume(e,l)):-1!==n&&stopMusic(e)))}function updateMenuMusic(e,t){if((e!=gameMenu||t)&&(gameMenu=e,removeMenuMusic(!bMusic),bMusic)){playMusicSmoothly("musics/menu/"+(gameMenu?"selection-remix":"main-remix")+".mp3",t?0:void 0),gameMenu||loopAfterIntro(oMusicEmbed,60.15,54.9);var i=oMusicEmbed;muteOnBlur=function(){oMusicEmbed==i&&(clearTimeout(oMusicHandler),i.pause())},window.addEventListener("blur",muteOnBlur),unmuteOnResume=function(){oMusicEmbed==i&&i.play()},window.addEventListener("focus",unmuteOnResume)}}function playMusicSmoothly(e,t){void 0===t&&(t=1e3),oMusicEmbed=document.createElement("audio"),oMusicEmbed.volume=vMusic,oMusicEmbed.setAttribute("loop",!0),oMusicEmbed.style.position="absolute",oMusicEmbed.style.left="-1000px",oMusicEmbed.style.top="-1000px";var i=document.createElement("source");i.type="audio/mpeg",i.src=e,oMusicEmbed.appendChild(i),clearTimeout(oMusicHandler),t?oMusicHandler=setTimeout(function(){oMusicEmbed.play()},t):oMusicEmbed.setAttribute("autoplay",!0),document.body.appendChild(oMusicEmbed)}function baseCustomPersos(){var e={};if("undefined"!=typeof characterRoster)for(var t=0,n;t<characterRoster.length;t++)n=characterRoster[t],baseCp0[n.sprites]||(e[n.sprites]=n);return e}function resetGame(e){oMap=oMaps[e],loadMap()}function posImg(e,t,i,n,l,o){bSelectedMirror&&(t=oMap.w-t,n=-n);var a=t/oPlanRealSize,s=i/oPlanRealSize;return e.style.transform=e.style.WebkitTransform=e.style.MozTransform="translate("+Math.round(o*a-l/2)+"px, "+Math.round(o*s-l/2)+"px) rotate("+Math.round(180-n)+"deg)",e}function posImgRel(e,t,i,n,l,o,a,s){bSelectedMirror&&(t=oMap.w-t,n=-n);var r=t/oPlanRealSize,p=i/oPlanRealSize;return e.style.transform=e.style.WebkitTransform=e.style.MozTransform="translate("+(Math.round(a)+Math.round(o*r-l/2))+"px, "+(Math.round(s)+Math.round(o*p-l/2))+"px) rotate("+Math.round(180-n)+"deg)",e}function setPlanPos(e){function t(e,t,i,n){var l=document.createElement("img");return l.src="images/map_icons/"+e+".png",l.style.position="absolute",l.style.width=t+"px",l.className="pixelated",i.insertBefore(l,n||null),l}function n(e,t,i,n,l,o,a){if(posImg(e,t,i,b.rotation,n,l),0<=o&&e.team!=o){var s=cTeamColors.primary[o];e.team=o,e.style.background="radial-gradient(ellipse at center, "+s+" 0%,transparent "+a+"%)"}return e}function l(e,i,n,l,o){if(e.length!=i.length){for(;e.length<i.length;)e.push(t(n,l,o));for(;e.length>i.length;)o.removeChild(e[0]),e.shift()}}function o(e,n,l,o){for(var a in e)if(oMap[a]){if(e[a].length<oMap[a].length)for(var s=e[a].length;s<oMap[a].length;s++){var r=oMap[a][s],p=r[1][2]*l/oMap.w,d=r[1][3]*l/oMap.w,c=t(r[0].src,p,n,o[0]),u=r[0].custom;u&&(c.src="images/map_icons/empty.png",function(e,t){getCustomDecorData(u,function(i){e.src=i.map;var n,o;switch(t){case"flippers":case"pointers":o=i.size.hd.h;break;case"oils":n=i.size.hd.w,o=i.size.hd.h;break;default:return;}n&&(p=n*l/oMap.w,e.style.width=p+"px"),o&&(d=o*l/oMap.w,e.style.height=d+"px")})}(c,a)),c.style.height=d+"px";var m=r[2][0],y=r[2][1];if(bSelectedMirror){m=1-m;var h=document.createElement("div");h.style.position="absolute",h.style.display="flex",c.style.position="static",c.className="mirrored",h.appendChild(c),n.appendChild(h),c=h}c.style.transformOrigin=c.style.WebkitTransformOrigin=c.style.MozTransformOrigin=Math.round(100*m)+"% "+Math.round(100*y)+"%",e[a].push(c)}for(var s=0;s<oMap[a].length;s++){var r=oMap[a][s],p=r[1][2]*l/oMap.w;posImg(e[a][s],r[1][0]+r[1][2]*(.5-r[2][0]),r[1][1]+r[1][2]/2-r[1][3]*r[2][1],Math.round(180*(Math.PI-r[2][2])/Math.PI),p,l)}}}function a(e,t){var i=e.getContext("2d");i.clearRect(0,0,e.width,e.height),oMap.sea.render(i,[0,0],t/oMap.w)}function s(t,n,l){for(var o=0;o<e.karts.length;o++){var a=e.karts[o],s=!0;if(a.ref.loose&&(isOnline&&!finishing||a==h?t[o].style.opacity=.25:(t[o].style.display="none",iTeamPlay&&n==oCharWidth&&(oPlanTeams[o].style.display="none",oPlanTeams2[o].style.display="none"),s=!1)),s){var r=a.ref.billball?1.5:a.size,p=Math.round(n*r);if(t[o].style.width=p+"px",posImg(t[o],a.x,a.y,a.rotation-360*a.tourne/21,p,l),iTeamPlay&&n==oCharWidth){var d=Math.round(oCharWidth2*r),c=Math.round(oTeamWidth*r),u=Math.round(oTeamWidth2*r);posImgRel(oPlanTeams[o],a.x,a.y,Math.round(b.rotation),p,oPlanSize,(p-c)/2,(p-c)/2),oPlanTeams[o].style.width=c+"px",oPlanTeams[o].style.height=c+"px",posImgRel(oPlanTeams2[o],a.x,a.y,Math.round(b.rotation),d,oPlanSize2,(d-u)/2,(d-u)/2),oPlanTeams2[o].style.width=u+"px",oPlanTeams2[o].style.height=u+"px"}}}}function r(e){for(var t=0;t<oMap.arme.length;t++)e[t].style.display=oMap.arme[t][2].active?"block":"none"}function p(e,t,n,o){if(e.length!=oMap.coins.length){l(e,oMap.coins,"coin",t,n);for(var a=0;a<e.length;a++)posImg(e[a],oMap.coins[a].x,oMap.coins[a].y,Math.round(b.rotation),t,o)}}function d(t,o,a,s){var r=customDecorFetchHandlers.find(function(e){return e.plan===t}).list||{};for(var p in e.decor){var d=e.decor[p],c=decorBehaviors[p],u=getDecorExtra(c),m=u.custom;if(!c.hidden&&(d.length!=t[p].length||c.movable)){var y=o;if(c.size_ratio&&(y*=c.size_ratio.w),l(t[p],d,p,y,a),m&&r[p]!==t[p].length){r[p]=t[p].length;for(var h=0,g;h<t[p].length;h++)g=t[p][h],g.src="images/map_icons/empty.png";(function(e,n,s){getCustomDecorData(m,function(r){y=o*n.size_ratio.w,l(t[e],s,e,y,a);for(var p=0,d;p<t[e].length;p++)d=t[e][p],d.src=r.map,d.style.width=y+"px"})})(p,c,d)}var b=c.rotatable,f;if(b){var x=t[p][0];x&&x.naturalWidth&&(f=Math.round(y*(x.naturalWidth-x.naturalHeight)/(2*x.naturalWidth)))}for(var h=0;h<d.length;h++)b?posImgRel(t[p][h],d[h].x,d[h].y,Math.round(d[h].ref[4]),y,s,0,f):n(t[p][h],d[h].x,d[h].y,y,s)}}}function c(e,t,i){return e+=-1==t?i:t,"images/map_icons/"+e+".png"}function u(e,t,o,a,s){l(e,g.bobomb,"bob-omb",t,o);for(var r=0,p;r<g.bobomb.length;r++)p=g.bobomb[r],0>=p.ref.cooldown?(posImg(e[r],p.x,p.y,Math.round(b.rotation),s,a).src=c("explosion",p.ref.team,""),e[r].style.width=s+"px",e[r].style.opacity=Math.max(1+p.ref.cooldown/10,0),e[r].style.background=""):n(e[r],p.x,p.y,t,a,p.ref.team,100).style.zIndex=2}function m(e,t,o,a,s){l(e,g["carapace-bleue"],"carapace-bleue",t,s);for(var r=0,p;r<g["carapace-bleue"].length;r++)p=g["carapace-bleue"][r],0>=p.ref.cooldown?(posImg(e[r],p.x,p.y,Math.round(b.rotation),a,o).src=c("explosion",p.ref.team,"0"),e[r].style.width=a+"px",e[r].style.opacity=Math.max(1+p.ref.cooldown/10,0),e[r].style.background=""):n(e[r],p.x,p.y,t,o,p.ref.team,200).style.zIndex=2}function y(e,t,o,a,s){l(e,g["carapace-noire"],"carapace-noire",t,s);for(var r=0,p;r<g["carapace-noire"].length;r++)p=g["carapace-noire"][r],0>=p.ref.cooldown?(posImg(e[r],p.x,p.y,Math.round(b.rotation),a,o).src=c("explosion",p.ref.team,"D"),e[r].style.width=a+"px",e[r].style.opacity=Math.max(1+p.ref.cooldown/10,0),e[r].style.background=""):n(e[r],p.x,p.y,t,o,p.ref.team,200).style.zIndex=2}var h=e.players[0];if(oSpecCam&&(h=e.karts[oSpecCam.playerId]),!(3<h.teleport||10<h.tombe)){var g=e.items,b=h;oSpecCam&&(b=oSpecCam.pos);var f=Math.round(b.rotation-180);bSelectedMirror&&(f=-f);var x=direction(1,f),v=direction(0,f),C=b.x/oPlanRealSize,k=b.y/oPlanRealSize;bSelectedMirror&&(C=1-C),oPlanCtn.style.transform=oPlanCtn.style.WebkitTransform=oPlanCtn.style.MozTransform="translate("+-Math.round(oPlanSize*(C*x-k*v)-oPlanWidth/2)+"px, "+-Math.round(oPlanSize*(C*v+k*x)-oPlanWidth/2)+"px) rotate("+f+"deg)",o(oPlanAssets,oPlanCtn,oPlanSize,oPlanObjects),o(oPlanAssets2,oPlanCtn2,oPlanSize2,oPlanObjects2),oMap.sea&&(a(oPlanSea,oPlanSize),a(oPlanSea2,oPlanSize2)),s(oPlanCharacters,oCharWidth,oPlanSize),s(oPlanCharacters2,oCharWidth2,oPlanSize2),r(oPlanObjects),r(oPlanObjects2),oMap.coins&&(p(oPlanCoins,oCoinWidth,oPlanCtn,oPlanSize),p(oPlanCoins2,oCoinWidth2,oPlanCtn2,oPlanSize2)),d(oPlanDecor,oObjWidth,oPlanCtn,oPlanSize),d(oPlanDecor2,oObjWidth2,oPlanCtn2,oPlanSize2),l(oPlanFauxObjets,g.fauxobjet,"objet",oObjWidth,oPlanCtn),l(oPlanFauxObjets2,g.fauxobjet,"objet",oObjWidth2,oPlanCtn2);for(var E=0,w;E<g.fauxobjet.length;E++)w=g.fauxobjet[E],n(oPlanFauxObjets[E],w.x,w.y,oObjWidth,oPlanSize,w.ref.team,200),n(oPlanFauxObjets2[E],w.x,w.y,oObjWidth2,oPlanSize2,w.ref.team,200),oPlanFauxObjets[E].style.zIndex=oPlanFauxObjets2[E].style.zIndex=2;l(oPlanBananes,g.banane,"banane",oObjWidth,oPlanCtn),l(oPlanBananes2,g.banane,"banane",oObjWidth2,oPlanCtn2);for(var E=0,S;E<g.banane.length;E++)S=g.banane[E],n(oPlanBananes[E],S.x,S.y,oObjWidth,oPlanSize,S.ref.team,100),n(oPlanBananes2[E],S.x,S.y,oObjWidth2,oPlanSize2,S.ref.team,100),oPlanBananes[E].style.zIndex=oPlanBananes2[E].style.zIndex=2;l(oPlanPoisons,g.poison,"poison",oObjWidth,oPlanCtn),l(oPlanPoisons2,g.poison,"poison",oObjWidth2,oPlanCtn2);for(var E=0,T;E<g.poison.length;E++)T=g.poison[E],n(oPlanPoisons[E],T.x,T.y,oObjWidth,oPlanSize,T.ref.team,100),n(oPlanPoisons2[E],T.x,T.y,oObjWidth2,oPlanSize2,T.ref.team,100),oPlanPoisons[E].style.zIndex=oPlanPoisons2[E].style.zIndex=2;l(oPlanChampis,g.champi,"champi",oObjWidth,oPlanCtn),l(oPlanChampis2,g.champi,"champi",oObjWidth2,oPlanCtn2);for(var E=0,I;E<g.champi.length;E++)I=g.champi[E],n(oPlanChampis[E],I.x,I.y,oObjWidth,oPlanSize,-1,100),n(oPlanChampis2[E],I.x,I.y,oObjWidth2,oPlanSize2,-1,100),oPlanChampis[E].style.zIndex=oPlanChampis2[E].style.zIndex=2;u(oPlanBobOmbs,oObjWidth,oPlanCtn,oPlanSize,oExpWidth),u(oPlanBobOmbs2,oObjWidth2,oPlanCtn2,oPlanSize2,oExpWidth2),l(oPlanCarapaces,g.carapace,"carapace",oObjWidth,oPlanCtn),l(oPlanCarapaces2,g.carapace,"carapace",oObjWidth2,oPlanCtn2);for(var E=0,z;E<g.carapace.length;E++)z=g.carapace[E],n(oPlanCarapaces[E],z.x,z.y,oObjWidth,oPlanSize,z.ref.team,200),n(oPlanCarapaces2[E],z.x,z.y,oObjWidth2,oPlanSize2,z.ref.team,200).style.zIndex=2;l(oPlanCarapacesRouges,g["carapace-rouge"],"carapace-rouge",oObjWidth,oPlanCtn),l(oPlanCarapacesRouges2,g["carapace-rouge"],"carapace-rouge",oObjWidth2,oPlanCtn2);for(var E=0,B;E<g["carapace-rouge"].length;E++)B=g["carapace-rouge"][E],n(oPlanCarapacesRouges[E],B.x,B.y,oObjWidth,oPlanSize,B.ref.team,200),n(oPlanCarapacesRouges2[E],B.x,B.y,oObjWidth2,oPlanSize2,B.ref.team,200).style.zIndex=2,B.ref.owner&&(oPlanCarapacesRouges[E].style.zIndex=2);m(oPlanCarapacesBleues,oObjWidth,oPlanSize,oExpBWidth,oPlanCtn),m(oPlanCarapacesBleues2,oObjWidth2,oPlanSize2,oExpBWidth2,oPlanCtn2),y(oPlanCarapacesNoires,oObjWidth,oPlanSize,oExpBWidth,oPlanCtn),y(oPlanCarapacesNoires2,oObjWidth2,oPlanSize2,oExpBWidth2,oPlanCtn2);for(var M=[],L=[],E=0,H;E<e.karts.length;E++)H=e.karts[E],H.ref.etoile?M.push(H):H.ref.billball&&L.push(H);l(oPlanEtoiles,M,"etoile",oObjWidth,oPlanCtn),l(oPlanEtoiles2,M,"etoile",oObjWidth2,oPlanCtn2);for(var E=0;E<M.length;E++)n(oPlanEtoiles[E],M[E].x,M[E].y,oObjWidth,oPlanSize),n(oPlanEtoiles2[E],M[E].x,M[E].y,oStarWidth2,oPlanSize2).style.width=oStarWidth2+"px",oPlanEtoiles[E].style.zIndex=oPlanEtoiles2[E].style.zIndex=2;l(oPlanBillballs,L,"billball",oObjWidth,oPlanCtn),l(oPlanBillballs2,L,"billball",oObjWidth2,oPlanCtn2);for(var E=0;E<L.length;E++)posImg(oPlanBillballs[E],L[E].x,L[E].y,Math.round(b.rotation),oBBWidth,oPlanSize).style.width=oBBWidth+"px",posImg(oPlanBillballs2[E],L[E].x,L[E].y,Math.round(b.rotation),oBBWidth2,oPlanSize2).style.width=oBBWidth2+"px",oPlanBillballs[E].style.zIndex=oPlanBillballs2[E].style.zIndex=2}}function removePlan(){try{oPlanDiv.parentNode.removeChild(oPlanDiv)}catch(t){}try{oPlanDiv2.parentNode.removeChild(oPlanDiv2)}catch(t){}}function loadMap(){var e=isCup?complete?oMap.img:"mapcreate.php"+oMap.map:"images/maps/map"+oMap.map+"."+oMap.ext;if(gameSettings=localStorage.getItem("settings"),gameSettings=gameSettings?JSON.parse(gameSettings):{},ctrlSettings=localStorage.getItem("settings.ctrl"),ctrlSettings=ctrlSettings?JSON.parse(ctrlSettings):{},isMobile()&&(void 0===ctrlSettings.autoacc&&(ctrlSettings.autoacc=1),void 0===ctrlSettings.vitem&&(ctrlSettings.vitem=1)),gameSettings.rtime){function e(){var i=new Date().getTime();n+=i-t-67,0>n?n=0:67<n&&(n=67),t=i,cycleHandler=setTimeout(e,67-n),runOneFrame()}var t,n;cycle=function(){n=67,t=new Date().getTime(),e()}}if(oMap.ext?"gif"!==oMap.ext:!e.match(/\.gif$/g))oMapImg=new Image,oMapImg.onload=startGame,oMapImg.src=e;else if(gameSettings.nogif){var l=new Image;l.onload=function(){oMapImg=document.createElement("canvas"),oMapImg.width=l.naturalWidth,oMapImg.height=l.naturalHeight;var e=oMapImg.getContext("2d");e.drawImage(l,0,0),startGame()},l.src=e}else oMapImg=GIF(),oMapImg.onloadone=startGame,oMapImg.onloadall=function(){oPlanImg&&(oPlanImg.src=e),oPlanImg2&&(oPlanImg2.src=e)},oMapImg.load(e);1<strPlayer.length&&updateCtnFullScreen(!1),formulaire.dataset.disabled=1,iTeamPlay=isTeamPlay(),aTracksHist.push(oMap.ref),iRaceCount++,setSRest(),document.body.style.cursor="progress";for(var o=0;o<strPlayer.length;o++){var a=o*(80*iScreenScale+2),s=document.createElement("div");s.style.position="absolute",s.style.left=oContainers[o].style.left,s.style.top=oContainers[o].style.top,s.style.width=80*iScreenScale+"px",s.style.height=39*iScreenScale+"px";var r=document.createElement("div");r.id="temps"+o,r.style.right=Math.round(.6*iScreenScale+1)+"px",r.style.top=Math.round(.4*iScreenScale+3)+"px",r.style.fontSize=Math.round(2.4*iScreenScale)+"px";var p=Math.round(iScreenScale/8)+"px",d=Math.round(iScreenScale/4)+"px";r.style.textShadow="-"+d+" 0 black, 0 "+d+" black, "+d+" 0 black, 0 -"+d+" black, -"+p+" -"+p+" black, -"+p+" "+p+" black, "+p+" -"+p+" black, "+p+" "+p+" black",s.appendChild(r);var c=document.createElement("div");if(c.id="compteur"+o,c.style.left=Math.round(iScreenScale/2)+"px",c.style.bottom=("BB"==course?Math.round(iScreenScale/4):Math.round(iScreenScale/4))+"px",c.style.fontSize=Math.round(2.4*iScreenScale)+"px",!pause||!fInfos.replay)if("BB"!=course){c.innerHTML="<div></div><div class=\"glow\"></div>";for(var u=c.querySelectorAll("div"),m=0;m<u.length;m++)if(u[m].style.height=Math.round(2.4*iScreenScale)+"px",u[m].innerHTML="<div>"+(oMap.sections?"SECTION":toLanguage("LAP","TOUR"))+" <span class=\"tour\">1</span>/"+oMap.tours+"</div>",!m){var p=Math.round(iScreenScale/8)+"px",d=Math.round(iScreenScale/4)+"px";u[m].style.textShadow="-"+d+" 0 black, 0 "+d+" black, "+d+" 0 black, 0 -"+d+" black, -"+p+" -"+p+" black, -"+p+" "+p+" black, "+p+" -"+p+" black, "+p+" "+p+" black"}}else{var y=aTeams[o];null==y&&(y=-1),updateBalloonHud(c,{reserve:4,team:y})}s.appendChild(c);var h=document.createElement("div");h.id="objet"+o,h.className="itemWheel",pause&&fInfos.replay||(h.style.left=Math.round(iScreenScale)+"px",h.style.top=Math.round(iScreenScale)+"px",h.style.width=Math.round(26*iScreenScale/3)+"px",h.style.height=Math.round(18*iScreenScale/3)+"px",h.style.visibility="visible");var g=document.createElement("div");g.id="roulette"+o,g.className="itemChamber",h.appendChild(g);var b=document.createElement("div");b.id="countdown"+o,b.style.position="absolute",b.style.opacity=.8,b.style.width=Math.round(6.6*iScreenScale)+"px",b.style.height=Math.round(4.2*iScreenScale)+"px",b.style.border="solid "+Math.round(.75*iScreenScale)+"px #FEFF3F",b.style.borderRadius=Math.round(1.75*iScreenScale)+"px",b.style.display="none",h.appendChild(b),s.appendChild(h);var f=document.createElement("div");f.id="reserve"+o,f.className="itemWheel",pause&&fInfos.replay||(f.style.left=Math.round(.75*iScreenScale)+"px",f.style.top=Math.round(iScreenScale)+"px",f.style.width=Math.round(26*iScreenScale/5)+"px",f.style.height=Math.round(18*iScreenScale/5)+"px",f.style.visibility="hidden");var g=document.createElement("div");g.id="roulette2"+o,g.className="itemChamber",f.appendChild(g),s.appendChild(f);var x=document.createElement("div");x.id="lakitu"+o,x.className="pixelated",x.innerHTML="<div></div>",x.style.width=9*iScreenScale+"px",x.style.height=Math.round(6.6*iScreenScale)+"px",x.style.fontSize=Math.round(2.3*iScreenScale)+"px",s.appendChild(x);var v=document.createElement("div");v.id="infoPlace"+o,v.style.right=Math.round(iScreenScale/2)+"px",v.style.bottom="0px",v.style.fontSize=8*iScreenScale+"px",s.appendChild(v);var C=document.getElementById("infos"+o);C||(C=document.getElementById("infos0").cloneNode(!0),C.id="infos"+o,$mkScreen.appendChild(C)),C.style.left=10+a+"px",C.style.top=10*iScreenScale+"px",C.style.width=80*iScreenScale+"px",C.style.fontSize=16*iScreenScale+"px",C.style.fontFamily="\"NSMBU\", Impact",C.style.textAlign="center",C.style.textStroke=C.style.WebkitTextStroke=C.style.MozTextStroke=Math.round(iScreenScale/4)+"px #FEFF3F",C.style.visibility="hidden",C.style.display="",C.style.pointerEvents="none",C.innerHTML="<tr><td id=\"decompte"+o+"\">3</td></tr>";var k=document.getElementById("scroller").cloneNode(!0);k.id="scroller"+o,k.className="itemScroller";var E=1;k.style.left=iScreenScale+"px",k.style.top=Math.round(iScreenScale+iScreenScale*E)+"px",k.style.width=Math.round(26*iScreenScale/3)+"px",k.style.height=Math.round(18*iScreenScale/3-2*iScreenScale*E)+"px",k.style.lineHeight=iScreenScale+"px";for(var w=Math.round(4*iScreenScale),m=0;m<k.getElementsByClassName("aObjet").length;m++)k.getElementsByClassName("aObjet")[m].style.height=w+"px";s.appendChild(k);var S=document.getElementById("scroller").cloneNode(!0);S.id="scroller2"+o,S.className="itemScroller",E=.6,S.style.left=Math.round(.75*iScreenScale)+"px",S.style.top=Math.round(iScreenScale+iScreenScale*E)+"px",S.style.width=Math.round(26*iScreenScale/5)+"px",S.style.height=Math.round(18*iScreenScale/5-2*iScreenScale*E)+"px",S.style.lineHeight=iScreenScale+"px",w=Math.round(2.5*iScreenScale);for(var m=0;m<S.getElementsByClassName("aObjet").length;m++)S.getElementsByClassName("aObjet")[m].style.height=w+"px";if(s.appendChild(S),$mkScreen.appendChild(s),hudScreens[o]=s,onlineSpectatorId)r.style.display="none",k.style.display="none",S.style.display="none",h.style.display="none",f.style.display="none";else if(gameSettings.spd){var T=document.createElement("div");T.className="speedometer",T.style.right=Math.round(.85*iScreenScale)+"px",T.style.top=Math.round(3.2*iScreenScale)+"px",T.style.fontSize=Math.round(1.9*iScreenScale)+"px",T.style.visibility="hidden";var I=document.createElement("span");I.innerHTML="-.-",T.appendChild(I);var z=document.createElement("span");z.innerHTML=" km/h",T.appendChild(z),s.appendChild(T),$speedometers.push(T),$speedometerVals.push(I)}}oChallengeCpts=document.createElement("div"),oChallengeCpts.id="challenge-cpts",oChallengeCpts.style.right=Math.round(.85*iScreenScale)+"px",oChallengeCpts.style.top=Math.round(iScreenScale*($speedometers.length?5.5:3.2))+"px",oChallengeCpts.style.fontSize=Math.round(1.9*iScreenScale)+"px",oChallengeCpts.style.visibility="hidden",s.appendChild(oChallengeCpts),initMap(),removeMenuMusic(),bMusic&&!isOnline&&loadMapMusic()}function getShapeType(e){return"number"==typeof e[0]?"rectangle":"polygon"}function classifyByShape(e,t){for(var n={rectangle:[],polygon:[]},l=0,o;l<e.length;l++)o=getShapeType(e[l]),t&&t(l,n[o].length,o),n[o].push(e[l]);return n}function initMap(){if(clSelected)for(var e=clSelected.data,t=listChallengeRules(e),n=0,o;n<t.length;n++)o=t[n],challengeRules[o.type].preinitSelected&&challengeRules[o.type].preinitSelected(o);if(oMap.collision){var a={rectangle:{},polygon:{}};oMap.collision=classifyByShape(oMap.collision,oMap.collisionProps&&function(e,t,i){a[i][t]=oMap.collisionProps[e]}),oMap.collisionProps=a}if(oMap.pivots)for(var s=0;s<oMap.pivots.length;s++){var r=oMap.pivots[s][1],p=r[0],c=r[1],u=Math.round(r[2]/2),m=Math.round(r[3]/2);oMap.collision.polygon.push([[p-u,c],[p,c-m],[p+u,c],[p,c+m]])}if(oMap.horspistes)for(var g in oMap.horspistes)oMap.horspistes[g]=classifyByShape(oMap.horspistes[g]);if(oMap.checkpointCoords=oMap.checkpoint?oMap.checkpoint.map(function(e){return getCheckpointCoords(e)}):[],oMap.flowers)for(var s=0;s<oMap.flowers.length;s++){var b=oMap.flowers[s][1],p=b[0],c=b[1],u=Math.round(b[2]/2),m=Math.round(b[3]/2);oMap.horspistes.herbe.rectangle.push([p-u,c-u,2*u,2*m])}if(oMap.trous)for(var s in oMap.trous){for(var f={rectangle:[],polygon:[]},n=0,v;n<oMap.trous[s].length;n++)v=oMap.trous[s][n],6==v.length&&(v=[[v[0],v[1],v[2],v[3]],[v[4],v[5]]]),f[getShapeType(v[0])].push(v);oMap.trous[s]=f}if(oMap.flows){for(var C={rectangle:[],polygon:[]},s=0,E;s<oMap.flows.length;s++)E=oMap.flows[s],C[getShapeType(E[0])].push(E);oMap.flows=C}if(oMap.accelerateurs){oMap.accelerateurs=classifyByShape(oMap.accelerateurs);for(var S=oMap.accelerateurs.rectangle,s=0,T;s<S.length;s++)T=S[s],T[2]?(T[2]++,T[3]++):(T[2]=9,T[3]=9)}if(oMap.sauts){for(var I={rectangle:[],polygon:[]},s=0;s<oMap.sauts.length;s++){var T=oMap.sauts[s],z;if("number"==typeof T[0]?(z="rectangle",T=[T.slice(0,4),T[4]]):(z=getShapeType(T[0]),T=[T[0],T[1]]),!T[1]){var B=T[0],M,L;switch(z){case"rectangle":M=B[2],L=B[3];break;case"polygon":for(var H=2*oMap.w,A=-oMap.w,_=2*oMap.h,P=-oMap.h,n=0,N;n<B.length;n++)N=B[n],H=Math.min(H,N[0]),A=Math.max(A,N[0]),_=Math.min(_,N[1]),P=Math.max(P,N[1]);M=A-H,L=P-_;}T[1]=(M+L)/45+1}I[z].push(T)}oMap.sauts=I}if(oMap.cannons){for(var R={rectangle:[],polygon:[]},s=0,D;s<oMap.cannons.length;s++)D=oMap.cannons[s],R[getShapeType(D[0])].push(D);oMap.cannons=R}if(oMap.teleports){for(var F={rectangle:[],polygon:[]},s=0,V;s<oMap.teleports.length;s++)V=oMap.teleports[s],F[getShapeType(V[0])].push(V);oMap.teleports=F}if(oMap.elevators){for(var O={rectangle:[],polygon:[]},s=0,q;s<oMap.elevators.length;s++)q=oMap.elevators[s],O[getShapeType(q[0])].push(q);oMap.elevators=O}if(oMap.sea){function e(e,t){return[e[2]+(e[0]-e[2])*t,e[3]+(e[1]-e[3])*t]}var W=oMap.sea.waves;oMap.sea.projections=[];for(var s=0;s<W.length;s++){for(var X=W[s][0],G=W[s][1],K=[],U=0,Y=3+Math.ceil(3*G.length/X.length),n=0;n<G.length;n++){for(var J=G[n][0],Q=G[n][1],$=1/0,Z=0,ee,H,_,te;Z<X.length;Z++){if((Z+X.length-U)%X.length>=Y){if(Z>U)break;Z=U-1;continue}var ie=Z,ne=(Z+1)%X.length;ee=projete(J,Q,X[ie][0],X[ie][1],X[ne][0],X[ne][1]),1<ee&&(ee=1),0>ee&&(ee=0);var le=X[ie][0]+ee*(X[ne][0]-X[ie][0]),oe=X[ie][1]+ee*(X[ne][1]-X[ie][1]),ae=(le-J)*(le-J)+(oe-Q)*(oe-Q);ae<$&&($=ae,H=le,_=oe,te=ie)}te<U&&(te+=X.length);for(var Z=U,ne;Z<te;Z++)ne=(Z+1)%X.length,K.push([J,Q,X[ne][0],X[ne][1]]);U=te%X.length,K.push([J,Q,H,_])}oMap.sea.projections.push(K)}oMap.sea.progress=.9999,oMap.sea.offroad0=oMap.horspistes.eau.polygon,oMap.sea.drawPolygon=function(e,t,i,n){e.beginPath();for(var l=0;l<t.length;l++){var o=t[l],a=[(o[0]-i[0])*n,(o[1]-i[1])*n];l?e.lineTo(a[0],a[1]):e.moveTo(a[0],a[1])}e.closePath(),e.fill(),e.stroke()},oMap.sea.render=function(e,t,n){var l=this.progress,o=this.waves,a=.99*l,s=l-.25*(1-l/2),r=l-.04*(1-l/3);if(e.lineWidth=1,0<s)for(var p=0,d;p<o.length;p++)d=this.polygon(p,0,a),e.fillStyle=e.strokeStyle=this.color(p,"water"),this.drawPolygon(e,d,t,n);else s=0;if(0<r)for(var p=0,d;p<o.length;p++)d=this.polygon(p,s,a),e.fillStyle=e.strokeStyle=this.color(p,"wave"),this.drawPolygon(e,d,t,n);else r=0;if(.005<l)for(var p=0,d;p<o.length;p++)d=this.polygon(p,r,1.04*l),e.fillStyle=e.strokeStyle=this.color(p,"foam"),this.drawPolygon(e,d,t,n)},gameSettings.nowater&&(oMap.sea.render=function(){}),oMap.sea.color=function(e,t){return this["colors."+e]?this["colors."+e][t]:this.colors[t]},oMap.sea.polygon=function(t,i,n){var l=this.waves[t][0],o=[],a=this.projections[t],s;if(i){s=e(a[0],i),o.push(s);for(var r=0,p;r<a.length;r++)p=e(a[r],i),o.push(p);o.push(s)}else{s=l[0],o.push(s);for(var r=1,p;r<l.length;r++)p=l[r],o.push(p);o.push(s)}var d=a.length-1;s=e(a[d],n),o.push(s);for(var r=d-1,p;0<=r;r--)p=e(a[r],n),o.push(p);return o.push(s),o}}}function throwItem(e,t,i){var n=e.using[i||0];if(n){for(var l in t)n[l]=t[l];isOnline&&syncItems.push(n),e.using.shift()}return n}function loadNewItem(e,t){addNewItem(e,t),e.using.push(t)}function dropNewItem(e,t){switch(t.type){case"carapace":t.vx=0,t.vy=0,t.owner=-1,t.lives=10;break;case"carapace-rouge":t.theta=-1,t.owner=-1,t.aipoint=-2,t.aimap=-1,t.target=-1;}addNewItem(e,t)}function addNewItem(e,t){var n=t.type,l=itemBehaviors[n];if(!1!==l.sprite&&(t.sprite=new Sprite(n),t.size=l.size),items[n].push(t),isOnline?e&&(e.id==identifiant||e.controller==identifiant)&&syncItems.push(t):e==oPlayers[0]&&clLocalVars.myItems&&clLocalVars.myItems.push(t),-1!=t.team){var o;switch(n){case"champi":break;case"banane":o=50;break;case"poison":o=60;break;case"carapace":case"carapace-rouge":o=60;break;case"fauxobjet":o=65;break;case"carapace-bleue":case"carapace-noire":o=60;break;case"bobomb":o=40;break;default:o=60;}if(o){var a=50-o,s=50-o;"banane"===n?s+=5:"poison"===n?s+=5:"bobomb"===n?s+=5:"fauxobjet"===n?s-=5:void 0;for(var r=0,p;r<oPlayers.length;r++)if(p=document.createElement("div"),p.className="sprite-hallow",p.style.position="absolute",p.style.left=a+"%",p.style.top=s+"%",p.style.width=2*o+"%",p.style.height=2*o+"%",p.style.borderRadius=o+"%",p.style.backgroundColor=cTeamColors.primary[t.team],p.style.opacity=.25,t.sprite){var d=t.sprite[r].div.firstChild;d?t.sprite[r].div.insertBefore(p,d):t.sprite[r].div.appendChild(p)}}}}function arme(e,n,l){var o=aKarts[e];if(!o.using.length){if(25!=o.roulette)return;o==oPlayers[0]&&(clLocalVars.itemsUsed=!0);var a=o.arme,s;switch(o.arme){case"champi":case"champiX2":case"champiX3":a="champi",s=20,o.champiType=1,o.maxspeed=11,o.speed=o.maxspeed*cappedRelSpeed(o),playIfShould(o,"musics/events/boost.mp3");break;case"champior":a="champi",12>o.champi&&(s=20,o.champiType=1,o.maxspeed=11,o.speed=o.maxspeed*cappedRelSpeed(o),playIfShould(o,"musics/events/boost.mp3"),!o.champior&&(o.champior=70,o.champior0=o.champior));break;case"etoile":s=80;for(var r=0;r<strPlayer.length;r++)o.sprite[r].img.src=getStarSrc(o.personnage);o.cpu||o.etoile||(!isOnline&&(o.sprite[0].img.onload=function(){bCounting=!1,this.onload=void 0,reprendre(!1)},interruptGame(),bCounting=!0),shouldPlaySound(o)&&!oPlayers[1]&&postStartMusic("musics/events/starman.mp3")),0<o.speedinc&&(o.speedinc*=5),delete o.shift,o.protect=!0;break;case"billball":if(o.billball)break;s=Math.max(Math.min(Math.round(distanceToFirst(o)/(9*cappedRelSpeed())),120),40),o.billball0=s;for(var r=0;r<strPlayer.length;r++)o.sprite[r].img.src="images/sprites/sprite_billball.png",resetSpriteHeight(o.sprite[r]);o.cpu||isOnline||(o.sprite[0].img.onload=function(){bCounting=!1,this.onload=void 0,reprendre(!1)},interruptGame(),bCounting=!0),o.rotinc=0,o.size=2.5,o.mini=0,o.z=2,o.protect=!0,o.champi=0,delete o.champiType,delete o.shift,resetPowerup(o),playIfShould(o,"musics/events/boost.mp3"),stopDrifting(e);break;case"megachampi":s=80,o.size=1,o.mini=0,o.protect=!0,o.megachampi||!shouldPlaySound(o)||oPlayers[1]||postStartMusic("musics/events/megamushroom.mp3");break;case"banane":loadNewItem(o,{type:"banane",team:o.team,x:o.x-5*direction(0,o.rotation),y:o.y-5*direction(1,o.rotation),z:o.z}),playIfShould(o,"musics/events/item_store.mp3");break;case"bananeX3":for(var r=0;3>r;r++)loadNewItem(o,{type:"banane",team:o.team,x:o.x-5*direction(0,o.rotation),y:o.y-5*direction(1,o.rotation),z:o.z});o.rotitem=0,playIfShould(o,"musics/events/item_store.mp3");break;case"fauxobjet":loadNewItem(o,{type:"fauxobjet",team:o.team,x:o.x-5*direction(0,o.rotation),y:o.y-5*direction(1,o.rotation),z:o.z}),playIfShould(o,"musics/events/item_store.mp3");break;case"poison":loadNewItem(o,{type:"poison",team:o.team,x:o.x-5*direction(0,o.rotation),y:o.y-5*direction(1,o.rotation),z:o.z}),playIfShould(o,"musics/events/item_store.mp3");break;case"carapace":loadNewItem(o,{type:"carapace",team:o.team,x:o.x-5*direction(0,o.rotation),y:o.y-5*direction(1,o.rotation),z:o.z,vx:0,vy:0,owner:-1,lives:10}),playIfShould(o,"musics/events/item_store.mp3");break;case"carapaceX3":for(var r=0;3>r;r++)loadNewItem(o,{type:"carapace",team:o.team,x:o.x-5*direction(0,o.rotation),y:o.y-5*direction(1,o.rotation),z:o.z,vx:0,vy:0,owner:-1,lives:10});o.rotitem=0,playIfShould(o,"musics/events/item_store.mp3");break;case"carapacerouge":loadNewItem(o,{type:"carapace-rouge",team:o.team,x:o.x-5*direction(0,o.rotation),y:o.y-5*direction(1,o.rotation),z:o.z,theta:-1,owner:-1,aipoint:-1,aimap:-1,target:-1}),playIfShould(o,"musics/events/item_store.mp3");break;case"carapacerougeX3":for(var r=0;3>r;r++)loadNewItem(o,{type:"carapace-rouge",team:o.team,x:o.x-5*direction(0,o.rotation),y:o.y-5*direction(1,o.rotation),z:o.z,theta:-1,owner:-1,aipoint:-1,aimap:-1,target:-1});o.rotitem=0,playIfShould(o,"musics/events/item_store.mp3");break;case"carapacebleue":var p=1/0,d=0,c=0;if("BB"!=course)for(var r=0,u;r<oMap.aipoints.length;r++){u=oMap.aipoints[r];for(var m=0;m<u.length;m++){var y=u[m],h=u[(m?m:u.length)-1],g=Math.hypot(y[0]-o.x,y[1]-o.y),b=0<(y[0]-o.x)*(y[0]-h[0])+(y[1]-o.y)*(y[1]-h[1]);b||(g+=oMap.w+oMap.h);var f=o.demitours+1;f>=oMap.checkpoint.length&&(f=0);var x=oMap.checkpointCoords[f];if(x){var v=x.O[0],C=x.O[1],k=Math.hypot(v-o.x,C-o.y)*Math.hypot(y[0]-h[0],y[1]-h[1]);k&&(g-=150*((v-o.x)*(y[0]-h[0])+(C-o.y)*(y[1]-h[1]))/k)}g<p&&(c=r,d=m,p=g)}}addNewItem(o,{type:"carapace-bleue",team:o.team,x:o.x,y:o.y,z:15,target:-1,aipoint:d,aimap:c,cooldown:itemBehaviors["carapace-bleue"].cooldown0}),playDistSound(o,"musics/events/throw.mp3",50);break;case"carapacenoire":var p=1/0,d=0,c=0;if("BB"!=course)for(var r=0,u;r<oMap.aipoints.length;r++){u=oMap.aipoints[r];for(var m=0;m<u.length;m++){var y=u[m],h=u[(m?m:u.length)-1],g=Math.hypot(y[0]-o.x,y[1]-o.y),b=0<(y[0]-o.x)*(y[0]-h[0])+(y[1]-o.y)*(y[1]-h[1]);b||(g+=oMap.w+oMap.h);var f=o.demitours+1;f>=oMap.checkpoint.length&&(f=0);var x=oMap.checkpointCoords[f];if(x){var v=x.O[0],C=x.O[1],k=Math.hypot(v-o.x,C-o.y)*Math.hypot(y[0]-h[0],y[1]-h[1]);k&&(g-=150*((v-o.x)*(y[0]-h[0])+(C-o.y)*(y[1]-h[1]))/k)}g<p&&(c=r,d=m,p=g)}}addNewItem(o,{type:"carapace-noire",team:o.team,x:o.x,y:o.y,z:15,target:-1,aipoint:d,aimap:c,cooldown:itemBehaviors["carapace-noire"].cooldown0}),playDistSound(o,"musics/events/throw.mp3",50);break;case"bobomb":loadNewItem(o,{type:"bobomb",team:o.team,x:o.x-5*direction(0,o.rotation),y:o.y-5*direction(1,o.rotation),z:o.z,theta:-1,countdown:15,cooldown:30}),playIfShould(o,"musics/events/item_store.mp3");break;case"eclair":addNewItem(o,{type:"eclair",owner:o.id});break;case"bloops":addNewItem(o,{type:"bloops",owner:o.id});}s&&(o[a]=s);var E;switch(o.arme){case"champiX2":E="champi";break;case"champiX3":E="champiX2";break;case"champior":E="champior";break;case"billball":E="billball";}if(!E)o.using.length&&oDoubleItemsEnabled||consumeItem(e);else if(o.arme!==E)o.arme=E,kartIsPlayer(o)&&updateObjHud(e);else if(kartIsPlayer(o))switch(E){case"champior":var w=document.getElementById("roulette"+e).getElementsByTagName("img")[0],S=0;function t(){S++;var e=(S-3)/3,i=.8+.2*e*e;return 1<=i?void(w.style.transform=""):void(w.style.transform="scale("+i+")",setTimeout(t,67))}t(),updateItemCountdownHud(e,o.champior/o.champior0);break;case"billball":updateItemCountdownHud(e,o.billball/o.billball0);}}else{var T=o.x,I=o.y;switch(o.using[0].type){case"banane":case"fauxobjet":case"poison":if(l)throwItem(o,{x:T,y:I,z:.01,theta:o.rotation,countdown:15}),playDistSound(o,"musics/events/throw.mp3",50);else{var z=30/(o.speed+5),B=throwItem(o,{x:T-z*direction(0,o.rotation),y:I-z*direction(1,o.rotation),z:0});playIfShould(o,"musics/events/put.mp3"),tombe(B.x,B.y)&&detruit(B)}break;case"carapace":var M=dirShoot(o,n,3.2),L=angleShoot(o,n),H=M[0],A=M[1],_=Math.hypot(H,A);_||(_=1);var P=n?7.5:6+_;1<o.using.length&&(P+=5),throwItem(o,{x:T+P*H/_,y:I+P*A/_,z:0,vx:H,vy:A,owner:o.id,lives:10}),playDistSound(o,"musics/events/throw.mp3",50);break;case"carapace-rouge":var L=angleShoot(o,n),P=7.5;n?1<o.using.length&&(P*=1.5):(P*=1.5,P+=o.speed,1<o.using.length&&(P*=4/3)),n?throwItem(o,{x:T+P*direction(0,L),y:I+P*direction(1,L),z:0,theta:L,owner:o.id,aipoint:-2,aimap:-1,target:-1}):throwItem(o,{x:T+P*direction(0,L),y:I+P*direction(1,L),z:0,theta:L,owner:o.id,aipoint:-1,aimap:-1,target:-1}),playDistSound(o,"musics/events/throw.mp3",50);break;case"bobomb":var L=angleShoot(o,n);n?throwItem(o,{x:T+5*direction(0,L),y:I+5*direction(1,L),z:0,theta:L,countdown:2,cooldown:42}):throwItem(o,{x:T,y:I,z:0,theta:L,countdown:15,cooldown:30}),playDistSound(o,"musics/events/throw.mp3",50);break;default:}o.using.length||consumeItemIfDouble(e)}}function loadMusic(e,t,i){var n=isOriginalMusic(e),l;if(n)l=document.createElement("audio"),l.setAttribute("loop",!0);else{i=i||{};var o=youtube_parser(e);l=document.createElement("iframe"),l.id="youtube-video-"+musicIdInc++,l.src="https://www.youtube.com/embed/"+o+"?"+(t?"autoplay=1&amp;":"")+(i.start?"":"loop=1&amp;")+"enablejsapi=1&amp;allow=autoplay",l.opts=i,l.setAttribute("enablejsapi",1),l.setAttribute("allow","autoplay")}if(l.className="gamemusic",n){var a=document.createElement("source");a.type="audio/mpeg",l.src=e,l.volume=i&&null!=i.vSnd?i.vSnd:vSfx,l.appendChild(a),t&&l.setAttribute("autoplay",!0)}return l}function pauseMusic(e){var t=isOriginalEmbed(e);t?e.pause():onPlayerReady(e,function(e){e.pauseVideo()}),oMusicEmbed==e&&(oMusicEmbed=void 0)}function bufferMusic(e,t){var i=isOriginalEmbed(e);if(i)return void(t&&setTimeout(t,1));options=e.opts||{};var n=options.start||0,l=options.speed;onPlayerReady(e,function(e){e.setVolume(0),n&&e.seekTo(n,!0),e.playVideo(),setTimeout(function(){e.pauseVideo(),l&&e.setPlaybackRate(l),e.seekTo(n,!0),e.setVolume(100*vMusic),t&&t()},1e3)})}function stopMusic(e){e&&(e.permanent?pauseMusic(e):removeIfExists(e))}function unpauseMusic(e){if(document.body.contains(e)){var t=isOriginalEmbed(e);t?e.play():onPlayerReady(e,function(e){e.playVideo()}),oMusicEmbed=e}}function muteSound(e){var t=isOriginalEmbed(e);t?e.muted=!0:onPlayerReady(e,function(e){e.mute()})}function unmuteSound(e){var t=isOriginalEmbed(e);t?e.muted=!1:onPlayerReady(e,function(e){e.unMute()})}function onPlayerReady(e,t){try{if(e.yt)e.tasks?e.tasks.push(t):t(e.yt);else{var i=e.opts||{};e.tasks=[t],e.yt=new YT.Player(e.id,{events:{onReady:function(){for(var t=0;t<e.tasks.length;t++)e.tasks[t](e.yt);delete e.tasks},onStateChange:function(t){t.data===YT.PlayerState.ENDED&&i.start&&e.yt.seekTo(i.start,!0)}}})}}catch(t){}}function updateMusic(e,t){if(e!=oMusicEmbed&&removeIfExists(oMusicEmbed),document.body.contains(e)){var i=isOriginalEmbed(e);i?(t&&(e.playbackRate=1.2),e.volume=vMusic,e.currentTime=0,e.play()):onPlayerReady(e,function(i){var n=e.opts||{};n.speed?i.setPlaybackRate(n.speed):t&&i.setPlaybackRate(1.25);var l=n.start||0;i.seekTo(l,!0),i.setVolume(100*vMusic),i.playVideo()}),oMusicEmbed=e}}function fastenMusic(e){var t=isOriginalEmbed(e);t?e.playbackRate=1.2:onPlayerReady(e,function(e){e.setPlaybackRate(1.25)})}function shouldPlaySound(e){return iSfx&&kartIsPlayer(e)&&!finishing&&!e.loose}function shouldPlayMusic(e){return bMusic&&kartIsPlayer(e)&&!finishing&&!e.loose}function playIfShould(e,t){if(shouldPlaySound(e))return playSoundEffect(t)}function playSoundEffect(e){var t=loadMusic(e,!0);return t.removeAttribute("loop"),t.onended=function(){document.body.removeChild(this)},document.body.appendChild(t),t}function playDistSound(e,t,i){if(iSfx){var n=i/distKart(e);if(1<=n){var l=playSoundEffect(t);return l.volume=Math.min(.05*n*n,1)*vSfx,l}}}function startMusic(e,t,i,n){var l=loadMusic(e,t,n);if(null!=l.volume&&(n&&null!=n.vSnd?l.volume=n.vSnd:l.volume=vMusic),document.body.appendChild(l),i){pauseMusic(l);var o=oMusicEmbed;setTimeout(function(){oMusicEmbed==l&&(stopMusic(o),unpauseMusic(l))},i),oMusicEmbed=l}else t&&(stopMusic(oMusicEmbed),oMusicEmbed=l);return l}function postStartMusic(e){var t=bMusic?vMusic:vSfx;return oMusicEmbed&&fadeOutMusic(oMusicEmbed,1,.6,!1,t),startMusic(e,!0,200,{vSnd:t})}function postResumeMusic(e,t){if(oMusicEmbed!=e){var i=oMusicEmbed,n=bMusic?vMusic:vSfx;fadeOutMusic(i,1,t,!0,n),e&&setTimeout(function(){oMusicEmbed!=i&&oMusicEmbed||(fadeInMusic(e,.2,t),unpauseMusic(e))},500)}}function stopStarMusic(e){shouldPlaySound(e)&&!oPlayers[1]&&postResumeMusic(mapMusic,.9)}function stopMegaMusic(e){shouldPlaySound(e)&&!oPlayers[1]&&postResumeMusic(mapMusic,.92)}function resetPowerup(e){e.etoile&&(e.etoile=0,stopStarMusic(e)),e.megachampi&&(e.megachampi=0,stopMegaMusic(e))}function isOriginalMusic(e){return-1!=e.indexOf("mp3")}function isOriginalEmbed(e){return"audio"==e.tagName.toLowerCase()}function loadMapMusic(){if(startMapMusic(!1),loadEndingMusic(),mapMusic.blur(),endingMusic.blur(),!isMobile()&&!isChatting()){var e=document.createElement("input");document.body.appendChild(e),e.focus(),e.blur(),document.body.removeChild(e)}}function startMapMusic(e){if(e)lastMapMusic&&mapMusic!==lastMapMusic&&(removeIfExists(mapMusic),mapMusic=lastMapMusic),updateMusic(mapMusic,mapMusic!==lastMapMusic);else{var t=oMap.yt_opts||{};mapMusic=startMusic(oMap.music?"musics/maps/map"+oMap.music+".mp3":oMap.yt,!1,0,t),mapMusic.permanent=1,bufferMusic(mapMusic,function(){endingMusic&&oMap.music&&bufferMusic(endingMusic)}),t.last&&(lastMapMusic=startMusic(t.last.url,!1,0,t.last),lastMapMusic.permanent=1)}}function loadEndingMusic(){var e=getEndingSrc(strPlayer[0]);endingMusic=startMusic(e),endingMusic.permanent=1}function loopWithoutGap(){if(playingCarEngine==this){this.currentTime>this.duration-.44&&(this.currentTime=0,this.parentNode&&this.play())}}function loopAfterIntro(e,t,i){if(!e.looper){i-=.15;var n=t+i;e.looper=function(){this.currentTime>=n&&(this.currentTime-=i)},e.addEventListener("timeupdate",e.looper,!1)}}function startEngineSound(){iSfx&&(carEngine=loadMusic("musics/events/engine.mp3",!0),carEngine2=loadMusic("musics/events/engine2.mp3",!1),carEngine3=loadMusic("musics/events/engine3.mp3",!1),carDrift=loadMusic("musics/events/drift.mp3",!1),carSpark=loadMusic("musics/events/spark.mp3",!1),playingCarEngine=carEngine,carEngine.addEventListener("timeupdate",loopWithoutGap,!1),carEngine2.addEventListener("timeupdate",loopWithoutGap,!1),carEngine.permanent=1,carEngine2.permanent=1,carEngine3.permanent=1,carDrift.permanent=1,carSpark.permanent=1,document.body.appendChild(carEngine),document.body.appendChild(carEngine2),document.body.appendChild(carEngine3),document.body.appendChild(carDrift),document.body.appendChild(carSpark))}function updateEngineSound(e){iSfx&&e!=playingCarEngine&&(playingCarEngine&&playingCarEngine.pause(),playingCarEngine=e,playingCarEngine&&playingCarEngine.play())}function startEndMusic(){if(bMusic&&(removeMenuMusic(!0),removeIfExists(mapMusic),removeIfExists(lastMapMusic)),iSfx&&removeSoundEffects(),bMusic&&(willPlayEndMusic=!0,setTimeout(function(){for(var e=document.getElementsByClassName("gamemusic"),t=[],n=0;n<e.length;n++)e[n].permanent||t.push(e[n]);for(var n=0;n<t.length;n++)document.body.removeChild(t[n]);willPlayEndMusic&&(willPlayEndMusic=!1,isEndMusicPlayed=!0,unpauseMusic(endingMusic),endingMusic.yt&&onPlayerReady(endingMusic,function(e){e.setVolume(100*vMusic)}))},200)),iSfx&&"BB"!=course){var e=playSoundEffect("musics/events/goal.mp3");e.className=""}}function handleEndRace(){(bMusic||iSfx)&&startEndMusic();var e=["next_circuit"];challengeCheck("end_game",e),challengeCheck("end_gp",e),clGlobalVars.nbcircuits++}function startGame(){function e(e,t){var i=27*((t+1)%x-(x-1)/2)/(x-.5),n=t*Math.min(12,130/d);y||(i=-i),i+=9,e.x-=i*g+n*b,e.y+=i*b-n*g}function t(e){return{acceleration:.2+.8*Math.pow(e[0],2),speed:.875+.25*e[1],handling:.2+.8*e[2],mass:.5+e[3]}}function n(){this.speedinc=this.stats.acceleration*this.size,this.etoile&&(this.speedinc*=5)}function l(e){e*=getMirrorFactor(),clLocalVars.invertDirs&&(e=-e),this.rotincdir=this.stats.handling*e,this.driftinc||this.tourne||this.fell||!this.ctrl||this.cannon||(this.jumped&&(this.driftinc=e),this.driftinc&&(clLocalVars.drifted=!0))}function o(e){this.tourne||(isOnline?playIfShould(this,"musics/events/spin.mp3"):playDistSound(this,"musics/events/spin.mp3","BB"==course?80:50)),this.frminv=10,this.tourne=e,resetWrongWay(this)}function a(){return tombe(this.x+this.speed*direction(0,this.rotation),this.y+this.speed*direction(1,this.rotation))}function s(){return this.speed*this.size*fSelectedClass}function r(){var e=this.x+this.speed*direction(0,this.rotation),t=this.y+this.speed*direction(1,this.rotation);return ralenti(e,t)}function p(e){var t=oPlayers[0].team,i=document.createElement("div");i.style.position="absolute",i.style.zIndex=1e4,i.style.left="0px",i.style.top=12*iScreenScale+"px",i.style.width=80*iScreenScale+"px",i.style.textAlign="center",i.style.fontSize=6*iScreenScale+"px",i.style.fontWeight="bold",i.style.color=cTeamColors.light[t],i.innerHTML=toLanguage("You are ","Vous \xEAtes ")+cTeamColors.name2[t];var n=Math.min(1500,e-1e3);500<n&&setTimeout(function(){oContainers[0].appendChild(i),setTimeout(function(){oContainers[0].removeChild(i)},n)},500)}resetScreen();var d=strPlayer.length+aPlayers.length;if(!isOnline)if("BB"==course)for(var c=0;c<d;c++)aPlaces[c]=c+1;else"CM"==course&&(aPlaces=[1]);isTeamPlay()&&setupTeamColors();var u=oMap.sections?oMap.checkpoint.length-1:0,m=null==oMap.startrotation?180:oMap.startrotation,y=oMap.startdirection||0,h=m*Math.PI/180,g=Math.cos(h),b=Math.sin(h),f=130,x=Math.max(2,Math.round((1+Math.sqrt((f+4*(d-1)*27)/f))/2)),v=timeTrialMode(),C=strPlayer.length;onlineSpectatorId&&(C=0);for(var c=0;c<C;c++){var E=strPlayer[c],w=aPlaces[c],S={id:c,x:oMap.startposition[0],y:oMap.startposition[1],z:0,personnage:E,speed:0,speedinc:0,heightinc:0,stats:t(cp[E]),rotation:m,rotincdir:0,rotinc:0,changeView:0,size:1,sprite:new Sprite(E),cpu:!1,aipoints:oMap.aipoints[0],tourne:0,tombe:0,protect:!1,roulette:0,roulette2:0,arme:!1,stash:!1,maxspeed:5.7,driftinc:0,driftcpt:0,drift:0,turbodrift:0,driftSprite:new Sprite("drift"),jumped:!1,champi:0,etoile:0,megachampi:0,mini:0,using:[]};if(isOnline&&(S.id=identifiant),isOnline&&(S.nick=aPseudos[c]),S.team=iTeamPlay?aTeams[c]:-1,"BB"!=course)e(S,v?1:w),S.time=0,S.tours=1,S.demitours=u,S.billball=0,S.place=w;else{var T=isOnline?w-1:c,I=T%oMap.startposition.length;S.x=oMap.startposition[I][0],S.y=oMap.startposition[I][1],S.rotation=90*oMap.startposition[I][2],S.loose=!1,S.ballons=[createBalloonSprite(S)],S.reserve=4,S.place=w}S.initialPlace=S.place,oPlayers.push(S),aKarts.push(S)}for(c=0;c<aPlayers.length;c++){var E=aPlayers[c],z=c+C,w=aPlaces[z],B=2*(iDificulty-4)+Math.round(Math.random());"BB"==course&&(B=2);var M={id:z,speed:0,speedinc:.5,heightinc:0,stats:t([.5,.5,.5,cp[E][3]]),rotation:m,rotincdir:0,rotinc:0,x:oMap.startposition[0],y:oMap.startposition[1],z:0,size:1,personnage:E,sprite:new Sprite(E),tourne:0,tombe:0,protect:!1,roulette:0,roulette2:0,arme:!1,drift:0,driftinc:0,driftcpt:0,driftSprite:new Sprite("drift"),champi:0,etoile:0,megachampi:0,mini:0,using:[],cpu:!0,aipoint:0,lastAItime:0,aipoints:oMap.aipoints[0],maxspeed:5.7,maxspeed0:5.7};isOnline&&(M.id=aIDs[c],aControllers[c]?M.controller=aControllers[c]:M.cpu=!1);var L=z%oMap.aipoints.length;if(M.aipoints=oMap.aipoints[L]||[],oMap.aishortcuts&&oMap.aishortcuts[L]){for(var H={},A=!1,_=0;_<oMap.aishortcuts[L].length;_++){var P=oMap.aishortcuts[L][_],N=P[0];P=P.slice(1),P[2]||(P[2]={});var R=P[2];null==R.items&&(R.items=["champi","champiX2","champiX3","champior","megachampi","etoile"]),null==R.difficulty&&(R.difficulty=1.01),null==R.cc&&(R.cc=150),null==R.ccm&&(R.ccm=1e3);var D=4+.5*R.difficulty,F=getRelSpeedFromCc(R.cc),V=getRelSpeedFromCc(R.ccm);if(iDificulty>=D&&fSelectedClass>=F&&fSelectedClass<=V){if(A=!0,!R.itemsDict){for(var O={},q=0;q<R.items.length;q++)O[R.items[q]]=1;R.itemsDict=O}H[N]=P}}A&&(M.aishortcuts=H)}if(isOnline&&(M.nick=aPseudos[z]),M.team=iTeamPlay?aTeams[z]:-1,(-1!=M.team||M.nick)&&(M.marker=createMarker(M)),"BB"!=course)e(M,v?1:w),M.tours=1,M.demitours=u,M.billball=0,isOnline||(M.speed=2>B?0:5.7,M.tourne=B?0:42),M.place=w;else{var T=isOnline?w-1:z,I=T%oMap.startposition.length;M.x=oMap.startposition[I][0],M.y=oMap.startposition[I][1],M.rotation=90*oMap.startposition[I][2],M.loose=!1,M.aipoint=oMap.startposition[I][3],simplified&&(M.lastAI=oMap.startposition[I][3]+[-6,-1,6,1][oMap.startposition[I][2]]),M.ballons=[createBalloonSprite(M)],M.reserve=4,M.place=T+1,simplified||isOnline||(M.speed=M.maxspeed)}M.initialPlace=M.place,aKarts.push(M)}if(onlineSpectatorId&&(oPlayers.push(aKarts[0]),oSpecCam={playerId:0,pos:{},aim:{},lastReset:0,isSetup(){return!isNaN(this.pos.x)},move:function(){var e=.3;this.pos.x=interpolateRaw(this.pos.x,this.aim.x,e),this.pos.y=interpolateRaw(this.pos.y,this.aim.y,e),this.pos.rotation=interpolateRaw(nearestAngle(this.pos.rotation,this.aim.rotation,360),this.aim.rotation,e),this.lastReset++;var t=aKarts[this.playerId];e=2/(1+this.lastReset),this.aim.x=interpolateRaw(this.aim.x,t.x,e),this.aim.y=interpolateRaw(this.aim.y,t.y,e),this.aim.rotation=interpolateRaw(nearestAngle(this.aim.rotation,t.rotation,360),t.rotation,e)},reset:function(e){e||(e={}),this.resetAim(),this.lastReset=e.since||0,e.smooth&&this.isSetup()||this.resetPos()},resetAim:function(){var e=aKarts[this.playerId];this.aim.x=e.x,this.aim.y=e.y,this.aim.rotation=e.rotation},resetPos:function(){this.pos.x=this.aim.x,this.pos.y=this.aim.y,this.pos.rotation=this.aim.rotation,lastState&&lastState.cam&&(lastState.cam.x=this.pos.x,lastState.cam.y=this.pos.y,lastState.cam.rotation=this.pos.rotation),oContainers[0].style.opacity=1,resetRenderState()}},getPlayerAtScreen=function(){return aKarts[oSpecCam.playerId]},getScreenPlayerIndex=function(e){for(var t=aKarts[e],n=0;n<oPlayers.length;n++)if(getPlayerAtScreen(n)===t)return n;return oPlayers.length},(!onlineSpectatorState||tnCourse+3e3>new Date().getTime())&&oSpecCam.reset()),itemDistribution=selectedItemDistrib,itemDistribution||(itemDistribution=itemDistributions[getItemMode()][0]),itemDistribution.value||(itemDistribution={value:itemDistribution}),ptsDistribution=selectedPtDistrib,!!v){oMap.arme=[];for(var c=0;c<aKarts.length;c++)aKarts[c].arme="champiX3",aKarts[c].maxspeed0=aKarts[c].maxspeed;if(aKarts[0].roulette=25,"CM"==course)for(var c=0,W;c<gPersos.length;c++)W=gPersos[c],aKarts.push({speed:2>B?0:5.7,speedinc:.5,heightinc:0,stats:t(cp[W]),rotation:m,rotincdir:0,rotinc:0,x:aKarts[0].x,y:aKarts[0].y,z:0,size:1,personnage:W,sprite:new Sprite(W),tourne:0,tombe:0,protect:!1,roulette:0,roulette2:0,arme:!1,drift:0,driftinc:0,driftcpt:0,driftSprite:new Sprite("drift"),champi:0,etoile:0,megachampi:0,using:[],cpu:!1,aipoint:0,aipoints:oMap.aipoints[0],maxspeed:5.7,maxspeed0:5.7,place:1});for(var c=oPlayers.length;c<aKarts.length;c++)for(var X=jTrajets?jTrajets[c-1]:[],G=iTrajet===X?0:.5,q=0;q<oPlayers.length;q++)aKarts[c].sprite[q].div.style.opacity=G,aKarts[c].driftSprite[q].div.style.opacity=G;for(var c=0;c<aKarts.length;c++){var K=!1,U=!1,Y=!1,J=[iTrajet];(function(e){var t=aKarts[e];t.stopDrifting=function(){t.tourne=0,t.driftcpt=0,t.driftinc=0,resetDriftSprite(t)},t.stopStunt=function(){K&&(K=!1,t.tourne=0);var e=t.sprite[0];e.div.ahallowed&&(e.div.ahallowed=!1,e.div.style.backgroundColor="",e.div.style.backgroundImage="",e.div.style.backgroundRepeat="",e.div.style.backgroundSize="",e.img.style.opacity=1)},t.moveGhost=function(t){var i=aKarts[e];i.tombe&&(i.tombe--,!i.tombe&&resetFall(i),!e&&(19===i.tombe&&(i.sprite[e].img.style.opacity=1),oContainers[0].style.opacity=Math.abs(i.tombe-10)/10));var n=i.x,l=i.y,o=i.rotation;i.x=t[0],i.y=t[1],i.z=t[2],i.rotation=t[3];for(var a=(t[4]||"0000").split(""),s=0;4>s;s++)a[s]=+a[s];var r=0;if(a[2]?r=1:a[3]&&(r=-1),i.rotincdir=i.stats.handling*r,i.z){if(U||(U=!0,Y=!0,i.stopDrifting()),1.18<i.z&&(Y=!1),Y)a[1]&&!i.driftinc&&r&&(i.driftinc=r);else if(!K)!a[1]||i.driftinc||i.tombe||(K=!0,i.stopDrifting(),i.tourne=19);else if(i.tourne-=1+Math.round(.5*(11-Math.abs(11-i.tourne))),8>i.tourne){var p=i.sprite[0];p.div.ahallowed||(p.div.ahallowed=!0,p.div.style.backgroundImage="url('images/halo.png')",p.div.style.backgroundRepeat="no-repeat",p.div.style.backgroundSize="contain",p.img.style.opacity=.7),0>i.tourne&&(i.tourne=0)}a[0]&&(i.tombe=20,i.aX=n,i.aY=l,i.aRotation=o,i.sprite[0].img.style.display="none",i.stopStunt())}else U&&(U=!1,i.stopStunt());i.driftinc&&!a[1]&&i.stopDrifting(),handleDriftCpt(e)}})(c)}updateObjHud(0)}else if(itemDistribution.value.length)for(var c=0;c<oMap.arme.length;c++)initItemSprite(oMap.arme[c]);else oMap.arme=[];for(var c=0,Q;c<aKarts.length;c++){Q=aKarts[c],Q.accelerate=n,Q.turn=l,Q.spin=o,Q.falling=a,Q.exiting=r,Q.actualSpeed=s;for(var q=0;q<strPlayer.length;q++)(function(e,t){e.nbSprites=24,t.nbSprites=3,t.w=63,t.h=22,t.z=-.544,e.img.onload=function(){e.w=this.naturalWidth/e.nbSprites,e.h=this.naturalHeight,t.z=-.017*e.h,delete this.onload}})(Q.sprite[q],Q.driftSprite[q])}if("CM"!=course)for(var c=0;c<oPlayers.length;c++){document.getElementById("infoPlace"+c).innerHTML=oPlayers[c].place,document.getElementById("infoPlace"+c).style.display="block";var $=-1==oPlayers[c].team?"":cTeamColors.light[oPlayers[c].team];document.getElementById("infoPlace"+c).style.color=$,"BB"==course||onlineSpectatorId||(document.getElementById("compteur"+c).style.color=$)}gameControls=getGameControls();for(var c=0;c<oPlayers.length;c++)previouslyPressedBtns[c]=[];challengesForCircuit={end_game:[],each_frame:[],each_hit:[],each_decor_hit:[],each_kill:[],each_item:[],each_coin:[],end_gp:[]},clGlobalVars||(clGlobalVars={nbcircuits:0});var Z=getMapId(oMap);if(addCreationChallenges("track",Z),isCup)if(isMCups){var ee=cupIDs[Math.floor((oMap.ref-1)/4)];for(var ee in addCreationChallenges("cup",ee),challenges.mcup)addCreationChallenges("mcup",ee)}else for(var ee in challenges.cup)addCreationChallenges("cup",ee);var te={};for(var ie in challengesForCircuit)for(var ne=challengesForCircuit[ie],c=0,le;c<ne.length;c++)le=ne[c],te[le.id]=!0;for(var oe in clRuleVars)te[oe]||delete clRuleVars[oe];if(clSelected&&!te[clSelected.id]&&(clSelected=void 0),reinitLocalVars(),clLocalVars.startPos&&(oPlayers[0].x=clLocalVars.startPos.pos[0],oPlayers[0].y=clLocalVars.startPos.pos[1],oPlayers[0].rotation=90-180*clLocalVars.startPos.angle/Math.PI),oMap.decor){for(var ae in oMap.decor){decorBehaviors[ae]||(decorBehaviors[ae]={type:ae});var se=decorBehaviors[ae],re=getDecorExtra(se),pe=re.custom;pe&&(decorBehaviors[pe.type]&&(Object.assign(se,decorBehaviors[pe.type]),se.type=ae),function(e){getCustomDecorData(pe,function(t){var n={w:t.size.hd.w/t.original_size.hd.w,h:t.size.hd.h/t.original_size.hd.h};if(e.size_ratio=n,1!==n.w){var l=e.hitbox||DEFAULT_DECOR_HITBOX,o=1;e.hitbox=o+(l-o)*n.w}if(1!==n.h){var a=e.hitboxH||DEFAULT_DECOR_HITBOX_H,o=.8;e.hitboxH=o+(a-o)*n.h}if(t.options&&(0===t.options.hitbox?e.transparent=!0:1===t.options.hitbox&&delete e.transparent,1!==t.options.spin||e.spin?0===t.options.spin&&delete e.spin:e.spin=20,1===t.options.unbreaking?(e.unbreaking=!0,delete e.breaking):0===t.options.unbreaking&&delete e.unbreaking,1===t.options.breaking?(e.breaking=!0,delete e.unbreaking):0===t.options.breaking&&delete e.breaking,t.options.items)){e.damagingItems={};for(var s=0;s<t.options.items.length;s++)e.damagingItems[t.options.items[s]]=!0}e.initcustom&&setTimeout(function(){e.initcustom(t)})})}(se)),se.preinit&&se.preinit(oMap.decor[ae],se)}var de={};for(var ae in oMap.decor){var se=decorBehaviors[ae],re=getDecorExtra(se),pe=re.custom,ce=pe?pe.type:ae,z=0;de[ce]?z=de[ce]:de[ce]=0;for(var ue=oMap.decor[ae],c=0,me;c<ue.length;c++)me=ue[c],me[2]=new Sprite(ae),se.init&&se.init(me,c,c+z),gameSettings.ld&&se.hidable?me[2][0].unshow():pe&&function(e,t){for(var i=0;i<oPlayers.length;i++)e[2][i].img.src="images/map_icons/empty.png";getCustomDecorData(pe,function(i){updateCustomDecorSprites(e,i,t.size_ratio)})}(me,se);de[ce]+=ue.length}}oMap.assets=[];for(var c=0,ye;c<assetKeys.length;c++)if(ye=assetKeys[c],oMap[ye]){function e(e){var t=this.canvas.getContext("2d");t.resetTransform?t.resetTransform():t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,this.canvas.width,this.canvas.height);var i=e[1][2],n=e[1][3],l=Math.hypot(i,n),o=e[2][2];t.translate(l/2,l/2),t.rotate(o),t.translate(-l/2,-l/2);try{t.drawImage(this.img,(l-i)/2,(l-n)/2,i,n)}catch(t){}var a=Math.cos(o),s=Math.sin(o),r=.5-e[2][0],p=.5-e[2][1];this.x=e[1][0]-l/2+r*i*a-p*n*s,this.y=e[1][1]-l/2+p*n*a+r*i*s}function t(t,i){var n=document.createElement("canvas");n.width=n.height=Math.hypot(i[1][2],i[1][3]);var l=new Image,o=i[0],a=getDecorCustomData(o),s={img:l,canvas:n,custom:a,redraw:e,x:i[1][0],y:i[1][1],w:i[1][2],h:i[1][3]};a?(s.src=a.type,l.src="images/map_icons/empty.png",getCustomDecorData(a,function(e){switch(l.src=e.hd,t){case"flippers":case"pointers":s.h=e.size.hd.h;break;case"oils":s.w=e.size.hd.w,s.h=e.size.hd.h;break;default:return;}i[1][2]=s.w,i[1][3]=s.h,n.width=n.height=Math.hypot(i[1][2],i[1][3])})):(s.src="assets/"+o,l.src="images/map_icons/"+s.src+".png"),l.onload=function(){s.redraw(i)},i[0]=s,"flippers"===t?i[3]=[0,16+Math.floor(16*Math.random())]:void 0,oMap.assets.push(s)}for(var q=0;q<oMap[ye].length;q++)t(ye,oMap[ye][q])}if(1==strPlayer.length&&!gameSettings.nomap&&!clLocalVars.noMap){oPlanWidth=Math.round(19.4*iScreenScale),oPlanWidth2=oMap.w>=oMap.h?oPlanWidth:oPlanWidth*(oMap.w/oMap.h);var he=oMap.w<=oMap.h?oPlanWidth:oPlanWidth*(oMap.h/oMap.w);if(oMap.iW&&oMap.iH){var ge=Math.min(oMap.w/oMap.iW,oMap.h/oMap.iH);oPlanWidth2*=ge,he*=ge}if(oPlanWidth2=Math.round(oPlanWidth2),he=Math.round(he),oPlanSize=59*iScreenScale,oPlanSize2=oPlanWidth2,oPlanRealSize=oMap.w,oCharRatio=.8,oPlanRatio=.5,oPlanDiv=document.createElement("div"),oPlanDiv.className="mkplan mkplanzoom",oPlanDiv.style.backgroundColor="rgb("+oMap.bgcolor+")",oPlanDiv.style.left=15+80*iScreenScale+"px",oPlanDiv.style.top="9px",oPlanDiv.style.width=oPlanWidth+"px",oPlanDiv.style.height=oPlanWidth+"px",oPlanDiv.style.opacity=.01,oPlanDiv2=document.createElement("div"),oPlanDiv2.className="mkplan mkplanfull",oPlanDiv2.style.backgroundColor="rgb("+oMap.bgcolor+")",oPlanDiv2.style.width=oPlanWidth+"px",oPlanDiv2.style.height=oPlanWidth+"px",oPlanDiv2.style.opacity=.01,oPlanCtn=document.createElement("div"),oPlanCtn.style.position="absolute",oPlanCtn.style.transformOrigin=oPlanCtn.style.WebkitTransformOrigin=oPlanCtn.style.MozTransformOrigin="left",oPlanCtn2=document.createElement("div"),oPlanCtn2.style.position="absolute",oPlanCtn2.style.left=Math.round((oPlanWidth-oPlanWidth2)/2)+"px",oPlanCtn2.style.top=Math.round((oPlanWidth-he)/2)+"px",oPlanCtn2.style.width=oPlanWidth2+"px",oPlanCtn2.style.height=he+"px",oMapImg.src)oPlanImg=document.createElement("img"),oPlanImg.src=oMapImg.src,oPlanImg.style.width=oPlanSize+"px";else{var be=Math.round(oPlanSize*oMap.h/oMap.w);oPlanImg=document.createElement("canvas"),oPlanImg.width=oPlanSize,oPlanImg.height=be,oPlanImg.getContext("2d").drawImage(oMapImg,0,0,oPlanSize,be)}if(oPlanImg.className="mkplanimg",oPlanCtn.appendChild(oPlanImg),oMapImg.src?(oPlanImg2=document.createElement("img"),oPlanImg2.src=oMapImg.src):(oPlanImg2=document.createElement("canvas"),oPlanImg2.width=oPlanSize,oPlanImg2.height=be,oPlanImg2.getContext("2d").drawImage(oMapImg,0,0,oPlanSize,be)),oPlanImg2.className="mkplanimg",oPlanImg2.style.width=oPlanWidth2+"px",oPlanCtn2.appendChild(oPlanImg2),bSelectedMirror&&(oPlanImg.className=oPlanImg2.className="mkplanimg mirrored"),oMap.decor)for(var ae in oMap.decor)oPlanDecor[ae]=[],oPlanDecor2[ae]=[];oMap.sea&&(oPlanSea=document.createElement("canvas"),oPlanSea.style.position="absolute",oPlanSea.style.left="0px",oPlanSea.style.top="0px",oPlanSea.setAttribute("width",oPlanSize+"px"),oPlanSea.setAttribute("height",oPlanSize+"px"),oPlanCtn.appendChild(oPlanSea),oPlanSea2=document.createElement("canvas"),oPlanSea2.style.position="absolute",oPlanSea2.style.left="0px",oPlanSea2.style.top="0px",oPlanSea2.setAttribute("width",oPlanWidth2+"px"),oPlanSea2.setAttribute("height",oPlanWidth2+"px"),oPlanCtn2.appendChild(oPlanSea2),bSelectedMirror&&(oPlanSea.className=oPlanSea2.className="mirrored"));for(var c=0,ye;c<assetKeys.length;c++)ye=assetKeys[c],oMap[ye]&&(oPlanAssets[ye]=[],oPlanAssets2[ye]=[]);if(oPlanImg.onload=function(){oMapImg.seekFrame&&oMapImg.seekFrame(2)},oCharWidth=2*iScreenScale,oTeamWidth=Math.round(2.4*iScreenScale),oBBWidth=2*iScreenScale,oStarWidth2=Math.round(1.5*iScreenScale),oObjWidth=Math.round(1.5*iScreenScale),oCoinWidth=Math.round(1.2*iScreenScale),oExpWidth=Math.round(4.2*iScreenScale),oExpBWidth=Math.round(5.6*iScreenScale),oCharWidth2=Math.round(oCharRatio*oCharWidth),oTeamWidth2=Math.round(oCharRatio*oTeamWidth),oBBWidth2=Math.round(oCharRatio*oBBWidth),oObjWidth2=Math.round(oPlanRatio*oObjWidth),oCoinWidth2=Math.round(oPlanRatio*oCoinWidth),oExpWidth2=Math.round(oPlanRatio*oExpWidth),oExpBWidth2=Math.round(oPlanRatio*oExpBWidth),iTeamPlay)for(var c=0,fe;c<aTeams.length;c++){fe=document.createElement("div"),fe.style.position="absolute",fe.style.zIndex=1,fe.style.width=oTeamWidth+"px",fe.style.height=oTeamWidth+"px",fe.style.borderRadius=Math.round(oTeamWidth/2)+"px",fe.style.opacity=.5,fe.style.backgroundColor=cTeamColors.primary[aTeams[c]],oPlanTeams.push(fe),oPlanCtn.appendChild(fe);var xe=document.createElement("div");xe.style.position="absolute",xe.style.zIndex=1,xe.style.width=oTeamWidth2+"px",xe.style.height=oTeamWidth2+"px",xe.style.borderRadius=Math.round(oTeamWidth2/2)+"px",xe.style.opacity=.5,xe.style.backgroundColor=cTeamColors.primary[aTeams[c]],oPlanTeams2.push(xe),oPlanCtn2.appendChild(xe)}for(var c=0,ve;c<aKarts.length;c++){ve=document.createElement("img"),ve.style.position="absolute",ve.style.zIndex=1,ve.style.width=oCharWidth+"px",ve.src=getMapIcSrc(aKarts[c].personnage),ve.className="pixelated",oPlanCharacters.push(ve);var Ce=document.createElement("img");Ce.style.position="absolute",Ce.style.zIndex=1,Ce.style.width=oCharWidth2+"px",Ce.src=getMapIcSrc(aKarts[c].personnage),Ce.className="pixelated",oPlanCharacters2.push(Ce)}if(timeTrialMode()&&1<oPlanCharacters.length){for(var c=0;c<oPlanCharacters.length;c++)c&&(oPlanCharacters[c].style.opacity=jTrajets&&iTrajet===jTrajets[c-1]?0:.5),oPlanCtn.appendChild(oPlanCharacters[c]);for(var c=0;c<oPlanCharacters2.length;c++)c&&(oPlanCharacters2[c].style.opacity=jTrajets&&iTrajet===jTrajets[c-1]?0:.5),oPlanCtn2.appendChild(oPlanCharacters2[c])}else{for(var c=oPlanCharacters.length-1;0<=c;c--)oPlanCtn.appendChild(oPlanCharacters[c]);for(var c=oPlanCharacters2.length-1;0<=c;c--)oPlanCtn2.appendChild(oPlanCharacters2[c])}for(var c=0;c<oMap.arme.length;c++){fSprite=oMap.arme[c];var ke=document.createElement("img");ke.src="images/map_icons/objet.png",ke.style.position="absolute",ke.style.display="none",ke.style.width=oObjWidth+"px",ke.className="pixelated",posImg(ke,fSprite[0],fSprite[1],Math.round(oPlayers[0].rotation),oObjWidth,oPlanSize),oPlanCtn.appendChild(ke),oPlanObjects.push(ke);var Ee=document.createElement("img");Ee.src="images/map_icons/objet.png",Ee.style.position="absolute",Ee.style.display="none",Ee.style.width=oObjWidth2+"px",Ee.className="pixelated",posImg(Ee,fSprite[0],fSprite[1],Math.round(oPlayers[0].rotation),oObjWidth2,oPlanSize2),oPlanCtn2.appendChild(Ee),oPlanObjects2.push(Ee)}oPlanDiv.appendChild(oPlanCtn),document.body.appendChild(oPlanDiv),oPlanDiv2.appendChild(oPlanCtn2),updatePlanFullScreen()}if(setTimeout(function(){oPlanDiv&&(oPlanDiv.style.opacity=""),oPlanDiv2&&(oPlanDiv2.style.opacity=""),render()},300),bMusic&&!onlineSpectatorState){var we=playSoundEffect("musics/events/"+("BB"==course?"startbb":"start")+".mp3");we.volume=vMusic,we.pause(),setTimeout(function(){we.play()},300),we.blur()}bCounting=!0;for(var Se=[],c=0;c<strPlayer.length;c++)Se[c]=[document.createElement("div"),new Image],Se[c][0].id="oCounts"+c,Se[c][0].style.position="absolute",Se[c][0].style.width=12*iScreenScale+"px",Se[c][0].style.height=12*iScreenScale+"px",Se[c][0].style.overflow="hidden",Se[c][0].style.top=4*iScreenScale+"px",Se[c][0].style.left=8*iScreenScale+"px",Se[c][0].style.zIndex=1e4,Se[c][1].src="images/lakitu_depart.png",Se[c][1].style.position="absolute",Se[c][1].style.left="0px",Se[c][1].height=12*iScreenScale,Se[c][1].className="pixelated",Se[c][0].appendChild(Se[c][1]),oContainers[c].appendChild(Se[c][0]),Se[c].scrollLeft=0,onlineSpectatorState&&(Se[c][0].style.display="none");var Te=0,Ie,ze,Be,Me;if((bMusic||iSfx)&&!onlineSpectatorState){var Le={vSnd:bMusic?vMusic:vSfx};if(Be=loadMusic("musics/events/countdown.mp3",!1,Le),Be.removeAttribute("loop"),document.body.appendChild(Be),Me=loadMusic("musics/events/go.mp3",!1,Le),Me.removeAttribute("loop"),document.body.appendChild(Me),Me.blur(),!isMobile()&&!isChatting()){var je=document.createElement("input");document.body.appendChild(je),je.focus(),je.blur(),document.body.removeChild(je)}}var He;if("CM"!=course&&1<iRaceCount&&isLocalScore()){He=[];for(var c=0,Ae;c<strPlayer.length;c++){Ae=document.createElement("div"),Ae.style.position="absolute",Ae.style.right=Math.round(.6*iScreenScale+1)+"px",Ae.style.top=Math.round(.4*iScreenScale-3)+"px",Ae.style.color="white",Ae.style.fontFamily="\"MuseoModerno\", Arial",Ae.style.fontSize=Math.round(2.4*iScreenScale)+"px";var _e=Math.round(iScreenScale/8)+"px",Pe=Math.round(iScreenScale/4)+"px";Ae.style.textShadow="-"+Pe+" 0 black, 0 "+Pe+" black, "+Pe+" 0 black, 0 -"+Pe+" black, -"+_e+" -"+_e+" black, -"+_e+" "+_e+" black, "+_e+" -"+_e+" black, "+_e+" "+_e+" black";var Ne="BB"==course?toLanguage("Battle","Bataille"):toLanguage("Race","Course");Ae.innerHTML=Ne+" "+iRaceCount,hudScreens[c].appendChild(Ae),He.push(Ae)}}var Re=fInfos&&fInfos.replay,De=function(){if(Te){for(var t=0;t<strPlayer.length;t++)Se[t][0].scrollLeft=12*Te*iScreenScale;if(3>Te){for(var t=0;t<strPlayer.length;t++)document.getElementById("decompte"+t).innerHTML--,oPlayers[t].speed+=oPlayers[t].speedinc;(bMusic||iSfx)&&(Be.currentTime=0,Be.play())}else{clearTimeout(Fe);var n={};0<oPlayers[0].speedinc&&(n.up=!0);for(var t=0;t<strPlayer.length;t++)He&&hudScreens[t].removeChild(He[t]),document.getElementById("infos"+t).innerHTML="<tr><td>"+toLanguage("GO!","PARTEZ !")+"</td></tr>",document.getElementById("infos"+t).style.fontSize=12*iScreenScale+"px",document.getElementById("infos"+t).style.top=Math.round(12.5*iScreenScale)+"px",1==oPlayers[t].speed?oPlayers[t].speed=11:1<oPlayers[t].speed&&(oPlayers[t].spin(42),oPlayers[t].speed=0);oChallengeCpts.style.visibility="visible";for(var t=0;t<$speedometers.length;t++)$speedometers[t].style.visibility="visible";if("BB"==course)for(var t=0,l;t<aKarts.length;t++)l=aKarts[t],l.cpu&&inflateNewBalloons(l);if((bMusic||iSfx)&&(onlineSpectatorId&&(iSfx=!1),Me&&(Me.play(),Me.onended=function(){document.body.removeChild(Be),document.body.removeChild(Me)})),forcePrepareEnding=!0,setTimeout(function(){for(var e=(kartIsPlayer(oPlayers[0])&&!oPlayers[0].loose||onlineSpectatorId)&&!finishing||Re,t=0;t<strPlayer.length;t++)oContainers[t].removeChild(Se[t][0]),(e||t)&&(document.getElementById("infos"+t).style.display="none");var n=document.getElementById("infos0");n&&(n.style.fontFamily="",n.style.textStroke=n.style.WebkitTextStroke=n.style.MozTextStroke="",n.style.width="",n.style.top=7*iScreenScale+10+"px",n.style.left=Math.round(25*iScreenScale+10+(strPlayer.length-1)/2*(80*iScreenScale+2))+"px",n.style.fontSize=4*iScreenScale+"px",n.style.pointerEvents="");var l=document.getElementById("virtualbtn-pause");if(l&&(l.style.display="block"),e){var o="CM"!=course||isSingle,a=o?3*iScreenScale:Math.round(2.5*iScreenScale);n.innerHTML="<tr><td><input type=\"button\" style=\"font-size: "+a+"pt; width: 100%;\" value=\" &nbsp; "+toLanguage("  RESUME  ","REPRENDRE")+" &nbsp; \" id=\"reprendre\" /></td></tr><tr><td style=\"font-size:"+2*iScreenScale+"px\">&nbsp;</td></tr><tr><td><input type=\"button\" style=\"font-size: "+a+"pt; width: 100%;\" value=\" &nbsp; "+toLanguage("  RETRY  ","R\xC9ESSAYER")+" &nbsp; \" id=\"recommencer\" /></td></tr>"+(o?"":"<tr><td style=\"font-size:"+2*iScreenScale+"px\">&nbsp;</td></tr><tr><td><input type=\"button\" style=\"font-size: "+a+"pt; width: 100%;\" value=\""+toLanguage("  CHANGE RACE  ","CHANGER CIRCUIT")+"\" id=\"changecircuit\" /></td></tr>")+"<tr><td style=\"font-size:"+2*iScreenScale+"px\">&nbsp;</td></tr><tr><td><input type=\"button\" id=\"quitter\" value=\" &nbsp; "+toLanguage("QUIT","QUITTER")+" &nbsp; \" style=\"font-size: "+a+"pt; width: 100%;\" /></td></tr>",n.onkeydown=function(t){var e;switch(t.keyCode){case 38:e=-1;break;case 40:e=1;break;case 13:var l=document.activeElement;l&&l.onclick&&n.contains(l)&&iSfx&&setTimeout(function(){document.onkeydown||playSoundEffect("musics/events/select.mp3")});}if(e){var l=document.activeElement;if(l){var o=Array.prototype.slice.call(document.querySelectorAll("#infos0 input, #infos0 button")),a=l,s=o.indexOf(l);if(-1!=s){var r=s;do{r+=e,0>r&&(r+=o.length),r>=o.length&&(r=0);var a=o[r];if(a&&"none"!=a.style.display&&"hidden"!=a.style.visibility){a.focus(),iSfx&&playSoundEffect("musics/events/move.mp3");break}}while(r!=s)}}}},document.getElementById("reprendre").onclick=reprendre,document.getElementById("recommencer").onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<oContainers.length;e++)$mkScreen.removeChild(oContainers[e]);fInfos={player:strPlayer,distribution:itemDistribution,ptsdistrib:ptsDistribution,cc:fSelectedClass,mirror:bSelectedMirror,double_items:oDoubleItemsEnabled,map:oMap.ref,difficulty:iDificulty,cl:clSelected},"CM"==course&&(fInfos.perso=gPersos,fInfos.cpu_route=jTrajets,fInfos.my_record=gRecord,fInfos.ow_record=gOverwriteRecord,fInfos.lap_times=iLapTimes),document.getElementById("infos0").style.display="none",1==strPlayer.length&&removePlan(),oBgLayers.length=0,resetScores()&&("GP"==course?fInfos.map-=(oMap.ref+3)%4:"CM"!=course&&delete fInfos.map),resetEvents(),resetApp()},o||(document.getElementById("changecircuit").onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources(),$mkScreen.removeChild(oContainers[0]),fInfos={player:strPlayer,distribution:itemDistribution,ptsdistrib:ptsDistribution,cc:fSelectedClass,mirror:bSelectedMirror,double_items:oDoubleItemsEnabled,perso:[],cl:clSelected},document.getElementById("infos0").style.display="none",1==strPlayer.length&&removePlan(),oBgLayers.length=0,resetEvents(),resetApp()}),document.getElementById("quitter").onclick=quitter,bMusic&&!oMusicEmbed&&(unpauseMusic(mapMusic),forceStartMusic=!0),onlineSpectatorId&&(n.innerHTML="<tbody style=\"text-align: left; color: white; font-weight: normal; text-shadow: black -1px -1px, black -1px 1px, black 1px -1px, black 1px 1px\"><tr><td style=\"font-weight: bold; text-decoration: underline; font-size: 1.1em; text-shadow: #030 -1px -1px, #030 -1px 1px, #030 1px -1px, #030 1px 1px\">"+toLanguage("Spectator mode","Mode spectateur")+"</td></tr><tr><td>"+toLanguage("Switch player:","Changer de joueur :")+" <strong style=\"font-size: 1.4em; line-height: 1.1em\">&larr; &rarr;</strong></td></tr><tr><td>"+toLanguage("Exit: Escape","Quitter : Echap")+"</td></tr></tbody>",n.style.left=10+iScreenScale+"px",n.style.top=10+iScreenScale+"px",n.style.fontSize=Math.round(1.75*iScreenScale)+"px",n.style.display="",n.style.visibility="",document.body.style.cursor="default")}bCounting=!1},onlineSpectatorState?1:1e3),!pause||!fInfos.replay){function t(e){switch(e){case"up":n[e]=!0,oPlayers[0].accelerate();break;case"left":n[e]=!0,oPlayers[0].turn(1);break;case"right":n[e]=!0,oPlayers[0].turn(-1);break;case"down":n[e]=!0,isRdDisabled()&&oPlayers[0].driftinc?oPlayers[0].speedinc=0:(oPlayers[0].speedinc=-.2,oPlayers[0].driftinc&&(clLocalVars.revDrifted=!0));break;case"jump":if(pause)break;if(!isJumpEnabled())break;oPlayers[0].ctrl=!0,oPlayers[0].z||oPlayers[0].heightinc?!oPlayers[0].jumped&&!oPlayers[0].fell&&!oPlayers[0].ctrled&&!oPlayers[0].billball&&!oPlayers[0].tourne&&!oPlayers[0].figuring&&!oPlayers[0].figstate&&!oPlayers[0].driftinc&&stuntKart(oPlayers[0]):!oPlayers[0].driftinc&&!oPlayers[0].tourne&&(oPlayers[0].z=1,oPlayers[0].heightinc=.5,oPlayers[0].jumped=!0,oPlayers[0].rotincdir&&(oPlayers[0].driftinc=0<oPlayers[0].rotincdir?1:-1),oPlayers[0].driftinc&&(clLocalVars.drifted=!0));break;case"pause":if(isOnline)break;if(!!pause)reprendre(!0);else if(!bCounting){document.getElementById("infos0").style.display="",interruptGame(),pauseSounds();var t=document.getElementById("recommencer");if(t&&("CM"==course||clSelected))t.focus();else{var i=document.getElementById("reprendre");i&&i.focus()}}break;case"balloon":if(pause)return;"BB"==course&&5>oPlayers[0].tourne&&oPlayers[0].reserve&&oPlayers[0].ballons.length&&3>oPlayers[0].ballons.length&&!oPlayers[0].sprite[0].div.style.opacity&&(oPlayers[0].ballons[oPlayers[0].ballons.length]=createBalloonSprite(oPlayers[0]),oPlayers[0].reserve--,updateBalloonHud(document.getElementById("compteur0"),oPlayers[0]),clLocalVars.inflatedBalloons++,updateChallengeHud("inflated",clLocalVars.inflatedBalloons),playIfShould(oPlayers[0],"musics/events/balloon.mp3"));break;case"quit":bCounting||quitter();break;case"cheat":isOnline||"GP"==course||"CM"==course||openCheats();break;case"up_p2":if(!oPlayers[1])return;oPlayers[1].accelerate();break;case"left_p2":if(!oPlayers[1])return;oPlayers[1].turn(1);break;case"right_p2":if(!oPlayers[1])return;oPlayers[1].turn(-1);break;case"down_p2":if(!oPlayers[1])return;oPlayers[1].speedinc=-.2;break;case"jump_p2":if(pause)break;return oPlayers[1]?(oPlayers[1].ctrl=!0,oPlayers[1].z||oPlayers[1].heightinc?!oPlayers[1].jumped&&!oPlayers[1].ctrled&&!oPlayers[1].fell&&!oPlayers[1].billball&&!oPlayers[1].tourne&&!oPlayers[1].figuring&&!oPlayers[1].figstate&&!oPlayers[1].driftinc&&stuntKart(oPlayers[1]):!oPlayers[1].driftinc&&!oPlayers[1].tourne&&(oPlayers[1].z=1,oPlayers[1].heightinc=.5,oPlayers[1].jumped=!0,oPlayers[1].rotincdir&&(oPlayers[1].driftinc=0<oPlayers[1].rotincdir?1:-1)),!1):void 0;case"balloon_p2":if(pause)return;if(!oPlayers[1])return;"BB"==course&&5>oPlayers[0].tourne&&oPlayers[1].reserve&&oPlayers[1].ballons.length&&3>oPlayers[1].ballons.length&&!oPlayers[1].sprite[0].div.style.opacity&&(oPlayers[1].ballons[oPlayers[1].ballons.length]=createBalloonSprite(oPlayers[1]),oPlayers[1].reserve--,updateBalloonHud(document.getElementById("compteur1"),oPlayers[1]));}}function i(e){switch(e){case"item":case"item_back":case"item_fwd":oPlayers[0].tourne||oPlayers[0].cannon||pause||arme(0,"item_back"===e,"item_fwd"===e);break;case"up":n.up=!1,oPlayers[0].speedinc=0,l("down");break;case"left":n.left=!1,oPlayers[0].rotincdir=0,l("right");break;case"right":n.right=!1,oPlayers[0].rotincdir=0,l("left");break;case"down":n.down=!1,oPlayers[0].speedinc=0,l("up");break;case"jump":if(pause)break;if(delete oPlayers[0].ctrl,oPlayers[0].driftinc){if(oPlayers[0].driftinc=0,80<=oPlayers[0].driftcpt){oPlayers[0].turbodrift=15,clLocalVars.miniTurbo++;var t;clSelected&&clRuleVars[clSelected.id]&&(t=clRuleVars[clSelected.id].mini_turbo)&&updateChallengeHud("miniTurbo",clLocalVars.miniTurbo+t.miniTurbo),160<=oPlayers[0].driftcpt&&(oPlayers[0].turbodrift+=15,clLocalVars.superTurbo++,clSelected&&clRuleVars[clSelected.id]&&(t=clRuleVars[clSelected.id].super_turbo)&&updateChallengeHud("superTurbo",clLocalVars.superTurbo+t.superTurbo)),oPlayers[0].turbodrift0=oPlayers[0].turbodrift,resetDriftSprite(oPlayers[0])}oPlayers[0].driftcpt=0,oPlayers[0].driftSound&&(oPlayers[0].driftSound.pause(),oPlayers[0].driftSound=void 0)}oPlayers[0].ctrled=!1,oPlayers[0].jumped&&(oPlayers[0].z||oPlayers[0].heightinc)&&(oPlayers[0].ctrled=!0);break;case"rear":clLocalVars.rearView||showRearView(0);break;case"item_p2":case"item_back_p2":case"item_fwd_p2":oPlayers[1].tourne||oPlayers[1].cannon||pause||arme(1,"item_back_p2"===e,"item_fwd_p2"===e);break;case"up_p2":if(!oPlayers[1])return;oPlayers[1].speedinc=0;break;case"left_p2":if(!oPlayers[1])return;oPlayers[1].rotincdir=0;break;case"right_p2":if(!oPlayers[1])return;oPlayers[1].rotincdir=0;break;case"down_p2":if(!oPlayers[1])return;oPlayers[1].speedinc=0;break;case"jump_p2":if(pause)break;if(!oPlayers[1])return;delete oPlayers[1].ctrl,oPlayers[1].driftinc&&(oPlayers[1].driftinc=0,80<=oPlayers[1].driftcpt&&(oPlayers[1].turbodrift=15,160<=oPlayers[1].driftcpt&&(oPlayers[1].turbodrift+=15),oPlayers[1].turbodrift0=oPlayers[1].turbodrift,resetDriftSprite(oPlayers[1])),oPlayers[1].driftcpt=0,oPlayers[1].driftSound&&(oPlayers[1].driftSound.pause(),oPlayers[1].driftSound=void 0)),oPlayers[1].ctrled=!1,oPlayers[1].jumped&&(oPlayers[1].z||oPlayers[1].heightinc)&&(oPlayers[1].ctrled=!0);break;case"rear_p2":if(!oPlayers[1])return;showRearView(1);}}function l(e){n[e]&&t(e)}if(document.onkeydown=function(i){if(forceStartMusic)try{mapMusic.yt&&mapMusic.yt.playVideo(),forceStartMusic=!1}catch(e){}else if(forcePrepareEnding)try{endingMusic.yt&&(endingMusic.yt.setVolume(0),endingMusic.yt.playVideo(),setTimeout(function(){endingMusic.yt.seekTo(0,!0),endingMusic.yt.setVolume(100*vMusic),endingMusic.yt.pauseVideo()},1e3)),forcePrepareEnding=!1}catch(e){}if(!clLocalVars.fastForward){if(onlineSpectatorId)return handleSpectatorInput(i);var e=getGameAction(i);if(e){var n=document.activeElement;n&&"INPUT"==n.tagName&&"button"!=n.type&&"submit"!=n.type&&i.keyCode||(i.preventDefault&&i.preventDefault(),t(e,i.keyIntensity))}}},document.onkeyup=function(t){if(!onlineSpectatorId){var e=getGameAction(t);if(e){var n=document.activeElement;n&&"INPUT"==n.tagName&&"button"!=n.type&&"submit"!=n.type&&t.keyCode||i(e)}}},window.releaseOnBlur=function(){if(!onlineSpectatorId){n={};for(var e=0;e<oPlayers.length;e++)ctrlSettings.autoacc||(oPlayers[e].speedinc=0),oPlayers[e].rotincdir=0,stopDrifting(e)}},window.addEventListener("blur",window.releaseOnBlur),isMobile()&&ctrlSettings.autoacc){var o=document.getElementById("virtualbtn-accelerate");if(!(o&&o.dataset))doPressKey("up");else if(o.ontouchend=void 0,!o.dataset.pressed){var a=new Event("touchstart");o.dispatchEvent(a)}}if(window.onbeforeunload||(window.onbeforeunload=logGameTime),pause=!1,"CM"==course&&(iTrajet=[]),clearInterval(Ie),clearInterval(ze),clLocalVars.delayedStart){function t(){pause&&(timer<s?(setTimeout(t,1),runOneFrame()):(delete clLocalVars.fastForward,oPlayers[0].speedinc=e,nbFrames=iFps,reprendre=r,reprendre(!1)))}oPlayers[0].speed=0;var e=oPlayers[0].speedinc;oPlayers[0].speedinc=0;var s=1e3*clLocalVars.delayedStart/67;nbFrames=1,pause=!0,clLocalVars.fastForward=!0;var r=reprendre;reprendre=function(){},t()}else cycle();bRunning=!0}else{function e(){if(!pause){for(var t=0;t<J.length;t++){var n=aKarts[t],l=J[t][timer];if(l){var o=n.x,a=n.y;n.moveGhost(l),updateSpeedometer(t,o,a)}else{null==n.aipoint&&(n.aipoint=0,n.lastAItime=0,n.arme=!1,n.maxspeed=5.7,!t&&(n.tourne=0,n.stopDrifting(),n.stopStunt())),void 0===n.demitours&&(n.tours=oMap.tours+1,n.demitours=0),ai(n);var s=iSfx;iSfx=!1,move(t),iSfx=s}}timer++,showTimer(67*timer),oPlayers[0].cpu=!1,moveDecor(),oPlayers[0].cpu=!0,setTimeout(timer==iTrajet.length?function(){var e=aKarts[0];e.tours=oMap.tours+1,e.demitours=0,e.aipoint=0,e.changeView=180,e.maxspeed=5.7,e.speed=5.7,e.tourne=0,e.stopDrifting(),e.stopStunt(),$speedometers[0]&&($speedometers[0].style.display="none"),document.onkeyup=void 0,document.getElementById("infos0").style.display="";var t=document.getElementById("infos0").getElementsByTagName("input")[0];t&&t.focus(),timerMS=iRecord,showTimer(timerMS),(bMusic||iSfx)&&startEndMusic(),cycle()}:e,67),render()}}for(pause=!1,t=0;t<aKarts.length;t++)aKarts[t].cpu=!0,aKarts[t].tours=1,aKarts[t].demitours=0;for(t=0;t<gPersos.length;t++)J.push(jTrajets[t]);clearInterval(Ie),clearInterval(ze),e(),pause=!1,setTimeout(function(){continuer(),document.querySelector("#enregistrer input").style.display="none"},1e3),document.onkeyup=function(t){var e=getGameAction(t);if("pause"==e&&!bCounting){document.getElementById("infos0").style.display="none"==document.getElementById("infos0").style.display?"":"none";var i=document.getElementById("infos0").getElementsByTagName("input")[0];i&&i.focus()}else"quit"==e&&quitter()}}return void(fInfos=void 0)}}else{for(var t=0;t<strPlayer.length;t++)document.getElementById("infos"+t).style.visibility="";(bMusic||iSfx)&&Be.play(),document.body.style.cursor="default",Fe=setInterval(De,1e3)}Te++},Fe;if(!iSfx||fInfos.replay||onlineSpectatorId||setTimeout(startEngineSound,bMusic?2600:1100),isOnline){var Ve=tnCourse-new Date().getTime();if(onlineSpectatorState){Te=3,Ve+=4e3;for(var c=0;c<aKarts.length;c++)aKarts[c].speedinc=0;0>Ve&&(Ve=0)}else iTeamPlay&&!onlineSpectatorId&&p(Ve);setTimeout(De,Ve)}else setTimeout(De,bMusic?3e3:1500);if(isMobile())if(onlineSpectatorId)showSpectatorKeyboard();else{switch(ctrlSettings.mode){case"gestures":setupGestureEvents();break;case"external":break;default:showVirtualKeyboard();}setupCommonMobileControls()}gameControls.gamepad&&(ze=setInterval(handleGamepadEvents,67)),oMapImg.image&&(Ie=setTimeout(function(){Ie=setInterval(function(){for(var e=0,t;e<oPlayers.length;e++)t=oPlayers[e],redrawCanvas(e,t)},100)},100)),(clLocalVars.backwardsStart||clLocalVars.rearView)&&showRearView(0),isOnline||(document.body.style.cursor="default")}function showVirtualKeyboard(){function e(e){function t(){addButton("I",{key:"item",src:"item"})}function i(){var e=document.createElement("div");e.className="btn-ctn",addButton("\u2191",{key:"item_fwd",src:"item_fwd",parent:e}),addButton("\u2193",{key:"item_back",src:"item_back",parent:e}),n.appendChild(e)}function l(){var e=document.createElement("div");e.className="btn-ctn";var t=document.createElement("button");t.id="virtualbtn-accelerate";var i=document.createElement("button");ctrlSettings.autoacc?(addButton("\u2191",{btn:t,key:"up",src:"up",parent:e,touchstart:o(i),touchend:void 0}),addButton("\u2193",{btn:i,key:"down",src:"down",parent:e,touchstart:o(t),touchend:void 0})):(addButton("\u2191",{btn:t,key:"up",src:"up",parent:e}),addButton("\u2193",{btn:i,key:"down",src:"down",parent:e})),n.appendChild(e)}function o(e){return function(){this.dataset.pressed?onButtonPress.bind(this)():(e.dataset.pressed&&onButtonPress.bind(e)(),onButtonTouch.bind(this)())}}e?(l(),i(),t()):(t(),i(),l())}function t(e){function t(){addButton("J",{key:"jump",src:"jump"})}function i(){var e=addButton("\u2190",{key:"left",src:"left"});e.id="virtualbtn-left"}function n(){var e=addButton("\u2192",{key:"right",src:"right"});e.id="virtualbtn-right"}e?(i(),n(),t()):(t(),i(),n())}function i(){var e=addButtonLegacy(" <span style=\"position:absolute;left:8px;top:-5px\">\u2191</span><span style=\"position:absolute;right:6px;bottom:8px;font-size:10px;text-align:right\">"+(language?"+ Jump<br/>Drift":"+ Saut<br/>D\xE9rapage")+"</span>",["up","jump"],0,0);ctrlSettings.autoacc&&(e.style.display="none");var t=addButtonLegacy(" \u2191 ","up",1,0);t.id="virtualbtn-accelerate",addButtonLegacy("Obj","item",2,0,null,null,25),addButtonLegacy("\u275A\u275A","pause",3,0,null,null,25),document.getElementById("virtualkeyboard").appendChild(document.createElement("br")),document.getElementById("virtualkeyboard").appendChild(document.createElement("br")),addButtonLegacy(language?"Jump<br/>Drift":"Saut<br/>D\xE9rapage","jump",0,1,null,null,11),addButtonLegacy(" \u2193 ","down",1,1);var i=addButtonLegacy(" \u2190 ","left",2,1);i.id="virtualbtn-left";var n=addButtonLegacy(" \u2192 ","right",3,1);n.id="virtualbtn-right"}setupVibrate();var n=document.getElementById("virtualkeyboard");switch(navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate||function(){},ctrlSettings.layout){case"old":i();break;case"h_sym":e(!0),t(!0);break;case"v_sym":t(),e();break;case"vh_sym":t(!0),e(!0);break;default:e(),t();}if(n.ontouchstart=function(t){return t.preventDefault(),!1},n.className="shown","old"===ctrlSettings.layout){n.classList.add("legacy");var l=288;return n.style.width=Math.round(l)+"px",n.style.height=Math.round(130)+"px",n.style.left=(80*iScreenScale-l)/2+"px",void(n.style.top=40*iScreenScale+"px")}posVirtualKeyboard(n)}function posVirtualKeyboard(e){var t=39*iScreenScale+20;e.style.top=t+"px";var i=e.offsetWidth,n=window.innerHeight-t;n=Math.min(n,Math.round(.45*i));var l=Math.min(window.innerWidth,80*iScreenScale);i<l&&(e.style.left=Math.round((l-i)/2)+"px"),e.style.height=n+"px"}function hideVirtualKeyboard(){var e=document.getElementById("virtualkeyboard");e.innerHTML="",e.className="",e.setAttribute("style","")}function setupGestureEvents(){for(var e=0,t;e<oContainers.length;e++){function i(t){function e(){var e=rotateToAngle(n,r);1<=Math.abs(e.targetDir)&&(a=!0)}t.preventDefault();var i=c(t.touches),l=i.x-p.x,o=i.y-p.y;if(o>Math.max(.2,3*Math.abs(l)))return releaseKey("up"),pressKey("down"),void(0<document.body.scrollTop?document.body.scrollTop-=10:0<document.documentElement.scrollTop&&(document.documentElement.scrollTop-=10));if(!ctrlSettings.gyroscope){var r=120*(-Math.sign(l)*Math.pow(Math.abs(l),1.4));e(),s=setInterval(e,67)}}function c(e){var i=80*iScreenScale;if($mkScreen.dataset.fs){var n=t.getBoundingClientRect();i=window.innerWidth-2*n.x}var l=e[0].pageX,o=e[0].clientY,a=l/i,s=o/i;return{x:a,y:s,t:new Date().getTime()}}t=document.createElement("div"),t.style.position="fixed",t.style.left="0px",t.style.top="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex=2e4;var n=oPlayers[e],l={t:0},o=ctrlSettings.autoacc?200:500,a=!1,s,r,p;t.ontouchstart=function(t){var e=p;if(p=c(t.touches),pressKey("up"),new Date().getTime()-l.t<o){var i=.1,n=p.x-e.x;Math.abs(n)<.5&&(pressKey("jump"),n>=i?pressKey("right"):n<=-i&&pressKey("left"))}clearTimeout(r)},t.ontouchmove=function(t){clearInterval(s),i(t)},t.ontouchend=function(){for(var e in clearInterval(s),s=void 0,n.driftinc&&(a=!0),oPressedKeys)"up"!=e&&releaseKey(e);ctrlSettings.autoacc||(r=setTimeout(function(){releaseKey("up")},300)),a?a=!1:l={t:new Date().getTime()}};var d=document.createElement("div");d.style.position="absolute",d.style.left=0,d.style.top=0,d.style.width=12*iScreenScale+"px",d.style.height=9*iScreenScale+"px",d.ontouchstart=function(t){t.stopPropagation(),doReleaseKey("item"),a=!0},t.appendChild(d),hudScreens[e].appendChild(t),$virtualScreens.push(t)}}function setupCommonMobileControls(){if(ctrlSettings.vitem){var e=document.createElement("div");e.style.position="absolute",e.style.left="0px",e.style.top="0px",e.style.zIndex=2e4,e.style.width=80*iScreenScale+"px",e.style.height=39*iScreenScale+"px";var t;e.ontouchstart=function(i){i.preventDefault(),t={x:i.touches[0].clientX,y:i.touches[0].clientY}},e.ontouchend=function(i){var e={x:i.changedTouches[0].clientX,y:i.changedTouches[0].clientY},n=e.x-t.x,l=e.y-t.y;Math.abs(l)>Math.max(50,3*Math.abs(n))?0<l?doReleaseKey("item_back"):doReleaseKey("item_fwd"):doReleaseKey("item")},hudScreens[0].appendChild(e)}if(!isOnline){var i=document.createElement("button");i.innerHTML="\u275A\u275A",i.style.position="absolute",i.style.zIndex=2e4,i.style.right=22*iScreenScale+"px",i.style.top="5px",i.style.fontSize=Math.round(3*iScreenScale)+"px",i.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",i.ontouchstart=function(t){t.preventDefault(),doPressKey("pause")},i.id="virtualbtn-pause",i.style.display="none",hudScreens[0].appendChild(i)}if("BB"==course){var n=document.createElement("div");n.style.position="absolute",n.style.zIndex=2e4,n.style.left="0px",n.style.bottom="-2px",n.style.width=16*iScreenScale+"px",n.style.height=5*iScreenScale+4+"px",n.ontouchstart=function(t){t.preventDefault(),doPressKey("balloon")},hudScreens[0].appendChild(n)}if(ctrlSettings.gyroscope){var l=document.getElementById("virtualbtn-left"),o=document.getElementById("virtualbtn-right"),a=window.innerWidth>window.innerHeight;window.turnOnRotate=function(t){if(!(l&&l.dataset.pressed)&&!(o&&o.dataset.pressed)){var e,i,n;a?(e=t.beta,90<=Math.abs(e)&&(e=Math.sign(e)*(180-Math.abs(e))),i=15,n=1):(e=t.gamma,90<=t.beta&&(e=-e),i=15,n=2);var s=-Math.sign(e)*Math.pow(Math.abs(e/90),n)*i;rotateToAngle(oPlayers[0],s)}},window.addEventListener("deviceorientation",window.turnOnRotate)}}function setupVibrate(){navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate||function(){}}function showSpectatorKeyboard(){setupVibrate();var e=document.getElementById("virtualkeyboard");addButton("\u2190",{key:"left",src:"left"}),addButton("\u2192",{key:"right",src:"right"}),e.className="shown spectator",posVirtualKeyboard(e),e.style.height="40px"}function pressKey(e){oPressedKeys[e]||doPressKey(e)}function doPressKey(e){oPressedKeys[e]=1,document.onkeydown&&document.onkeydown({keyAction:e})}function releaseKey(e){oPressedKeys[e]&&doReleaseKey(e)}function doReleaseKey(e){oPressedKeys[e]=void 0,document.onkeyup&&document.onkeyup({keyAction:e})}function rotateToAngle(e,t){var i=getMirrorFactor();clLocalVars.invertDirs&&(i=-i);var n=(t-angleInc(e)*i)/2,l;return n>e.stats.handling/2?l="left":n<-e.stats.handling/2&&(l="right"),"left"!==l&&releaseKey("left"),"right"!==l&&releaseKey("right"),l&&pressKey(l),{targetDir:n,action:l}}function youtube_parser(e){var t=e.match(/.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/);return!!(t&&11==t[1].length)&&t[1]}function resetScreen(){function e(e,t){for(var n=0;n<e.length;n++)oBgLayers[n]=new BGLayer(e[n],t?1:n+1);for(var n=0;n<oPrevFrameStates.length;n++)for(var l=0;l<prevScreenDelay;l++)for(var o=0;o<oBgLayers.length;o++)oPrevFrameStates[n][l].layer.push(oBgLayers[o].clone(n,oPrevFrameStates[n][l].container))}fSpriteScale=iScreenScale/4,fLineScale=1/iScreenScale*iQuality,aStrips=[];for(var t=0,n;t<strPlayer.length;t++){n=oContainers[t],n.style.width=80*iScreenScale+"px",n.style.height=39*iScreenScale+"px";var l=document.createElement("canvas");l.style.position="absolute",oScreens.push(l),oContainers[t].appendChild(l),l.width=80/fLineScale,l.height=39/fLineScale,l.style.width=80*iScreenScale+iScreenScale+"px",l.style.left=-iScreenScale/2+"px",l.style.top=iScreenScale+"px",l.style.height=39*iScreenScale+"px"}for(var t=0;t<oBgLayers.length;t++)oBgLayers[t].suppr();var o=0;nbFrames=iFps,frameHandlers=Array(nbFrames);var a=getFrameSettings(gameSettings);interpolateFn=a.frameint,prevScreenDelay=a.framerad,o=a.frameblur,prevScreenOpacity=a.frameopacity,prevScreenFade=a.framefade,1>=nbFrames&&(prevScreenDelay=0),oPrevFrameStates=[];for(var t=0;t<oContainers.length;t++){oPrevFrameStates[t]=[];for(var s=0,r;s<prevScreenDelay;s++)r=oContainers[t].cloneNode(!0),r.className="",r.style.position="absolute",r.style.left="0px",r.style.top="0px",r.style.width="100%",r.style.height="100%",r.style.opacity=0,r.style.filter="blur("+o+"px)",oPrevFrameStates[t][s]={container:r,canvas:r.firstChild,layer:[],opacity:0}}for(var p=0,d=0;39>d;d+=fLineScale){var c=d+-10,u=c/((24-c)/32),m=fFocal/(fFocal+u),y=Math.floor(80/m);0<m&&y<iViewCanvasWidth&&(0==d&&(p=u-1),aStrips.push({viewy:d,mapz:u,scale:m,stripwidth:y,mapzspan:u-p}),p=u)}oMap.custombg?customBgData[oMap.custombg]?e(customBgData[oMap.custombg]):xhr("getBgData.php","id="+oMap.custombg,function(t){return!t||(t=JSON.parse(t),customBgData[oMap.custombg]=t.layers.map(function(e){return e.path}),e(customBgData[oMap.custombg]),!0)}):oMap.fond&&e(oMap.fond.map(function(e){return"images/map_bg/"+e+".png"}),2===oMap.fond.length);for(var t=0;t<oPrevFrameStates.length;t++)for(var s=0;s<prevScreenDelay;s++)oContainers[t].appendChild(oPrevFrameStates[t][s].container);oViewCanvas=document.createElement("canvas"),oViewCanvas.width=iViewCanvasWidth,oViewCanvas.height=iViewCanvasHeight}function getFrameSettings(e){var t=e.frameint;t||(3<iFps?t="ease_out_cubic":1<iFps&&(t="ease_out_quad"));var i=Math.floor(iFps/2),n=0<=e.framerad?+e.framerad:i;return{frameint:t,framerad:n,defaultframerad:i,frameblur:e.frameblur||"1",frameopacity:0<=e.frameopacity?+e.frameopacity:.39/(n+1),framefade:0<=e.framefade?+e.framefade:1}}function interruptGame(){pause=!0,clearInterval(cycleHandler),cycleHandler=null}function reprendre(e){pause&&(pause=!1,cycle()),e&&(unpauseSounds(),document.getElementById("infos0").style.display="none")}function quitter(){if(isOnline)return void(document.location.href=isCup?(isBattle?complete?"battle":"arena":complete?"map":"circuit")+".php?"+(isMCups?"mid="+nid:(isSingle?complete?"i":"id":"cid")+"="+nid):"index.php");interruptGame(),displayCommands(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++){$mkScreen.removeChild(oContainers[e]);var t=document.getElementById("infos"+e);t&&(t.style.display="none")}$mkScreen.style.opacity=1,1==strPlayer.length&&removePlan(),resetEvents(),oBgLayers.length=0,aPlayers=[],aScores=[],clRuleVars={},clGlobalVars=void 0,resetApp({onRestart:function(){pause=!1}})}function resetApp(e){e=e||{},setTimeout(function(){e.onRestart&&e.onRestart(),MarioKart()},e.time||500),window.onbeforeunload=void 0,logGameTime()}function logGameTime(){var e=getActualGameTimeMS();0<e&&xhr("incGameTime.php","time="+e,function(){return!0})}function classement(){for(var e=aKarts.length,t=0;t<e;t++){for(var n=aKarts[t],l=aScores[t],o=1,a=0,s;a<e;a++)s=aScores[a],n!=aKarts[a]&&l<=s&&(l<s||t>a)&&o++;n.place=o}for(var r=[],t=1;t<=e;t++)for(var a=0,o;a<e;a++)o=aKarts[a].place,o==t&&(r.push(a),a=e);document.getElementById("infos0").style.display="none";for(var p=strPlayer.length-1,t=0;t<r.length;t++){var d=r[t],c=aKarts[d].personnage;document.getElementById("fJ"+t).style.backgroundColor=rankingColor(d),document.getElementById("fJ"+t).style.opacity=c==strPlayer?.8:"",document.getElementById("j"+t).innerHTML=toPerso(c),document.getElementById("pts"+t).innerHTML=aScores[d]}var u;if(iTeamPlay){for(var m=Array(selectedNbTeams).fill(0),t=0;t<aScores.length;t++)m[aTeams[t]]+=aScores[t];u=createTeamTable(m)}document.getElementById("octn").onclick=continuer,setTimeout(function(){document.getElementById("infos0").style.display="",u&&(u.style.visibility="visible");var e=document.body.scrollTop;document.getElementById("octn").focus(),document.body.scrollTop=e},500)}function handleRankingStyle(){for(var e=0,t;t=document.getElementById("j"+e),!!t;e++)t.style.overflow="hidden",t.style.textOverflow="ellipsis",t.style.maxWidth=20*iScreenScale+"px",t.style.whiteSpace="nowrap",document.getElementById("j"+e)}function createTeamTable(e){for(var t=[],n=0;n<e.length;n++)t.push(n);t.sort(function(t,i){return e[i]-e[t]});var l=document.createElement("table");l.id="team-table";for(var o="<tr style=\"font-size: "+1.8*iScreenScale+"px; background-color: white; color: black;\"><td>Places</td><td>"+toLanguage("Team","\xC9quipe")+"</td><td>Pts</td></tr>",n=0;n<t.length;n++){var a=t[n],s=cTeamColors.name[a];o+="<tr id=\"fJ"+n+"\" style=\"background-color:"+cTeamColors.primary[a]+"; text-shadow: -1px 0 #603, 0 1px #603, 1px 0 #603, 0 -1px #603\"><td>"+toPlace(n+1)+" </td><td id=\"j"+n+"\" style=\"padding: 0 "+Math.round(iScreenScale/2)+"px; max-width: "+Math.round(12*iScreenScale)+"px; font-size: "+Math.round(Math.max(1,Math.min(14,4.75*iScreenScale/Math.sqrt(s.length))))+"pt; word-wrap: break-word\">"+s+"</td><td id=\"pts"+n+"\" style=\"padding: 0 "+Math.round(iScreenScale/2)+"px\">"+e[a]+"</td></tr>"}return l.style.visibility="hidden",l.style.position="absolute",l.style.zIndex=2e4,l.style.left=Math.round(.5*iScreenScale+10)+"px",l.style.top=10*iScreenScale+"px",l.style.backgroundColor="blue",l.style.color="#FEFF3F",l.style.opacity=.7,l.style.textAlign="center",l.style.fontSize=Math.round(1.5*iScreenScale+2)+"pt",l.style.fontFamily="Courier",l.style.fontWeight="bold",l.style.fontFamily="arial",l.innerHTML=o,$mkScreen.appendChild(l),l}function resetScores(){for(var e=0;e<strPlayer.length;e++)aPlaces[e]=aPlayers.length+e+1;for(var e=0;e<aPlayers.length;e++)aPlaces[e+strPlayer.length]=e+1;clRuleVars={},clGlobalVars=void 0;var t=!1;aScores.length=aPlaces.length;for(var e=0;e<aScores.length;e++)0!==aScores[e]&&(t=!0,aScores[e]=0);return aTracksHist=[],iRaceCount=0,t}function continuer(){document.getElementById("infos0").style.border=0,document.getElementById("infos0").style.top=10*iScreenScale+10+"px",document.getElementById("infos0").style.left=Math.round(20*iScreenScale+10+(strPlayer.length-1)/2*(80*iScreenScale+2))+"px",document.getElementById("infos0").style.background="transparent",document.getElementById("infos0").style.fontSize=4*iScreenScale+"px",document.getElementById("infos0").innerHTML="<tr><td id=\"continuer\"></td></tr><tr><td"+("CM"==course?" id=\"enregistrer\"></td></tr><tr><td id=\"revoir\"></td></tr><tr><td id=\"classement\"></td></tr><tr><td id=\"changercircuit\">":" style=\"font-size: "+3*iScreenScale+"px;\">&nbsp;</td></tr>")+"</td></tr><tr><td><input type=\"button\" id=\"quitter\" value=\""+toLanguage("QUIT","QUITTER")+"\" style=\"font-size: "+3*iScreenScale+"pt; width: 100%;\" /></td></tr>";var oTeamTable=document.getElementById("team-table");oTeamTable&&$mkScreen.removeChild(oTeamTable);var oContinue=document.createElement("input");if(oContinue.type="button",oContinue.style.fontSize=3*iScreenScale+"pt",oContinue.style.width="100%","CM"==course){var oQuit=document.getElementById("quitter");oContinue.style.fontSize=oQuit.style.fontSize=3*iScreenScale+"px";var oSave=oContinue.cloneNode(!1),oReplay=oContinue.cloneNode(!1),oChangeRace=oContinue.cloneNode(!1),oClassement=oContinue.cloneNode(!1);oContinue.value=gSelectedPerso?toLanguage("        FACE WITH        ","     AFFRONTER     "):toLanguage("          RETRY          ","     R\xC9ESSAYER     "),oContinue.onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources(),$mkScreen.removeChild(oContainers[0]),fInfos={player:strPlayer,distribution:itemDistribution,ptsdistrib:ptsDistribution,cc:fSelectedClass,mirror:bSelectedMirror,double_items:oDoubleItemsEnabled,map:oMap.ref,difficulty:iDificulty,perso:gPersos,cpu_route:jTrajets,my_record:gRecord,ow_record:gOverwriteRecord,lap_times:iLapTimes,cl:clSelected},gSelectedPerso?(fInfos.player=[gSelectedPerso],!jTrajets&&(fInfos.perso=[strPlayer[0]],fInfos.cpu_route=[iTrajet])):2==gOverwriteRecord&&lapTimers.length==oMap.tours&&(fInfos.cpu_route=[iTrajet],fInfos.perso=strPlayer,fInfos.lap_times=lapTimers),document.getElementById("infos0").style.display="none",1==strPlayer.length&&removePlan(),oBgLayers.length=0,resetEvents(),resetApp()},oSave.value="   "+toLanguage("SAVE","ENREGISTRER")+"   ",oSave.onclick=function(){document.getElementById("infos0").style.display="none";var oForm=document.createElement("form");oForm.style.color="black",oForm.style.position="absolute",oForm.style.left=5*iScreenScale+10+"px",oForm.style.top=5*iScreenScale+10+"px",oForm.style.fontSize=4*iScreenScale+"pt",oForm.style.backgroundColor="#FF6",oForm.style.opacity=.8,oForm.style.border="double 4px black",oForm.style.textAlign="center",oForm.style.width=70*iScreenScale-10+"px",oForm.style.zIndex=2e4;var savedRecord;oForm.onsubmit=function(){var nom=this.pseudo.value;if(nom){function postSaveRecord(reponse){if(reponse){function showBackUi(e){oInput.disabled=!0,oCheckbox.disabled=!0,oValide.parentNode.removeChild(oValide),aPara2.style.fontSize=Math.round(2.5*iScreenScale)+"px",e&&(aPara2.innerHTML=toLanguage("Congratulations "+nom+", your score has been saved successfully ! You placed ","F&eacute;licitations "+nom+", votre score a bien &eacute;t&eacute; enregistr&eacute; ! Vous &ecirc;tes ")+toPlace(enregistre[0])+toLanguage(" out of "+enregistre[1]+" in this race !"," sur "+enregistre[1]+" au classement de ce circuit !"),oSave.style.display="none"),aPara2.style.visibility="",oRetour.focus()}function rollbackUi(){oValide.style.visibility="",oValide.style.marginRight=2*iScreenScale+"px",aPara3.insertBefore(oValide,oRetour),oCheckbox.disabled=!1,oInput.disabled=!1,oInput.select()}document.body.style.cursor="default";var enregistre;try{enregistre=eval(reponse)}catch(t){return!1}if(!Array.isArray(enregistre)){switch(showBackUi(!1),enregistre){case 0:aPara2.innerHTML=toLanguage("You did a better score on this race before.<br />Your score has not been registered.","Vous avez fait un meilleur score sur ce circuit.<br />Votre temps n'a donc pas &eacute;t&eacute; enregistr&eacute;.");break;case 1:aPara2.innerHTML=toLanguage("This username is already used, please choose another one. If it's you, <a href=\"forum.php\" target=\"_blank\" style=\"color: orange\">log-in</a> to your account and try again.","Ce pseudo est d\xE9j\xE0 utilis\xE9, veuillez en choisir un autre. S'il s'agit de vous, <a href=\"forum.php\" target=\"_blank\" style=\"color: orange\">connectez-vous</a> et r\xE9essayez.");break;default:aPara2.innerHTML=toLanguage("An unknown error occured, please try again later","Une erreur inconnue est survenue, veuillez r\xE9essayer ult\xE9rieurement");}0!=enregistre&&rollbackUi()}else if(savedRecord=enregistre,oCheckbox.checked){oSave.style.display="none",oValide.style.display="none";var aSmall=document.createElement("span");aSmall.style.fontSize=Math.round(2.5*iScreenScale)+"px",aSmall.innerHTML=toLanguage("Saving ghost...","Enregistrement du fant\xF4me..."),aPara2.appendChild(aSmall),aPara2.style.visibility="";var oRequest="map="+getCreationId(oMap)+"&type="+getCreationTable()+"&perso="+strPlayer[0]+"&time="+getActualGameTimeMS()+"&times="+JSON.stringify(lapTimers)+"&cc="+getActualCc();for(i=0;i<iTrajet.length;i++)oRequest+="&p"+i+"="+iTrajet[i].toString().replace(/\,/g,"_");xhr("saveghost.php",oRequest,function(e){return 1==e?(gRecord=getActualGameTimeMS(),gOverwriteRecord&&(gOverwriteRecord=2),showBackUi(!0),!0):-1==e&&(showBackUi(!1),oValide.style.display="",aPara2.innerHTML=toLanguage("You have exceeded your saved ghosts quota. You can <a href=\"manageGhosts.php\" target=\"_blank\" style=\"color: orange\">delete ghosts</a> to save space","Vous avez d\xE9pass\xE9 votre quota de fant\xF4mes enregistr\xE9s. Vous pouvez <a href=\"manageGhosts.php\" target=\"_blank\" style=\"color: orange\">supprimer des fant\xF4mes</a> pour gagner de l'espace"),rollbackUi(),!0)})}else showBackUi(!0);return!0}return!1}document.body.style.cursor="progress",oValide.style.visibility="hidden",aPara2.style.visibility="hidden";var params="name="+nom+"&perso="+strPlayer[0]+"&time="+getActualGameTimeMS()+"&cc="+getActualCc();"MK"===page?params+="&circuit="+oMap.map:"CI"===page?params+="&creation="+oMap.id:"MA"===page?params+="&map="+oMap.map:void 0,savedRecord?postSaveRecord(savedRecord):xhr("records.php",params,postSaveRecord),recorder=nom}return!1};var aPara1=document.createElement("p");aPara1.innerHTML=toLanguage("Username: ","Pseudo : "),aPara1.style.margin=iScreenScale+"px";var oInput=document.createElement("input");oInput.type="text",oInput.name="pseudo",oInput.value=recorder,oInput.size=15,oInput.maxlength=18,oInput.style.fontSize=3*iScreenScale+"px",oInput.onkeydown=function(t){t.stopPropagation()},oInput.onkeyup=function(t){t.stopPropagation()},aPara1.appendChild(oInput);var aPara12=aPara1.cloneNode(!1),oCheckLabel=document.createElement("label");oCheckLabel.style.display="inline-block";var oCheckbox=document.createElement("input");oCheckbox.type="checkbox",oCheckbox.name="saveghost",oCheckbox.checked=!0,oCheckbox.style.transform=oCheckbox.style.WebkitTransform=oCheckbox.style.MozTransform="scale("+(iScreenScale/6).toFixed(1)+")",oCheckLabel.appendChild(oCheckbox);var oCheckSpan=document.createElement("span");oCheckSpan.style.fontSize=2*iScreenScale+"px",oCheckSpan.innerHTML=" "+toLanguage("Save ghost","Enregistrer le fant\xF4me"),oCheckLabel.appendChild(oCheckSpan),aPara12.appendChild(oCheckLabel),timerMS>=gRecord&&(oCheckbox.checked=!1,aPara12.style.display="none");var aPara2=aPara1.cloneNode(!1),oValide=document.createElement("input");oValide.type="submit",oValide.value="     "+toLanguage("Submit","Valider")+"     ",oValide.style.fontSize=5*iScreenScale+"px",oValide.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",oRetour.style.fontSize=4*iScreenScale+"px"},aPara2.appendChild(oValide);var aPara3=aPara1.cloneNode(!1),oRetour=document.createElement("input");oRetour.type="button",oRetour.value="     "+toLanguage("Back","Retour")+"     ",oRetour.style.fontSize=4*iScreenScale+"px",oRetour.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",oValide.style.fontSize=4*iScreenScale+"px"},oRetour.onclick=function(){$mkScreen.removeChild(oForm),document.getElementById("infos0").style.display="",oContinue.focus()},aPara3.appendChild(oRetour),oForm.appendChild(aPara1),oForm.appendChild(aPara12),oForm.appendChild(aPara2),oForm.appendChild(aPara3),$mkScreen.appendChild(oForm),oForm.style.height=oForm.scrollHeight+"px",oInput.select()},gSelectedPerso&&(oSave.style.display="none"),document.getElementById("enregistrer").appendChild(oSave),oReplay.value=toLanguage("REPLAY","REVOIR"),oReplay.onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++)$mkScreen.removeChild(oContainers[e]),fInfos={player:strPlayer,distribution:itemDistribution,ptsdistrib:ptsDistribution,cc:fSelectedClass,mirror:bSelectedMirror,double_items:oDoubleItemsEnabled,map:oMap.ref,my_route:iTrajet,replay:!0,perso:gPersos,selPerso:gSelectedPerso,cpu_route:jTrajets,my_record:gRecord,ow_record:gOverwriteRecord,record:timerMS,lap_times:iLapTimes,cl:clSelected},null==fInfos.record&&(fInfos.record=iRecord),null==fInfos.lap_times&&(fInfos.lap_times=lapTimers),document.getElementById("infos"+e).style.display="none";1==strPlayer.length&&removePlan(),oBgLayers.length=0,resetEvents(),resetApp()},document.getElementById("revoir").appendChild(oReplay),oChangeRace.value=toLanguage("     CHANGE RACE     ","   CHANGER CIRCUIT   "),oChangeRace.onclick=function(){interruptGame(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++)$mkScreen.removeChild(oContainers[e]),document.getElementById("infos"+e).style.display="none";fInfos={player:strPlayer,distribution:itemDistribution,ptsdistrib:ptsDistribution,cc:fSelectedClass,mirror:bSelectedMirror,double_items:oDoubleItemsEnabled,perso:[],cl:clSelected},gSelectedPerso&&(fInfos.player=[gSelectedPerso]),1==strPlayer.length&&removePlan(),oBgLayers.length=0,resetEvents(),resetApp()},document.getElementById("changercircuit").appendChild(oChangeRace),oClassement.value="RECORDS",oClassement.onclick=function(){open(rankingsLink(oMap))},gSelectedPerso&&(oClassement.style.display="none"),document.getElementById("classement").appendChild(oClassement),isSingle&&(oContinue.style.width=Math.round(36*iScreenScale)+"px",gSelectedPerso&&(oReplay.style.marginTop=oReplay.style.marginBottom=Math.round(2*iScreenScale)+"px"),oChangeRace.style.display="none")}else if(oMap.ref%4||"GP"!=course){oContinue.value=isSingle&&!isOnline?"        "+toLanguage("  REPLAY","REJOUER")+"        ":"BB"==course?toLanguage("      NEXT BATTLE\t   ","BATAILLE SUIVANTE"):toLanguage("       NEXT RACE\t   ","COURSE SUIVANTE");var forceClic3=!0;oContinue.onclick=function(){forceClic3=!1,nextRace()},isOnline&&setTimeout(function(){forceClic3&&nextRace()},5e3)}else oContinue.value=toLanguage("           NEXT           ","         SUIVANT          "),oContinue.onclick=function(){$mkScreen=document.body,interruptGame();var posX=[29,22,36],posY=[15,17,19];document.body.innerHTML=toLanguage("You are","Vous &ecirc;tes")+" <span id=\"position\"></span> !<br /><a href=\"javascript:location.reload()\" style=\"color: white;\">"+toLanguage("Back","Retour")+"</a><img alt=\".\" src=\"images/podium.gif\" style=\"position: absolute; left: "+20*iScreenScale+"px; top: "+20*iScreenScale+"px; width: "+24*iScreenScale+"px;\" />";for(var placement=[],i=1,oPlace;i<=aKarts.length;i++)for(var j=0;j<aKarts.length;j++)if(aKarts[j].place==i){placement.push(aKarts[j]);break}document.body.style.fontSize=2*iScreenScale+"pt";for(var i=0;i<placement.length;i++){placement[i]==oPlayers[0]&&(oPlace=i+1);var persoKey=placement[i].personnage;if(3>i)document.body.innerHTML+="<img alt=\".\" src=\""+getWinnerSrc(persoKey)+"\" style=\"width: "+4*iScreenScale+"px; position: absolute; left: "+iScreenScale*posX[i]+"px; top: "+iScreenScale*(posY[i]+(isCustomPerso(persoKey)?6:0))+"px;"+(isCustomPerso(persoKey)?"transform:translateY(-100%);-webkit-transform:translateY(-100%);-moz-transform:translateY(-100%);-o-transform:translateY(-100%);-ms-transform:translateY(-100%);":"")+"\" />";else if(oPlace)break}if(document.getElementById("position").innerHTML=toPlace(oPlace),3>=oPlace){document.body.innerHTML+="<img alt=\".\" src=\"images/cups/cup"+oPlace+".png\" style=\"width: "+3*iScreenScale+"px; position: absolute; left: "+30*iScreenScale+"px; top: "+25*iScreenScale+"px;\" />";var saveParams="pts="+(4-oPlace),saveUrl;"MK"==page?(saveUrl="saveGP.php",saveParams+="&change="+(oMap.map-4)/4):nid&&(saveUrl="cupsave.php",saveParams+=isMCups?"&cup="+cupIDs[oMap.ref/4-1]:"&cup="+nid),saveUrl&&xhr(saveUrl,saveParams,function(reponse){if(reponse){var newPerso;try{newPerso=eval(reponse)}catch(t){return!1}if(newPerso){var uwPerso=toPerso(newPerso);uwPerso=uwPerso.charAt(0).toUpperCase()+uwPerso.substring(1),document.body.innerHTML+="<div style=\"position: absolute; left: "+16*iScreenScale+"px; top: "+30*iScreenScale+"px; text-align: center\">"+toLanguage("You can now play<br />with "+uwPerso+" !","Vous pouvez d&eacute;sormais<br />jouer avec "+uwPerso+" !")+"<br /><img src=\""+getWinnerSrc(newPerso)+"\" style=\"width: "+4*iScreenScale+"px\" /></div>"}return!0}return!1}),bMusic&&(endGPMusic=startMusic("musics/menu/congrats.mp3",!0,700))}else bMusic&&(endGPMusic=startMusic("musics/menu/toobad.mp3",!0,700));reinitChallengeVars(),clLocalVars.endGP=!0,challengeCheck("end_gp")};document.getElementById("continuer").appendChild(oContinue),document.getElementById("quitter").onclick=quitter,isChatting()||oContinue.focus()}function nextRace(){interruptGame(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++)$mkScreen.removeChild(oContainers[e]),document.getElementById("infos"+e).style.display="none";fInfos={player:strPlayer,distribution:itemDistribution,ptsdistrib:ptsDistribution,cc:fSelectedClass,mirror:bSelectedMirror,double_items:oDoubleItemsEnabled,difficulty:iDificulty,cl:clSelected},"GP"==course&&(fInfos.map=oMap.ref+1),$mkScreen.style.opacity=1,1==strPlayer.length&&removePlan(),oBgLayers.length=0,resetEvents(),resetApp()}function rankingColor(e){var t=aKarts[e],i=t.team,n=getScreenPlayerIndex(e);return-1==i?n<oPlayers.length?n?cTeamColors.dark[0]:"#990":"transparent":n<oPlayers.length?n?cTeamColors.dark[i]:cTeamColors.light[i]:cTeamColors.primary[i]}function Sprite(e){for(var t=[],n=0;n<strPlayer.length;n++){this[n]={};var l=new Image;l.style.position="absolute",l.style.left="200px",l.alt=".",l.className="pixelated",l.src=getSpriteSrc(e);var o=document.createElement("div");o.style.width="32px",o.style.height="32px",o.style.position="absolute",o.style.overflow="hidden",o.style.zIndex=1e4,o.className="pixelated",o.style.display="none",o.appendChild(l),oContainers[n].appendChild(o),this[n].i=n,this[n].w=32,this[n].h=32,this[n].z=0,this[n].draw=function(e,n,l,o){o||(o=0);var a=this.i,i=this.w*fSpriteScale*l,s=this.h*fSpriteScale*l,r=n-s*(this.z+1)+i/2;return isNaN(r)||r>39*iScreenScale||n+o*iScreenScale<9*iScreenScale?void(t[a][0].style.display="none"):void(t[a][0].style.display="block",t[a][0].style.left=Math.round(e-i/2)+"px",t[a][0].style.top=Math.round(r)+"px",t[a][1].style.width=this.h==this.w?"":Math.round(i)*this.nbSprites+"px",t[a][1].style.height=Math.round(s)+"px",t[a][0].style.width=Math.round(i)+"px",t[a][0].style.height=Math.round(s)+"px",t[a][1].style.left=-(Math.round(i)*t[a][2])+"px")},this[n].render=function(e,t){var i=t.size||1,n=(t.x-e.x)*getMirrorFactor(),l=t.y-e.y,o=e.rotation*Math.PI/180*getMirrorFactor(),a=n*Math.cos(o)-l*Math.sin(o),s=n*Math.sin(o)+l*Math.cos(o),r=32+s,p=t.z?correctCamZ(t.z,r):0;this.div.style.zIndex=Math.round(1e4-s);var d=(40+32*-(a/(s+32)))*iScreenScale,c=(39-(32*(-24/r)+24- -10+p))*iScreenScale;this.draw(d,c,fFocal/(fFocal+s)*i,p)},this[n].setState=function(e){t[this.i][2]=e},this[n].getState=function(){return t[this.i][2]},this[n].div=o,this[n].img=l,t.push([o,l,0])}var a=this;this[0].unshow=function(){a[0].suppr(),a[0].unshown=!0},this[0].suppr=function(){if(!a[0].unshown)for(var e=0;e<strPlayer.length;e++)oContainers[e].removeChild(t[e][0])},this[0].fadein=function(e){if(!a[0].unshown){function o(){1<=n&&(n="");for(var e=0;e<strPlayer.length;e++)t[e][0].style.opacity=n;return""===n?void delete a[0].fadeinhandler:void(n+=l,a[0].fadeinhandler=setTimeout(o,67))}var n=0,l=67/e;o()}},this[0].fadeout=function(e){if(!a[0].unshown){function o(){if(n-=l,0>=n)return void a[0].suppr();for(var e=0;e<strPlayer.length;e++)t[e][0].style.opacity=n;setTimeout(o,67)}var n=1;a[0].fadeinhandler&&(clearTimeout(a[0].fadeinhandler),n=0);var l=67/e;o()}}}function BGLayer(e,t){var n=[],l=new Image;l.src=e,iSmooth||(l.className="pixelated");for(var o=0,a;o<oContainers.length;o++)a=document.createElement("div"),a.style.height=10*iScreenScale+"px",a.style.width=80*iScreenScale+"px",a.style.position="absolute",function(t){setTimeout(function(){t.style.backgroundImage="url('"+e+"')"},300)}(a),a.style.backgroundSize="auto 100%",iSmooth||(a.className="pixelated"),oContainers[o].appendChild(a),n[o]=a;return{draw:function(e,o){if(l.naturalWidth){bSelectedMirror&&(e=-e);var i=e-360*Math.ceil(e/360),a=10*iScreenScale*l.naturalWidth/l.naturalHeight;n[o].style.backgroundPosition=Math.round(i*(a*t/360))+"px 0"}},clone:function(e,t){var i=n[e].cloneNode(!0);return setTimeout(function(){i.style.backgroundImage=n[e].style.backgroundImage},500),t.appendChild(i),{drawCurrentState:function(){i.style.backgroundPosition=n[e].style.backgroundPosition}}},suppr:function(){for(var e=0;e<strPlayer.length;e++)oContainers[e].removeChild(n[e])}}}function GIF(){function e(e,t){var n,l,o,a,s,r,p,c,u,m,y,h;for(o=l=0,c=[],a=1<<e,s=a+1,r=e+1,p=!1;!p;){for(m=u,u=0,n=0;n<r;n++)t[o>>3]&1<<(7&o)&&(u|=1<<n),o++;if(u===a){for(c=[],r=e+1,n=0;n<a;n++)c[n]=[n];c[a]=[],c[s]=null}else{if(u===s)return void(p=!0);for(u>=c.length?c.push(c[m].concat(c[m][0])):m!==a&&c.push(c[m].concat(c[u][0])),y=c[u],h=y.length,n=0;n<h;n++)M[l++]=y[n];c.length===1<<r&&12>r&&r++}}}function t(e){for(var t=[],n=0;n<e;n++)t.push([T.data[T.pos++],T.data[T.pos++],T.data[T.pos++]]);return t}function i(){var e;T.pos+=6,E.width=T.data[T.pos++]+(T.data[T.pos++]<<8),E.height=T.data[T.pos++]+(T.data[T.pos++]<<8),e=T.data[T.pos++],E.colorRes=(112&e)>>4,E.globalColourCount=1<<(7&e)+1,E.bgColourIndex=T.data[T.pos++],T.pos++,128&e&&(E.globalColourTable=t(E.globalColourCount)),S=setTimeout(d,0)}function n(){T.pos+=1,"NETSCAPE"===T.getString(8)?T.pos+=8:(T.pos+=3,T.readSubBlocks())}function l(){var e;T.pos++,e=T.data[T.pos++],E.disposalMethod=(28&e)>>2,E.transparencyGiven=!!(1&e),E.delayTime=T.data[T.pos++]+(T.data[T.pos++]<<8),E.transparencyIndex=T.data[T.pos++],T.pos++}function o(){var i,n,l;i=function(e){var t,i,n;for(t=B/e,i=0,I!==B&&(z=new Uint8Array(B),I=B),n=0;4>n;n++)for(toLine=x[n];toLine<t;toLine+=v[n])z.set(M.subArray(i,i+e),toLine*e),i+=e},n={},E.frames.push(n),n.disposalMethod=E.disposalMethod,n.time=E.length,n.delay=10*E.delayTime,E.length+=n.delay,n.transparencyIndex=E.transparencyGiven?E.transparencyIndex:void 0,n.leftPos=T.data[T.pos++]+(T.data[T.pos++]<<8),n.topPos=T.data[T.pos++]+(T.data[T.pos++]<<8),n.width=T.data[T.pos++]+(T.data[T.pos++]<<8),n.height=T.data[T.pos++]+(T.data[T.pos++]<<8),l=T.data[T.pos++],n.localColourTableFlag=!!(128&l),n.localColourTableFlag&&(n.localColourTable=t(1<<(7&l)+1)),B!==n.width*n.height&&(M=new Uint8Array(n.width*n.height),B=n.width*n.height),e(T.data[T.pos++],T.readSubBlocksB()),64&l?(n.interlaced=!0,i(n.width)):n.interlaced=!1,a(n)}function a(e){var t,n,l,o,a,s,r,p,d,c,e,m;for(e.image=document.createElement("canvas"),e.image.width=E.width,e.image.height=E.height,e.image.ctx=e.image.getContext("2d"),t=e.localColourTableFlag?e.localColourTable:E.globalColourTable,null===E.lastFrame&&(E.lastFrame=e),s=2===E.lastFrame.disposalMethod||3===E.lastFrame.disposalMethod,s||e.image.ctx.drawImage(E.lastFrame.image,0,0,E.width,E.height),n=e.image.ctx.getImageData(e.leftPos,e.topPos,e.width,e.height),m=e.transparencyIndex,l=n.data,d=e.interlaced?z:M,o=d.length,a=0,r=0;r<o;r++)p=d[r],c=t[p],m===p?s?(l[a+3]=0,a+=4):a+=4:(l[a++]=c[0],l[a++]=c[1],l[a++]=c[2],l[a++]=255);e.image.ctx.putImageData(n,e.leftPos,e.topPos),E.lastFrame=e,E.waitTillDone||"function"!=typeof E.onload||u()}function s(){E.loading=!1,E.frameCount=E.frames.length,E.lastFrame=null,T=void 0,E.complete=!0,E.disposalMethod=void 0,E.transparencyGiven=void 0,E.delayTime=void 0,E.transparencyIndex=void 0,E.waitTillDone=void 0,M=void 0,z=void 0,B=void 0,z=void 0,E.currentFrame=0,0<E.frames.length&&(E.image=E.frames[0].image,"function"==typeof E.onloadone&&(E.onloadone.bind(E)({type:"load",path:[E]}),delete E.onloadone)),u(),"function"==typeof E.onloadall&&E.onloadall.bind(E)({type:"loadall",path:[E]}),E.playOnLoad&&E.play()}function r(){s(),"function"==typeof E.cancelCallback&&E.cancelCallback.bind(E)({type:"canceled",path:[E]})}function p(){var e=T.data[T.pos++];e===C.GCExt?l():e===C.COMMENT?E.comment+=T.readSubBlocks():e===C.APPExt?n():(e===C.UNKNOWN&&(T.pos+=13),T.readSubBlocks())}function d(){if(void 0!==E.cancel&&!0===E.cancel)return void r();var e=T.data[T.pos++];if(e!==C.IMAGE){if(e===C.EOF)return void s();p()}else if(o(),E.firstFrameOnly)return void s();E.frames.length&&"function"==typeof E.onloadone&&(E.image=E.frames[0].image,E.onloadone.bind(E)({type:"load",path:[E]}),delete E.onloadone),"function"==typeof E.onprogress&&E.onprogress({bytesRead:T.pos,totalBytes:T.data.length,frame:E.frames.length}),S=setTimeout(d,0)}function c(e){"function"==typeof E.onerror&&E.onerror.bind(this)({type:e,path:[this]}),E.onload=E.onerror=void 0,E.loading=!1}function u(){E.currentFrame=0,E.nextFrameAt=E.lastFrameAt=new Date().valueOf(),"function"==typeof E.onload&&E.onload.bind(E)({type:"load",path:[E]}),E.onerror=E.onload=void 0}function m(e){T=new k(e),i()}function y(){E.paused=!0,E.playing=!1,clearTimeout(w)}function h(e){clearTimeout(w),E.currentFrame=e%E.frames.length,E.playing?b():E.image=E.frames[E.currentFrame].image}function g(e){clearTimeout(w),0>e&&(e=0),e*=1e3,e%=E.length;for(var t=0;e>E.frames[t].time+E.frames[t].delay&&t<E.frames.length;)t+=1;E.currentFrame=t,E.playing?b():E.image=E.frames[E.currentFrame].image}function b(){var e,t;return 0===E.playSpeed?void E.pause():void(0>E.playSpeed?(E.currentFrame-=1,0>E.currentFrame&&(E.currentFrame=E.frames.length-1),t=E.currentFrame,t-=1,0>t&&(t=E.frames.length-1),e=1*-E.frames[t].delay/E.playSpeed):(E.currentFrame+=1,E.currentFrame%=E.frames.length,e=1*E.frames[E.currentFrame].delay/E.playSpeed),E.image=E.frames[E.currentFrame].image,w=setTimeout(b,e))}function f(){clearTimeout(w),clearTimeout(S),E.frames.length=0}var x=[0,4,2,1],v=[8,8,4,2],C={GCExt:249,COMMENT:254,APPExt:255,UNKNOWN:1,IMAGE:44,EOF:59,EXT:33},k=function(e){this.data=new Uint8ClampedArray(e),this.pos=0;var t=this.data.length;this.getString=function(e){for(var t="";e--;)t+=String.fromCharCode(this.data[this.pos++]);return t},this.readSubBlocks=function(){var e="",i,n;do for(n=i=this.data[this.pos++];n--;)e+=String.fromCharCode(this.data[this.pos++]);while(0!==i&&this.pos<t);return e},this.readSubBlocksB=function(){var e=[],i,n;do for(n=i=this.data[this.pos++];n--;)e.push(this.data[this.pos++]);while(0!==i&&this.pos<t);return e}},E={onload:null,onerror:null,onprogress:null,onloadall:null,paused:!1,playing:!1,waitTillDone:!0,loading:!1,firstFrameOnly:!1,width:null,height:null,frames:[],comment:"",length:0,currentFrame:0,frameCount:0,playSpeed:1,lastFrame:null,image:null,playOnLoad:!0,load:function(e){var t=new XMLHttpRequest;t.responseType="arraybuffer",t.onload=function(i){404===i.target.status?c("File not found"):200<=i.target.status&&300>i.target.status?m(t.response):c("Loading error : "+i.target.status)},t.open("GET",e,!0),t.send(),t.onerror=function(){c("File error")},this.src=e,this.loading=!0},cancel:function(e){return!E.complete&&(E.cancelCallback=e,E.cancel=!0,!0)},play:function(){E.playing||(E.paused=!1,E.playing=!0,b())},pause:y,seek:g,seekFrame:h,togglePlay:function(){E.paused||!E.playing?E.play():E.pause()},clear:f},w,S,T,I,z,B,M;return E}function createMarker(e){for(var t={div:[]},n=0,l;n<strPlayer.length;n++){l=document.createElement("div"),l.style.display="none",l.style.position="absolute",l.style.opacity=.7;var o=-1==e.team?"#EEE":cTeamColors.primary[e.team],a=12*iScreenScale,s=3*iScreenScale,r=Math.PI/4,p=Math.round(iScreenScale/4),d=Math.cos(r),c=Math.sin(r),u=document.createElement("div");u.style.position="absolute",u.style.width=p+"px",u.style.height=s+"px",u.style.backgroundColor=o,u.style.left="0px",u.style.bottom="0px",u.style.transform=u.style.WebkitTransform=u.style.MozTransform="rotate("+Math.round(180*r/Math.PI)+"deg)",u.style.transformOrigin=u.style.WebkitTransformOrigin=u.style.MozTransformOrigin="bottom left",l.appendChild(u);var m=document.createElement("div");m.style.position="absolute",m.style.width=a+"px",m.style.height=p+"px",m.style.backgroundColor=o,m.style.left=Math.round(s*Math.sin(r))+"px",m.style.bottom=Math.round(s*d-p*c)+"px",l.appendChild(m);var y=document.createElement("div");y.style.color=-1==e.team?"#555":o,y.style.whiteSpace="nowrap";var h=-1==e.team?"#EEE":cTeamColors.secondary[e.team],g=Math.ceil(iScreenScale/4)+"px";y.style.textShadow="-"+g+" 0 "+h+", 0 "+g+" "+h+", "+g+" 0 "+h+", 0 -"+g+" "+h,e.nick?y.innerHTML=e.nick:(y.style.textTransform="capitalize",y.innerHTML=toPerso(e.personnage)),y.style.position="absolute",y.style.left=Math.round(s*c)+"px",y.style.bottom=Math.round(s*d)+"px",y.style.width=Math.round(a-.5*iScreenScale)+"px",y.style.overflow="hidden",y.style.fontSize=Math.round(1.5*iScreenScale)+"px",y.style.textAlign="right",l.appendChild(y),t.div.push(l),oContainers[n].appendChild(l)}return t.draw=function(t,i,n,l,o){o||(o=0);var a=this.div[t];if(n>39*iScreenScale||n+o*iScreenScale<12*iScreenScale)return void(a.style.display="none");a.style.display="block";var s=Math.round(e.sprite[t].h*fSpriteScale*l);a.style.left=Math.round(i)+"px",a.style.top=Math.round(n-s/2)+"px"},t.render=function(e,t,i){var n=i.size||1,l=(i.x-t.x)*getMirrorFactor(),o=i.y-t.y,a=t.rotation*Math.PI/180*getMirrorFactor(),s=l*Math.cos(a)-o*Math.sin(a),r=l*Math.sin(a)+o*Math.cos(a),p=32+r,d=correctCamZ(i.z,p);this.div[e].style.zIndex=Math.round(1e4-r);var c=(40+32*-(s/(r+32)))*iScreenScale,u=(39-(32*(-24/p)+24- -10+d))*iScreenScale;this.draw(e,c,u,fFocal/(fFocal+r)*n,d)},t}function clonePreviousScreen(e,t){if(prevScreenDelay){var i=oPrevFrameStates[e];i[prevScreenCur].canvas.getContext("2d").drawImage(oScreens[e],0,0);for(var n=0;n<oBgLayers.length;n++)i[prevScreenCur].layer[n].drawCurrentState();i[prevScreenCur].opacity=Math.max(0,Math.min(prevScreenOpacity,t.speed*prevScreenOpacity/8));for(var n=0,l;n<prevScreenDelay;n++)l=(prevScreenCur-n+prevScreenDelay)%prevScreenDelay,i[n].container.style.zIndex=prevScreenDelay-l,i[n].container.style.opacity=i[n].opacity*Math.pow(prevScreenFade,l);prevScreenCur++,prevScreenCur>=prevScreenDelay&&(prevScreenCur=0)}}function redrawCanvas(e,t){var i=oViewCanvas.getContext("2d");i.fillStyle="rgb("+oMap.bgcolor+")",i.fillRect(0,0,oViewCanvas.width,oViewCanvas.height),i.save(),i.translate(300,230),bSelectedMirror&&i.scale(-1,1),i.rotate((180+t.rotation)*Math.PI/180);var n=t.x,l=t.y;oMapImg.image?i.drawImage(oMapImg.image,-n,-l):i.drawImage(oMapImg,-n,-l);for(var o=0,a;o<oMap.assets.length;o++)a=oMap.assets[o],i.drawImage(a.canvas,a.x-n,a.y-l);oMap.sea&&oMap.sea.render(i,[n,l],1),i.restore(),oScreens[e].getContext("2d").imageSmoothingEnabled=iSmooth;for(var s=oScreens[e].getContext("2d"),r=1/fLineScale,o=0,p;o<aStrips.length;o++){p=aStrips[o];try{s.drawImage(oViewCanvas,(600-p.stripwidth)/2,229-p.mapz,p.stripwidth,p.mapzspan,0,(39-p.viewy)*r,80*r,1)}catch(t){}}}function byteType(e){return{key:e,type:"byte"}}function shortType(e){return{key:e,type:"short"}}function floatType(e){return{key:e,type:"float"}}function intType(e){return{key:e,type:"int"}}function initItemSprite(e){var t=[],i=e[2];i&&oDoubleItemsEnabled||(i=1);for(var n=0;n<i;n++)t[n]=new Sprite("item");e[2]={active:!0,box:t}}function handleSpriteLaunch(e,t,i){e.countdown--,t+=5*(cappedRelSpeed()-1);var n=inTeleport(e.x,e.y),l,o;if(n)l=n[0],o=n[1],e.theta=90*n[2];else{var a=t*direction(0,e.theta),s=t*direction(1,e.theta);l=e.x+a,o=e.y+s}e.x=l,e.y=o,e.z=correctZInv((-Math.pow(e.countdown-8,2)+64)*i),!e.countdown&&tombe(l,o)&&detruit(e)}function getDecorParams(e,t){var i=e.type;return oMap.decorparams&&oMap.decorparams[i]&&oMap.decorparams[i][t]?oMap.decorparams[i][t]:{}}function getDecorExtraParams(e){return oMap.decorparams&&oMap.decorparams.extra&&oMap.decorparams.extra[e]?oMap.decorparams.extra[e]:{}}function getDecorExtra(e,t){var i=e.type,n=getDecorExtraParams(i);return t&&n.custom&&(n=getDecorExtra(decorBehaviors[n.custom.type])),n}function getDecorCustomData(e){return getDecorExtraParams(e).custom}function getDecorActualType(e){var t=getDecorExtra(decorBehaviors[e.type]);return t.custom?t.custom.type:e.type}function initCustomDecorSprites(e,t){function n(){for(var t=e.linkedSprite.start,n;t<e.linkedSprite.end;t++)n=oPlanDecor[l][t],n&&(n.src=o.map,n.style.width=s+"px"),n=oPlanDecor2[l][t],n&&(n.src=o.map,n.style.width=r+"px")}if(e.linkedSprite){var l=e.linkedSprite.type;if(t.extra&&t.extra[l]){for(var o=t.extra[l],a={w:o.size.hd.w/o.original_size.hd.w,h:o.size.hd.h/o.original_size.hd.h},s=oObjWidth*a.w,r=oObjWidth2*a.w,p=e.linkedSprite.start,d;p<e.linkedSprite.end;p++)d=oMap.decor[l][p],d&&updateCustomDecorSprites(d,o,a);n(),setTimeout(n,300)}}}function updateCustomDecorSprites(e,t,i){for(var n=0;n<oPlayers.length;n++){e[2][n].img.src=t.hd,t.size.nb_sprites&&(e[2][n].nbSprites=t.size.nb_sprites),bSelectedMirror&&!(1<t.size.nb_sprites)&&e[2][n].img.classList.add("mirrored"),e[2][n].w=Math.round(e[2][n].w*i.w),e[2][n].h=Math.round(e[2][n].h*i.h);var l=(i.w-i.h)/(i.w+i.h);l*=e[2][n].w/(2*e[2][n].h),e[2][n].z+=l}}function getApparentRotation(e){var t=e.rotation,i=e.changeView;return i&&(t+=t<360-i?i:i-360),t}function getLastObj(e,t,i){if(e[t]&&e[t].ref===i.ref)return e[t];for(var n=0;n<e.length;n++)if(e[n].ref===i.ref)return e[n];return i}function interpolateState(e,t,i){return interpolateFn&&("ease_out_quad"===interpolateFn?i=-i*(i-2):"ease_out_cubic"===interpolateFn?(i--,i=i*i*i+1):"ease_out_quart"===interpolateFn?(i--,i=1-i*i*i*i):"ease_out_exp"===interpolateFn?i=1===i?1:1-Math.pow(2,-10*i):void 0),interpolateRaw(e,t,i)}function interpolateRaw(e,i,n){return e*(1-n)+i*n}function interpolateStateNullable(e,t,i){return null==e?t:null==t?e:interpolateState(e,t,i)}function interpolateStateAngle(e,t,i){return e=nearestAngle(e,t,360),interpolateState(e,t,i)}function interpolateStateRound(e,t,i){return Math.round(interpolateState(e,t,i))}function resetRenderState(){lastState=void 0;for(var e=0;e<frameHandlers.length;e++)clearTimeout(frameHandlers[e])}function render(){function e(e){var n=new Date().getTime(),l=1/nbFrames,o=e==nbFrames,a;if(o&&(lastState=t),1==nbFrames)a=t,a.players=[];else{if(1<e){if(l+=(n-lastStateTime)/67,l*nbFrames>=e+1)return;1<l&&(l=1)}else lastStateTime=n;if(a={karts:[],players:[],decor:{},items:{}},t.cam){var s=lastState.cam,r=t.cam;s||(s=r),a.cam={x:interpolateState(s.x,r.x,l),y:interpolateState(s.y,r.y,l),rotation:interpolateStateAngle(s.rotation,r.rotation,l)}}for(var p=0;p<t.karts.length;p++){var d=t.karts[p],c=getLastObj(lastState.karts,p,d);d.ref.progressiveView||(c.changeView=d.changeView),d.tombe&&!c.tombe&&(c.tombe=d.tombe),d.figstate&&!c.figstate&&(c.figstate=d.figstate),d.tourne&&!c.tourne&&(c.tourne=d.tourne),a.karts.push({ref:d.ref,x:interpolateState(c.x,d.x,l),y:interpolateState(c.y,d.y,l),z:interpolateState(c.z,d.z,l),speed:interpolateState(c.speed,d.speed,l),rotation:interpolateStateAngle(c.rotation,d.rotation,l),changeView:interpolateStateAngle(c.changeView,d.changeView,l),size:interpolateState(c.size,d.size,l),tourne:interpolateStateRound(c.tourne,d.tourne,l),figstate:interpolateStateRound(c.figstate,d.figstate,l),time:interpolateState(c.time,d.time,l),roulette:interpolateState(c.roulette,d.roulette,l),roulette2:interpolateState(c.roulette2,d.roulette2,l),tombe:interpolateState(c.tombe,d.tombe,l),teleport:interpolateStateNullable(c.teleport,d.teleport,l)})}for(var u in t.decor){a.decor[u]=[];for(var p=0;p<t.decor[u].length;p++){var d=t.decor[u][p],c=getLastObj(lastState.decor[u],p,d);a.decor[u].push({ref:d.ref,x:interpolateState(c.x,d.x,l),y:interpolateState(c.y,d.y,l),z:interpolateState(c.z,d.z,l)})}}for(var u in t.items){a.items[u]=[];for(var p=0;p<t.items[u].length;p++){var d=t.items[u][p],c=getLastObj(lastState.items[u],p,d);a.items[u].push({ref:d.ref,x:interpolateState(c.x,d.x,l),y:interpolateState(c.y,d.y,l),z:interpolateState(c.z,d.z,l),size:interpolateState(c.size,d.size,l)})}}}for(var p=0;p<oPlayers.length;p++)a.players.push(a.karts[p]);for(var p=0,m;p<a.players.length;p++){m=a.players[p],oSpecCam&&(m=a.karts[oSpecCam.playerId]);var y=m.x,h=m.y,g=getApparentRotation(m);a.cam&&(y=a.cam.x,h=a.cam.y,g=a.cam.rotation),m.tombe?(10<m.tombe&&(20!=m.tombe||o?(y=m.ref.aX,h=m.ref.aY,g=getApparentRotation({rotation:m.ref.aRotation,changeView:m.changeView})):(y=interpolateState(lastState.karts[p].x,m.ref.aX,l),h=interpolateState(lastState.karts[p].y,m.ref.aY,l),m.x=y,m.y=h,m.z=0,m.rotation=m.ref.aRotation,m.ref.sprite[p].img.style.opacity=1-l,g=getApparentRotation(m))),oContainers[p].style.opacity=Math.abs(m.tombe-10)/10):m.teleport&&(3<m.teleport?(y=m.ref.aX,h=m.ref.aY,m.rotation=m.ref.aRotation):(y=m.ref.x,h=m.ref.y,m.rotation=m.ref.rotation),g=getApparentRotation(m),m.ref.teleport&&(oContainers[p].style.opacity=Math.abs(m.teleport-3)/3));var b={x:y,y:h,rotation:g};if(clonePreviousScreen(p,m),redrawCanvas(p,b),m.time){var f=document.getElementById("lakitu"+p);f&&(f.style.left=Math.round(iScreenScale*(20-m.time/5))+"px",f.style.top=Math.round((-Math.abs(m.time-20)+18)*(iScreenScale-2))+"px")}for(var x=0;x<oRoulettesPrefixes.length;x++){var v=oRoulettesPrefixes[x],C=m["roulette"+v];if(C&&25>C){var E=document.getElementById("scroller"+v+p).getElementsByTagName("div")[0],w=+E.dataset.h,S=+E.dataset.s,T=+E.dataset.v,I=parseInt(E.style.top)+Math.round(iScreenScale*T/nbFrames);0<I&&(I+=S-w),E.style.top=I+"px"}}for(var x=0,z;x<a.karts.length;x++){z=a.karts[x];var B=z.ref,M=nearestAngleMirrored(g-z.rotation,180,360),L=Math.round(11*M/180)+z.tourne%21;21<L&&(L-=22);var H=z==m&&!oSpecCam;if(z.changeView||(z.figstate?L=(L+21-z.figstate)%21:B.driftinc&&(4>L||18<L)?L=0<B.driftinc*getMirrorFactor()?18:4:H&&(B.rotincdir&&!z.tourne?L=0<B.rotincdir*getMirrorFactor()?23:22:!z.tourne&&(L=0))),B.sprite[p].setState(L),B.sprite[p].render(b,z),"BB"==course){var A=B.ballons.length,_=z.size/2,P=correctZInv(correctZ(z.z)+2*_*(6+(B.sprite[p].h-32)/5)),N=2.5*getMirrorFactor();for(U=0;U<A;U++)B.ballons[U][p].render(b,{x:z.x-(U+.75-A/2)*N*z.size*direction(1,g),y:z.y+(U+.75-A/2)*N*z.size*direction(0,g),z:P,size:_})}if(B.driftinc?(!B.z||"block"===B.driftSprite[p].div.style.display)&&B.driftSprite[p].render(b,{x:z.x,y:z.y,z:z.z,size:z.size/2}):B.driftSprite[p].div.style.display="none",B.wrongWaySprite&&p===x){var R=interpolateState(-1,0,l),D=B.wrongWaySince+R-10,F,V;if(B.wrongWaySprite[p].setState(Math.floor(D%8/4)),20>D){var O=D/20;F=15*(Math.pow(O,.7)-1),V=40*(1-O)}else{D-=20;var O=D%30/30,q=Math.cos(2*Math.PI*O),W=Math.sin(2*Math.PI*O),X=1+q*q;F=5*W/X,V=-10*q*W/X}if(F-=2,B.rightWaySince){var G=(B.rightWaySince+R)/10;V+=50*G}B.wrongWaySprite[p].render(b,{x:z.x-F*direction(1,g),y:z.y+F*direction(0,g),z:20+V})}H||!B.marker||B.loose||B.tombe||B.marker.render(p,b,z)}for(var x=0;x<oMap.arme.length;x++){z=oMap.arme[x];var K=z[2];if(K.active)for(var U=0,Y;U<K.box.length;U++)Y=K.box[U],Y[p].render(b,{x:z[0],y:z[1],z:4.5*U});else!p&&o&&(K.countdown?K.countdown--:K.active=!0)}if(oMap.coins)for(var x=0;x<oMap.coins.length;x++){z=oMap.coins[x];var J=b.rotation*Math.PI/180,Q=Math.abs(Math.cos(z.theta-J));z.sprite[p].w=24*Q,z.sprite[p].z=.5*(Q-1),z.sprite[p].render(b,{x:z.x,y:z.y})}for(var u in a.decor)for(var x=0;x<a.decor[u].length;x++)z=a.decor[u][x],z.ref[2][0].unshown||z.ref[2][p].render(b,{x:z.x,y:z.y,z:z.z,size:1.2});for(var $ in a.items)for(var x=0;x<a.items[$].length;x++){if(z=a.items[$][x],o){var Z=itemBehaviors[$];Z.render&&Z.render(z.ref,p)}z.ref.sprite&&z.ref.sprite[p].render(b,z)}if(o)for(var x=0;x<aKarts.length;x++){var ee=aKarts[x],te=ee.sprite[p];0<ee.figstate&&ee.figuring?!te.div.hallowed&&(te.div.hallowed=!0,te.div.style.backgroundImage="url('images/halo.png')",te.div.style.backgroundRepeat="no-repeat",te.div.style.backgroundSize="contain",te.img.style.opacity=.7):te.div.hallowed&&(te.div.hallowed=!1,te.div.style.backgroundImage="",te.div.style.backgroundRepeat="",te.div.style.backgroundSize="",te.img.style.opacity=1)}for(var x=0;x<oBgLayers.length;x++)oBgLayers[x].draw(g,p);oPlanCtn&&setPlanPos(a)}}var t={karts:[],decor:{},items:{}};if(oSpecCam){if(!oSpecCam.isSetup())return;t.cam={x:oSpecCam.pos.x,y:oSpecCam.pos.y,rotation:oSpecCam.pos.rotation}}for(var n=0,l;n<aKarts.length;n++)l=aKarts[n],t.karts.push({ref:l,x:l.x,y:l.y,z:l.z,speed:l.speed,rotation:l.rotation,changeView:l.changeView||0,size:l.size,tourne:l.tourne,figstate:l.figstate||0,time:l.time,roulette:l.roulette,roulette2:l.roulette2,tombe:l.tombe,teleport:l.teleport});if(oMap.decor)for(var o in oMap.decor){t.decor[o]=[];for(var n=0,a;n<oMap.decor[o].length;n++)a=oMap.decor[o][n],t.decor[o].push({ref:a,x:a[0],y:a[1],z:a[3]})}for(var s in items){t.items[s]=[];for(var n=0,r;n<items[s].length;n++)r=items[s][n],t.items[s].push({ref:r,x:r.x,y:r.y,z:r.z,size:r.size})}lastState||(lastState=t);for(var n=1;n<nbFrames;n++)(function(t){frameHandlers[t]=setTimeout(function(){e(t+1)},67*t/nbFrames)})(n);e(1)}function makeSpriteExplode(e,t,i){var n="explosion";n+=-1==e.team?t:e.team,e.sprite[i].img.src="images/sprites/sprite_"+n+".png";var l=e.sprite[i].div.getElementsByClassName("sprite-hallow");l.length&&e.sprite[i].div.removeChild(l[0])}function correctZ(e){return 7*Math.pow(e/7,.7)}function correctZInv(e){return 7*Math.pow(e/7,1/.7)}function correctCamZ(e,t){return 32*correctZ(e)/t}function direction(e,t){return Math[["sin","cos"][e]](t*Math.PI/180)}function getItemDistributionRange(e){var t=(e.place-1)/aKarts.length,n=e.place/aKarts.length;if("BB"!=course){var l,o;if(1==e.place){var s=-distanceToSecond(e);l=0,o=.18*Math.exp(s/150)}else{var r=distanceToFirst(e);l=Math.pow(r/metaItemRange,.75),o=.07}var p=Math.min(1,l),c=Math.min(1,l+o);t=getItemAvgRange(p,t),n=getItemAvgRange(c,n)}else{for(var u=0,m=0;m<aKarts.length;m++)u=Math.max(u,aKarts[m].ballons.length+aKarts[m].reserve);var y=e.ballons.length+e.reserve,l=(u-y)/2.5,o=.07,p=l,c=l+o;t=getItemAvgRange(p,t),n=getItemAvgRange(c,n)}return[t*itemDistribution.value.length,n*itemDistribution.value.length]}function getItemAvgRange(e,t){var i;switch(itemDistribution.algorithm){case"dist":i=e;break;case"rank":i=t;break;default:i=Math.pow(e,1-metaItemPosition)*Math.pow(t,metaItemPosition);}return Math.min(.99999,i)}function randObj(e){var t=getItemDistributionRange(e),n=t[0],l=t[1],o=Math.floor(n+(l-n)*Math.random()),i=itemDistribution.value[o],a=0;for(var s in i)a+=i[s];var r=Math.floor(Math.random()*a);for(var s in a=0,i)if(a+=i[s],a>r)return s}function possibleObjs(e,t){var n=getItemDistributionRange(e),l=.005,o=Math.floor(n[0]+l),s=Math.ceil(n[1]-l),r={};o>=itemDistribution.value.length&&(o=itemDistribution.value.length-1,s=itemDistribution.value.length);for(var p=o,d;p<s;p++)for(var c in d=itemDistribution.value[p],d)t[c]||(r[c]=!0);return r}function otherObjects(e,t){var i=possibleObjs(e,t);return 0<Object.getOwnPropertyNames(i).length}function friendlyFire(e,t){return e==t||iTeamPlay&&!selectedFriendlyFire&&e.team==t.team}function sameTeam(e,t){return-1!=e&&e==t}function friendlyHit(e,t){return!selectedFriendlyFire&&sameTeam(e,t)}function addNewBalloon(e,t){e.ballons.push(createBalloonSprite(e,t))}function inflateNewBalloons(e){for(var t=1+Math.round(Math.random()),n=0;n<t&&e.reserve;n++)addNewBalloon(e),e.reserve--}function createBalloonSprite(e,t){return void 0===t&&(t=e.team),new Sprite("ballon"+(-1==t?"":t))}function balloonSrc(e){return"images/sprites/sprite_"+(-1==e?"ballon":"ballon"+e)+".png"}function updateBalloonHud(e,t){var n=balloonSrc(t.team);e.innerHTML="";for(var l=0;l<t.reserve;l++)e.innerHTML+="<img src=\""+n+"\" style=\"width:"+3*iScreenScale+"px;margin:0 "+Math.round(.5*iScreenScale)+"px 0 "+Math.round(.2*iScreenScale)+"px\" />"}function detruit(e,t){isOnline&&(e=getItemToDestroy(e),e.deleted=1,syncItems.push(e)),supprime(e,t)}function supprime(e,t){var n=e.type,l=items[n].indexOf(e);if(-1!=l){var o=itemBehaviors[n];if(e.sprite){for(var a=0,s;a<oPlayers.length;a++)if(s=getPlayerAtScreen(a),!s.tombe){var r={x:s.x,y:s.y,rotation:getApparentRotation(s)};e.sprite[a].render(r,e)}e.sprite[0].fadeout(o.fadedelay)}o.del&&o.del(e);for(var a=0,p;a<aKarts.length;a++)if(p=aKarts[a].using.indexOf(e),-1!=p){aKarts[a].using.splice(p,1),aKarts[a].using.length||consumeItemIfDouble(a),t&&playIfShould(aKarts[a],"musics/events/hit.mp3")&&(t=!1);break}if("object"==typeof t&&playDistSound(t,"musics/events/hit.mp3",80),clLocalVars.myItems){var d=clLocalVars.myItems.indexOf(e);-1!=d&&clLocalVars.myItems.splice(d,1)}items[n].splice(l,1)}}function getItemToDestroy(e){for(var t=0,n;t<aKarts.length;t++)if(n=aKarts[t].using.indexOf(e),-1!=n){var l=aKarts[t].using[0];return l.type===e.type?l:e}return e}function supprArme(e){for(var t=aKarts[e],i=0,n;i<oRoulettesPrefixes.length;i++)n=oRoulettesPrefixes[i],t["roulette"+n]=0,t[oArmeKeys[i]]=!1;kartIsPlayer(t)&&(updateObjHud(e),updateItemCountdownHud(e,null),removeIfExists(t.rouletteSound))}function consumeItem(e){var t=aKarts[e];t.arme=t.stash,t.stash=!1,t.roulette=t.roulette2,t.roulette2=0,kartIsPlayer(t)&&(updateObjHud(e),updateItemCountdownHud(e,null))}function consumeItemIfDouble(e){oDoubleItemsEnabled&&consumeItem(e)}function loseUsingItems(e){if(e.using.length){for(var t=0,n;t<e.using.length;t++){n=e.using[t],n.z&&(n.z=0);var l=itemBehaviors[n.type];l.drop&&l.drop(n,e),isOnline&&syncItems.push(n)}e.using.length=0,consumeItemIfDouble(aKarts.indexOf(e))}}function loseUsingItem(e){void 0===e.rotitem&&loseUsingItems(e)}function dropCurrentItem(e){var t=e.arme;if(t){var n=e.roulette,l=aKarts.indexOf(e);if((consumeItem(l),consumeItemIfDouble(l),delete e.champiType,delete e.champior,delete e.champior0,!(25>n))&&!(isOnline&&e.id!=identifiant&&e.controller!=identifiant)){var o=1,a=t.match(/^(.+)X(\d+)$/);a&&(t=a[1],o=+a[2]);var s;if("champi"===t||"banane"===t||"carapace"===t||"poison"===t?s=t:"carapacerouge"===t?s="carapace-rouge":void 0,s)for(var r=0;r<o;r++){var p=e.rotation*Math.PI/180+.9*(Math.random()-.5)*Math.PI,d=9+6*Math.random(),c={type:s,team:e.team,x:e.x-d*Math.sin(p),y:e.y-d*Math.cos(p),z:0};dropNewItem(e,c),c.sprite[0].fadein(200)}}}}function deleteUsingItems(e){for(var t=e.using.length-1;0<=t;t--)detruit(e.using[t])}function moveUsingItems(e,t){if(e.using.length){var n=0,o=5,a=360/e.using.length,s="banane"===e.using[0].type;void 0!==e.rotitem&&(n=e.rotitem,o=s?4:4.5,!t&&(e.rotitem-=30));for(var r=0,p;r<e.using.length;r++)p=e.using[r],s?(p.x=e.x-o*(.7+.35*(e.using.length-r))*direction(0,e.rotation),p.y=e.y-o*(.7+.35*(e.using.length-r))*direction(1,e.rotation)):(p.x=e.x-o*direction(0,e.rotation+n+r*a),p.y=e.y-o*direction(1,e.rotation+n+r*a)),p.z=e.z}else delete e.rotitem}function hasOnHoldItem(e){return!!e.using.length&&void 0===e.rotitem}function stopDrifting(e){var t=aKarts[e];t.driftinc=0,t.driftcpt=0,t.turbodrift=0,resetDriftSprite(t),t.driftSound&&(t.driftSound.pause(),t.driftSound=void 0),t.sparkSound&&(t.sparkSound.pause(),t.sparkSound=void 0)}function resetDriftSprite(e){for(var t=0,n;t<oPlayers.length;t++)n=e.driftSprite[t],n.div.style.display="none",n.setState(0)}function isJumpEnabled(){return!(isOnline&&shareLink.options&&shareLink.options.noJump)}function isRdDisabled(){return isOnline&&shareLink.options&&shareLink.options.noRd}function isLocalScore(){return!isOnline||shareLink.options&&shareLink.options.localScore}function showRearView(e){var t=oPlayers[e],i=180-t.changeView;if(t.changeView=i,t.sprite[0].setState(11),bCounting){var n=document.getElementById("oCounts"+e);n&&(n.style.visibility=t.changeView?"hidden":"visible")}}function resetSpriteHeight(e){e.lastW=e.w,e.lastH=e.h,e.w=32,e.h=32}function resumeSpriteSize(e){e.lastW&&(e.w=e.lastW,delete e.lastW),e.lastH&&(e.h=e.lastH,delete e.lastH)}function updateProtectFlag(e){e.protect=e.etoile||e.megachampi||e.billball||e.cannon}function colKart(e){for(var t=aKarts[e],n=0;n<e;n++){var o=aKarts[n],a=t.protect?t.etoile||t.billball?2:1:0,s=o.protect?o.etoile||o.billball?2:1:0,r="BB"==course&&!t.champi!=!o.champi;if(!(t.cpu&&o.cpu&&a==s&&!r)&&!friendlyFire(t,o)&&("BB"!=course||t.ballons.length&&o.ballons.length)&&1e3>Math.pow(t.x-o.x,2)+Math.pow(t.y-o.y,2)&&(t.z<=jumpHeight0||t.billball&&!t.cannon)&&(o.z<=jumpHeight0||o.billball&&!o.cannon)&&!t.tourne&&!o.tourne){var p=kartInstantSpeed(t),d=kartInstantSpeed(o),c=[d[0]-p[0],d[1]-p[1]],u=[t.x-o.x,t.y-o.y],m=5*(o.size+t.size)*(o.size+t.size),y=projete(0,0,u[0],u[1],u[0]-c[0],u[1]-c[1]);0>y&&(y=0),1<y&&(y=1);var h=[u[0]-y*c[0],u[1]-y*c[1]],g=h[0]*h[0]+h[1]*h[1];if(g<=m)if(!a&&!s){if(isOnline&&shareLink.options&&shareLink.options.noBumps)continue;if(r){var b=t.champi?o:t;if(!b.loose&&!b.cannon&&!b.frminv){var f=t.champi?t:o;if(1===f.champiType){var x=aKarts.indexOf(b);handleHit2(f,b),loseBall(x),stopDrifting(x),3>f.ballons.length&&addNewBalloon(f,b.team),b.spin(62)}}}var v=u[0]*u[0]+u[1]*u[1];if(v>m&&(!t.cpu||!o.cpu)){var C=[u[1],-u[0]],k=C[0]*u[1]-u[0]*C[1];if(k){var E=(C[0]*c[1]-C[1]*c[0])/k,w=(u[1]*c[0]-u[0]*c[1])/k;u[0]*=E,u[1]*=E,C[0]*=w,C[1]*=w;var S=o.stats.mass*o.size/(t.stats.mass*t.size),T=[u[0]*S,u[1]*S];(!t.pushVector||t.pushVector[0]*t.pushVector[0]+t.pushVector[1]*t.pushVector[1]<T[0]*T[0]+T[1]*T[1])&&(t.pushVector=T),T=[(C[0]+p[0]-d[0])/S,(C[1]+p[1]-d[1])/S],(!o.pushVector||o.pushVector[0]*o.pushVector[0]+o.pushVector[1]*o.pushVector[1]<T[0]*T[0]+T[1]*T[1])&&(o.pushVector=T),o.cpu||o.colSound||(o.colSound=playIfShould(o,"musics/events/colkart.mp3"),o.colSound&&function(e){e.colSound.onended=function(){e.colSound=void 0,document.body.removeChild(this)}}(o))}}}else if(a!=s&&g<m/2){var b=a<s?t:o;if(!b.loose&&!b.cannon&&!b.frminv){var f=a<s?o:t,x=aKarts.indexOf(b);handleHit2(f,b),loseBall(x),stopDrifting(x),b.spin(62),loseUsingItems(b),dropCurrentItem(b)}}}}}function pointInRectangle(e,t,i){return e>i[0]&&e<=i[0]+i[2]&&t>i[1]&&t<=i[1]+i[3]}function pointInPolygon(e,t,n){for(var l=!1,o=0,a=n.length-1;o<n.length;a=o++){var s=n[o][0],r=n[o][1],p=n[a][0],d=n[a][1];r>t!=d>t&&e<(p-s)*(t-r)/(d-r)+s&&(l=!l)}return l}function pointInZone(e,t,n){for(var l=n.rectangle,o=0;o<l.length;o++)if(pointInRectangle(e,t,l[o]))return!0;for(var a=n.polygon,o=0;o<a.length;o++)if(pointInPolygon(e,t,a[o]))return!0;return!1}function pointInQuad(e,t,i){var n=projete(e,t,i.A[0],i.A[1],i.B[0],i.B[1]);return!!(0<n&&1>=n&&(n=projete(e,t,i.A[0],i.A[1],i.C[0],i.C[1]),0<n&&1>=n))}function pointInAltitude(e,t,i){return i<getZoneHeight(e,t)}function getZoneHeight(e,t){var i=e[t]||{z:1};return getPointHeight(i.z)}function getPointHeight(e){return e*jumpHeight1}function pointCrossRectangle(e,t,i,n,o){for(var a=[e,t],s=[i,n],r=[0<i,0<n],p=0,d;2>p;p++)if(d=r[p],d?a[p]<=o[p]&&a[p]+s[p]>=o[p]:a[p]>=o[p]+o[p+2]&&a[p]+s[p]<=o[p]+o[p+2]){var c=1-p,u=a[c]+((d?o[p]:o[p]+o[p+2])-a[p])*s[c]/s[p];if(u>=o[c]&&u<=o[c]+o[c+2])return!0}return!1}function pointCrossPolygon(e,t,i,n,l){for(var o=0;o<l.length;o++){var a=l[o],s=l[(o+1)%l.length];if(secants(e,t,i,n,a[0],a[1],s[0],s[1]))return!0}return!1}function canMoveTo(e,t,n,l,o,a,s){var r=e+l,p=t+o;if(oMap.decor)for(var d in oMap.decor)for(var c=decorBehaviors[d],u=c.hitbox||5,m=c.hitboxH||4,y=0,h;y<oMap.decor[d].length;y++)if(h=oMap.decor[d][y],r>h[0]-u&&r<h[0]+u&&p>h[1]-u&&p<h[1]+u&&Math.abs((h[3]?h[3]:0)-n)<m){if(null==h[3]&&e>h[0]-u&&e<h[0]+u&&t>h[1]-u&&t<h[1]+u)continue;if(!a||c.unbreaking){if(collisionDecor=d,collisionTest!=COL_KART)collisionTest==COL_OBJ&&collisionItem&&c.damagingItems&&c.damagingItems[collisionItem.type]&&handleDecorHit(y,d);else if((c.breaking||isBreakingItem(c))&&4<collisionPlayer.speed&&(handleDecorHit(y,d),collisionPlayer.turbodrift&&(collisionPlayer.turbodrift=0),c.bonus&&(!isOnline||collisionPlayer==oPlayers[0]&&!onlineSpectatorId))){var g="champi";"CM"!=course&&.5>Math.random()&&(g="banane"),addNewItem(collisionPlayer,{type:g,team:collisionPlayer.team,x:r+2.5*l,y:p+2.5*o,z:0})}if(c.transparent)continue;return!1}handleDecorHit(y,d);break}if(n>jumpHeight0&&!oMap.collisionProps)return!0;if(!oMap.collision)return!0;if(!isCup)if("BB"==course||20>=oMap.map){if(e>oMap.w-5||t>oMap.h-5||4>e||4>t)return!0;}else if(e>=oMap.w||t>=oMap.h||0>e||0>t)return!0;for(var b=0,f=oMap.collision.rectangle,y=0;y<f.length;y++)pointInRectangle(e,t,f[y])&&(b=Math.max(b,getZoneHeight(oMap.collisionProps.rectangle,y)));for(var x=oMap.collision.polygon,y=0;y<x.length;y++)pointInPolygon(e,t,x[y])&&(b=Math.max(b,getZoneHeight(oMap.collisionProps.polygon,y)));if(oMap.elevators){for(var v=oMap.elevators.rectangle,y=0,C;y<v.length;y++)C=v[y],pointInRectangle(e,t,C[0])&&!(s<getPointHeight(C[1][0]))&&(b=Math.max(b,getPointHeight(C[1][1])));for(var k=oMap.elevators.polygon,y=0,E;y<k.length;y++)E=k[y],pointInPolygon(e,t,E[0])&&!(s<getPointHeight(E[1][0]))&&(b=Math.max(b,getPointHeight(E[1][1])))}if(s&&(n+=s),b){if(!oMap.collisionProps)return!0;b>n&&(n=b),collisionFloor={z:b}}if(!isCup&&n<=jumpHeight0)if("BB"==course||20>=oMap.map){if(r>oMap.w-5||p>oMap.h-5||4>r||4>p)return!1;}else if(r>=oMap.w||p>=oMap.h||0>r||0>p)return!1;for(var y=0;y<f.length;y++)if(pointCrossRectangle(e,t,l,o,f[y])&&pointInAltitude(oMap.collisionProps.rectangle,y,n))return!1;for(var y=0;y<x.length;y++)if(pointCrossPolygon(e,t,r,p,x[y])&&pointInAltitude(oMap.collisionProps.polygon,y,n))return!1;return!0}function getLineHorizontality(e,t,n,l,o){for(var a=null,s=1,r=0;r<o.length;r++){var p=o[r],d=secants(e,t,n,l,p.x1,p.y1,p.x2,p.y2);d&&d[0]<s&&(s=d[0],a={dir:[p.x2-p.x1,p.y2-p.y1],t:s})}return a}function isBreakingItem(e){return!!e.damagingItems&&(!!(e.damagingItems.megachampi&&collisionPlayer.megachampi)||!!(e.damagingItems.billball&&collisionPlayer.billball)||!!(e.damagingItems.etoile&&collisionPlayer.etoile)||!!(e.damagingItems.champi&&collisionPlayer.champi&&1===collisionPlayer.champiType)||void 0)}function secants(e,t,i,n,o,a,s,r){var p=-i*r+i*a+e*r-e*a+s*n-s*t-o*n+o*t,d=(-s*t+o*t-e*a+e*r+s*a-o*r)/p;if(0<=d&&1>=d){var l=(e*n-i*t+i*a-e*a-o*n+o*t)/p;if(0<=l&&1>=l)return[d,l]}return null}function intersectionLineLine(e,t,i,n,l,o,a,s){var r=-i*s+i*o+e*s-e*o+a*n-a*t-l*n+l*t;return[(-a*t+l*t-e*o+e*s+a*o-l*s)/r,(e*n-i*t+i*o-e*o-l*n+l*t)/r]}function projete(e,t,i,n,l,o){var a=(l-i)*(l-i)+(o-n)*(o-n);return a?(-i*l+i*i+e*l-e*i-n*o+n*n+t*o-t*n)/a:1}function intersectionLineCircle(e,t,i,n,l,o,a){var s=i*i,r=o*o,p=a*a,d=-r*(l*l)+2*r*t*l+2*o*a*n*l-2*o*a*e*l-r*(t*t)-2*o*a*n*t+2*o*a*e*t-p*(n*n)+2*p*e*n-p*(e*e)+s*p+s*r;if(0<=d){return(Math.sqrt(d)-(a*l-a*t+o*n-o*e))/(r+p)}return NaN}function followCircleWithAngle(e,t,i,n,o,a){var s=Math.hypot(o,a),p=Math.hypot(i-e,n-t),l=Math.atan2(a,o)-Math.atan2(n-t,i-e),d=Math.sin(l);if(s&&d){var c=p/(2*d);return[i-a*c/s,n+o*c/s,c]}return[i,n,p]}function nextAiStop(e,t,i,n,l,o,a,s,p){var r=Math.hypot(i,n),d=Math.hypot(a,s),c=a*n-i*s;if(r&&d&&c)for(var u=-1;2>u;u+=2)for(var m=-1;2>m;m+=2){var y=(i*(-p*m*d+a*(o-t)-s*l)+a*p*u*r+n*a*e)/c,h=(n*(-p*m*d+a*o+s*(e-l))+s*p*u*r-i*s*t)/c,g=-u*(n*p)/r,b=u*(i*p)/r,f=-m*(s*p)/d,x=m*(a*p)/d,v=projete(y+g,h+b,e,t,e+i,t+n),C=projete(y+f,h+x,l,o,l+a,o+s);if(1>=v&&0<=C)return v}return 0<i*a+n*s?1:0}function aiMarginLimitSpeed(t,i,n,l,a,s,p,d,c,u){for(var o=Math.hypot(p,d),m=1/0,y=-1;2>y;y+=2){var h=a+y*d*c/o,g=s-y*p*c/o,b=aiMarginLimitRadius(t,i,n,l,h,g,p,d);b<m&&(m=b)}return 2*m*u}function aiMarginLimitRadius(t,i,n,l,o,a,s,r){var p=o-t,d=a-i,c=n*n*r*r-2*n*l*s*r+l*l*s*s,u=n*n*(r*r*r*r+s*s*r*r)+n*l*s*r*(-2*r*r-2*s*s)+l*l*s*s*(r*r+s*s);if(c&&u)for(var m=-1;2>m;m+=2){var y=Math.hypot(n,l),h=Math.hypot(s,r),g=(l*(-m*p*y*r*h+m*d*y*s*h+n*(p*s*r-d*s*s))+l*l*(p*r*r-d*s*r))/c,b=-(n*(m*d*y*s*h-m*p*y*r*h)+n*l*(p*r*r-d*s*r)+n*n*(p*s*r-d*s*s))/c,f=(l*r*r*(m*d*y*s*h-m*p*y*r*h)+n*s*r*(m*d*y*s*h-m*p*y*r*h)+l*l*r*(p*r*r*r-d*s*r*r+p*s*s*r-d*s*s*s)+n*n*r*(p*r*r*r-d*s*r*r+p*s*s*r-d*s*s*s))/u,x=-(l*s*r*(m*d*y*s*h-m*p*y*r*h)+n*s*s*(m*d*y*s*h-m*p*y*r*h)+l*l*s*(p*r*r*r-d*s*r*r+p*s*s*r-d*s*s*s)+n*n*(p*s*r*r*r-d*s*s*r*r+p*s*s*s*r-d*s*s*s*s))/u,v=Math.atan2(x,f)-Math.atan2(b,g),C=rotateVector(n,l,v),k=C[0]*s-C[1]*r;if(0<=k)return Math.hypot(g,b)}return 1/0}function rotateVector(e,t,i){var n=Math.cos(i),l=Math.sin(i);return[e*n-t*l,e*l+t*n]}function getHorizontality(e,t,n,l,o,a){function s(l,o,a){for(var s=l.rectangle,c=0;c<s.length;c++){var u=o(s[c]),m=[{x1:u[0],y1:u[1],x2:u[0]+u[2],y2:u[1]},{x1:u[0],y1:u[1],x2:u[0],y2:u[1]+u[3]},{x1:u[0]+u[2],y1:u[1],x2:u[0]+u[2],y2:u[1]+u[3]},{x1:u[0],y1:u[1]+u[3],x2:u[0]+u[2],y2:u[1]+u[3]}],y=getLineHorizontality(e,t,p,d,m);y&&y.t<r.t&&a("rectangle",c,n)&&(r=y)}for(var h=l.polygon,c=0;c<h.length;c++){for(var m=[],g=o(h[c]),b=0;b<g.length;b++){var f=g[b],x=g[(b+1)%g.length];m.push({x1:f[0],y1:f[1],x2:x[0],y2:x[1]})}var y=getLineHorizontality(e,t,p,d,m);y&&y.t<r.t&&a("polygon",c,n)&&(r=y)}}a||(a={});var r={t:1},p=e+l,d=t+o;if(isCup||("BB"==course||20>=oMap.map?((p>oMap.w-5||4>p)&&(r.dir=[0,oMap.h]),(d>oMap.h-5||4>d)&&(r.dir=[oMap.w,0])):((p>=oMap.w||0>p)&&(r.dir=[0,oMap.h]),(d>=oMap.h||0>d)&&(r.dir=[oMap.w,0]))),oMap.decor&&!a.skipDecor)for(var c in oMap.decor)for(var u=0;u<oMap.decor[c].length;u++){var m=oMap.decor[c][u],y=decorBehaviors[c].hitbox||5,h=[{x1:m[0]-y,y1:m[1]-y,x2:m[0]+y,y2:m[1]-y},{x1:m[0]-y,y1:m[1]-y,x2:m[0]-y,y2:m[1]+y},{x1:m[0]-y,y1:m[1]+y,x2:m[0]+y,y2:m[1]+y},{x1:m[0]+y,y1:m[1]-y,x2:m[0]+y,y2:m[1]+y}],g=getLineHorizontality(e,t,p,d,h);g&&g.t<r.t&&(r=g)}if(oMap.collision&&s(oMap.collision,function(e){return e},function(e,t,i){return pointInAltitude(oMap.collisionProps[e],t,i)}),a.holes&&oMap.trous)for(var b in oMap.trous)s(oMap.trous[b],function(e){return e[0]},function(){return!0});if(r.dir){var f=Math.hypot(r.dir[0],r.dir[1]);r.dir[0]/=f,r.dir[1]/=f}else a.nullableRes||(r.dir=[.7,.7]);return r.dir}function normalizeAngle(e,t){return e-t*Math.round(e/t)}function nearestAngle(e,t,i){return e+i*Math.round((t-e)/i)}function nearestAngleMirrored(e,t,i){return nearestAngle(e*getMirrorFactor(),t,i)}function getNearestHoleDist(e,t,n){var l=n||1/0;if(!oMap.trous)return l;for(var o in collisionItem=null,oMap.trous){for(var a=oMap.trous[o].rectangle,s=0,r;s<a.length;s++)if(r=a[s][0],l=getHoleSegmentDist(l,e,t,r[0],r[1],r[2],0),l=getHoleSegmentDist(l,e,t,r[0],r[1],0,r[3]),l=getHoleSegmentDist(l,e,t,r[0],r[1]+r[3],r[2],0),l=getHoleSegmentDist(l,e,t,r[0]+r[2],r[1],0,r[3]),l<n)return l;for(var p=oMap.trous[o].polygon,s=0,r;s<p.length;s++){r=p[s][0];for(var d=0,c;d<r.length;d++)c=(d+1)%r.length,l=getHoleSegmentDist(l,e,t,r[d][0],r[d][1],r[c][0],r[c][1]);if(l<n)return l}}return l}function getHoleSegmentDist(e,t,i,n,o,a,s){var r=projete(t,i,n,o,n+a,o+s);0>r&&(r=0),1<r&&(r=1);var p=n+r*a,d=o+r*s,c=p-t,u=d-i,m=c*c+u*u;return m>e?e:canMoveTo(t,i,0,c,u)?m:e}function objet(e,t){for(var n=-1,l=0,o=0,a;o<oMap.arme.length;o++)if(a=oMap.arme[o],e>a[0]-7&&e<a[0]+7&&t>a[1]-7&&t<a[1]+7&&a[2].active){var s=a[2].box.length;s>l&&(n=o,l=s)}if(-1!==n){var r=oMap.arme[n][2];r.active=!1,r.countdown=20;for(var p=0,d;p<l;p++){d=r.box[p];for(var c=0;c<strPlayer.length;c++)d[c].div.style.display="none"}}return n}function touche_piece(e,t){if(oMap.coins)for(var n=0,l;n<oMap.coins.length;n++)if(l=oMap.coins[n],e>l.x-5&&e<l.x+5&&t>l.y-5&&t<l.y+5)return l.sprite[0].suppr(),oMap.coins.splice(n,1),!0;return!1}function sauts(e,t,n,l){if(!oMap.sauts)return!1;for(var o=oMap.sauts.rectangle,a=0,s;a<o.length;a++){if(s=o[a],pointInRectangle(e,t,s[0]))return s[1];if(pointCrossRectangle(e,t,n,l,s[0]))return s[1]}for(var r=oMap.sauts.polygon,a=0,s;a<r.length;a++){if(s=r[a],pointInPolygon(e,t,s[0]))return s[1];if(pointCrossPolygon(e,t,e+n,t+l,s[0]))return s[1]}return!1}function handleJump(e,t){if(t&&!e.tourne){var i=1.5*t;return e.heightinc=i*Math.pow(cappedRelSpeed(e),-.7),1<fSelectedClass&&.7*e.heightinc*e.heightinc<jumpHeight0&&(e.z=Math.max(e.z,i*i-e.heightinc*e.heightinc)),!0}return!1}function handleHeightInc(e){return e.z+=.7*e.heightinc*Math.abs(e.heightinc),e.heightinc-=.5,!!(0>=e.z)&&(e.heightinc=0,e.z=0,!0)}function handleCannon(e,t){if(t&&(t[0]||t[1])){if(e.cannon=[e.x+t[0],e.y+t[1],e.x,e.y],e.champi){var i=t[0]*t[0]+t[1]*t[1];5e4<i&&(e.champi=0,delete e.champiType)}return e.z||(e.z=.001),e.heightinc=0,!0}return!1}function ralenti(e,t){for(var n in oMap.horspistes){for(var l=oMap.horspistes[n],o=l.rectangle,a=0;a<o.length;a++)if(pointInRectangle(e,t,o[a]))return n;for(var s=l.polygon,a=0;a<s.length;a++)if(pointInPolygon(e,t,s[a]))return n}return!1}function getOffroadProps(e,t){return"herbe"===t?{speed:1.9+e.speedinc/2}:"glace"===t?{speed:2.8+e.speedinc/2,sliding:8}:"eau"===t?{speed:2.7,sliding:5}:"choco"===t?{speed:2.1,sliding:4}:void 0}function accelere(e,t,n,l){if(!oMap.accelerateurs)return!1;for(var o=e+n,a=t+l,s=oMap.accelerateurs.rectangle,r=0,p;r<s.length;r++){if(p=s[r],pointInRectangle(o,a,p))return!0;if(pointCrossRectangle(e,t,n,l,p))return!0}for(var d=oMap.accelerateurs.polygon,r=0;r<d.length;r++){if(pointInPolygon(o,a,d[r]))return!0;if(pointCrossPolygon(e,t,o,a,d[r]))return!0}return!1}function flowShift(e,t,n){if(oMap.flows){for(var l=oMap.flows.rectangle,o=0,a;o<l.length;o++)if(a=l[o],pointInRectangle(e,t,a[0])&&(!n||a[2]))return[a[1][0],a[1][1],0];for(var s=oMap.flows.polygon,o=0,a;o<s.length;o++)if(a=s[o],pointInPolygon(e,t,a[0])&&(!n||a[2]))return[a[1][0],a[1][1],0]}if(oMap.spinners)for(var r=oMap.spinners,o=0;o<r.length;o++){var p=r[o],d=e-p[0],c=t-p[1];if(d*d+c*c<p[2]*p[2])return[c*p[3],-d*p[3],p[3]]}return[0,0,0]}function tombe(e,t,n){var l;e>oMap.w?(e=oMap.w-.5,l=!0):0>=e&&(e=.5,l=!0),t>oMap.h?(t=oMap.h-.5,l=!0):0>=t&&(t=.5,l=!0);var o;if(oMap.trous)for(var a in oMap.trous){for(var s=oMap.trous[a].rectangle,r=0,p;r<s.length;r++)if(p=s[r],pointInRectangle(e,t,p[0])){if(null==n)return!0;if(o=[p[1][0],p[1][1],a],a%2-n)return o}for(var d=oMap.trous[a].polygon,r=0,p;r<d.length;r++)if(p=d[r],pointInPolygon(e,t,p[0])){if(null==n)return!0;if(o=[p[1][0],p[1][1],a],a%2-n)return o}}if(o)return o;if(l){var c;return c=null==oMap.startposition[2]?null==oMap.startrotation?2:oMap.startrotation/90:oMap.startposition[2],"BB"==course||[oMap.startposition[0],oMap.startposition[1],c]}return!1}function inCannon(e,t,n,l){if(!oMap.cannons)return!1;for(var o=oMap.cannons.rectangle,a=0,s;a<o.length;a++)if(s=o[a],pointInRectangle(n,l,s[0]))return s[1];for(var r=oMap.cannons.polygon,a=0,s;a<r.length;a++)if(s=r[a],pointInPolygon(n,l,s[0]))return s[1];for(var a=0,s;a<o.length;a++)if(s=o[a],pointCrossRectangle(e,t,n-e,l-t,s[0]))return s[1];for(var a=0,s;a<r.length;a++)if(s=r[a],pointCrossPolygon(e,t,n,l,s[0]))return s[1];return!1}function inTeleport(e,t){if(!oMap.teleports)return!1;for(var n=oMap.teleports.rectangle,l=0,o;l<n.length;l++)if(o=n[l],pointInRectangle(e,t,o[0]))return o[1];for(var a=oMap.teleports.polygon,l=0,o;l<a.length;l++)if(o=a[l],pointInPolygon(e,t,o[0]))return o[1]}function getActualGameTimeMS(){return null==timerMS?67*(timer-1):timerMS}function getActualGameTime(){return getActualGameTimeMS()/1e3}function addChallengeHud(e,t){if(!clHud[e]){var i=document.createElement("div");i.innerHTML="<span>"+t.title+":</span> <span>"+t.value+"</span>"+(null==t.out_of?"":"/<span>"+t.out_of+"</span>");var n=i.getElementsByTagName("span");oChallengeCpts.appendChild(i),clHud[e]={$cpt:i,$label:n[0],$value:n[1],$outOf:n[2]}}}function updateChallengeHud(e,t){clHud[e]&&(clHud[e].$value.innerText=t)}function addCreationChallenges(e,t){var n=challenges[e][t];if(n)for(var l=n.list,o=0,a;o<l.length;o++)if(a=l[o],!(a.succeeded&&a!==clSelected)){var s=a.data,r=challengeRules[s.goal.type].verify;challengesForCircuit[r].push(a);for(var p=listChallengeRules(s),d=!1,c=0,u;c<p.length;c++)u=p[c],"cc"===u.type&&(d=!0),initChallengeRule(a,u);if(!d){var u={type:"cc",value:150,mirror:null};s.constraints.push(u),initChallengeRule(a,u)}}}function listChallengeRules(e){var t=e.constraints.slice(0);return t.unshift(e.goal),t}function initChallengeRule(e,t){challengeRules[t.type].initRuleVars&&(!clRuleVars[e.id]&&(clRuleVars[e.id]={}),!clRuleVars[e.id][t.type]&&(clRuleVars[e.id][t.type]=challengeRules[t.type].initRuleVars(e,t)))}function reinitChallengeVars(){for(var e in challengesForCircuit)for(var t=challengesForCircuit[e],n=0;n<t.length;n++)for(var l=t[n],o=l.data,a=listChallengeRules(o),s=0;s<a.length;s++)initChallengeRule(l,a[s]);reinitLocalVars()}function isSameDistrib(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++){var l=e[n],o=t[n];for(var a in l)if(l[a]!==o[a])return!1;for(var a in o)if(l[a]!==o[a])return!1}return!0}function reinitLocalVars(){if(clLocalVars={drifted:!1,revDrifted:!1,stunted:!1,itemsGot:!1,itemsUsed:!1,falls:0,jumps:0,cannons:0,miniTurbo:0,superTurbo:0,stunts:0,lostBalloons:0,inflatedBalloons:0,cheated:!1},ptsDistribution.value)clLocalVars.cheated=!0;else if(itemDistribution.value&&!itemDistribution.isSetup){for(var e=itemDistributions[getItemMode()],t=!1,n=0;2>n;n++)if(isSameDistrib(itemDistribution.value,e[n].value)){t=!0;break}t||(clLocalVars.cheated=!0)}for(var l in clHud={},challengesForCircuit)for(var o=challengesForCircuit[l],n=0;n<o.length;n++)for(var a=o[n],s=a.data,r=listChallengeRules(s),p=0;p<r.length;p++){var d=r[p],c=clRuleVars[a.id]?clRuleVars[a.id][d.type]:void 0;challengeRules[d.type].initLocalVars&&challengeRules[d.type].initLocalVars(d,c),clSelected===a&&challengeRules[d.type].initSelected&&challengeRules[d.type].initSelected(d,c)}}function challengeCheck(e,t){if(!clLocalVars.cheated&&!(1<strPlayer.length))for(var n=challengesForCircuit[e],l=0,o;l<n.length;l++)if(o=n[l],!(clLocalVars.isSetup&&o!==clSelected)){var a=listChallengeRules(o.data),s=challengeRulesSatisfied(o,a);if(s){var r=o.data.goal,p=challengeRules[r.type].post_success;if(p){var d=clRuleVars[o.id]?clRuleVars[o.id][r.type]:void 0;if(!p(r,d,o))return!1}}!0===s?(challengeSucceeded(o),n.splice(l,1),l--):!1===s||challengeRules[a[0].type].reset_on_fail?(delete clRuleVars[o.id],n.splice(l,1),l--):challengeHandleEvents(o,t)}}function challengeHandleEvents(e,t){if(t){var n=clRuleVars[e.id];if(n)for(var l=listChallengeRules(e.data),o=0,a;o<t.length;o++){a=t[o];for(var s=0,r;s<l.length;s++)r=l[s],challengeRules[r.type][a]&&challengeRules[r.type][a](n[r.type])}}}function challengeHandleFail(){clSelectionFail||(clSelectionFail=!0,clHud={},oChallengeCpts.innerHTML="",1<timer&&showClFailedPopup())}function challengeRulesSatisfied(e,t){for(var n=!0,l=0,o;l<t.length;l++){if(o=challengeRuleSatisfied(e,t[l]),!1===o)return!1;!0!==o&&(n=!1)}return!!n||null}function challengeRuleSatisfied(e,t){var i=clRuleVars[e.id]?clRuleVars[e.id][t.type]:void 0;return challengeRules[t.type].success(t,i,e)}function challengeSucceeded(e){if(!(e.succeeded&&e!==clSelected)){var t=e.succeeded;return e.succeeded=!0,clSelected==e&&(clSelected=void 0,clHud={}),"pending_completion"===e.status&&(e.status="pending_publication"),delete clRuleVars[e.id],t?void setTimeout(function(){showChallengePopup(e,{})},1):void xhr("challengeSucceeded.php","id="+e.id,function(t){if(!t)return!1;var n;try{n=JSON.parse(t)}catch(t){return!1}if(showChallengePopup(e,n),n.rewards)for(var l=0,o;l<n.rewards.length;l++){o=n.rewards[l].id;for(var a=0;a<clRewards.length;a++)if(clRewards[a].id==o){clRewards[a].unlocked=1;break}}return!0})}}function showChallengePartialSuccess(e,t){function i(){1>d?(l.style.opacity=d,d+=.2,setTimeout(i,40)):l.style.opacity=1}var n=document.getElementById("challenge-popup-"+e.id);if(!n){var l=document.createElement("div");l.id="challenge-popup-"+e.id,l.className="challenge-popup challenge-popup-partial",l.style.width=56*iScreenScale+"px",l.style.left=12*iScreenScale+"px",l.style.top=Math.round(4.5*iScreenScale)+"px",l.style.padding=Math.round(1.5*iScreenScale)+"px",l.style.paddingBottom=5*iScreenScale+"px",l.style.border="inset "+Math.round(.5*iScreenScale)+"px #07B",l.style.fontSize=2*iScreenScale+"px",l.style.opacity=0;var o=language?"Challenge being completed":"D\xE9fi en cours de r\xE9ussite",a=e.description.main,s=language?"Cups completed: "+t.nb+"/"+t.total:"Coupes r\xE9ussies: "+t.nb+"/"+t.total,r=language?"Close":"Fermer";l.innerHTML="<div style=\"font-size: "+Math.round(2*iScreenScale)+"px\"><img src=\"images/cups/cup2.png\" alt=\"star\" class=\"pixelated\" style=\"width:"+Math.round(2.5*iScreenScale)+"px\" /> <h1 class=\"challenge-popup-title\" style=\"margin:"+Math.round(iScreenScale/2)+"px 0; font-size: "+Math.round(3.25*iScreenScale)+"px\">"+o+"</h1></div><div class=\"challenge-popup-header\" style=\"font-size: "+Math.round(2.25*iScreenScale)+"px\">"+a+"</div><div class=\"challenge-popup-award\" style=\"margin:"+iScreenScale+"px 0\">"+s+"</div><div class=\"challenge-popup-close\" style=\"font-size:"+2*iScreenScale+"px;bottom:"+iScreenScale+"px;right:"+Math.round(1.25*iScreenScale)+"px\"><a href=\"javascript:closeChallengePopup("+e.id+");\">"+r+"</a></div>";var p=document.getElementsByClassName("challenge-popup");p.length?$mkScreen.insertBefore(l,p[0]):$mkScreen.appendChild(l);var d=0;i(),focusOnChallengeClose()}}function showChallengePopup(e,t){function n(){1>w?(a.style.opacity=w,w+=.2,setTimeout(n,40)):a.style.opacity=1}var l=document.getElementById("challenge-popup-"+e.id);if(!l){var o=t.pts,a=document.createElement("div");a.id="challenge-popup-"+e.id,a.className="challenge-popup",a.style.width=56*iScreenScale+"px",a.style.left=12*iScreenScale+"px",a.style.top=Math.round(4.5*iScreenScale)+"px",a.style.padding=Math.round(1.5*iScreenScale)+"px",a.style.paddingBottom=5*iScreenScale+"px",a.style.border="inset "+Math.round(.5*iScreenScale)+"px #7B0",a.style.fontSize=2*iScreenScale+"px",a.style.opacity=0;var s=language?"Challenge completed!":"D\xE9fi r\xE9ussi !",r=e.description.main,p=(language?"You receive a reward of <strong>"+o+" pt"+(2<=o?"s":"")+"</strong>.":"Vous recevez <strong>"+o+" pt"+(2<=o?"s":"")+"</strong> en r\xE9compense.")+"<br />",d="";if(t.pts_advent){var c=t.pts_advent,u=c+"";t.pts_advent_extra&&(u+="+"+t.pts_advent_extra,c+=t.pts_advent_extra),d="<div class=\"challenge-popup-award-advent\">\uD83C\uDF81 "+(language?"Advent calendar: you receive a bonus reward of <strong>"+u+" pt"+(2<=c?"s":"")+"</strong>!!":"Calendrier de l'avent : vous recevez un bonus de <strong>"+u+" pt"+(2<=c?"s":"")+"</strong> !!")+"</div>",o||(o=!0,p="")}var m=language?"Your challenge points go from <strong>"+t.pts_before+"</strong> to <strong>"+t.pts_after+"</strong>!":"Vos points d\xE9fis passent de <strong>"+t.pts_before+"</strong> \xE0 <strong>"+t.pts_after+"</strong> !",y=language?"Close":"Fermer";if(a.innerHTML="<div style=\"font-size: "+Math.round(2*iScreenScale)+"px\"><img src=\"images/cups/cup1.png\" alt=\"star\" class=\"pixelated\" style=\"width:"+Math.round(2.5*iScreenScale)+"px\" /> <h1 class=\"challenge-popup-title\" style=\"margin:"+Math.round(iScreenScale/2)+"px 0; font-size: "+Math.round(3.25*iScreenScale)+"px\">"+s+"</h1></div><div class=\"challenge-popup-header\" style=\"font-size: "+Math.round(2.25*iScreenScale)+"px\">"+r+"</div>"+(o?"<div class=\"challenge-popup-award\" style=\"margin:"+iScreenScale+"px 0\">"+p+d+m+"</div>":"")+(0<=t.rating?"<div class=\"challenge-rating\" style=\"margin-left:"+Math.round(3.5*iScreenScale)+"px;font-size:"+Math.round(2.5*iScreenScale)+"px\">"+toLanguage("Rate this challenge:","Notez ce d\xE9fi :")+"<div class=\"challenge-rating-stars\"></div><div class=\"challenge-rated\">"+toLanguage("Thanks","Merci")+"</div></div>":"")+(t.publish?"<div class=\"challenge-publish\" style=\"margin:"+iScreenScale+"px 0\">"+toLanguage("You can now","Vous pouvez maintenant")+" <a href=\"javascript:publishChallenge("+e.id+")\">"+toLanguage("publish challenge","publier le d\xE9fi")+"</a>.</div>":"")+"<div class=\"challenge-popup-close\" style=\"font-size:"+2*iScreenScale+"px;bottom:"+iScreenScale+"px;right:"+Math.round(1.25*iScreenScale)+"px\"><a href=\"javascript:closeChallengePopup("+e.id+");\">"+y+"</a></div>",0<=t.rating){var h=a.getElementsByClassName("challenge-rating-stars");h=h[0],h.style.position="relative",h.style.marginLeft=Math.round(.4*iScreenScale)+"px",h.style.marginRight=Math.round(.4*iScreenScale)+"px",h.style.top=Math.round(.4*iScreenScale)+"px";var g=a.getElementsByClassName("challenge-rated");g=g[0];for(var b=[],f=function(){for(var e=+this.rating,t=0;t<e;t++)b[t].src="images/star1.png";for(var t=e;5>t;t++)b[t].src="images/star0.png"},x=function(){for(var e=0;e<t.rating;e++)b[e].src="images/star1.png";for(var e=t.rating;5>e;e++)b[e].src="images/star0.png"},v=function(){var n=+this.rating;t.rating=t.rating==n?0:n,x(),g.style.visibility="hidden",xhr("challengeRate.php","challenge="+e.id+"&rating="+t.rating,function(e){return 1==e&&(g.style.visibility="visible",!0)})},C=0,k;5>C;C++)k=document.createElement("img"),k.alt="S",k.src="images/star0.png",k.style.width=3*iScreenScale+"px",k.style.marginLeft=Math.round(.4*iScreenScale)+"px",k.style.marginRight=Math.round(.4*iScreenScale)+"px",k.rating=C+1,k.onmouseover=f,k.onmouseout=x,k.onclick=v,b[C]=k,h.appendChild(k);x()}var E=document.getElementsByClassName("challenge-popup");E.length?$mkScreen.insertBefore(a,E[0]):$mkScreen.appendChild(a);var w=0;if(n(),!pause&&document.onkeydown&&(clLocalVars.forcePause=!0,doPressKey("pause"),delete clLocalVars.forcePause),(bMusic||iSfx)&&!challengeMusic&&(challengeMusic=playSoundEffect("musics/events/challenge.mp3"),challengeMusic.className="",endGPMusic?(pauseMusic(endGPMusic),challengeMusic.onended=function(){unpauseMusic(endGPMusic),challengeMusic=null}):willPlayEndMusic?(willPlayEndMusic=!1,challengeMusic.onended=function(){unpauseMusic(endingMusic),isEndMusicPlayed=!0,challengeMusic=null}):isEndMusicPlayed?(pauseMusic(endingMusic),challengeMusic.onended=function(){unpauseMusic(endingMusic),isEndMusicPlayed=!0,challengeMusic=null}):challengeMusic.onended=function(){challengeMusic=null}),t.unlocked)for(var C=0;C<t.unlocked.length;C++)showChallengeRewardPopup(t.unlocked[C]);focusOnChallengeClose()}}function showChallengeRewardPopup(e){function t(){1>p?(n.style.opacity=p,p+=.2,setTimeout(t,40)):n.style.opacity=1}var i=document.getElementById("challenge-popup-reward-"+e.id);if(!i){var n=document.createElement("div");n.id="challenge-popup-reward-"+e.id,n.className="challenge-popup",n.style.width=56*iScreenScale+"px",n.style.left=12*iScreenScale+"px",n.style.top=Math.round(4.5*iScreenScale)+"px",n.style.padding=Math.round(1.5*iScreenScale)+"px",n.style.paddingBottom=5*iScreenScale+"px",n.style.border="inset "+Math.round(.5*iScreenScale)+"px #7B0",n.style.fontSize=2*iScreenScale+"px",n.style.opacity=0;var l=language?"New character unlocked!":"Nouveau perso d\xE9bloqu\xE9 !",o=language?"You can now play with <strong>"+e.name+"</strong>!":"Vous pouvez d\xE9sormais jouer avec <strong>"+e.name+"</strong> !",a=document.createElement("img");a.src=getSpriteSrc(e.sprites),a.alt=e.name,a.className="pixelated",a.style.visibility="hidden";var s=language?"Close":"Fermer";n.innerHTML="<div style=\"font-size: "+Math.round(2*iScreenScale)+"px\"><img src=\"images/cups/cup1.png\" alt=\"star\" class=\"pixelated\" style=\"width:"+Math.round(2.5*iScreenScale)+"px\" /> <h1 class=\"challenge-popup-title\" style=\"margin:"+Math.round(iScreenScale/2)+"px 0; font-size: "+Math.round(3.25*iScreenScale)+"px\">"+l+"</h1></div><div class=\"challenge-popup-header\" style=\"font-size: "+Math.round(2.25*iScreenScale)+"px\">"+o+"</div><div class=\"challenge-popup-reward-ch\"></div><div class=\"challenge-popup-close\" style=\"font-size:"+2*iScreenScale+"px;bottom:"+iScreenScale+"px;right:"+Math.round(1.25*iScreenScale)+"px\"><a href=\"javascript:closeChallengePopup(&quot;reward-"+e.id+"&quot;);\">"+s+"</a></div>",n.getElementsByClassName("challenge-popup-reward-ch")[0].appendChild(a),a.onload=function(){var e=this.parentNode,t=iScreenScale/8,i=Math.round(t*this.naturalWidth/24),n=Math.round(t*this.naturalHeight);e.style.width=i+"px",e.style.height=n+"px",this.style.width=24*i+"px",this.style.height=n+"px",this.style.visibility=""};var r=document.getElementsByClassName("challenge-popup");r.length?$mkScreen.insertBefore(n,r[0]):$mkScreen.appendChild(n);var p=0;t()}}function focusOnChallengeClose(){var e=document.querySelectorAll(".challenge-popup .challenge-popup-close a");if(e.length)e[e.length-1].focus();else{var t=document.getElementById("reprendre");if(t)t.focus();else{var i=document.getElementById("octn");i&&i.focus()}}}function showClSelectedPopup(){function e(){0<i?(t.style.opacity=i,i-=.04,setTimeout(e,40)):document.body.removeChild(t)}var t=document.createElement("div");t.style.fontSize=2*iScreenScale+"px",t.className="clselected-popup",t.style.left=27*iScreenScale+"px",t.style.top=39*iScreenScale+"px",t.innerHTML="<div class=\"clselected-close\"><a href=\"#null\">&times;</a></div><div class=\"clselected-ctn\"><div>\u2714</div><div><strong>"+toLanguage("Challenge selected :","D\xE9fi s\xE9lectionn\xE9:")+"</strong> "+(clSelected.name||clSelected.description.main)+"</div></div>",t.querySelector(".clselected-close a").onclick=function(){return document.body.removeChild(t),!1},document.body.appendChild(t);var i=1;setTimeout(e,1500)}function showClFailedPopup(){var e=document.createElement("div");e.style.position="absolute",e.style.color="#C00",e.style.right=Math.round(iScreenScale/2)+"px",e.style.top=Math.round(iScreenScale*($speedometers.length?4.8:2.5))+"px",e.style.fontSize=Math.round(1.8*iScreenScale)+"px",e.style.display="flex",e.style.alignItems="center",e.style.fontFamily="Courier New",e.innerHTML="<strong style=\"color:#800;font-size:1.8em\">&times;</strong>&nbsp;"+(language?"Challenge failed...":"D\xE9fi \xE9chou\xE9...");var t=oChallengeCpts.parentNode;t.appendChild(e),!iSfx||finishing||oPlayers[0].cpu||playSoundEffect("musics/events/clfail.mp3")}function getSessionStorage(e){return sessionStorage.getItem(e)}function setSessionStorage(e,t){sessionStorage.setItem(e,t),addUpdatingKey(e),xhr("sessionStorage.php","key="+encodeURIComponent(e)+"&value="+encodeURIComponent(t),function(i){return 1==i&&(deleteUpdatingKey(e,t),!0)})}function deleteSessionStorage(e){sessionStorage.removeItem(e),addUpdatingKey(e),xhr("sessionStorage.php","key="+encodeURIComponent(e)+"&delete",function(t){return 1==t&&(deleteUpdatingKey(e,null),!0)})}function initSessionStorage(){var e=sessionStorage.getItem("updatingKeys");if(e)for(let t in e=JSON.parse(e),e){let e=sessionStorage.getItem(t),i;i=null==e?"key="+encodeURIComponent(t)+"&delete":"key="+encodeURIComponent(t)+"&value="+encodeURIComponent(e),xhr("sessionStorage.php",i,function(i){return 1==i&&(deleteUpdatingKey(t,e),!0)})}else xhr("sessionStorage.php","",function(e){var t;try{t=JSON.parse(e)}catch(t){return!1}if(!t)return!1;var i=sessionStorage.getItem("updatingKeys");for(var n in i||(sessionStorage.setItem("updatingKeys","{}"),i={}),t)i[n]||sessionStorage.setItem(n,t[n]);return!0})}function addUpdatingKey(e){var t=JSON.parse(sessionStorage.getItem("updatingKeys"))||{};t[e]=1,sessionStorage.setItem("updatingKeys",JSON.stringify(t))}function deleteUpdatingKey(e,t){var i=JSON.parse(sessionStorage.getItem("updatingKeys"))||{};sessionStorage.getItem(e)===t?delete i[e]:i[e]=1,sessionStorage.setItem("updatingKeys",JSON.stringify(i))}function showGamePopup(t){function n(){t.container.removeChild(o),window.removeEventListener("keydown",l),t.close&&t.close()}function l(t){27===t.keyCode&&n()}var o=document.createElement("form");o.className="game-popup",o.style.fontSize=4*iScreenScale+"px",o.onsubmit=function(i){i.preventDefault(),t.submit(i),n()};var a=document.createElement("div");if(t.title){var s=document.createElement("h1");s.innerHTML=t.title,a.appendChild(s)}var r=document.createElement("div");r.className="game-popup-body";for(var p=0,e;p<t.elements.length;p++)e=document.createElement("div"),e.innerHTML=t.elements[p],r.appendChild(e);a.appendChild(r);var d=document.createElement("div");d.className="game-popup-submit";var c=document.createElement("input");return c.type="submit",c.style.fontSize=4*iScreenScale+"px",c.value=t.submitVal,d.appendChild(c),a.appendChild(d),o.appendChild(a),t.container.appendChild(o),window.addEventListener("keydown",l),o.onclick=function(t){t.target===t.currentTarget&&n()},o}function getItemMode(){return"BB"==course?"BB":"VS"}function getPointDistribution(){if(!ptsDistribution.value)return getDefaultPointDistribution(aKarts.length);for(var e=Array(aKarts.length),t=0;t<aKarts.length;t++)e[t]=ptsDistribution.value[t]||0;return e}function getDefaultPointDistribution(e){if(12==e)return[15,12,10,8,7,6,5,4,3,2,1,0];for(var t=Math.round(1.25*e),n=Array(e),l=0,o;l<e;l++)o=(e-l-1)/(e-1),n[l]=Math.round(t*(Math.exp(o)-1)/(Math.E-1));return n}function isHitSound(e){return 1==collisionTest||collisionTeam==e.team&&{x:e.x,y:e.y}}function handleHit(e){!clLocalVars.currentKart||clLocalVars.currentKart.tourne||clLocalVars.currentKart.protect||clLocalVars.currentKart.frminv&&itemBehaviors[e.type]&&itemBehaviors[e.type].frminv||(clLocalVars.hitItems&&clLocalVars.currentKart==oPlayers[0]&&incItemHits(e.type),clLocalVars.myItems&&clLocalVars.currentKart&&clLocalVars.currentKart!=oPlayers[0]&&-1!=clLocalVars.myItems.indexOf(e)&&incChallengeHits(clLocalVars.currentKart))}function handleHit2(e,t){t==oPlayers[0]?clLocalVars.hitItems&&(e.billball&&incItemHits("billball"),e.etoile&&incItemHits("etoile"),e.megachampi&&incItemHits("megachampi"),1===e.champiType&&incItemHits("champi")):e==oPlayers[0]&&incChallengeHits(t)}function handleItemHit(e,t){e===oPlayers[0]&&clLocalVars.hitItems&&incItemHits(t)}function incItemHits(e){var t;t="carapace-rouge"===e?"carapacerouge":"carapace-bleue"===e?"carapacebleue":e,clLocalVars.hitItems[t]=!0}function incChallengeHits(e){clLocalVars.nbHits++,updateChallengeHud("hits",clLocalVars.nbHits),"BB"==course&&1==e.ballons.length&&clLocalVars.killed&&-1==clLocalVars.killed.indexOf(e)&&(clLocalVars.killed.push(e),clLocalVars.nbKills++,updateChallengeHud("kills",clLocalVars.nbKills)),challengeCheck("each_hit")}function handleDecorHit(e,t){collisionDecorHit=!0,oMap.decor[t][e][2][0].suppr(),oMap.decor[t].splice(e,1),clLocalVars.nbDecorHits&&null!=clLocalVars.nbDecorHits[t]&&(clLocalVars.nbDecorHits[t]++,updateChallengeHud("decors",clLocalVars.nbDecorHits[t]),challengeCheck("each_decor_hit"))}function touche_banane(e,t,n){n||(n=[]);for(var l=0,o;l<items.banane.length;l++)if(o=items.banane[l],-1==n.indexOf(o)&&!o.z&&e>o.x-4&&e<o.x+4&&t>o.y-4&&t<o.y+4)return handleHit(o),detruit(o,isHitSound(o)),collisionTeam!=o.team;return!1}function touche_poison(e,t,n){n||(n=[]);for(var l=0,o;l<items.poison.length;l++)if(o=items.poison[l],-1==n.indexOf(o)&&!o.z&&e>o.x-4&&e<o.x+4&&t>o.y-4&&t<o.y+4)return handleHit(o),detruit(o,isHitSound(o)),collisionTeam!=o.team;return!1}function touche_champi(e,t){for(var n=0,l;n<items.champi.length;n++)if(l=items.champi[n],e>l.x-4&&e<l.x+4&&t>l.y-4&&t<l.y+4)return detruit(l),!0;return!1}function touche_fauxobjet(e,t,n){n||(n=[]);for(var l=0,o;l<items.fauxobjet.length;l++)if(o=items.fauxobjet[l],-1==n.indexOf(o)&&!o.z&&e>o.x-4&&e<o.x+4&&t>o.y-4&&t<o.y+4)return handleHit(o),detruit(o,isHitSound(o)),collisionTeam!=o.team;return!1}function touche_cverte(e,t,n){n||(n=[]);for(var l=0,o;l<items.carapace.length;l++)if(o=items.carapace[l],-1==n.indexOf(o)&&!o.z&&touche_cverte_aux(e,t,o))return collisionTeam!=o.team;return!1}function touche_cverte_aux(e,t,i){return!!(e>i.x-5&&e<i.x+5&&t>i.y-5&&t<i.y+5)&&(handleHit(i),detruit(i,isHitSound(i)),!0)}function touche_cverte_future(e,t,n){n||(n=[]);for(var l=cappedRelSpeed()/2,o=0,a;o<items.carapace.length;o++)if(a=items.carapace[o],-1==n.indexOf(a)&&!a.z){var s=a.vx*l,r=a.vy*l,p=a.x+s,d=a.y+r;if(e>p-5&&e<p+5&&t>d-5&&t<d+5)return handleHit(a),detruit(a,isHitSound(a)),collisionTeam!=a.team}return!1}function touche_crouge(e,t,n){n||(n=[]);for(var l=0,o;l<items["carapace-rouge"].length;l++)if(o=items["carapace-rouge"][l],-1==n.indexOf(o)&&touche_crouge_aux(e,t,o))return collisionTeam!=o.team;return!1}function touche_crouge_aux(e,t,i){if(!i.z){var n=-1==i.owner||-2==i.aipoint;if(n?e>i.x-5&&e<i.x+5&&t>i.y-5&&t<i.y+5:e==i.x&&t==i.y)return handleHit(i),detruit(i,isHitSound(i)),!0}return!1}function touche_bobomb(e,t,n,l){n||(n=[]);for(var o=0,a;o<items.bobomb.length;o++)if(a=items.bobomb[o],!a.z&&-1==n.indexOf(a))if(-1!=a.theta){if(touche_bobomb_aux(e,t,a,l)){if(0>=a.cooldown){var s=collisionTeam!=a.team&&(-5>a.cooldown?42:84);return s&&handleHit(a),s}a.cooldown=1,isOnline&&syncItems.push(a)}}else if(e>a.x-5&&e<a.x+5&&t>a.y-5&&t<a.y+5)for(j=0;j<aKarts.length;j++){var r=aKarts[j],p=r.using.indexOf(a);if(-1!=p){throwItem(r,{theta:1,countdown:0,cooldown:1},p),r.using.length||consumeItemIfDouble(j);break}}return!1}function touche_bobomb_aux(e,t,i,n){var l=18;return 38<=i.cooldown?l=0:30<=i.cooldown?l=5:n&&n.transparent&&(l=5),!i.countdown&&(i.x-e)*(i.x-e)+(i.y-t)*(i.y-t)<l*l}function touche_cbleue(e,t){for(var n=0,l;n<items["carapace-bleue"].length;n++)if(l=items["carapace-bleue"][n],touche_cbleue_aux(e,t,l)){var o=collisionTeam!=l.team&&(-5>l.cooldown?42:84);return o&&handleHit(l),o}for(var n=0,l;n<items["carapace-noire"].length;n++)if(l=items["carapace-noire"][n],touche_cbleue_aux(e,t,l)){var o=collisionTeam!=l.team&&(-5>l.cooldown?42:84);return o&&handleHit(l),o}return!1}function touche_cbleue_aux(e,t,i){if(0>=i.cooldown&&-10<=i.cooldown){if(!i.countdown&&576>(i.x-e)*(i.x-e)+(i.y-t)*(i.y-t))return!0}return!1}function touche_asset(e,t,n,l){for(var o=["pointers","flippers"],a=0,s;a<o.length;a++)if(s=o[a],oMap[s])for(var p=2*Math.PI,d=0;d<oMap[s].length;d++){var c=oMap[s][d],u=c[1][0],m=c[1][1],g=c[1][2]*(1-c[2][0]),b=(e-u)*(e-u)+(t-m)*(t-m);if(b<g*g){var f=c[2][2],v=Math.atan2(t-m,e-u),C=c[2][3];if((n-u)*(n-u)+(l-m)*(l-m)<g*g){var k=Math.atan2(l-m,n-u);k-=p*Math.round((k-v)/p),C-=k-v}var E=Math.sqrt(b),r=E/g,S=c[1][3]*(c[1][4]*(1-r)+c[1][5]*r),T=S/E,I;if(0<C?(v-=p*Math.floor((v-f)/p),I=v<f+C+T):(v-=p*Math.ceil((v-f)/p),I=v>f+C-T),I)return[s,c]}}{var s="bumpers";if(oMap[s])for(var a=0;a<oMap[s].length;a++){var c=oMap[s][a],u=c[1][0],m=c[1][1],g=c[1][2]/2;if((n-u)*(n-u)+(l-m)*(l-m)<g*g){if(!c[2][5]){var z=(e-u)*(e-u)+(t-m)*(t-m),B=(n-u)*(n-u)+(l-m)*(l-m);if(z<=B)continue}return[s,c]}}}{var s="oils";if(oMap[s])for(var a=0;a<oMap[s].length;a++){var c=oMap[s][a],u=c[1][0],m=c[1][1],M=Math.max(4,c[1][2]/2),S=Math.max(4,c[1][3]/2);if(Math.abs(n-u)<M&&Math.abs(l-m)<S)return[s,c]}}{var s="flowers";if(oMap[s])for(var a=0;a<oMap[s].length;a++){var c=oMap[s][a],L=c[1],H=L[0],x=L[1],y=Math.round(L[2]/2),w=Math.round(L[3]/2);if(pointInRectangle(n,l,[H-y,x-y,2*y,2*w]))return[s,c]}}return!1}function otherPlayerItems(e){return{indexOf:function(t){var n=e.indexOf(t);if(-1!==n)return n;for(var l=1,o;l<aKarts.length;l++)if(o=aKarts[l],o.controller!=identifiant&&-1!==o.using.indexOf(t))return e.length;return-1}}}function onlyThisItems(e){return{indexOf:function(t){var i=e.indexOf(t);return-1===i?0:-1}}}function distKart(e){for(var t=1/0,n=0,l;n<oPlayers.length;n++)if(l=oPlayers[n],kartIsPlayer(l)&&!finishing){var o=Math.hypot(e.x-l.x,e.y-l.y);o<t&&(t=o)}return t}function stuntKart(e){e.figstate=21,e.z+=1,e.heightinc+=.5,e==oPlayers[0]&&(clLocalVars.stunted=!0),playIfShould(e,"musics/events/stunt.mp3")}function getRankScore(e){if("BB"!=course){var t=e.demitours+1;t>=oMap.checkpoint.length&&(t=0);var i=oMap.checkpointCoords[t];if(!i)return 0;var n=projete(e.x,e.y,i.A[0],i.A[1],i.B[0],i.B[1]),l=i.A[0]+n*i.u[0],o=i.A[1]+n*i.u[1],a=Math.hypot(l-e.x,o-e.y);return e.tours*oMap.checkpoint.length+getCpScore(e)-a/1e4}return e.ballons.length?e.ballons.length+e.reserve:0}function getRankScores(){return aKarts.map(function(e){return getRankScore(e)})}function places(e,t,n){for(var l=aKarts[e],o=!n,a=0,s;a<strPlayer.length;a++)s=getPlayerAtScreen(a),s.tours>oMap.tours||s.loose?onlineSpectatorId&&!finishing&&(document.getElementById("infoPlace"+a).style.visibility="hidden"):o=!1;if(!o){var r=1;if("BB"==course||!(l.tours>oMap.tours)&&oMap.checkpoint.length){var p=t[e];for(a=0;a<aKarts.length;a++){var d=t[a];(aKarts[a]!=l&&p<d||p==d&&l.initialPlace>aKarts[a].initialPlace)&&r++}if(l.loose||(l.place=r),!finishing){var c=getScreenPlayerIndex(e);c<oPlayers.length&&(document.getElementById("infoPlace"+c).innerHTML=r)}}}}function getLastCp(e){return oMap.sections?1<e.tours&&e.tours<=oMap.tours?oMap.sections[e.tours-2]:oMap.checkpoint.length-1:0}function getNextCp(e){return oMap.sections?e.tours<=oMap.sections.length?oMap.sections[e.tours-1]:oMap.checkpoint.length-1:0}function getCpDiff(e){var t=getLastCp(e),i=getNextCp(e),n=i-t;return 0>=n&&(n+=oMap.checkpoint.length),n}function getCpScore(e){var t=getLastCp(e),i=e.demitours,n=i-t;return 0>n&&(n+=oMap.checkpoint.length),n}function distanceToFirst(e){for(var t=1/0,i=0,n;i<aKarts.length;i++)aKarts[i].place<t&&(n=aKarts[i],t=n.place);return distanceToKart(e,n)}function distanceToSecond(e){for(var t=1/0,i=0,n;i<aKarts.length;i++)aKarts[i]!=e&&aKarts[i].place<t&&(n=aKarts[i],t=n.place);return n?distanceToKart(n,e):0}function distanceToKart(e,t){var i=0,n=e.x,l=e.y,o=e.tours,a=e.demitours;for(oMap.sections&&(o=t.tours);o<t.tours||o==t.tours&&a<t.demitours;){a++,a>=oMap.checkpoint.length&&(a=0,o++);var s=oMap.checkpointCoords[a],r=s.O[0],p=s.O[1];i+=Math.hypot(r-n,p-l),n=r,l=p}return i+=Math.hypot(t.x-n,t.y-l),i}function checkpoint(e,t,n){var l=[e.x-t,e.y-n],o=e.demitours;if(!simplified)var a=getNextCp(e);for(var s=0;s<oMap.checkpointCoords.length;s++){var r=oMap.checkpointCoords[s],p=pointInQuad(e.x,e.y,r);if(!p&&200<t*t+n*n&&(secants(l[0],l[1],e.x,e.y,r.A[0],r.A[1],r.B[0],r.B[1])?p=!0:secants(l[0],l[1],e.x,e.y,r.C[0],r.C[1],r.D[0],r.D[1])&&(p=!0)),p)if(simplified){if(0==s&&5>oMap.checkpoint.length-o)return!0;if(o==s-1||o&&5>Math.abs(o-s))return e.demitours=s,!1}else{for(var d=!0,c=o+1;c>=oMap.checkpoint.length&&(c-=oMap.checkpoint.length),c!=s;c++)if(!oMap.checkpoint[c][4]){d=!1;break}if(d)return s==a||(e.demitours=s,!1)}}return!1}function getCheckpointCoords(e){var t=e[0],i=e[1],n=e[2],o=15,a;switch(e[3]){case 0:case 1:var s=e[3];a={A:[t,i],u:[s?n:0,s?0:n],v:[s?0:o,s?o:0],O:[t+(s?n/2:8),i+(s?8:n/2)]};break;default:var l=e[3]*Math.PI/2,r=7.5,p=Math.cos(l),d=Math.sin(l),c=e[2]/2-r,u=t+r+c*d,m=i+7.5+c*p,y=n*d,h=o*p,g=-n*p,b=o*d;a={A:[u-(y+h)/2,m-(g+b)/2],u:[y,g],v:[h,b],O:[u,m]};}return a.B=[a.A[0]+a.u[0],a.A[1]+a.u[1]],a.C=[a.A[0]+a.v[0],a.A[1]+a.v[1]],a.D=[a.B[0]+a.v[0],a.B[1]+a.v[1]],a}function int8ToHexString(e){return[].slice.call(e).map(function(e){return e.toString(16).padStart(2,"0")}).join("")}function hexStringToInt8(e){return new Uint8Array(e.match(/../g).map(function(e){return parseInt(e,16)})).buffer}function itemDataToHex(e,t){return"double"===e?int8ToHexString(new Uint8Array(new Float64Array([t]).buffer,0,8)):"float"===e?int8ToHexString(new Uint8Array(new Float32Array([t]).buffer,0,4)):"int"===e?int8ToHexString(new Uint8Array(new Int32Array([t]).buffer,0,4)):"short"===e?int8ToHexString(new Uint8Array(new Int16Array([t]).buffer,0,2)):"byte"===e?int8ToHexString(new Uint8Array(new Int8Array([t]).buffer,0,1)):void 0}function hexToItemData(e,t){return"double"===e?new Float64Array(hexStringToInt8(t))[0]:"float"===e?new Float32Array(hexStringToInt8(t))[0]:"int"===e?new Int32Array(hexStringToInt8(t))[0]:"short"===e?new Int16Array(hexStringToInt8(t))[0]:"byte"===e?new Int8Array(hexStringToInt8(t))[0]:void 0}function itemDataLength(e){return"double"===e?16:"float"===e?8:"int"===e?8:"short"===e?4:"byte"===e?2:void 0}function resetDatas(){var e=oPlayers[0],t="BB"==course?["x","y","z","speed","speedinc","heightinc","rotation","rotincdir","rotinc","drift","driftinc","driftcpt","size","tourne","tombe","arme","stash","ballons","reserve","champi","etoile","megachampi"]:["x","y","z","speed","speedinc","heightinc","rotation","rotincdir","rotinc","drift","driftinc","driftcpt","size","tourne","tombe","arme","stash","tours","demitours","champi","etoile","megachampi","billball","place"],n="BB"==course?[]:["finaltime"],l=t.concat("aipoint"),o={player:[],extra:{},item:[],lastcon:connecte},a=[{params:o.player,mapping:t,kart:e}];if(onlineSpectatorId)delete o.player;else{for(var s=0,r;s<aKarts.length;s++)r=aKarts[s],r.controller==identifiant&&(!o.cpu&&(o.cpu={}),o.cpu[r.id]=[],a.push({params:o.cpu[r.id],mapping:l,kart:r}));for(var p=0;p<a.length;p++){var d=a[p],c=d.params,r=d.kart,u=d.mapping;c.length=u.length;for(var s=0;s<u.length;s++){var m=u[s],y;"demitours"===m?"BB"!=course&&(y=getCpScore(r)):"ballons"===m?"BB"==course&&(y=r.ballons.length):y=r[u[s]],c[s]=y}for(var h={},s=0;s<n.length;s++)r[n[s]]&&(h[n[s]]=r[n[s]]);Object.keys(h).length&&(o.extra[r.id]=h)}}Object.keys(o.extra).length||delete o.extra;var g=Array.from(new Set(syncItems)),b=[];if(!onlineSpectatorId)for(var s=0;s<g.length;s++){var f=g[s],x="";if(!f.deleted)for(var v=itemBehaviors[f.type],p=0,C;p<v.sync.length;p++)C=v.sync[p],x+=itemDataToHex(C.type,f[C.key]||0);else if(!f.id)continue;for(var k={data:x},p=0,r;p<a.length;p++)if(r=a[p].kart,-1!==r.using.indexOf(f)){k.holder=r.id;break}f.id?k.id=f.id:(k.type=itemTypes.indexOf(f.type),b.push(f)),o.item.push(k)}syncItems.length=0,"BB"==course?o.battle=1:3!=oMap.tours&&(o.laps=oMap.tours),onlineSpectatorId&&(o.spectator=onlineSpectatorId),fetch("api/reload.php",{method:"post",body:JSON.stringify(o)}).then(function(e){return e.json()}).then(function(e){if(-1!=e){refreshDatas=!0;for(var n=e[1],o=n[0],a=n[1],s=0,r;s<o.length;s++)r=o[s],b[s]&&(b[s].id=r);for(var p=e[0],s=0;s<p.length;s++)for(var d=p[s],c=d[0][0],u=0,m;u<aKarts.length;u++)if(m=aKarts[u],m.id==c){if(d[2]){var y=d[2];if(y.controller&&(m.controller=y.controller,m.controller==identifiant))break}for(var h=d[1],g=m.x,f=m.y,x=m.rotation,v=m.etoile,C=m.billball,E=m.tombe,w=m.driftcpt,S=m.champi,T=m.arme,I=m.tours,z=m.reserve,B=m.controller?l:t,M=0;M<B.length;M++){var L=B[M],H=h[M];switch(L){case"demitours":m.demitours=(getLastCp(m)+H)%oMap.checkpoint.length;break;case"ballons":if("BB"==course){for(;m.ballons.length<H;)m.ballons.length||(m.sprite[0].div.style.opacity=1,m.sprite[0].img.style.display="",oPlanCharacters[u].style.display="block",oPlanCharacters2[u].style.display="block",m.loose=!1),addNewBalloon(m);for(;m.ballons.length>H;){var A=m.ballons.length-1;m.ballons[A][0].suppr(),m.ballons.pop()}}break;default:m[B[M]]=H;}}if(25<=m.billball&&!C?(m.sprite[0].img.src="images/sprites/sprite_billball.png",resetSpriteHeight(m.sprite[0]),m.aipoint=void 0):50<=m.etoile&&!v?m.sprite[0].img.src=getStarSrc(m.personnage):(v&&!m.etoile||C&&!m.billball)&&(m.sprite[0].img.src=getSpriteSrc(m.personnage),resumeSpriteSize(m.sprite[0])),T&&T.startsWith("champi")&&(T!==m.arme||"champior"===T)&&m.champi>S?m.champiType=1:!m.champi&&delete m.champiType,m.aipoint>=m.aipoints.length&&(m.aipoint=0),I!==m.tours){var _=getScreenPlayerIndex(u);_<oPlayers.length&&updateLapHud(_)}if(z!==m.reserve){var _=getScreenPlayerIndex(u);_<oPlayers.length&&updateBalloonHud(document.getElementById("compteur0"),m)}if(updateProtectFlag(m),E&&!m.tombe){if(m.sprite[0].img.style.display="block","BB"==course)for(var M=0;M<m.ballons.length;M++)m.ballons[M][0].img.style.display="block";var _=getScreenPlayerIndex(u);_<oPlayers.length&&(oContainers[_].style.opacity=1,resetRenderState())}if(!E&&m.tombe&&(m.sprite[0].img.style.display="none",m.frminv=10,2<m.tombe)){if("BB"==course)for(var M=0;M<m.ballons.length;M++)m.ballons[M][0].img.style.display="none";m.marker&&(m.marker.div[0].style.display="none"),m.aX=g,m.aY=f,m.aRotation=x}80<=w&&80>m.driftcpt?m.driftinc?70>m.driftcpt&&m.driftSprite[0].setState(0):resetDriftSprite(m):(80>w&&80<=m.driftcpt&&m.driftSprite[0].setState(1),160>w&&160<=m.driftcpt&&m.driftSprite[0].setState(2)),!m.turnSound&&m.tourne&&(m.turnSound=playDistSound(m,"musics/events/spin.mp3","BB"==course?80:50),!m.frminv&&(m.frminv=10)),m.turnSound&&!m.tourne&&(m.turnSound=void 0);for(var M=d[0][1];M<e[2];M++)move(u,!0);oSpecCam&&oSpecCam.playerId===u&&oSpecCam.reset({smooth:!0,since:e[2]-d[0][1]});break}var P=[];if(!onlineSpectatorId)for(var s=0,m;s<aKarts.length;s++)m=aKarts[s],s&&m.controller!=identifiant||P.push(s);for(var s=0;s<a.length;s++){var N=a[s],R=N[0],D=itemTypes[N[1]];if(D){var F=N[4],V=items[D].find(function(e){return e.id==R});V&&!F&&(supprime(V,!1),N[2]=0)}}for(var s=0;s<a.length;s++){var N=a[s],R=N[0],D=itemTypes[N[1]],O=N[2],q=N[3],F=N[4],V=items[D].find(function(e){return e.id==R}),W=!1;if(!V&&F&&(V={id:R,type:D},W=!0),F){for(var X=0,G=itemBehaviors[D],u=0;u<G.sync.length;u++){var K=G.sync[u],U=itemDataLength(K.type),Y=F.substr(X,U);Y.length==U&&(V[K.key]=hexToItemData(K.type,Y)),X+=U}W&&addNewItem(null,V)}for(var u=0;u<aKarts.length;u++){var m=aKarts[u],J=m.using.indexOf(V);m.id==O?-1==J&&(m.using.push(V),1<m.using.length&&!m.rotitem&&(m.rotitem=0)):-1!=J&&(m.using.splice(J,1),!m.using.length&&consumeItemIfDouble(u)),moveUsingItems(m,!0)}if(F&&0==O){var Q=e[2],$=itemBehaviors[D].move;if($&&!1!==itemBehaviors[D].onlineResync){function e(e){for(var t=0;t<P.length;t++){var i=P[t],n=aKarts[i];n.loose||n.tourne||n.protect||n.fell||Z(e,i)}}var Z=itemBehaviors[D].checkCollisions,ee={onlineSync:!0,checkCollisions:e};collisionTest=1;for(var M=q;M<Q&&!V.deleted;M++)$(V,ee),Z&&e(V)}}}if(connecte=e[2],e[3]){function t(){function t(){l.style.display="none";for(var t=0;t<e[3].length;t++)e[3][t][2]+=e[3][t][3];var n=e[3].length-1;for(t=0;t<n;t++){for(var s=0,r=0,p=t;p<e[3].length;p++)e[3][p][2]>=s&&(s=e[3][p][2],r=p);var d=e[3][t];e[3][t]=e[3][r],e[3][r]=d}for(t=0;t<a.length;t++){var c=e[3][t];a[t][0].innerHTML=toPerso(c[1]),a[t][1].innerHTML=c[2],o[t].style.backgroundColor=c[0]==identifiant?rankingColor(0):-1==c[4]?"":cTeamColors.primary[c[4]]}var m;if(iTeamPlay&&shareLink.options&&shareLink.options.localScore){for(var y=Array(selectedNbTeams).fill(0),t=0;t<e[3].length;t++)y[e[3][t][4]]+=e[3][t][2];m=createTeamTable(y)}var h=!0;setTimeout(function(){l.style.display="",m&&(m.style.visibility="visible"),isChatting()||u.focus()},500),setTimeout(function(){h&&continuer()},5e3),u.onclick=function(){h=!1,continuer()}}var n=getPlayerAtScreen(0);"BB"==course&&(n.arme=!1,n.speed=0,supprArme(0)),n.speedinc=0,n.rotinc=0,n.rotincdir=0,n.sprite[0].setState(0),stopDrifting(0);var l=document.getElementById("infos0");l.innerHTML="",l.style.border="solid 1px black",l.style.opacity=.7,l.style.fontSize=Math.round(1.5*iScreenScale+4)+"pt",l.style.fontFamily="Courier",l.style.top=3*iScreenScale+"px",l.style.left=Math.round(25*iScreenScale+10)+"px",l.style.backgroundColor=iTeamPlay?"blue":"#063",l.style.color="#FEFF3F";var o=[],a=[];for(y=0;y<e[3].length;y++){var s=e[3][y],r=document.createElement("tr");a[y]=[],s[0]==identifiant?(r.style.backgroundColor=rankingColor(0),document.getElementById("infoPlace0").innerHTML=y+1,document.getElementById("infoPlace0").style.visibility="visible"):-1!=s[4]&&(r.style.backgroundColor=cTeamColors.primary[s[4]]);var p=document.createElement("td");p.innerHTML=toPlace(y+1),a[y][0]=document.createElement("td"),a[y][0].innerHTML=shareLink.options&&shareLink.options.timeTrial&&s[5]?"<span style=\"font-size: "+Math.round(1*iScreenScale+3)+"pt\">"+s[1]+"</span><br /><span style=\"font-size: "+Math.round(.75*iScreenScale+2)+"pt\">"+timeStr(s[5])+"</span>":s[1],a[y][0].id="j"+y,a[y][1]=document.createElement("td"),a[y][1].innerHTML=s[2];var d=document.createElement("small");if(d.innerHTML=(0>s[3]?"":"+")+s[3],r.appendChild(p),r.appendChild(a[y][0]),a[y][1].appendChild(d),r.appendChild(a[y][1]),iTeamPlay){r.style.textShadow="-1px 0 #603, 0 1px #603, 1px 0 #603, 0 -1px #603";for(var c=0;c<a[y].length;c++)a[y][c].style.padding="0 "+Math.round(iScreenScale/2)+"px"}l.appendChild(r),o[y]=r}handleRankingStyle();var r=document.createElement("tr"),p=document.createElement("td");p.setAttribute("colspan",3);var u=document.createElement("input");u.type="button",u.value=toLanguage("CONTINUE","CONTINUER"),u.style.width="100%",u.style.height="100%",u.style.fontSize=3*iScreenScale+"pt";var m=!0;u.onclick=function(){m=!1,t()},setTimeout(function(){m&&t()},5e3),p.appendChild(u),r.appendChild(p),l.appendChild(r),l.style.display="",isChatting()||u.focus(),resetEvents(),window.onbeforeunload=logGameTime,supprArme(0),resetWrongWay(n),(bMusic||iSfx)&&startEndMusic(),finishing=!0,document.getElementById("racecountdown").innerHTML=e[4]-("BB"==course?6:5),onlineSpectatorId&&"queuing"!==onlineSpectatorState||(document.getElementById("waitrace").style.visibility="visible",dRest()),document.getElementById("compteur0").innerHTML="";for(var y=0,h;y<oRoulettesPrefixes.length;y++)h=oRoulettesPrefixes[y],document.getElementById("roulette"+h+0).innerHTML="",document.getElementById("scroller"+h+0).style.visibility="hidden";updateItemCountdownHud(0,null);var g=document.getElementById("lakitu0");g&&(g.style.display="none"),"queuing"===onlineSpectatorState&&(m=!1,l.style.display="none",xhr("getCourse.php",getOnlineCourseParams({spectator:onlineSpectatorId}),function(e){if(!e)return!1;try{e=JSON.parse(e)}catch(t){return!1}return e.found&&setSpectatorId(void 0),nextRace(),!0}))}if(refreshDatas=!1,"BB"==course){for(var te=e[3][0][0],ie=e[3][0][4],s=0,m;s<aKarts.length;s++)if(m=aKarts[s],iTeamPlay?m.team==ie:m.id==te)m!=oPlayers[0]&&(m.loose=!0);else if(m.ballons.length&&!m.tourne){do{var A=m.ballons.length-1;m.ballons[A][0].suppr(),m.ballons.pop()}while(m.ballons.length);m.spin(20),m!=oPlayers[0]&&playDistSound(m,"musics/events/spin.mp3","BB"==course?80:50)}setTimeout(t,1e3)}else t()}}else iDeco(),interruptGame()}).catch(function(t){if(console.error(t),!refreshDatas){refreshDatas=!0;for(var e=g.length-1;0<=e;e--)syncItems.unshift(g[e])}}),refreshDatas=!1}function resetFall(e){delete e.aX,delete e.aY,delete e.aRotation;for(var t=0;t<oPlayers.length;t++)e==getPlayerAtScreen(t)&&(oContainers[t].style.opacity=1),e.sprite[t].img.style.display="block"}function loseBall(e){if("BB"==course){var t=aKarts[e].ballons.length-1;if(!aKarts[e].tourne&&aKarts[e].ballons[t]&&(aKarts[e].ballons[t][0].suppr(),aKarts[e].ballons.pop(),aKarts[e].cpu||(clLocalVars.lostBalloons++,updateChallengeHud("balloons",clLocalVars.lostBalloons)),isOnline)){var i=getScreenPlayerIndex(e);i<oPlayers.length&&!aKarts[e].ballons.length&&(supprArme(e),document.getElementById("infoPlace"+i).style.visibility="hidden")}}}function showTimer(e){for(var t=timeStr(e),n=0;n<strPlayer.length;n++)document.getElementById("temps"+n).innerHTML=t}function move(e,t){var n=aKarts[e];collisionTest=0,collisionPlayer=n,collisionTeam=-1==n.team||selectedFriendlyFire?void 0:n.team,clLocalVars.currentKart=n;var n=aKarts[e];if(e<strPlayer.length&&(n.cpu||finishing?n.tours==oMap.tours+1&&(!n.changeView&&(n.changeView=0),180>n.changeView&&(n.changeView+=15),n.progressiveView=!0):(showTimer(67*timer),!e&&timer++,n.time&&(n.time--,document.getElementById("lakitu"+e).style.display=n.time&&!oPlayers[e].changeView?"block":"none",oLapTimeDiv&&25>n.time&&(5>n.time?(oContainers[0].removeChild(oLapTimeDiv),oLapTimeDiv=void 0):oLapTimeDiv.style.visibility=4>n.time%6?"visible":"hidden")),handleWrongWay(n)),finishing&&timer++),n.tombe){if(n.tombe--,n.size=1,n.mini=0,19==n.tombe){for(var o=0;o<strPlayer.length;o++){if(n.sprite[o].img.style.display="none",n.sprite[o].img.style.opacity="",n.sprite[o].div.style.backgroundImage="","BB"==course)for(var a=0;a<n.ballons.length;a++)n.ballons[a][o].img.style.display="none";n.marker&&(n.marker.div[o].style.display="none")}playIfShould(n,"musics/events/rescue.mp3")}else if(2==n.tombe){if("BB"==course)for(var o=0;o<strPlayer.length;o++)for(var a=0;a<n.ballons.length;a++)n.ballons[a][o].img.style.display="block";}else if(!n.tombe&&(resetFall(n),loseBall(e),"BB"==course&&(n.cpu&&1==n.ballons.length&&(!isOnline||n.controller==identifiant)&&inflateNewBalloons(n),!n.ballons.length&&!n.loose)))for(var o=0;o<strPlayer.length;o++)n.sprite[o].div.style.opacity=1;return}if(n.teleport){if(n.teleport--,3==n.teleport){delete n.aX,delete n.aY;for(var o=0;o<strPlayer.length;o++)if(n.sprite[o].img.style.display="","BB"==course)for(var a=0;a<n.ballons.length;a++)n.ballons[a][o].img.style.display=""}if(2<=n.teleport)return;if(0>=n.teleport){delete n.teleport;var o=oPlayers.indexOf(n);-1!==o&&(oContainers[o].style.opacity="")}}if(!n.rotincdir)0>n.rotinc?n.rotinc=Math.min(0,n.rotinc+1):0<n.rotinc&&(n.rotinc=Math.max(0,n.rotinc-1));else if(n.rotinc+=2*n.rotincdir,n.driftinc&&0<n.driftinc!=0<n.rotincdir){var r=Math.max(1.1,1.6-Math.max(0,(n.driftcpt-20)/80));n.rotinc=0<n.driftinc?Math.max(n.rotinc,-r):Math.min(n.rotinc,r)}if(handleDriftCpt(e),n.cpu?(n.rotinc=Math.min(n.rotinc,fMaxRotInCp),n.rotinc=Math.max(n.rotinc,-fMaxRotInCp)):(n.rotinc=Math.min(n.rotinc,6),n.rotinc=Math.max(n.rotinc,-6)),n.shift&&(n.rotation+=180*n.shift[2]/Math.PI),!n.tourne){if(!n.figstate)!n.speed||n.billball||n.cannon||(n.rotation+=angleInc(n));else if(n.figstate-=1+Math.round(.5*(11-Math.abs(11-n.figstate))),0>n.figstate&&(n.figstate=0),!n.figuring&&8>n.figstate&&(n.figuring=!0,n==oPlayers[0])){clLocalVars.stunts++;var p;clSelected&&clRuleVars[clSelected.id]&&(p=clRuleVars[clSelected.id].stunts)&&updateChallengeHud("stunts",p.stunts+clLocalVars.stunts)}n.frminv&&n.frminv--}else if(n.figuring=!1,n.figstate=0,n.z||(n.speed=(n.speed-Math.max(0,n.speedinc+.1))/1.5),n.tourne-=2,!n.tourne&&"BB"==course&&(n.cpu&&1==n.ballons.length&&(!isOnline||n.controller==identifiant)&&inflateNewBalloons(n),!n.ballons.length&&!n.loose))for(var o=0;o<strPlayer.length;o++)n.sprite[o].div.style.opacity=1;if(0>n.rotation&&(n.rotation+=360),360<n.rotation&&(n.rotation-=360),kartIsPlayer(n)){if(!clLocalVars.startedAt&&1<n.speed&&(clLocalVars.startedAt=timer),!clLocalVars.forwards&&0<n.speed&&(0<n.speedinc||n.turbodrift)&&(clLocalVars.forwards=!0),!clLocalVars.backwards&&0>n.speed&&0>n.speedinc&&(clLocalVars.backwards=!0),!clLocalVars.rightTurn&&n.speed){var c=0>(n.speedinc||n.speed)?-getMirrorFactor():getMirrorFactor();0>n.rotinc*c&&0>n.rotincdir*c?clLocalVars.rightTurn=!0:0>n.driftinc*c&&(clLocalVars.rightTurn=!0)}if(!clLocalVars.leftTurn&&n.speed){var c=0>(n.speedinc||n.speed)?-getMirrorFactor():getMirrorFactor();0<n.rotinc*c&&0<n.rotincdir*c?clLocalVars.leftTurn=!0:0<n.driftinc*c&&(clLocalVars.leftTurn=!0)}}var u=n.maxspeed*n.size*fSelectedClass;n.speed>u&&(n.speed=u),n.speed<-u/4&&(n.speed=-u/4);var m=kartInstantSpeed(n),y=m[0],h=m[1],g=n.x+y,b=n.y+h,f=n.x,x=n.y;if(n.z||n.heightinc)handleHeightInc(n)&&(delete n.jumped,n.driftinc&&carDrift&&!n.driftSound&&kartIsPlayer(n)&&(carDrift.currentTime=0,carDrift.play(),n.driftSound=carDrift));else if(clLocalVars.autoAccelerate&&!n.cpu&&n.accelerate(),n.speed+=n.speedinc,isCup&&22!=oMap.skin&&30!=oMap.skin||!isCup&&oMap.smartjump){var v,C;n.cpu&&(tombe(g,b)&&!sauts(f,x,y,h)||(v=ralenti(g,b))&&(C=getOffroadProps(n,v))&&n.speed-1.01*n.speedinc>C.speed&&!n.protect&&!n.champi)&&(n.z=1,n.heightinc=.5,n.jumped=!0)}var E=(!isOnline||!e||n.controller==identifiant)&&!onlineSpectatorId;if(E&&!n.loose){var w=n.using;if(n.tourne){w=[];for(var o=0;o<aKarts.length;o++)w=w.concat(aKarts[o].using)}var S=touche_bobomb(g,b,w)+touche_cbleue(g,b);if(S&&!n.tourne&&!n.protect&&!n.fell)handleExplosionHit(e,S);else if(5>n.z){var T=(n.x+g)/2,I=(n.y+b)/2;if(T=g,I=b,(touche_fauxobjet(g,b,w)||1.5<fSelectedClass&&touche_fauxobjet(T,I,w)||touche_cverte(g,b,w)||touche_cverte(n.x,n.y,w)||1<fSelectedClass&&touche_cverte_future(g,b,w)||1.5<fSelectedClass&&touche_cverte(T,I,w)||touche_crouge(n.x,n.y,w)||1.5<fSelectedClass&&touche_crouge(T,I,w))&&!n.protect&&!n.frminv)handleHardHit(e);else if((touche_banane(g,b,w)||1.5<fSelectedClass&&touche_banane(T,I,w))&&!n.protect&&!n.frminv)handleSoftHit(e);else if((touche_poison(g,b,w)||1.5<fSelectedClass&&touche_poison(T,I,w))&&!n.protect&&!n.frminv)handlePoisonHit(e);else if((touche_champi(g,b)||1.5<fSelectedClass&&touche_champi(T,I))&&!n.tourne)n.champi=20,n.champiType=1,n.maxspeed=11,n.speed=n.maxspeed*cappedRelSpeed(n),playIfShould(n,"musics/events/boost.mp3");else if(!n.tourne&&1.2>n.z){var z=!n.protect&&!n.frminv,B=touche_asset(f,x,g,b),M=!0,L=!1;if(B){var H=B[1][0].src;switch(B[1][0].custom&&(H="custom-"+B[1][0].custom.id),B[0]){case"oils":z&&.5<Math.abs(n.speed)&&!n.tourne&&0>=Math.min(n.z,n.z+n.heightinc)&&(stopDrifting(e),loseBall(e),n.spin(20)),M=!1;break;case"pointers":H="assets/pivothand",z?(stopDrifting(e),loseBall(e),n.spin(42),n.cpu&&(n.frminv=16)):M=!1;break;case"flippers":z&&(stopDrifting(e),loseBall(e),n.spin(42)),n.speed*=-1;var A=8;switch(B[1][3][0]){case 1:A=12;break;case 2:A=4;}n.shift=[-A*direction(0,n.rotation),-A*direction(1,n.rotation),0];break;case"bumpers":z=!1,n.speed*=-1;var A=8,_=y,P=h,N=B[1];N[3]&&(_+=N[3][0]*Math.sin(N[3][1])*N[2][5],P-=N[3][0]*Math.cos(N[3][1])*N[2][5]);var R=f+_,D=x+P,F=N[1][0],V=N[1][1],O=f-F,q=x-V,W=Math.hypot(O,q),X=O/W,G=q/W,K=_*X+P*G,U=R-K*X,Y=D-K*G;_=f+2*(U-f)-R,P=x+2*(Y-x)-D;var J=Math.hypot(_,P);n.shift=J?[A*_/J,A*P/J,0]:[-A*direction(0,n.rotation),-A*direction(1,n.rotation),0],n.cpu&&(n.bounced=!0,n.bouncedsince=0);break;case"flowers":M=!1,z=!1,L=!0;}M&&(L=!0,stopDrifting(e),g=f,b=x,!n.collideSound&&(n.collideSound=playIfShould(n,"musics/events/collide.mp3"),n.collideSound&&(n.collideSound.onended=function(){n.collideSound=void 0,document.body.removeChild(this)}))),z&&(L=!0,loseUsingItem(n)),L&&clLocalVars.decorsHit&&!n.cpu&&(clLocalVars.decorsHit[H]=!0)}}if(!n.cpu)for(;touche_piece(n.x,n.y);)clLocalVars.nbCoins++,updateChallengeHud("coins",clLocalVars.nbCoins),challengeCheck("each_coin"),playIfShould(n,"musics/events/coin.mp3")}}var Q=objet(g,b),$,Z,ee;if(-1!==Q){n.destroySound||(n.destroySound=playDistSound(n,"musics/events/item_destroy.mp3",80),n.destroySound&&(n.destroySound.onended=function(){n.destroySound=void 0,document.body.removeChild(this)}));for(var te=oMap.arme[Q][2].box.length,ie=0;ie<te;ie++)if((!n.arme||oDoubleItemsEnabled&&!n.stash&&(ie||!n.roulette||7<n.roulette))&&(n.tours<=oMap.tours||"BB"==course)&&!finishing){var ne;if("BB"!=course){ne=randObj(n);var le={};1==n.tours&&getCpScore(n)<=getCpDiff(n)/2&&(le.bloops=1,le.carapaceX3=1,le.carapacerougeX3=1),375>timer&&(1!=itemDistribution.lightningstart&&(le.eclair=1),1!=itemDistribution.blueshellstart&&(le.carapacebleue=1,le.carapacenoire=1)),1==n.place&&(le.carapacebleue=1);var oe={carapacebleue:1,carapacenoire:1,eclair:1,bloops:1,bananeX3:1};1==itemDistribution.lightningx2&&delete oe.eclair,1==itemDistribution.blueshellx2&&(delete oe.carapacebleue,delete oe.carapacenoire);for(var o=0,ae;o<aKarts.length;o++){ae=aKarts[o];for(var a=0,se;a<oArmeKeys.length;a++)se=oArmeKeys[a],oe[ae[se]]&&(le[ae[se]]=1)}if(items["carapace-bleue"].length&&(le.carapacebleue=1),items["carapace-noire"].length?le.carapacenoire=1:nextBlueShellCooldown&&0!=itemDistribution.blueshelldelay&&(le.carapacebleue=1),(n.place<aKarts.length||items.eclair.length)&&(le.eclair=1),items.bloops.length&&(le.bloops=1),n.arme&&1!=itemDistribution.doubleitemx2&&(le[n.arme]=1),le[ne]&&otherObjects(n,le))do ne=randObj(n);while(le[ne])}else if(n.ballons.length)ne=randObj(n);else{var re=["fauxobjet","banane","carapace","bobomb"];ne=re[Math.floor(Math.random()*re.length)]}var pe=n.arme?1:0,se=oArmeKeys[pe];if(n[se]=ne,shouldPlaySound(n)&&!n.rouletteSound&&(n.rouletteSound=playSoundEffect("musics/events/roulette.mp3")),kartIsPlayer(n)){var de=oRoulettesPrefixes[pe],$=document.getElementById("scroller"+de+e),ce=$.getElementsByTagName("div")[0],Z=ce.offsetHeight,ee=7*iScreenScale;switch(ce.dataset||(ce.dataset={}),ce.dataset.h=Z,ce.dataset.s=ee,ce.dataset.v=pe?1.2:2,document.getElementById("scroller"+de+e).getElementsByTagName("div")[0].style.top=-Math.floor(Math.random()*Z)+"px",updateObjHud(e),clLocalVars.itemsGot=!0,ne){case"etoile":var ue=document.createElement("img");ue.src=getStarSrc(n.personnage);break;case"billball":var ue=document.createElement("img");ue.src="images/sprites/sprite_billball.png";}}}!clLocalVars.itemsHit||n.cpu||clLocalVars.itemsHit[Q]||(clLocalVars.itemsHit[Q]=!0,clLocalVars.nbItems++,updateChallengeHud("items",clLocalVars.nbItems),challengeCheck("each_item"))}for(var o=0;o<oRoulettesPrefixes.length;o++){var me=oArmeKeys[o],de=oRoulettesPrefixes[o],ye="roulette"+de;n[me]&&25>n[ye]&&(n[ye]++,25<=n[ye]&&(n[ye]=25,kartIsPlayer(n)&&(updateObjHud(e),n.rouletteSound&&(removeIfExists(n.rouletteSound),playSoundEffect("musics/events/gotitem.mp3"),n.rouletteSound=void 0))))}collisionDecor=null,collisionFloor=null,collisionItem=null;var he=!1,ge;if(n.cannon||canMoveTo(f,x,n.z,y,h,n.protect,n.z0||0)||n.billball)n.x=g,n.y=b,n.cpu&&delete n.collided;else{n.collideSound||(n.collideSound=playIfShould(n,"musics/events/collide.mp3"),n.collideSound&&(n.collideSound.onended=function(){n.collideSound=void 0,document.body.removeChild(this)}));var be=Math.max(collisionFloor?collisionFloor.z:0,n.z+(n.z0||0)),fe=getHorizontality(f,x,be,y,h);n.cpu&&(n.collided=!0,n.horizontality=fe);var xe=g-n.x,ve=b-n.y,Ce=xe*fe[0]+ve*fe[1];n.speed>n.speedinc&&(n.speed=Math.min(.75*n.speed,n.speed+.5-n.speedinc)),collisionDecor||(3<n.speed&&5<=n.driftcpt&&160>n.driftcpt&&(80>n.driftcpt||85<=n.driftcpt)&&(n.driftcpt-=5),!n.cpu&&(clLocalVars.touchedWalls=!0));for(var o=5;0<o&&(n.x+=fe[0]*Ce*o/5,n.y+=fe[1]*Ce*o/5,!canMoveTo(f,x,n.z,n.x-f,n.y-x,n.protect,n.z0||0));o--)n.x=f,n.y=x;0>=n.speedinc&&(n.speed=Math.hypot(n.x-f,n.y-x))}if(collisionDecor){clLocalVars.decorsHit&&!n.cpu&&(clLocalVars.decorsHit[collisionDecor]=!0);var s=decorBehaviors[collisionDecor].spin;if(s&&!n.tourne&&!n.protect&&!n.frminv&&E){var ke=decorBehaviors[collisionDecor].minSpeedToSpin||2.5;Math.abs(n.speed)>ke&&(loseBall(e),stopDrifting(e),n.spin(s),n.frminv=24,n.speed=2.5*Math.sign(n.speed),loseUsingItems(n))}}if(collisionFloor&&(ge=collisionFloor.z),n.speedinc||(n.speed*=n.sliding?.95:.9),!n.cannon&&handleCannon(n,inCannon(f,x,n.x,n.y))){if(stopDrifting(e),n.protect=!0,n.jumped=!0,n.tourne&&(n.tourne=2),delete n.shift,!n.cpu){clLocalVars.cannons++;var p;clSelected&&clRuleVars[clSelected.id]&&(p=clRuleVars[clSelected.id].max_cannons)&&updateChallengeHud("cannons",clLocalVars.cannons+p.cannons)}n.boostSound||(n.boostSound=playIfShould(n,"musics/events/boost.mp3"),n.boostSound&&(n.boostSound.onended=function(){n.boostSound=void 0,document.body.removeChild(this)}))}if(!n.teleport&&E){var Ee=inTeleport(n.x,n.y);if(Ee){n.aX=n.x,n.aY=n.y,n.aRotation=n.rotation,n.x=Ee[0],n.y=Ee[1],n.rotation=90*Ee[2],n.teleport=5,he=!0,playIfShould(n,"musics/events/teleport.mp3"),0>n.speed&&(n.speed=0);for(var o=0;o<strPlayer.length;o++)if(n.sprite[o].img.style.display="none","BB"==course)for(var a=0;a<n.ballons.length;a++)n.ballons[a][o].img.style.display="none";if(void 0!==n.aipoint)if("BB"==course)n.aipoint=void 0;else{var we=n.aipoints[n.aipoint];we&&Ee===inTeleport(we[0],we[1])&&(n.aipoint++,n.aipoint>=n.aipoints.length&&(n.aipoint=0))}}}if(n.sliding=void 0,!n.z){n.heightinc||(n.ctrled=!1,n.fell=!1,ge?n.z0=ge:n.z0&&delete n.z0),n.figuring&&(n.turbodrift=15,n.turbodrift0=n.turbodrift,n.driftcpt=0);var Se;if(handleJump(n,sauts(f,x,y,h))){if(n.speed=11*cappedRelSpeed(n),n.figuring=!1,n.figstate=0,!n.cpu){clLocalVars.jumps++;var p;clSelected&&clRuleVars[clSelected.id]&&(p=clRuleVars[clSelected.id].max_jumps)&&updateChallengeHud("jumps",clLocalVars.jumps+p.jumps)}n.bounceSound||(n.bounceSound=playIfShould(n,"musics/events/jump.mp3"),n.bounceSound&&(n.bounceSound.onended=function(){n.bounceSound=void 0,document.body.removeChild(this)}))}else{var v,Te;if(E&&(Te=tombe(n.x,n.y,oMap.checkpoint&&n.demitours?oMap.checkpoint[n.demitours+1==oMap.checkpoint.length?0:n.demitours+1][3]:0)),Te){!0==Te?isBattle&&simplified?(Te=[n.x,n.y,n.rotation],n.x>oMap.w-1?(Te[0]=oMap.w-50,n.y>oMap.h-1?(Te[1]=oMap.h-50,Te[2]=225):0>n.y?(Te[1]=50,Te[2]=315):(Te[1]=n.y-n.y%100+50,Te[2]=270)):n.y>oMap.h-1?(Te[1]=oMap.h-50,0>n.x?(Te[0]=50,Te[2]=135):(Te[0]=n.x-n.x%100+50,Te[2]=180)):0>n.x?(Te[0]=50,0>n.y?(Te[1]=50,Te[2]=45):(Te[1]=n.y-n.y%100+50,Te[2]=90)):(Te[1]=50,Te[0]=n.x-n.x%100+50,Te[2]=0)):Te=oMap.startposition[0]:isNaN(Te[0])&&(Te=oMap.startposition[(n.initialPlace-1)%oMap.startposition.length]),n.aX=n.x,n.aY=n.y,n.aRotation=n.rotation,n.x=Te[0],n.y=Te[1],n.rotation=90*Te[2],n.speed=0,n.protect=!1,n.figuring=!1,n.figstate=0,n.fell=!0,n.champi=0,delete n.champiType,delete n.champior,delete n.champior0,n.cpu&&(n.aipoint=void 0),n.tombe=20,n.frminv=10,n.ctrled=!0,n.z=10,n.tourne=0,stopDrifting(e),supprArme(e),deleteUsingItems(n);for(var Ie=getScreenPlayerIndex(o),o=0;o<oPlayers.length;o++){if(o!=Ie&&(n.sprite[o].img.style.display="none",n.sprite[o].div.style.backgroundImage="","BB"==course))for(var ze=0;ze<n.ballons.length;ze++)n.ballons[ze][0].img.style.display="none";n.etoile&&(n.sprite[o].img.src=getSpriteSrc(n.personnage))}if(resetPowerup(n),resetWrongWay(n),!n.cpu){clLocalVars.falls++;var p;clSelected&&clRuleVars[clSelected.id]&&(p=clRuleVars[clSelected.id].falls)&&updateChallengeHud("falls",clLocalVars.falls+p.falls)}playIfShould(n,"musics/events/fall.mp3")}else{if(!n.protect&&!n.champi&&!n.figuring&&1.5<n.speed&&!(n.turbodrift>.8*n.turbodrift0)&&(v=ralenti(g,b))){var C=getOffroadProps(n,v);C.speed*=cappedRelSpeed(),C.sliding&&(n.sliding=C.sliding),n.speed>C.speed&&(n.speed=C.speed),stopDrifting(e)}if(n.tourne||(Se=flowShift(g,b,n.protect)),Se&&n.cpu&&100<=Se[0]*Se[0]+Se[1]*Se[1]){var Be=y+Se[0],Me=h+Se[1];0>Be*y+Me*h&&(n.collided=!0,n.horizontality=[Se[1],-Se[0]])}}n.figuring=!1,n.figstate=0}if(Se){n.shift||(n.shift=[0,0,0]);for(var o=0;3>o;o++)n.shift[o]=.7*n.shift[o]+.3*Se[o];.01>n.shift[0]*n.shift[0]+n.shift[1]*n.shift[1]+300*n.shift[2]*n.shift[2]&&delete n.shift}else delete n.shift}if(n.cpu||he||updateSpeedometer(e,f,x),moveUsingItems(n,t),"BB"!=course){if(checkpoint(n,y,h)){var Le=aKarts.length;n.demitours=getNextCp(n),n.tours++;var je=oMap.checkpointCoords[0];oMap.sections&&(je=oMap.checkpointCoords[oMap.checkpointCoords.length-1]);var He=1,Ae=intersectionLineLine(f,x,f+y,x+h,je.A[0],je.A[1],je.B[0],je.B[1]);0<=Ae[0]&&Ae[0]<He&&(He=Ae[0]),Ae=intersectionLineLine(f,x,f+y,x+h,je.C[0],je.C[1],je.D[0],je.D[1]),0<=Ae[0]&&Ae[0]<He&&(He=Ae[0]);var _e=Math.round(67*(timer+He-1));if(n==oPlayers[0]&&!n.cpu){for(var Pe=0,o=0;o<lapTimers.length;o++)Pe+=lapTimers[o];lapTimers.push(_e-Pe)}var Ie=getScreenPlayerIndex(e);if(n.tours==oMap.tours+1){n.place=0;for(var o=0;o<Le;o++)aKarts[o].tours>oMap.tours&&n.place++;if(isOnline&&!n.finaltime&&(n.finaltime=timeTrialMode()?_e:new Date().getTime()-tnCourse),kartIsPlayer(n)&&!finishing){for(timerMS=_e,showTimer(timerMS),"CM"!=course&&(document.getElementById("infoPlace"+e).innerHTML=n.place);n.using.length;){var Ne=bMusic,Re=iSfx;bMusic=!1,iSfx=!1,arme(e),bMusic=Ne,iSfx=Re}if(n.arme=!1,stopDrifting(e),supprArme(e),resetWrongWay(n),n.billball&&(n.billball=1),n.cpu=!0,$speedometers[e]&&($speedometers[e].style.display="none"),n.aipoint=0,n.lastAItime=0,n.maxspeed=5.7,n.maxspeed0=n.maxspeed,!oPlayers[1-e]||oPlayers[1-e].cpu){if(!isOnline){if("CM"!=course){for(var De=getRankScores(),o=0;o<Le;o++)places(o,De,!0);var Fe=aKarts.slice(0);Fe.sort(function(e,t){return e.place-t.place});for(var o=0;o<Le;o++)Fe[o].place=o+1;aPlaces=[];for(var o=0;o<Le;o++)aPlaces[o]=aKarts[o].place;var Ve="<tr style=\"font-size: "+2*iScreenScale+"px; background-color: white; color: black;\"><td>Places</td><td>"+toLanguage("Player","Joueur")+"</td><td>Pts</td></tr>",Oe=Math.round(1.25*aKarts.length),qe="",We="";iTeamPlay&&(qe="; text-shadow: -1px 0 #603, 0 1px #603, 1px 0 #603, 0 -1px #603",We=" style=\"padding: 0 "+Math.round(iScreenScale/2)+"px\"");for(var Xe=getPointDistribution(),o=0;o<Le;o++)for(var a=0,Ge;a<Le;a++)if(Ge=aKarts[a].personnage,aKarts[a].place==o+1){var Ke=aKarts[a].team;-1===Ke&&(Ke=0);var Ue=Xe[o];Ve+="<tr id=\"fJ"+o+"\" style=\"background-color: "+rankingColor(a)+qe+"\"><td>"+toPlace(o+1)+" </td><td id=\"j"+o+"\""+We+">"+toPerso(Ge)+"</td><td id=\"pts"+o+"\""+We+">"+aScores[a]+"<small>+"+Ue+"</small></td></tr>",aScores[a]+=Ue,a=Le}Ve+="<tr><td colspan=\"3\" id=\"continuer\"></td></tr>",document.getElementById("infos0").style.border="solid 1px black",document.getElementById("infos0").style.opacity=.7,document.getElementById("infos0").style.fontSize=Math.round(1.77*iScreenScale-.5)+"pt",document.getElementById("infos0").style.fontFamily="Courier",document.getElementById("infos0").style.top=3*iScreenScale+"px",document.getElementById("infos0").style.left=Math.round(24*iScreenScale+10+(strPlayer.length-1)/2*(80*iScreenScale+2))+"px",document.getElementById("infos0").style.backgroundColor=iTeamPlay?"blue":"#063",document.getElementById("infos0").style.color="#FEFF3F",document.getElementById("infos0").innerHTML=Ve,handleRankingStyle();var Ye=document.createElement("input");Ye.type="button",Ye.id="octn",Ye.value=toLanguage("CONTINUE","CONTINUER"),Ye.style.width="100%",Ye.style.height="100%",Ye.style.fontSize=3*iScreenScale+"pt",Ye.onclick=classement,document.getElementById("continuer").appendChild(Ye),document.getElementById("infos0").style.display="";var Je=document.body.scrollTop;Ye.focus(),document.body.scrollTop=Je}else{document.getElementById("infos0").style.fontSize=5*iScreenScale+"px",document.getElementById("infos0").style.fontWeight="bold",document.getElementById("infos0").style.color="white";var Qe=Math.ceil(iScreenScale/4)+"px",$e="black";sShadow="-"+Qe+" 0 "+$e+", 0 "+Qe+" "+$e+", "+Qe+" 0 "+$e+", 0 -"+Qe+" "+$e;for(var Ze="",et=lapTimers[0],o=1;o<lapTimers.length;o++)et=Math.min(et,lapTimers[o]);for(var o=0;o<lapTimers.length;o++){Qe=Math.ceil(iScreenScale/8)+"px",$e=lapTimers[o]==et?"#e99c00":"black";var tt="-"+Qe+" 0 "+$e+", 0 "+Qe+" "+$e+", "+Qe+" 0 "+$e+", 0 -"+Qe+" "+$e;Ze+="<div style=\"color:"+(lapTimers[o]==et?"#fffdbe":"#DDD")+";text-shadow:"+tt+"\">"+(o+1)+". "+timeStr(lapTimers[o])+"</div>"}document.getElementById("infos0").style.top=7*iScreenScale+10+"px",document.getElementById("infos0").innerHTML="<tr><td style=\"text-decoration: blink;font-family:Courier New;font-size:"+Math.round(4*iScreenScale)+"px;text-shadow:"+sShadow+"\">"+document.getElementById("temps0").innerHTML+"</td></tr><tr><td id=\"continuer\"></td></tr><tr><td style=\"padding-top:"+iScreenScale+";font-size:"+Math.round(2.5*iScreenScale)+"px\">"+Ze+"</td></tr>",document.getElementById("infos0").style.display="";var Ye=document.createElement("input");Ye.type="button",Ye.id="octn",Ye.value=toLanguage("CONTINUE","CONTINUER"),Ye.style.width="100%",Ye.style.height="100%",Ye.style.fontSize=3*iScreenScale+"pt",Ye.onclick=function(){document.getElementById("infos0").style.display="none";var e=document.createElement("div");e.style.color="black",e.style.position="absolute",e.style.left=5*iScreenScale+10+"px",e.style.top=5*iScreenScale+10+"px",e.style.fontSize=4*iScreenScale+"pt",e.style.backgroundColor="#FF6",e.style.opacity=.8,e.style.border="double 4px black",e.style.textAlign="center",e.style.width=70*iScreenScale-10+"px",e.style.height=25*iScreenScale-10+"px",e.style.zIndex=2e4;var t=document.createElement("p");t.innerHTML=toLanguage("Save the time to the <a href=\""+rankingsLink(oMap)+"\" target=\"_blank\" style=\"color: orange\">record list</a> ?","Enregistrer le temps dans la <a href=\""+rankingsLink(oMap)+"\" target=\"_blank\" style=\"color: orange\">liste des records</a> ?"),t.style.margin=iScreenScale+"px";var i=t.cloneNode(!1),n=document.createElement("input");n.type="button",n.value="  "+toLanguage("Yes","Oui")+"  ",n.style.marginRight=iScreenScale+"px",n.style.fontSize=4*iScreenScale+"px",n.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",l.style.fontSize=4*iScreenScale+"px"},n.onclick=function(){$mkScreen.removeChild(e),continuer(),document.getElementById("enregistrer").getElementsByTagName("input")[0].onclick()},i.appendChild(n);var l=document.createElement("input");l.type="button",l.value="  "+toLanguage("No","Non")+"  ",l.style.fontSize=4*iScreenScale+"px",l.style.marginLeft=iScreenScale+"px",l.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",n.style.fontSize=4*iScreenScale+"px"},l.onclick=function(){$mkScreen.removeChild(e),document.getElementById("infos0").style.display="",continuer()},i.appendChild(l),e.appendChild(t),e.appendChild(i),$mkScreen.appendChild(e),timerMS>=gRecord?l.focus():n.focus()},document.getElementById("continuer").appendChild(Ye),document.getElementById("infos0").style.display="",Ye.focus()}handleEndRace()}else{var nt=document.getElementById("infos0");nt.style.left=15*iScreenScale+"px",nt.innerHTML="";var lt=document.createElement("tr"),ot=document.createElement("td");ot.style.fontSize=8*iScreenScale+"px",ot.style.color="#F80",ot.innerHTML=toLanguage("&nbsp; &nbsp; FINISH !","TERMIN&Eacute; !"),lt.appendChild(ot);var at=document.createElement("tr"),st=document.createElement("td");st.style.fontSize=Math.round(4.5*iScreenScale+10)+"px",st.style.color="#FF0",st.innerHTML=toLanguage("&nbsp; &nbsp; &nbsp; Please wait...","Veuillez patienter..."),at.appendChild(st),nt.appendChild(lt),nt.appendChild(at),nt.style.display="",document.getElementById("infoPlace0").style.visibility="hidden",finishing=!0}resetEvents(),window.onbeforeunload=logGameTime}}else onlineSpectatorId&&!finishing&&Ie<oPlayers.length&&(document.getElementById("infoPlace0").style.visibility="hidden");oMap.sections&&1<n.billball&&(n.billball=1)}else if((isOnline?!(Ie||finishing):!n.cpu)&&(updateLapHud(Ie),!onlineSpectatorId)){if(document.getElementById("lakitu"+Ie).getElementsByTagName("div")[0].innerHTML=(oMap.sections?"Sec":toLanguage("Lap","Tour"))+"<small>&nbsp;</small>"+n.tours,n.time=40,bMusic||iSfx)if(n.tours==oMap.tours){for(var rt=!0,o=0;o<oPlayers.length;o++)if(oPlayers[o]!=n&&3<=oPlayers[o].tours){rt=!1;break}if(rt){var pt=postStartMusic("musics/events/lastlap.mp3");iSfx&&(fadeOutMusic(carEngine,1,.6,-1,vSfx),fadeOutMusic(carEngine2,1,.6,-1,vSfx)),pt.removeAttribute("loop"),setTimeout(function(){if(bMusic){if(willPlayEndMusic||isEndMusicPlayed)return;document.body.contains(pt)?(document.body.removeChild(pt),startMapMusic(!0)):lastMapMusic?(startMapMusic(!0),forceStartMusic=!0):fastenMusic(mapMusic)}iSfx&&(carEngine.volume=vSfx,carEngine2.volume=vSfx)},2700),lastMapMusic&&(mapMusic!==lastMapMusic&&(removeIfExists(mapMusic),mapMusic=lastMapMusic),bufferMusic(lastMapMusic))}}else iSfx&&playSoundEffect("musics/events/nextlap.mp3");if(timeTrialMode()){oLapTimeDiv&&oContainers[0].removeChild(oLapTimeDiv),oLapTimeDiv=document.createElement("div"),oLapTimeDiv.style.position="absolute",oLapTimeDiv.style.zIndex=2e4,oLapTimeDiv.style.left=Math.round(80*iScreenScale/2)+"px",oLapTimeDiv.style.top=Math.round(39*iScreenScale/2)+"px",oLapTimeDiv.style.textAlign="center",oLapTimeDiv.style.transform=oLapTimeDiv.style.WebkitTransform=oLapTimeDiv.style.MozTransform="translate(-50%, -100%)";var ct=document.createElement("div");ct.className="lap-time",ct.innerHTML=timeStr(lapTimers[lapTimers.length-1]),ct.style.fontSize=4*iScreenScale+"px",ct.style.fontFamily="Courier New",ct.style.color="#DDD";var Qe=Math.ceil(iScreenScale/4)+"px",$e="black";if(ct.style.textShadow="-"+Qe+" 0 "+$e+", 0 "+Qe+" "+$e+", "+Qe+" 0 "+$e+", 0 -"+Qe+" "+$e,oLapTimeDiv.appendChild(ct),iLapTimes){for(var ut=0,o=0;o<lapTimers.length;o++)ut+=lapTimers[o]-iLapTimes[o];var mt=document.createElement("div");mt.innerHTML=(0<=ut?"+":"-")+" "+timeStr(Math.abs(ut)),mt.style.fontSize=Math.round(2.5*iScreenScale)+"px",mt.style.fontFamily="Courier New",mt.style.color=0<=ut?"#FDD":"#DFD",Qe=Math.ceil(iScreenScale/8)+"px",$e=0<=ut?"#C00":"#0A0",mt.style.textShadow="-"+Qe+" 0 "+$e+", 0 "+Qe+" "+$e+", "+Qe+" 0 "+$e+", 0 -"+Qe+" "+$e,oLapTimeDiv.appendChild(mt)}oContainers[0].appendChild(oLapTimeDiv)}}}}else if(!isOnline){var yt;if(oPlayers[0].loose&&(!oPlayers[1]||oPlayers[1].loose)){for(var a=0;1e4>a&&(yt=aKarts[Math.floor(Math.random()*(aKarts.length-strPlayer.length))+strPlayer.length],!!yt.loose);a++);for(o=strPlayer.length;o<aKarts.length;o++)aKarts[o].loose=!0}else if(!(1<aKarts.length))oPlayers[0].losing&&(yt=oPlayers[0],delete yt.losing);else if(iTeamPlay){var ht=Array(selectedNbTeams).fill(!1),gt=0;for(o=0;o<aKarts.length;o++)if(!aKarts[o].loose){aKarts[o].cpu||(yt=aKarts[o]);var Ke=aKarts[o].team;ht[Ke]||(ht[Ke]=!0,gt++)}1<gt&&(yt=void 0)}else{var ht=!1;for(o=0;o<aKarts.length;o++)aKarts[o].loose||(ht?(yt=void 0,o=aKarts[o].length):(ht=!0,yt=aKarts[o]))}if(yt){for(clLocalVars.gagnant=yt,o=0;o<strPlayer.length;o++)stopDrifting(o),supprArme(o);var Ve="<tr style=\"font-size: "+2*iScreenScale+"px; background-color: white; color: black;\"><td>Places</td><td>"+toLanguage("Player","Joueur")+"</td><td>Pts</td></tr>",bt="",ft=1,qe="",We="";iTeamPlay&&(qe="; text-shadow: -1px 0 #603, 0 1px #603, 1px 0 #603, 0 -1px #603",We=" style=\"padding: 0 "+Math.round(iScreenScale/2)+"px\"");for(var o=0,Ke;o<aKarts.length;o++){Ke=aKarts[o].team,-1===Ke&&(Ke=0);var Ue=aKarts[o]==yt,Ge=aKarts[o].personnage,xt=Ue?0:ft,vt="<tr id=\"fJ"+xt+"\" style=\"background-color:"+rankingColor(o)+qe+"\"><td>"+toPlace(xt+1)+" </td><td id=\"j"+xt+"\""+We+">"+toPerso(Ge)+"</td><td id=\"pts"+xt+"\""+We+">"+aScores[o]+(Ue?"<small>+1</small>":"")+"</td></tr>";Ue?bt=vt+bt:(bt+=vt,ft++),aScores[o]+=Ue}Ve+=bt,Ve+="<tr><td colspan=\"3\" id=\"continuer\"></td></tr>",document.getElementById("infos0").style.border="solid 1px black",document.getElementById("infos0").style.opacity=.7,document.getElementById("infos0").style.fontSize=Math.round(1.77*iScreenScale-.5)+"pt",document.getElementById("infos0").style.fontFamily="Courier",document.getElementById("infos0").style.top=3*iScreenScale+"px",document.getElementById("infos0").style.left=Math.round(24*iScreenScale+10+(strPlayer.length-1)/2*(80*iScreenScale+2))+"px",document.getElementById("infos0").style.backgroundColor=iTeamPlay?"blue":"#063",document.getElementById("infos0").style.color="#FEFF3F",document.getElementById("infos0").innerHTML=Ve,handleRankingStyle();var Ye=document.createElement("input");Ye.type="button",Ye.id="octn",Ye.value=toLanguage("CONTINUE","CONTINUER"),Ye.style.width="100%",Ye.style.height="100%",Ye.style.fontSize=3*iScreenScale+"pt",Ye.onclick=classement,document.getElementById("continuer").appendChild(Ye),document.getElementById("infos0").style.display="";var Je=document.body.scrollTop;for(Ye.focus(),document.body.scrollTop=Je,o=0;o<aKarts.length;o++)aKarts[o].loose=!0;handleEndRace(),resetEvents(),window.onbeforeunload=logGameTime}}if(n.cpu){if("BB"==course)n.maxspeed=5.7;else{var Ct=oPlayers[0].place,kt=oPlayers.length,Et=aKarts.length-1-kt,wt=e-kt,St=aKarts[kt];if(isOnline){kt=0,Et=-1,wt=0,St=null;for(var o=0;o<aKarts.length;o++)aKarts[o].controller?(o<e&&wt++,St||(St=aKarts[o]),Et++):(kt++,aKarts[o].place<Ct&&(Ct=aKarts[o].place))}var Tt=iDificulty,It=1;if(0<Et){if(St.place<n.place&&St.place<Ct){var zt=n.distToFirstCache;zt?(n.distToFirstTtl--,0>=n.distToFirstTtl&&(n.distToFirstCache=0)):(zt=distanceToKart(n,St),n.distToFirstCache=zt,n.distToFirstTtl=15+Math.floor(15*Math.random()));var Bt=1/(1+zt/(42*Et));wt=Bt*(1+wt)-1}else n.distToFirstCache=0;It=Math.pow(.96,6*(wt/Et-.5))}Tt*=It*iDificulty/5;var d=1.25;4.75<iDificulty&&8<aKarts.length&&(d*=Math.log(1+100*aKarts.length/8)/5.5),n.maxspeed0>Tt*d?n.maxspeed0=Tt*d:n.maxspeed0<Tt&&(n.maxspeed0=Tt),n.place<=Ct?n.maxspeed0-=(n.maxspeed0*It-Tt*n.size*fSelectedClass)/100:n.maxspeed0+=(1.12*(Tt*d)*n.size*fSelectedClass-n.maxspeed0*It)/100}n.maxspeed=n.maxspeed0}else n.maxspeed=5.4*n.stats.speed;if(n.turbodrift){var Mt=8;15<n.turbodrift&&(Mt+=Math.pow(2*(n.turbodrift-15)/(15*n.size),2),n.turbodrift--,n.turbodrift0--),n.speed>-Mt&&(n.maxspeed=Mt,n.speed=Math.max(Mt*cappedRelSpeed(n),n.speed)),n.turbodrift--}if(n.champi&&(n.maxspeed=11,n.champi--,!n.champi&&delete n.champiType),n.billball){n.z=2,n.heightinc=0,n.speed=Math.min(30,13*cappedRelSpeed());var Lt,jt;if(null!=n.aipoint){var we=n.aipoints[n.aipoint];we?(Lt=we[0]-n.x,jt=we[1]-n.y,2e3>Lt*Lt+jt*jt&&!inTeleport(we[0],we[1])&&(n.aipoint++,n.aipoint>=n.aipoints.length&&(n.aipoint=0))):(Lt=0,jt=0)}else{var Ht=n.demitours+1;Ht>=oMap.checkpoint.length&&(Ht=0);var At=oMap.checkpointCoords[Ht];At?(Lt=At.O[0]-n.x,jt=At.O[1]-n.y):(Lt=0,jt=0);dance:for(var o=0,_t;o<oMap.aipoints.length;o++){_t=oMap.aipoints[o];for(var a=0,At;a<_t.length;a++)if(At=_t[a],n.x>At[0]-35&&n.x<At[0]+35&&n.y>At[1]-35&&n.y<At[1]+35){var Pt=a+1;Pt==_t.length&&(Pt=0);var R=_t[Pt][0],D=_t[Pt][1],Nt=n.rotation*Math.PI/180,Rt=Math.abs(normalizeAngle(Math.atan2(R-n.x,D-n.y)-Nt,2*Math.PI)),Dt=Math.abs(normalizeAngle(Math.atan2(Lt,jt)-Nt,2*Math.PI));if(Rt<Math.max(Dt,Math.PI/4)){n.aipoints=_t,n.aipoint=Pt,Lt=R-n.x,jt=D-n.y;break dance}}}}var Ft=Lt*direction(1,n.rotation)-jt*direction(0,n.rotation),Vt=Lt*direction(0,n.rotation)+jt*direction(1,n.rotation),Ot=180*(Math.atan2(Ft,Vt)/Math.PI),qt=Math.abs(Ot),Wt=Math.max(15,15/cappedRelSpeed());qt>Wt&&(60<qt?(n.speed=Math.min(n.speed,200/qt),Ot=0<Ot?30:-30):Ot=0<Ot?Wt:-Wt),n.rotation+=Ot,n.rotation%=360,n.billball--;if(n.billjump?4>n.billjump&&6>n.billball:12>n.billball){var y=n.speed*direction(0,n.rotation),h=n.speed*direction(1,n.rotation);(sauts(n.x,n.y,y,h)||6>n.billball&&(tombe(n.x,n.y)||tombe(n.x+y,n.y+h)))&&!n.cannon&&(n.billball0=Math.floor(12*n.billball0/n.billball),n.billball=12,n.billjump=(n.billjump||0)+1)}if(!n.billball){for(var o=0;o<strPlayer.length;o++)n.sprite[o].img.src=getSpriteSrc(n.personnage),resumeSpriteSize(n.sprite[o]);n.size=1,n.mini=0,n.cannon||(n.z=0),n.jumped=!1,delete n.billjump,delete n.billball0,consumeItem(e),updateProtectFlag(n),n.cpu||delete n.aipoint}updateItemCountdownHud(e,n.billball/n.billball0)}if(n.champior&&(n.champior--,0>=n.champior&&(delete n.champior,delete n.champior0,consumeItem(e)),updateItemCountdownHud(e,n.champior/n.champior0)),n.etoile&&(n.maxspeed+=2,n.etoile--,15>n.etoile)){for(var o=0;o<strPlayer.length;o++)n.sprite[o].img.src=n.etoile%2?getStarSrc(n.personnage):getSpriteSrc(n.personnage);if(!n.etoile){updateProtectFlag(n);var Xt=n.cpu?1:n.stats.acceleration*n.size*fSelectedClass;n.speedinc=Math.min(n.speedinc,Xt),stopStarMusic(n)}}if(n.megachampi&&(n.megachampi--,71<n.megachampi?n.size*=1.05:8>n.megachampi&&(n.size/=1.05,!n.megachampi&&(updateProtectFlag(n),stopMegaMusic(n)))),n.mini&&(n.mini--,1>n.mini&&(n.mini=0,E&&(n.size=1))),n.cannon){var Gt=3*Math.pow(cappedRelSpeed(n),-2);n.speed=(n.speed*Gt+20)/(Gt+1),n.billball&&(n.speed=20),n.maxspeed=n.speed/(n.size*fSelectedClass),n.speedinc||(n.speedinc=.01),n.z=(3*n.z+4)/4,n.heightinc=0,n.rotinc=0;var Kt=n.cannon[2]-n.x,Ut=n.cannon[3]-n.y,Yt=n.cannon[0]-n.cannon[2],Jt=n.cannon[1]-n.cannon[3],Qt=Math.hypot(Yt,Jt),$t=Math.hypot(Kt,Ut)/Qt;if(.2>$t){var l=n.cannon[0]-n.x,Zt=n.cannon[1]-n.y;n.rotation=nearestAngle(180*Math.atan2(l,Zt)/Math.PI,n.rotation,360)}else $t*Qt>=Qt-40&&(.01>=Math.abs(n.speedinc)&&(n.speedinc=0),delete n.cannon,n.fell=!0,updateProtectFlag(n))}if(!n.z&&(!n.heightinc||1>=fSelectedClass)&&accelere(f,x,y,h)&&(!n.champi&&(n.champiType=2),n.champi=20,n.maxspeed=11,n.speed=n.maxspeed*cappedRelSpeed(n),!n.boostSound&&(n.boostSound=playIfShould(n,"musics/events/boost.mp3"),n.boostSound&&(n.boostSound.onended=function(){n.boostSound=void 0,document.body.removeChild(this)}))),!iSfx||n!=oPlayers[0]||finishing||n.cpu||n.loose&&!isOnline||(bMusic&&(n.etoile||n.megachampi)||n.tombe||n.turbodrift||n.turboSound?(updateEngineSound(),n.turbodrift==n.turbodrift0-1&&(carEngine3.currentTime=0,carEngine3.volume=vSfx,carEngine3.play(),n.turboSound=carEngine3,clearTimeout(n.turboHandler),n.turboHandler=setTimeout(function(){n.turboSound&&(n.turboSound.pause(),n.turboSound=void 0)},2e3),n.sparkSound&&(fadeOutMusic(n.sparkSound,1,.8,!1,vSfx),n.sparkSound=void 0)),bMusic&&n.protect&&n.turboSound&&(n.turboSound.volume=0)):updateEngineSound(3<n.speed?carEngine2:carEngine)),"BB"==course&&!n.ballons.length&&!n.tourne&&!n.loose){for(var ei=n.sprite[0].div.style.opacity-.1,o=0;o<strPlayer.length;o++)n.sprite[o].div.style.opacity=ei,n.driftSprite[o].div.style.opacity=ei;var ti=isOnline&&(n==oPlayers[0]||onlineSpectatorId),ii=ti?.4:.01;if(ei<ii){if(!ti)for(var o=0;o<strPlayer.length;o++)n.sprite[o].img.style.display="none",n.driftSprite[o].img.style.display="none",n.marker&&(n.marker.div[o].style.display="none");else if(onlineSpectatorId&&n.marker)for(var o=0;o<strPlayer.length;o++)n.marker.div[o].style.display="none";1<aKarts.length?n.loose=!0:n.losing=!0,challengeCheck("each_kill")}}}function kartIsPlayer(e){return isOnline?!onlineSpectatorId&&e==oPlayers[0]:!e.cpu}function isControlledByPlayer(e){var t=aKarts.find(function(t){return t.id==e});return t&&(t.id==identifiant||t.controller==identifiant)}function timeTrialMode(){return"CM"==course||!!(isOnline&&shareLink.options&&shareLink.options.timeTrial)}function handleDriftCpt(e){var t=aKarts[e];if(!t.driftinc)t.drift&&(0>t.drift?t.drift=Math.min(0,t.drift+1):0<t.drift&&(t.drift=Math.max(0,t.drift-1)));else if(t.rotincdir&&(0<t.rotincdir==0<t.driftinc?(t.drift+=t.driftinc,0<t.driftinc?6<t.drift?t.drift=6:0>t.drift&&(t.drift=Math.ceil(t.drift/2)):-6>t.drift?t.drift=-6:0<t.drift&&(t.drift=Math.floor(t.drift/2))):0<t.rotincdir?(t.drift++,0<t.drift&&(t.drift=0)):(t.drift--,0>t.drift&&(t.drift=0))),160>t.driftcpt){var n=t.driftcpt;if(t.rotincdir?0<t.rotincdir==0<t.driftinc?t.driftcpt+=6*Math.max(.7,Math.pow(Math.abs(t.rotincdir)/.6,.8)):t.driftcpt++:t.driftcpt+=2,160<=t.driftcpt){for(var l=0;l<oPlayers.length;l++)t.driftSprite[l].setState(2);carSpark&&t===oPlayers[0]&&(carSpark.currentTime=0,carSpark.volume=vSfx,carSpark.play(),t.sparkSound=carSpark)}else if(80>n&&80<=t.driftcpt){for(var l=0;l<oPlayers.length;l++)t.driftSprite[l].setState(1);carSpark&&t===oPlayers[0]&&(carSpark.currentTime=0,carSpark.volume=.7*vSfx,carSpark.play(),t.sparkSound=carSpark)}}}function angleDrift(e){return e.sliding&&kartIsPlayer(e)?e.rotinc*e.sliding:6*e.drift}function angleInc(e){return(e.rotinc+1.5*(e.driftinc||0))*(0>e.speedinc||0==e.speedinc&&0>e.speed?-1:1)*Math.abs(Math.cos(angleDrift(e)*Math.PI/180))}function angleShoot(e,t){var i=e.rotation;return t&&(i+=180),i}function dirShoot(e,t,i){var n=t?[0,0]:kartInstantSpeed(e),l=angleShoot(e,t);return n[0]+=i*direction(0,l),n[1]+=i*direction(1,l),n}function tendsToSpeed(e,t,i){var n=Math.hypot(e.vx,e.vy);if(n){var l=n*(1-i)+t*i;e.vx*=l/n,e.vy*=l/n}}function kartInstantSpeed(e){var t=e.rotation-angleDrift(e),i=e.speed*direction(0,t),n=e.speed*direction(1,t);return e.shift&&(i+=e.shift[0],n+=e.shift[1]),[i,n]}function handleExplosionHit(e,t){var i=aKarts[e];loseBall(e),i.spin(t),loseUsingItems(i),stopDrifting(e),84<=t&&(i.champi=0,delete i.champiType,i.speed=0,i.heightinc=3,supprArme(aKarts.indexOf(i)))}function handleHardHit(e){var t=aKarts[e];loseBall(e),stopDrifting(e),t.spin(42),loseUsingItem(t)}function handleSoftHit(e){var t=aKarts[e];loseBall(e),stopDrifting(e),t.spin(20),loseUsingItem(t)}function handlePoisonHit(e){var t=aKarts[e];loseBall(e),stopDrifting(e),t.spin(20),loseUsingItems(t),t.size=.6,t.mini=Math.max(t.mini,60)}function handleDecorExplosions(e,t){if(oMap.decor)for(var n in oMap.decor){var l=decorBehaviors[n];if(l.damagingItems&&l.damagingItems[e.type])for(var o=0,a;o<oMap.decor[n].length;o++)a=oMap.decor[n][o],t(a[0],a[1],e)&&handleDecorHit(o,n)}}function updateObjHud(e){for(var t=aKarts[e],n=0;n<oRoulettesPrefixes.length;n++){var l=oRoulettesPrefixes[n],o=oArmeKeys[n],a=t[o],s=!1,r=!1;a&&(25>t["roulette"+l]?r=!0:s=!0);var p=n?2.5:4;document.getElementById("scroller"+l+e).style.visibility=r?"visible":"hidden",document.getElementById("roulette"+l+e).innerHTML=s?"<img alt=\""+a+"\" class=\"pixelated\" src=\"images/items/"+a+".png\" style=\"height: "+Math.round(iScreenScale*p)+"px;\" />":""}var d=document.getElementById("scroller"+e),c=document.getElementById("objet"+e),u=1;t.stash?(document.getElementById("reserve"+e).style.visibility="visible",c.style.left=Math.round(3*iScreenScale)+"px",c.style.top=Math.round(3*iScreenScale)+"px",d.style.left=Math.round(3*iScreenScale)+"px",d.style.top=Math.round(3*iScreenScale+iScreenScale*u)+"px"):(document.getElementById("reserve"+e).style.visibility="hidden",c.style.left=Math.round(iScreenScale)+"px",c.style.top=Math.round(iScreenScale)+"px",d.style.left=iScreenScale+"px",d.style.top=Math.round(iScreenScale+iScreenScale*u)+"px")}function updateItemCountdownHud(e,t){var i=document.getElementById("countdown"+e);if(i)if(0<t){i.style.display="block";var n=8.5*iScreenScale,l=6.25*iScreenScale,o=Math.atan2(l,n),a=2*Math.PI,s=.2,r=s+t*(a-s)+o,p=n/2-n*Math.cos(r),d=l/2-l*Math.sin(r),c=[[0,0],[iScreenScale,0],[Math.round(2.5*iScreenScale),2*iScreenScale],[n/2,l/2],[p,d]];r>a-o&&c.push([0,l]),r>a-Math.PI+o&&c.push([n,l]),r>a-Math.PI-o&&c.push([n,0]),i.style.clipPath="polygon("+c.map(function(e){return e[0]+"px "+e[1]+"px"}).join(", "),")"}else i.style.display="none",i.style.clipPath=""}function updateLapHud(e){for(var t=getPlayerAtScreen(e),n=document.querySelectorAll("#compteur"+e+" .tour"),l=0;l<n.length;l++)n[l].innerHTML=Math.min(t.tours,oMap.tours)}function timeStr(e){var t=Math.floor(e/6e4);e-=6e4*t,t+="";var i=Math.floor(e/1e3);for(e-=1e3*i,i+="",2>i.length&&(i="0"+i),e+="";3>e.length;)e="0"+e;return t+"'"+i+"&quot;"+e}function updateSpeedometer(e,t,i){if($speedometerVals[e]){var n=aKarts[e],l=10*Math.hypot(n.x-t,n.y-i);0>n.speed&&(l=-l),n.tombe&&(l=0),$speedometerVals[e].innerHTML=l.toFixed(1)}}function handleWrongWay(e){if(oMap.checkpoint&&!isCup&&!onlineSpectatorId){for(var t=!0,n=!1,l=1;l<=oMap.checkpointCoords.length;l++){var o=(e.demitours+l)%oMap.checkpointCoords.length,a=oMap.checkpointCoords[o],s=projete(e.x,e.y,a.O[0],a.O[1],a.O[0]+a.u[0],a.O[1]+a.u[1]),r=a.O[0]+s*a.u[0],p=a.O[1]+s*a.u[1],d=Math.atan2(r-e.x,p-e.y),c=Math.atan2(a.O[0]-e.x,a.O[1]-e.y),u=e.rotation*Math.PI/180,m=Math.abs(nearestAngle(d-u,0,2*Math.PI)),y=Math.abs(nearestAngle(c-u,0,2*Math.PI)),h=(m+y)/2;if(h<.6*Math.PI&&(t=!1,h<.45*Math.PI)){n=!0;break}if(!oMap.checkpoint[o][4])break}if(!e.wrongWaySince)!t||e.tombe||e.tourne||(e.wrongWaySince=1);else if(e.rightWaySince)e.rightWaySince++,10<e.rightWaySince&&resetWrongWay(e);else{if(e.wrongWaySince++,10<e.wrongWaySince&&!e.wrongWaySprite){e.wrongWaySprite=new Sprite("wrongway");for(var g=0,b;g<oPlayers.length;g++)b=e.wrongWaySprite[g],b.nbSprites=2,b.w=36,b.h=32;!e.wrongWaySound&&shouldPlaySound(e)&&(e.wrongWaySound=loadMusic("musics/events/wrongway.mp3",!0),document.body.appendChild(e.wrongWaySound))}n&&(e.rightWaySince=1,removeIfExists(e.wrongWaySound))}}}function resetWrongWay(e){delete e.wrongWaySince,delete e.rightWaySince,e.wrongWaySprite&&(e.wrongWaySprite[0].suppr(),delete e.wrongWaySprite),removeIfExists(e.wrongWaySound),delete e.wrongWaySound}function openCheats(){var e=prompt("MKPC Console command");return!!e&&void(processCode(e)?(clLocalVars.cheated=!0,clSelected&&challengeHandleFail()):alert("Invalid command"))}function processCode(e){if("/"!=e.charAt(0))return!1;e=e.substring(1);var n=oPlayers[0],l=/^give (\w+)$/g.exec(e);if(l){var o=l[1],a=!1,s=getItemMode(),r=itemDistributions[s].concat(customItemDistrib[s]);dance:for(var p=0,d;p<r.length;p++){d=r[p];for(var u=0;u<d.value.length;u++)if(null!=d.value[u][o]){a=!0;break dance}}return!!a&&(n.billball?(n.stash=o,n.roulette2=25):(n.arme=o,n.roulette=25),updateObjHud(0),!0)}var m=/^tp ([\d\-+\.]+) ([\d\-+\.]+)$/g.exec(e);if(m||(m=/^tp ([\d\-+\.]+) ([\d\-+\.]+) ([\d\-+\.]+)$/g.exec(e)),m){var h=parseFloat(m[1]),g=parseFloat(m[2]);if(isNaN(h)||isNaN(g))return!1;var y=parseFloat(m[3]);return n.x=h,n.y=g,isNaN(y)||(n.rotation=y),resetRenderState(),!0}var b=/^lap(?: ([1-3]|c))?(?: (\d+|c))?$/g.exec(e);if(b){var f=parseInt(b[1]),x=parseInt(b[2]);return("c"==b[1]&&(f=n.tours),b[1]||(f=oMap.tours,x=oMap.checkpoint.length-1),"c"==b[2]&&(x=n.demitours),b[2]||(x=oMap.checkpoint.length-1),!(isNaN(f)||isNaN(x)))&&(n.tours=f,n.demitours=x,updateLapHud(0),!0)}if("pos"==e)return alert("x: "+Math.round(n.x)+"\ny: "+Math.round(n.y)+"\ntheta: "+Math.round(n.rotation)),!0;if("xs"==e)return n.size=.6,n.mini=0,!0;if("md"==e)return n.size=1,n.mini=0,!0;if("xl"==e)return n.size=Math.pow(1.05,8),n.mini=0,!0;if("BB"==course){"balloon"==e&&(e+=" 1");var v=/^balloon (\d+)$/g.exec(e);if(v){var C=parseInt(v[1]);if(C)return n.reserve+=C,updateBalloonHud(document.getElementById("compteur0"),n),!0}}return!1}function distToAiPoints(e,t,n){for(var o=1/0,a=0;a<n.length;a++){var s=(a+1)%n.length,r=n[a][0],p=n[a][1],d=n[s][0],c=n[s][1],u=projete(e,t,r,p,d,c);0>u&&(u=0),1<u&&(u=1);var m=r+(d-r)*u,y=p+(c-p)*u;o=Math.min(o,(m-e)*(m-e)+(y-t)*(y-t))}return o}function distToNextShortcut(e){var t=e.aipoint,i=e.aipoints[t];if(!i)return 1/0;for(var n=Math.hypot(i[0]-e.x,i[1]-e.y);;){if(e.aishortcuts[t]&&hasShortcutItem(e,e.aishortcuts[t])&&!hasExtraShortcutItem(e,e.aishortcuts[t]))return n;var l=t+1;if(l>=e.aipoints.length){if(oMap.sections||e.tours>=oMap.tours)return 1/0;l=0}var o=e.aipoints[l];if(n+=Math.hypot(o[0]-i[0],o[1]-i[1]),t=l,i=e.aipoints[t],t==e.aipoint)return 1/0}}function hasShortcutItem(e,t){return!e.using.length&&25==e.roulette&&isShortcutItem(e.arme,t)}function isShortcutItem(e,t){return isShortcutItemKey(e,t)}function isShortcutItemKey(e,t){return!!e&&(!t||t[2].itemsDict[e])}function hasExtraShortcutItem(e,t){if(25==e.roulette2&&isShortcutItem(e.stash,t))return!0;if(isShortcutItemKey("champi",t))switch(e.arme){case"champiX2":case"champiX3":return!0;case"champior":if(e.champior)return!0;}return!1}function ai(e){var t=isBattle&&simplified,n=isBattle&&complete,o=!isBattle&&complete;if(null==e.aipoint)if(delete e.aishortcut,"BB"!=course)for(var a=1/0,s=0;s<e.aipoints.length;s++){var r=e.aipoints[s],p=r[0]-e.x,d=r[1]-e.y,c=Math.sqrt(p*p+d*d),m=c*Math.abs(nearestAngle(Math.atan2(p,d)-e.rotation*Math.PI/180,0,2*Math.PI)),y=2*c+m;y<a&&(e.aipoint=s,e.lastAItime=0,a=y)}else t&&(e.aipoint=Math.floor(e.x/100)+6*Math.floor(e.y/100),e.lastAItime=0,e.lastAI=-1);if(!e.billball&&!e.tombe){if(oMap.sections&&e.tours>oMap.tours||e.ballons&&!e.ballons.length&&!e.loose)return e.speedinc=0,e.rotinc=0,void(e.rotincdir=0);if(e.tourne)return e.speedinc=!e.z&&1<e.speed?1:0,e.rotinc=0,void(e.rotincdir=0);if(e.aipoints.length){for(var g=0,b=2*Math.PI,x=0,C=0;C<e.aipoints.length;C++){var k=e.aipoint,E,S,T;if("BB"!=course){if(null==e.aishortcut||e.aishortcuts[e.aipoint]||delete e.aishortcut,null!=e.aishortcut){var I=e.aishortcuts[e.aipoint],z=I[0];E=0<e.aishortcut&&e.aishortcut<=z.length?z[e.aishortcut-1]:e.aipoints[k];var B;e.aishortcut<z.length?(S=z[e.aishortcut],e.aishortcut+1<z.length?T=z[e.aishortcut+1]:B=I[1]):(k=I[1],S=e.aipoints[k],B=k+1),null!=B&&(B>=e.aipoints.length&&(B=0),T=e.aipoints[B])}else{var M=k-1;0>M&&(M+=e.aipoints.length);var B=k+1;B>=e.aipoints.length&&(B=0),E=e.aipoints[M],S=e.aipoints[k],T=e.aipoints[B]}}else if(t){E=[100*(e.lastAI%6)+50,100*Math.floor(e.lastAI/6)+50],S=[100*(e.aipoint%6)+50,100*Math.floor(e.aipoint/6)+50],T=[E[0]+2*(S[0]-E[0]),E[1]+2*(S[1]-E[1])];var L=Math.floor(e.x/100)+6*Math.floor(e.y/100);if(L!=e.lastAI){var H=!0;if(0<=e.speed&&!e.tombe){var A=(S[0]-e.x)*(S[0]-e.x)+(S[1]-e.y)*(S[1]-e.y);switch(oMap.skin){case 27:H=1500>A;break;case 48:H=900>A;}}if(H){var _=e.aipoints[L];if(!_||!_.length){_=[],L%6&&_.push(L-1),5>L%6&&_.push(L+1),6<=L&&_.push(L-6),30>L&&_.push(L+6);var P=_.indexOf(e.lastAI);-1!=P&&_.splice(P,1)}var N=e.lastAI;e.lastAI=L;do e.aipoint=_[Math.floor(Math.random()*_.length)];while(N==e.aipoint&&1<_.length)}e.nextAiStop=void 0,e.randShift=void 0}}else{if(null==e.aipoint){e.lastAI=void 0,e.nextAI=void 0;for(var a=1/0,s=0;s<e.aipoints.length;s++)if(s!=e.lastAI){var r=e.aipoints[s];if(0==r[0]){var p=r[1]-e.x,d=r[2]-e.y,c=Math.sqrt(p*p+d*d),m=c*Math.abs(nearestAngle(Math.atan2(p,d)-e.rotation*Math.PI/180,0,2*Math.PI)),y=2*c+m;y<a&&(e.aipoint=s,e.lastAItime=0,a=y)}}}if(S=e.aipoints[e.aipoint].slice(1),e.lastAI?E=e.aipoints[e.lastAI].slice(1):(!e.lastAIpt&&(e.lastAIpt=[e.x,e.y]),E=e.lastAIpt),void 0===e.nextAI){for(var _=[],s=0,r;s<e.aipoints.length;s++)r=e.aipoints[s],1==r[0]&&(r[1]==e.aipoint?_.push(r[2]):!r[3]&&r[2]==e.aipoint&&_.push(r[1]));if(_.length)do e.nextAI=_[Math.floor(Math.random()*_.length)];while(e.lastAI==e.nextAI&&1<_.length);else e.nextAI=-1}T=-1==e.nextAI?E:e.aipoints[e.nextAI].slice(1)}e.speedinc=1,e.lastAItime++;var R=S[0]-E[0],u=S[1]-E[1],v=Math.hypot(R,u),w=T[0]-S[0],D=T[1]-S[1],F=10*Math.PI/180,V=20;if(n&&(V=15),!e.nextAiStop){e.nextAiStop=nextAiStop(E[0],E[1],R,u,S[0],S[1],w,D,e.maxspeed/F);var O=1-50/v;e.nextAiStop<O&&(e.nextAiStop=O)}if(!e.randShift)if(e.randShift=10*Math.random()-5,null!=oMap.randshift&&(e.randShift*=oMap.randshift),n)e.randShift/=1.5;else if(o||null!=e.aishortcut){var q=v/10;Math.abs(e.randShift)>q&&(e.randShift=q*Math.sign(e.randShift))}var W=projete(e.x,e.y,E[0],E[1],S[0],S[1]),X=E[0]+W*(S[0]-E[0]),G=E[1]+W*(S[1]-E[1]),K=Math.hypot(e.x-X,e.y-G);if(R||u||(K=0,e.nextAiStop=0,W=1),W>=e.nextAiStop&&K<V&&!t){if("BB"==course)e.lastAI=e.aipoint,delete e.lastAIpt,e.aipoint=-1==e.nextAI?void 0:e.nextAI,e.nextAI=void 0;else if(!inTeleport(S[0],S[1]))if(null!=e.aishortcut&&e.aishortcuts[e.aipoint]){var I=e.aishortcuts[e.aipoint],z=I[0];e.aishortcut<z.length?e.aishortcut++:e.aipoint=I[1]}else e.aishortcuts&&e.aishortcuts[e.aipoint]&&hasShortcutItem(e,e.aishortcuts[e.aipoint])?e.aishortcut=0:(e.aipoint++,e.aipoint>=e.aipoints.length&&(e.aipoint=0));e.nextAiStop=void 0,e.randShift=void 0,e.lastAItime=0;continue}var U=!1;if(e.bounced)e.rotinc=e.bouncedsince?0:10*Math.random(),e.bouncedsince++,10==e.bouncedsince&&(delete e.bouncedsince,delete e.bounced),U=!0;else if(e.collided){if(delete e.recovering,delete e.minDecor,e.recovertime||(e.recovertime=21+Math.floor(10*Math.random())),!!e.collidesince)e.collidesince>e.recovertime&&(e.randShift=Math.random()*e.recovertime/2-e.recovertime/4,e.recovertime+=30,e.decision=-e.decision,e.collidesince=1,t&&(e.lastAI=e.aipoint));else if(e.collidesince=1,!e.decision){var Y=direction(0,e.rotation),J=direction(1,e.rotation),Q=e.horizontality[0],$=e.horizontality[1];e.decision=0<Y*Q+J*$==0<Y*$-J*Q?-1:1}if(e.collidesince++,e.horizontality){var Y=direction(0,e.rotation),J=direction(1,e.rotation),Q=e.horizontality[0],$=e.horizontality[1];(.1<Math.abs(Y*$-J*Q)||150<e.lastAItime)&&(e.rotinc=10*e.decision)}else e.rotinc=10*e.decision;U=!0}else{g=(e.nextAiStop-W)*v,e.collidesince&&(!e.recovering&&(e.recovering=1),e.recovering++,U=!0,20<=e.recovering&&(delete e.recovering,delete e.recovertime,delete e.decision,delete e.collidesince));var Z,ee,te;if(K<V)Z=S[0]+e.randShift*u/v,ee=S[1]-e.randShift*R/v,te=Math.atan2(Z-e.x,ee-e.y);else{var ie=followCircleWithAngle(e.x,e.y,S[0],S[1],R,u),ne=E[0]+(e.x-X)*V/K,le=E[1]+(e.y-G)*V/K,oe=intersectionLineCircle(ie[0],ie[1],ie[2],ne,le,R,u);Z=ne+oe*R,ee=le+oe*u;var ae=ie[1]-e.y,se=e.x-ie[0];0>ae*(X-e.x)+se*(G-e.y)&&(ae=-ae,se=-se),te=Math.atan2(ae,se);var re=Math.atan2(S[0]-e.x,S[1]-e.y),pe=normalizeAngle(te-re,2*Math.PI),de=.3;Math.abs(pe)>de&&(te=re+de*Math.sign(pe))}var ce=e.x,ue=e.y,me=Z,ye=ee,he=Math.hypot(me-ce,ye-ue),ge=(me-ce)*e.speed/he,be=(ye-ue)*e.speed/he,fe=1,xe;if(!isCup)for(var ve in decorPos){var Ce=decorBehaviors[ve].hitbox||5;Ce*=1.1;for(var s=0;s<decorPos[ve].length;s++)for(var ke=decorPos[ve][s],Ee=[[ke.x-Ce,ke.y-Ce,2*Ce,0],[ke.x-Ce,ke.y-Ce,0,2*Ce],[ke.x-Ce,ke.y+Ce,2*Ce,0],[ke.x+Ce,ke.y-Ce,0,2*Ce]],we=ge-ke.vX,Se=be-ke.vY,Te=0;Te<Ee.length;Te++){var Ie=Ee[Te],ze=secants(ce,ue,ce+16*we,ue+16*Se,Ie[0],Ie[1],Ie[0]+Ie[2],Ie[1]+Ie[3]);ze&&ze[0]<fe&&(xe={type:ve,i:s,line:Ie,inter:ze,box:[Ie[0]+16*ke.vX*ze[1],Ie[1]+16*ke.vY*ze[1],Ie[2],Ie[3]]},fe=ze[0])}}if(xe){var Be=xe.box[0],Me=xe.box[1],Le=xe.box[0]+xe.box[2],je=xe.box[1]+xe.box[3],He=distToAiPoints(Be,Me,e.aipoints),Ae=distToAiPoints(Le,je,e.aipoints);Be-=xe.box[2]/1.5,Me-=xe.box[3]/1.5,Le+=xe.box[2]/1.5,je+=xe.box[3]/1.5,He<Ae?(Z=Be,ee=Me):(Z=Le,ee=je),te=Math.atan2(Z-e.x,ee-e.y),e.minDecor={x:Z,y:ee,t:10}}else if(e.minDecor){var _e=e.minDecor.x,Pe=e.minDecor.y;if(e.minDecor.t--,0>e.minDecor.t)delete e.minDecor;else if(300>(e.x-_e)*(e.x-_e)+(e.y-Pe)*(e.y-Pe))delete e.minDecor;else{var Ne=direction(0,e.rotation),Re=direction(1,e.rotation),De=_e-e.x,Fe=Pe-e.y;0>De*Ne+Fe*Re&&delete e.minDecor}e.minDecor&&(Z=_e,ee=Pe)}var Ve=e.rotation,Oe=e.speed;if(e.shift&&!isCup){var qe=flowShift(e.x,e.y,e.protect);if(qe){var We=kartInstantSpeed(e);if(qe[2])Oe=Math.min(Oe,Math.hypot(We[0],We[1]));else{Ve=180*Math.atan2(We[0],We[1])/Math.PI;var Xe=Math.pow(cappedRelSpeed(e),-2);qe[0]*qe[0]+qe[1]*qe[1]>=10*Xe&&(Ve+=.15*(Ve-e.rotation)*Xe)}isNaN(Ve)&&(Ve=e.rotation)}}te=nearestAngle(180*te/Math.PI,Ve,360),isNaN(te)&&(te=Ve),isNaN(Z)&&(Z=S[0]),isNaN(ee)&&(ee=S[1]);var pe=te-Ve;e.rotinc=Math.max(Math.min(pe,10),-10);var Ge=Math.abs(pe);b=Ge,isBattle&&(Ge*=Math.pow(Ge/10,1.5)),g=Math.hypot(Z-e.x,ee-e.y);var Ke=Math.atan2(Z-E[0],ee-E[1])-e.rotation,Ue=(Math.abs(Math.sin(Ke))+Ge*Math.PI/180/2)/F,x=g/Ue;if("BB"==course){var Ye=Math.max(5,Ue/1.57);if(Ue>Ye){var Je=getNearestHoleDist(e.x,e.y,1600);x=1600>Je?g/Math.pow(Ye*Math.tan(Ue/Ye),1.5):g/Math.pow(Ue,1.2)}}if(10<Ge){if(K<V){var Qe=aiMarginLimitSpeed(e.x,e.y,direction(0,e.rotation),direction(1,e.rotation),S[0],S[1],R,u,2*V,F);Qe<x&&(x=Qe)}var $e=x;e.bloops&&e.bloops.effective(e)&&($e=Math.min($e,3)),$e/=.9,$e||($e=.01),32==oMap.skin&&6<Oe&&$e<Oe-1?(e.speed=Math.max($e,e.speed-2),e.speedinc=0):e.speedinc=Math.max(Math.min($e-Oe,1),-1),0>e.speedinc&&(e.rotinc=-e.rotinc)}}U&&e.lastAItime>250+50*Math.random()&&!t&&(e.aipoint=void 0);break}if((25==e.roulette||e.using[0])&&!e.tourne&&!e.cannon){function t(t,n,l,o,a){for(var s=isOnline?aKarts.length:strPlayer.length,r=0;r<s;r++){var p=aKarts[r],d=o*Math.max(.2,Math.min(Math.abs(p.speed)/5,1));if(!p.loose&&!p.protect&&!p.cpu){var c=(p.x-e.x)*(p.x-e.x)+(p.y-e.y)*(p.y-e.y);if(c>=t*t&&c<n*n){var u=180*Math.atan2(p.x-e.x,p.y-e.y)/Math.PI;a&&(u+=180);var m=Math.abs(nearestAngle(u-e.rotation,0,360));if(m>=l&&m<d)return!0}}}return!1}var Ze=!1;if(!isOnline||e.controller==identifiant)if(e.using.length)switch(e.using[0].type){case"carapace-rouge":"BB"==course&&2>e.using.length?t(15,100,0,30)&&arme(aKarts.indexOf(e)):Ze=!0;break;case"carapace":"BB"==course&&2>e.using.length?((t(0,20,0,30)||t(0,150,0,15))&&arme(aKarts.indexOf(e)),(t(0,20,0,30,!0)||t(0,80,0,15,!0))&&arme(aKarts.indexOf(e),!0)):Ze=!0;break;default:Ze=!0;}else{var et=!1,tt=!1;if(e.aishortcuts){var it;if(hasShortcutItem(e))if(null!=e.aishortcut)tt=!0,!e.champi&&(8<=x||5<=x-e.speed)&&10>=b&&arme(aKarts.indexOf(e));else{if(it=e.shouldWaitItemCache,!(it&&it.isValid()))if(1e3>distToNextShortcut(e))it={value:!0,isValid:function(){return!0}};else{var nt=e.aipoint;it={value:!1,isValid:function(){return e.aipoint===nt}}}et=it.value}e.shouldWaitItemCache=it}if(!et&&!tt)switch(e.arme){case"megachampi":case"etoile":11<=x&&100<=g&&10>=b&&arme(aKarts.indexOf(e));break;case"champi":case"champiX2":case"champiX3":!e.champi&&11<=x&&100<=g&&10>=b&&arme(aKarts.indexOf(e));break;case"champior":e.champior?(8<=x||5<=x-e.speed)&&10>=b&&arme(aKarts.indexOf(e)):11<=x&&100<=g&&10>=b&&arme(aKarts.indexOf(e));break;default:Ze=!0;}}if(Ze&&.98<Math.random()){var lt=!0;if(e.using.length)switch(e.using[0].type){case"banane":case"fauxobjet":case"poison":lt=!1;}var ot=((lt?e.place<oPlayers[0].place:e.place>oPlayers[0].place)||"BB"==course)&&.5<Math.random(),at=ot&&lt,st=ot&&!lt;arme(aKarts.indexOf(e),at,st)}}!oMap.jumpable||!(4<iDificulty)||!e.z||e.jumped||e.billball||e.figstate||e.figuring||e.tourne||!(0<e.heightinc)||!(8<=x)||oMap.jumpexc&&-1!=oMap.jumpexc.indexOf(e.aipoint)||(e.figstate=21)}}}function moveItems(){for(var e in collisionTest=1,collisionTeam=void 0,clLocalVars.currentKart=void 0,nextBlueShellCooldown&&nextBlueShellCooldown--,itemBehaviors){var t=itemBehaviors[e].move;if(t)for(var n=items[e],l=n.length-1;0<=l;l--)n[l]&&t(n[l])}}function moveDecor(){for(var e in decorPos={},oMap.decor)if(decorBehaviors[e].dodgable){decorPos[e]=[];for(var t=oMap.decor[e],n=0;n<t.length;n++)decorPos[e].push({aX:t[n][0],aY:t[n][1],x:t[n][0],y:t[n][1],vX:0,vY:0})}var l={};for(var e in oMap.decor){var t=oMap.decor[e],o=decorBehaviors[e];if(o.move){var a=getDecorActualType(o),s=0;l[a]?s=l[a]:l[a]=0;for(var n=0;n<t.length;n++)o.move(t[n],n,n+s,o.scope);l[a]+=t.length}}var r=2*Math.PI;for(var e in decorPos)for(var t=oMap.decor[e],n=0;n<t.length;n++)decorPos[e][n].x=t[n][0],decorPos[e][n].y=t[n][1],decorPos[e][n].vX=decorPos[e][n].x-decorPos[e][n].aX,decorPos[e][n].vY=decorPos[e][n].y-decorPos[e][n].aY;if(oMap.pointers)for(var n=0,p;n<oMap.pointers.length;n++)p=oMap.pointers[n],p[2][2]+=p[2][3],p[2][2]%=r,p[0].redraw(p);if(oMap.flippers)for(var n=0;n<oMap.flippers.length;n++){var d=oMap.flippers[n],c=d[3][0];switch(c){case 0:0>=--d[3][1]&&(d[3][0]=1,d[3][1]=d[2][2],d[2][3]=.13*d[2][4]);break;case 1:case 2:var u=1==c?d[3][1]+d[2][4]:d[3][1];d[2][2]+=d[2][3],d[2][2]*d[2][3]>=u*d[2][3]&&(d[2][2]=u,1==c?(d[3][0]=2,d[2][3]=-d[2][3]):(d[3][0]=0,d[2][3]=0,d[3][1]=1+Math.floor(50*Math.random())));}c&&d[0].redraw(d)}if(oMap.bumpers)for(var n=0,m;n<oMap.bumpers.length;n++)if(m=oMap.bumpers[n],m[2][5]){if(!m[3]){var y=Math.hypot(m[1][0]-m[2][3],m[1][1]-m[2][4]),h=Math.atan2(m[1][1]-m[2][4],m[1][0]-m[2][3]);m[3]=[y,h]}m[3][1]+=m[2][5],m[3][1]%=r,m[1][0]=m[2][3]+m[3][0]*Math.cos(m[3][1]),m[1][1]=m[2][4]+m[3][0]*Math.sin(m[3][1]),m[0].redraw(m)}if(oMap.sea){var g=oMap.sea,b=g.progress,f=120,x=f,v=30,C=v,k=(timer+f/2)%(f+x+v+C);if(g.progress=k<f?1:k<f+v?.5-.5*Math.sin(Math.PI*((k-f)/v-.5)):k<f+x+v?0:.5+.5*Math.sin(Math.PI*((k-f-x-v)/C-.5)),g.progress!==b&&(oMap.horspistes.eau.polygon=g.offroad0.slice(),g.progress))for(var E=.99*g.progress,n=0;n<g.waves.length;n++)oMap.horspistes.eau.polygon.push(g.polygon(n,0,E))}if(oMap.coins)for(var n=0,w;n<oMap.coins.length;n++)w=oMap.coins[n],w.theta+=.25,w.theta>=r&&(w.theta-=r)}function handleGamepadEvents(){if(gameControls.gamepad)for(var e=0,t;e<gameControls.gamepad.length;e++)if(t=getGamepadInputsData(e,previouslyPressedBtns[e]),t){for(var n=t.pressedActions,l=t.pressActions,o=t.releaseActions,a=e?"_p2":"",s=oPlayers[e],r=0;r<l.length;r++){var p=l[r],d=p.key,c=d+a;"down"===d?n.up?doReleaseKey("up"):doPressKey(c):"up"===d?doPressKey(c):"item"===d||"item_fwd"===d||"item_back"===d?p.wasPressed||hasOnHoldItem(s)||doReleaseKey(c):"rear"===d?s.changeView||doReleaseKey(c):"pause"===d?pressKey(d):p.wasPressed||doPressKey(c)}for(var r=0;r<o.length;r++){var u=o[r],d=u.key,c=d+a;"item"===d||"item_fwd"===d||"item_back"===d?hasOnHoldItem(s)&&doReleaseKey(c):"rear"===d?s.changeView&&doReleaseKey(c):doReleaseKey(c)}}}function getGamepadInputsData(e,t){var i=gameControls.gamepad[e],n=findGamePadById(i);if(n){for(var l=getGamepadPressedBtns(n),o={},a=0;a<l.length;a++)o[l[a].key]=l[a];for(var s=[],r={},p={},d=[],c=[],a=0;a<i.controls.length;a++){var u=i.controls[a],m=u.inputs.every(function(e){var t=o[e.key];return t&&e.isPressed(t)}),y=t[a];if(m){for(var h=!1,g=0;g<s.length;g++)if(isGamepadControlSubset(u.inputs,s[g].inputs)){h=!0;break}if(!h){s.push(u);var b=u.key;t[a]=!0,d.push({key:b,wasPressed:y}),r[b]=!0}}else if(y){var f=u.inputs.every(function(e){var t=o[e.key];return!t||"stick"===t.type});if(f){var b=u.key;t[a]=void 0,c.push({key:b}),p[b]=!0}}}return{pressedBtnsRaw:l,pressedBtns:s,pressedActions:r,releasedActions:p,pressActions:d,releaseActions:c}}}function handleAudio(){if(mapMusic&&mapMusic.opts&&mapMusic.yt&&mapMusic.yt.getCurrentTime){var e=mapMusic.yt.getCurrentTime(),t=mapMusic.opts.end?e>mapMusic.opts.end:0===mapMusic.yt.getPlayerState()&&e>mapMusic.yt.getDuration()-1;if(t){var i=mapMusic.opts.start||0;i<e&&mapMusic.yt.seekTo(i,!0)}}}function handleChallengeEvents(){var e=oPlayers[0],t=0<e.z;if(clLocalVars.zonesHit)for(var n=e.x,l=e.y,o=0,a;o<clLocalVars.zonesHit.length;o++)if(a=clLocalVars.zonesHit[o],!(t&&a.floor)){var s=a.zones;pointInZone(n,l,s)&&(a.ruleVars.hit=!0)}clSelected&&!clSelectionFail&&!1===challengeRulesSatisfied(clSelected,clSelected.data.constraints)&&challengeHandleFail(),challengeCheck("each_frame")}function cycle(){cycleHandler=setInterval(runOneFrame,67),runOneFrame()}function runOneFrame(){try{if(handleGamepadEvents(),!timeTrialMode())for(var e=0;e<aKarts.length;e++)colKart(e);for(var e=0,t;e<aKarts.length;e++)if(t=aKarts[e],t.pushVector){var n=6*cappedRelSpeed(),l=t.pushVector[0]*t.pushVector[0]+t.pushVector[1]*t.pushVector[1];if(l>n*n){var o=Math.sqrt(l);t.pushVector[0]*=n/o,t.pushVector[1]*=n/o}t.shift||(t.shift=[0,0,0]),t.shift[0]+=t.pushVector[0],t.shift[1]+=t.pushVector[1],delete t.pushVector}for(var e=0,t;e<aKarts.length;e++){if(t=aKarts[e],e&&"CM"==course&&!t.cpu){var a=jTrajets[e-1];if(timer<=a.length){var s=a[timer-1];t.moveGhost(s);continue}else t.cpu=!0,t.aipoint=0,t.tours=oMap.tours+1,t.demitours=0,t.lastAItime=0,t.arme=!1,t.stopDrifting(),t.stopStunt()}if((!t.loose||isOnline&&!finishing)&&(t.cpu&&ai(t),move(e),"CM"==course&&!t.cpu)){var r=[Math.round(t.x),Math.round(t.y),t.z,Math.round(t.rotation)],p=["0","0","0","0"];20==t.tombe&&(p[0]="1"),t.ctrl&&(p[1]="1",0<t.rotincdir?p[2]="1":0>t.rotincdir&&(p[3]="1")),-1!=p.indexOf("1")&&r.push(p.join("")),iTrajet.push(r)}}if("CM"!=course)for(var d=getRankScores(),e=0;e<aKarts.length;e++)places(e,d);moveItems(),moveDecor(),oSpecCam&&oSpecCam.move(),oPlayers[0].cpu||oPlayers[0].loose||handleChallengeEvents(),refreshDatas&&resetDatas(),handleAudio(),render()}catch(t){console.error(t);var c=new Date().getTime();1e4<c-lastErrorTs&&(o_xhr("logGameCrash.php","error="+encodeURIComponent(t.stack),function(){return!0}),lastErrorTs=c)}}function getGameAction(t){return t.keyAction?t.keyAction:gameControls.keyboard[t.keyCode]}function handleSpectatorInput(t){switch(t.keyCode){case 37:t.keyAction="left";break;case 39:t.keyAction="right";break;case 27:t.keyAction="quit";}switch(t.keyAction){case"left":oSpecCam.playerId--,0>oSpecCam.playerId&&(oSpecCam.playerId+=aKarts.length);break;case"right":oSpecCam.playerId++,oSpecCam.playerId>=aKarts.length&&(oSpecCam.playerId=0);break;case"quit":return document.location.reload(),!1;default:return!0;}oSpecCam.reset();var e=getPlayerAtScreen(0),i=isBattle?!e.loose:e.tours<=oMap.tours;if(i){var n=document.getElementById("infoPlace0");n.style.visibility="",n.innerHTML=e.place,-1!=e.team&&(n.style.color=cTeamColors.light[e.team])}return isBattle?updateBalloonHud(document.getElementById("compteur0"),e):updateLapHud(0),!1}function releaseOverEvents(){for(var e=document.querySelectorAll(":hover"),t=0,n;t<e.length;t++)n=e[t],n.onmouseout&&n.onmouseout()}function showFocusIndicator(e,t){selectedOscrElt=t;var i=t.getBoundingClientRect(),n=e.getBoundingClientRect();focusIndicator||(focusIndicator=document.createElement("div"),focusIndicator.style.position="absolute",focusIndicator.style.zIndex=1,focusIndicator.style.backgroundColor="#FEFF3F",focusIndicator.style.opacity=.4,focusIndicator.style.pointerEvents="none"),e.appendChild(focusIndicator);var l=iScreenScale,o=Math.round(iScreenScale/2);focusIndicator.style.left=i.left-n.left-l+"px",focusIndicator.style.top=i.top-n.top-o+"px",focusIndicator.style.width=i.width+2*l+"px",focusIndicator.style.height=i.height+2*o+"px",focusIndicator.style.borderRadius=o+"px",iSfx&&playSoundEffect("musics/events/move.mp3")}function addButton(e,t){var i=t.btn||document.createElement("button");if(i.style.textAlign="center",i.style.padding="0px",i.dataset.key=t.key,t.src){i.className="btn-img";var n=document.createElement("img");n.src="images/vkeyboard/"+t.src+".png",n.alt=e,i.appendChild(n)}else i.innerHTML=e;return i.ontouchstart="touchstart"in t?t.touchstart:onButtonTouch,i.ontouchend="touchend"in t?t.touchend:onButtonPress,t.parent||(t.parent=document.getElementById("virtualkeyboard")),t.parent.appendChild(i),i}function addButtonLegacy(e,t,i,n,l,o,a){l=60*(l||1),o=50*(o||1);var s=document.createElement("button");return s.style.position="absolute",s.style.left=Math.round(1.2*(60*i))+"px",s.style.top=Math.round(1.3*(50*n))+"px",s.style.width=l+"px",s.style.height=o+"px",s.style.textAlign="center",s.style.padding="0px",a&&(s.style.fontSize=a+"px"),s.innerHTML=e,s.dataset.key=t,s.ontouchstart=onButtonTouch,s.ontouchend=onButtonPress,document.getElementById("virtualkeyboard").appendChild(s),s}function isCustomPerso(e,t){if(t||(t={}),e.startsWith("cp-")){if(!customPersos[e]||t.forceReload){cp[e]=[.5,.5,.5,.5];var i=PERSOS_DIR+e+"-ld.png";customPersos[e]={name:language?"Deleted character":"Perso supprim\xE9",map:i,podium:i,music:"mario"},xhr("getCP.php","perso="+e,function(i){if(-1==i)return t.callback&&t.callback(n),!0;if(!i)return!1;var n;try{n=JSON.parse(i)}catch(t){return!1}return cp[e][0]=n.acceleration,cp[e][1]=n.speed,cp[e][2]=n.handling,cp[e][3]=n.mass,customPersos[e]=n,t.callback&&t.callback(n),!0})}else t.callback&&t.callback(perso);return!0}return!1}function getWinnerSrc(e){return isCustomPerso(e)?customPersos[e].podium:"images/winners/w_"+e+".png"}function getEndingSrc(e){return isCustomPerso(e)&&(e=customPersos[e].music),baseCp0[e]?"musics/endings/ending_"+e+".mp3":e}function getStarSrc(e){return isCustomPerso(e)?PERSOS_DIR+e+"-star.png":"images/star/star_"+e+".png"}function getSpriteSrc(e){return isCustomPerso(e)?PERSOS_DIR+e+".png":"images/sprites/sprite_"+e+".png"}function getCustomDecorData(e,t){var n=e.id,i=e.type,l=!1;if(customDecorData[n]){if(void 0!==customDecorData[n].data)return void t(customDecorData[n].data);l=!0}else customDecorData[n]={callbacks:[]};customDecorData[n].callbacks.push(t),l||xhr("getDecorData.php?id="+n+"&full",null,function(e){var t;try{t=JSON.parse(e)}catch(l){t={id:n,hd:"images/sprites/sprite_"+i+".png",map:"images/map_icons/"+i+".png",size:{hd:{w:32,h:32}},original_size:{hd:{w:32,h:32}}},i.startsWith("assets/")&&(t.hd=t.map)}customDecorData[n].data=t;for(var l=customDecorData[n].callbacks,o=0;o<l.length;o++)customDecorData[n].callbacks[o](t);return l.length=0,!0})}function getMapIcSrc(e){return isCustomPerso(e)?customPersos[e].map:"images/map_icons/"+e+".png"}function getMapSelectorSrc(e){return isCup?oMaps[aAvailableMaps[e]].icon:"images/selectors/select_"+aAvailableMaps[e]+".png"}function getMapId(e){var t=simplified?e.id:e.map;return null==t&&(t=-1),t}function privateGame(e){var t=document.createElement("div"),i=t.style;i.width=80*iScreenScale+"px",i.height=39*iScreenScale+"px",i.border="solid 1px black",i.backgroundColor="black",t.appendChild(toTitle(toLanguage("Private game","Partie priv\xE9e"),0));var n=document.createElement("div");n.style.position="absolute",n.style.left=6*iScreenScale+"px",n.style.top=12*iScreenScale+"px",n.style.fontSize=Math.round(2.5*iScreenScale)+"px",n.style.color="#DFC",n.innerHTML=language?"The &quot;private game&quot; option allows you to play only with people you want.<br />The principle is simple: a private link is generated, you send this link to the concerned members, and you can start playing.":"L'option &quot;partie priv\xE9e&quot; vous permet de jouer uniquement avec les personnes de votre choix.<br />Le principe est simple : un lien priv\xE9 est g\xE9n\xE9r\xE9, vous envoyez ce lien aux membres concern\xE9s, et vous pouvez commencer \xE0 jouer.",t.appendChild(n);var l=document.createElement("input");l.type="button",l.value=toLanguage("Generate private link","G\xE9n\xE9rer un lien priv\xE9"),l.style.fontSize=3*iScreenScale+"px",l.style.position="absolute",l.style.width=35*iScreenScale+"px",l.style.left=23*iScreenScale+"px",l.style.top=28*iScreenScale+"px",l.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),privateLink(e)},t.appendChild(l);var l=document.createElement("input");l.type="button",l.value=toLanguage("Back","Retour"),l.style.fontSize=2*iScreenScale+"px",l.style.position="absolute",l.style.left=2*iScreenScale+"px",l.style.top=35*iScreenScale+"px",l.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),shareLink.options=null,selectPlayerScreen(0)},t.appendChild(l);var l=document.createElement("input");l.type="button",l.value=toLanguage("Private game options...","Options de la partie priv\xE9e..."),l.style.fontSize=2*iScreenScale+"px",l.style.position="absolute",l.style.left=52*iScreenScale+"px",l.style.top=35*iScreenScale+"px",l.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),privateGameOptions(shareLink.options,function(t){t&&(shareLink.options=t,e=t),privateGame(e)})},t.appendChild(l),oContainers[0].appendChild(t)}function privateGameOptions(e,t){function n(e){return parseFloat(e.replace("m",".5"))}function l(e,t,l){var o=document.createElement("option"),a=t+(l?"m":"");o.value=a;var s=n(a);o.innerHTML=t+"cc"+(l?toLanguage(" mirror"," miroir"):"");for(var r=e.getElementsByTagName("option"),p=0,d;p<r.length;p++)if(d=r[p],n(d.value)>s){e.insertBefore(o,d);break}else if(d.value==o.value){o=d;break}o.parentNode||e.insertBefore(o,r[r.length-1]),e.value=a}var o=document.createElement("div"),a=o.style;a.width=80*iScreenScale+"px",a.height=39*iScreenScale+"px",a.border="solid 1px black",a.backgroundColor="black";var s;s=isOnline?toTitle(toLanguage("Private game options","Options partie priv\xE9e"),0):toTitle(toLanguage("Online game options","Options mode en ligne"),0),s.style.fontSize=7*iScreenScale+"px",o.appendChild(s);var r=document.createElement("form");r.style.position="absolute",r.style.left="0px",r.style.top=8*iScreenScale+"px",r.style.width=80*iScreenScale+"px",r.onsubmit=function(i){i.preventDefault();var e=this.elements["option-teams"].checked?1:0,n=this.elements["option-manualTeams"].checked?1:0,l=this.elements["option-friendlyFire"].checked?1:0,a=+this.elements["option-nbTeams"].value,s=JSON.parse(this.elements["option-teamOpts"].value),r=this.elements["option-friendly"].checked?1:0,p=+this.elements["option-localScore"].checked?1:0;r||(p=0);var d=+this.elements["option-minPlayers"].value,c=+this.elements["option-maxPlayers"].value,u=parseInt(this.elements["option-cc"].value),m=this.elements["option-cc"].value.endsWith("m"),y=JSON.parse(this.elements["option-itemDistrib"].value),h=JSON.parse(this.elements["option-ptDistrib"].value),g=this.elements["option-cpu"].checked?1:0,b=+this.elements["option-cpuCount"].value,f=+this.elements["option-cpuLevel"].value,x=this.elements["option-cpuNames"].dataset.value;x&&(x=JSON.parse(x));var v=this.elements["option-cpuChars"].dataset.value;v&&(v=JSON.parse(v));var C=this.elements["option-timeTrial"].checked?1:0,k=this.elements["option-noBumps"].checked?1:0,E=this.elements["option-noJump"].checked?1:0,w=this.elements["option-noRd"].checked?1:0,S=this.elements["option-doubleItems"].checked?0:1;e||(n=0,s=0,l=0),C&&(k=0),g||(b=defaultGameOptions.cpuCount,f=defaultGameOptions.cpuLevel,x=defaultGameOptions.cpuNames,v=defaultGameOptions.cpuChars),t({team:e,manualTeams:n,friendlyFire:l,nbTeams:a,teamOpts:s,friendly:r,localScore:p,minPlayers:d,maxPlayers:c,cc:u,mirror:m,itemDistrib:y,ptDistrib:h,cpu:g,cpuCount:b,cpuLevel:f,cpuNames:x,cpuChars:v,timeTrial:C,noBumps:k,noJump:E,noRd:w,doubleItems:S}),o.innerHTML="",oContainers[0].removeChild(o)};var p=document.createElement("div");p.style.height=Math.round(21*iScreenScale+18)+"px",p.style.overflow="auto";var d=document.createElement("table");d.style.marginLeft="auto",d.style.marginRight="auto";var c=document.createElement("tr"),u=document.createElement("td");u.style.textAlign="center",u.style.width=8*iScreenScale+"px";var m=document.createElement("input");m.style.transform=m.style.WebkitTransform=m.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",m.id="option-teams",m.name="option-teams",m.type="checkbox",e&&e.team&&(m.checked=!0),m.onchange=function(){this.checked?(document.getElementById("option-manualTeams-ctn").style.display="",isOnline&&(document.getElementById("option-nbTeams-ctn").style.display="",document.getElementById("option-friendlyFire-ctn").style.display="")):(document.getElementById("option-manualTeams-ctn").style.display="none",document.getElementById("option-nbTeams-ctn").style.display="none",document.getElementById("option-friendlyFire-ctn").style.display="none")},u.appendChild(m),c.appendChild(u);var u=document.createElement("td"),y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-teams");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.style.marginBottom="0px",h.innerHTML=toLanguage("Team games","Parties par \xE9quipe"),y.appendChild(h);var g=document.createElement("div");g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("If enabled, 2 teams are selected in each game. Your objective: defeat the opposing team.","Si activ\xE9, 2 \xE9quipes sont s\xE9lectionn\xE9es \xE0 chaque partie. Votre objectif : vaincre l'\xE9quipe adverse."),y.appendChild(g),u.appendChild(y),u.style.padding=Math.round(1.5*iScreenScale)+"px 0",c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");c.id="option-manualTeams-ctn",e&&e.team||(c.style.display="none");var u=document.createElement("td");u.style.textAlign="center",u.style.width=8*iScreenScale+"px";var m=document.createElement("input");m.style.position="relative",m.style.left=Math.round(1.5*iScreenScale)+"px",m.style.transform=m.style.WebkitTransform=m.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",m.id="option-manualTeams",m.name="option-manualTeams",m.type="checkbox",e&&e.team&&e.manualTeams&&(m.checked=!0),u.appendChild(m),c.appendChild(u);var u=document.createElement("td"),y=document.createElement("label");y.style.cursor="pointer",y.style.display="inline-block",y.setAttribute("for","option-manualTeams");var h=document.createElement("h1");h.style.marginTop=0,h.style.marginLeft=Math.round(1.5*iScreenScale)+"px",h.style.fontSize=3*iScreenScale+"px",h.style.marginBottom="0px",h.innerHTML=toLanguage("Manual selection","S\xE9lection manuelle"),y.appendChild(h);var g=document.createElement("div");if(g.style.paddingLeft=Math.round(1.5*iScreenScale)+"px",g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("If enabled, teams are selected manually at each game.","Si activ\xE9, les \xE9quipes sont s\xE9lectionn\xE9es manuellement \xE0 chaque partie. Sinon, les \xE9quipes sont form\xE9es automatiquement en fonction du niveau de chaque joueur."),y.appendChild(g),u.appendChild(y),c.appendChild(u),!isOnline)for(var b=c.getElementsByTagName("td"),f=0;f<b.length;f++)b[f].style.paddingBottom=Math.round(2*iScreenScale)+"px";d.appendChild(c);var c=document.createElement("tr");c.id="option-nbTeams-ctn",e&&e.team&&isOnline||(c.style.display="none");var u=document.createElement("td");u.setAttribute("colspan",2),u.style.paddingLeft=iScreenScale+"px",u.style.paddingTop=Math.round(.5*iScreenScale)+"px",u.style.paddingBottom=iScreenScale+"px";var x=document.createElement("div");x.style.display="flex",x.style.flexDirection="row",x.style.alignItems="center";var v=document.createElement("div");v.style.paddingLeft=3*iScreenScale+"px",v.style.paddingRight=3*iScreenScale+"px";var y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-nbTeams");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.innerHTML=toLanguage("Number of teams","Nombre d'\xE9quipes"),h.style.marginTop="0px",h.style.marginBottom="0px",y.appendChild(h),v.appendChild(y),x.appendChild(v);var v=document.createElement("div");v.style.display="inline-block";var C=document.createElement("input");C.id="option-nbTeams",C.name="option-nbTeams",C.type="number",C.setAttribute("min",2),C.setAttribute("max",6),C.setAttribute("step",1),C.setAttribute("required",!0),C.style.backgroundColor="#F6F6F6",C.style.width=6*iScreenScale+"px",C.value=e&&e.nbTeams?e.nbTeams:defaultGameOptions.nbTeams,C.style.fontSize=3*iScreenScale+"px",C.style.marginTop=Math.round(.5*iScreenScale)+"px",C.onchange=function(){var e=parseInt(this.value);e<this.getAttribute("min")?(e=this.getAttribute("min"),this.value=e):e>this.getAttribute("max")&&(e=this.getAttribute("max"),this.value=e);var t=JSON.parse(document.getElementById("option-teamOpts").value);if(t){t.length=e;for(var n=[],l=0;l<t.length;l++)n.push(l);for(var l=0;l<t.length;l++)t[l]?n.splice(n.indexOf(t[l].color),1):t[l]={color:n.shift()}}document.getElementById("option-teamOpts").value=JSON.stringify(t)},v.appendChild(C);var k=document.createElement("input");k.type="hidden",k.id="option-teamOpts",k.name="option-teamOpts",k.value=e&&e.teamOpts?JSON.stringify(e.teamOpts):JSON.stringify(defaultGameOptions.teamOpts),v.appendChild(k);var E=document.createElement("a");E.innerHTML=toLanguage("Set teams color &amp; name...","Couleur &amp; nom des \xE9quipes..."),E.style.fontSize=2*iScreenScale+"px",E.style.marginLeft=Math.round(2.5*iScreenScale)+"px",E.style.color="white",E.style.position="relative",E.style.top=Math.round(-iScreenScale/2)+"px",E.href="#null",E.onclick=function(){var e=parseInt(document.getElementById("option-nbTeams").value),t=JSON.parse(document.getElementById("option-teamOpts").value),n=document.createElement("form");n.style.position="absolute",n.style.width="100%",n.style.height="100%",n.style.left="0px",n.style.top="0px",n.style.zIndex=2,n.style.backgroundColor="#000",n.onsubmit=function(){for(var t=[],l=!0,a=0,s;a<e;a++)s={color:+this.elements["color"+a].value,name:this.elements["name"+a].value},s.color!==a&&(l=!1),s.name===oTeamColors.name[s.color]?delete s.name:l=!1,t.push(s);return l&&(t=0),document.getElementById("option-teamOpts").value=JSON.stringify(t),o.removeChild(n),!1},n.appendChild(toTitle(toLanguage("Team options","Option des \xE9quipes"),0));var l=document.createElement("div");l.style.position="absolute",l.style.width="100%",l.style.top=iScreenScale*(13-e)+"px",l.style.textAlign="center";var a=document.createElement("div");a.style.display="inline-grid",a.style.fontSize=3*iScreenScale+"px",a.style.gridTemplateColumns=12*iScreenScale+"px "+12*iScreenScale+"px "+18*iScreenScale+"px",a.style.gridColumnGap=3*iScreenScale+"px",a.style.gridRowGap=Math.round(iScreenScale*(3-.5*e))+"px",a.style.marginTop=2*iScreenScale+"px";var s=document.createElement("div");a.appendChild(s);var s=document.createElement("div");s.style.color="white",s.innerHTML=toLanguage("Color","Couleur"),a.appendChild(s);var s=document.createElement("div");s.style.color="white",s.innerHTML=toLanguage("Name","Nom"),a.appendChild(s);for(var r=0;r<e;r++)(function(l){var i=document.createElement("div");i.innerHTML=toLanguage("Team "+(l+1),"\xC9quipe "+(l+1)),a.appendChild(i);var o=t[l];o||(o={color:l});var s=document.createElement("select");s.name="color"+l;for(var r=0,p;r<oTeamColors.name.length;r++)p=document.createElement("option"),p.value=r,p.innerHTML=oTeamColors.name[r],p.style.color=oTeamColors.light[r],o.color===r&&(p.selected=!0),s.appendChild(p);s.currentValue=s.value,s.onchange=function(){c.value===oTeamColors.name[s.currentValue]&&(c.value=oTeamColors.name[s.value]),s.currentValue=s.value;for(var t=!0,l=0,o;l<e;l++)if(o=n.elements["color"+l],o!==s&&o.value===s.value){t=!1;break}t?(d.disabled=!1,d.style.opacity=1,d.style.cursor=""):(d.disabled=!0,d.style.opacity=.4,d.style.cursor="not-allowed")},s.style.fontSize=2*iScreenScale+"px",a.appendChild(s);var c=document.createElement("input");c.name="name"+l,c.type="text",c.value=o.name||oTeamColors.name[s.value],c.style.fontSize=2*iScreenScale+"px",c.required=!0,a.appendChild(c)})(r);l.appendChild(a),n.appendChild(l);var p=document.createElement("input");p.type="button",p.value=toLanguage("Back","Retour"),p.style.fontSize=2*iScreenScale+"px",p.style.position="absolute",p.style.left=2*iScreenScale+"px",p.style.top=35*iScreenScale+"px",p.onclick=function(){o.removeChild(n)},n.appendChild(p);var d=document.createElement("input");return d.style.position="absolute",d.style.right=6*iScreenScale+"px",d.style.top=34*iScreenScale+4+"px",d.type="submit",d.style.fontSize=3*iScreenScale+"px",d.value=toLanguage("Validate","Valider"),d.style.marginLeft=iScreenScale+"px",n.appendChild(d),o.appendChild(n),!1},v.appendChild(E),x.appendChild(v),u.appendChild(x),c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");c.id="option-friendlyFire-ctn",e&&e.team||(c.style.display="none");var u=document.createElement("td");u.style.textAlign="center",u.style.width=8*iScreenScale+"px";var m=document.createElement("input");m.style.position="relative",m.style.left=Math.round(1.5*iScreenScale)+"px",m.style.transform=m.style.WebkitTransform=m.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",m.id="option-friendlyFire",m.name="option-friendlyFire",m.type="checkbox",e&&e.team&&e.friendlyFire&&(m.checked=!0),u.appendChild(m),c.appendChild(u);var u=document.createElement("td"),y=document.createElement("label");y.style.cursor="pointer",y.style.display="inline-block",y.setAttribute("for","option-friendlyFire");var h=document.createElement("h1");h.style.marginTop=0,h.style.marginLeft=Math.round(1.5*iScreenScale)+"px",h.style.fontSize=3*iScreenScale+"px",h.style.marginBottom="0px",h.innerHTML=toLanguage("Friendly fire","Friendly fire"),y.appendChild(h);var g=document.createElement("div");g.style.paddingLeft=Math.round(1.5*iScreenScale)+"px",g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("If enabled, your items can hit your teammates","Si activ\xE9, vos objets peuvent toucher les joueurs de votre \xE9quipe"),y.appendChild(g),u.appendChild(y),c.appendChild(u);for(var b=c.getElementsByTagName("td"),f=0;f<b.length;f++)b[f].style.paddingBottom=Math.round(2*iScreenScale)+"px";d.appendChild(c);var c=document.createElement("tr"),u=document.createElement("td");u.style.textAlign="center",u.style.width=8*iScreenScale+"px";var m=document.createElement("input");m.id="option-friendly",m.name="option-friendly",m.type="checkbox",e&&e.friendly&&(m.checked=!0),m.onchange=function(){document.getElementById("option-localScore-ctn").style.display=this.checked&&isOnline?"":"none"},m.style.transform=m.style.WebkitTransform=m.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",u.appendChild(m),c.appendChild(u);var u=document.createElement("td"),y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-friendly"),u.appendChild(y);var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.innerHTML=toLanguage("Friendly game","Matchs amicaux"),h.style.marginBottom="0px",y.appendChild(h);var g=document.createElement("div");g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("If enabled, games won't make you win or lose points in the online mode.","Si activ\xE9, les parties ne vous feront pas gagner ou perdre de points dans le mode en ligne."),y.appendChild(g),u.appendChild(y),c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");c.id="option-localScore-ctn",e&&e.friendly||(c.style.display="none");var u=document.createElement("td");u.style.textAlign="center",u.style.width=8*iScreenScale+"px";var m=document.createElement("input");m.style.position="relative",m.style.left=Math.round(1.5*iScreenScale)+"px",m.style.transform=m.style.WebkitTransform=m.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",m.id="option-localScore",m.name="option-localScore",m.type="checkbox",e&&e.friendly&&e.localScore&&isOnline&&(m.checked=!0),m.onchange=function(){document.getElementById("option-ptDistrib-ctn").style.display=this.checked?"":"none"},u.appendChild(m),c.appendChild(u);var u=document.createElement("td"),y=document.createElement("label");y.style.cursor="pointer",y.style.display="inline-block",y.setAttribute("for","option-localScore");var h=document.createElement("h1");h.style.marginTop=0,h.style.marginLeft=Math.round(1.5*iScreenScale)+"px",h.style.fontSize=3*iScreenScale+"px",h.style.marginBottom="0px",h.innerHTML=toLanguage("Local scoring","Classement local"),y.appendChild(h);var g=document.createElement("div");g.style.paddingLeft=Math.round(1.5*iScreenScale)+"px",g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("If enabled, an ranking internal to this room will be calculated instead of the classic online mode ranking.","Si activ\xE9, un classement interne \xE0 la partie priv\xE9e sera calcul\xE9 \xE0 la place du classement en ligne classique."),y.appendChild(g),u.appendChild(y),u.style.paddingBottom=Math.round(1.5*iScreenScale)+"px",c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");c.id="option-ptDistrib-ctn",e&&e.localScore||(c.style.display="none");var u=document.createElement("td");u.setAttribute("colspan",2),u.style.paddingBottom=Math.round(2*iScreenScale)+"px";var x=document.createElement("div");x.style.display="flex",x.style.flexDirection="row",x.style.alignPts="center";var v=document.createElement("div");v.style.paddingLeft=3*iScreenScale+"px",v.style.paddingRight=3*iScreenScale+"px";var y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-ptDistrib");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.innerHTML=toLanguage("Point distribution","Distribution des points"),h.style.marginTop="0px",h.style.marginLeft=Math.round(1.5*iScreenScale)+"px",h.style.marginBottom="0px",y.appendChild(h),v.appendChild(y),x.appendChild(v);var v=document.createElement("div");v.style.display="inline-block";var w=document.createElement("select");w.id="option-ptDistrib",w.name="option-ptDistrib",w.style.backgroundColor="black",w.style.width=24*iScreenScale+"px",w.style.fontSize=Math.round(2.5*iScreenScale)+"px";for(var f=0,S;f<ptDistributions.length;f++)S=document.createElement("option"),S.value=f,S.innerHTML=ptDistributions[f].name,w.appendChild(S);for(var f=0,S;f<customPtDistrib.length;f++)S=document.createElement("option"),S.value=JSON.stringify(customPtDistrib[f]),S.innerHTML=customPtDistrib[f].name,w.appendChild(S);if(e&&e.ptDistrib){var T=JSON.stringify(e.ptDistrib);if(w.value=T,w.value!==T){var S=document.createElement("option");S.value=T,S.innerHTML=toLanguage("Custom","Personnalis\xE9"),w.insertBefore(S,w.firstChild),w.selectedIndex=0}}var S=document.createElement("option");S.value=-1,S.innerHTML=toLanguage("Custom...","Personnalis\xE9..."),w.appendChild(S),w.currentValue=w.value,w.onchange=function(){if(-1==this.value){this.value=this.currentValue,selectedPtDistrib=isNaN(this.currentValue)?JSON.parse(this.currentValue):ptDistributions[this.currentValue];var e=this;selectPtScreen(o,function(t){var i=e.querySelector("option");isNaN(i.value)||(i=document.createElement("option"),i.innerHTML=toLanguage("Custom","Personnalis\xE9"),e.insertBefore(i,e.firstChild)),i.value=JSON.stringify(t),e.selectedIndex=0,e.currentValue=e.value},{value:getDefaultPointDistribution(6),untitled:!0})}else this.currentValue=this.value},v.appendChild(w),x.appendChild(v),u.appendChild(x),c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");isOnline||(c.style.display="none");var u=document.createElement("td");u.setAttribute("colspan",2);var x=document.createElement("div");x.style.display="flex",x.style.flexDirection="row",x.style.alignItems="center";var v=document.createElement("div");v.style.paddingLeft=3*iScreenScale+"px",v.style.paddingRight=3*iScreenScale+"px";var y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-minPlayers");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.innerHTML=toLanguage("Minimum number of players","Nombre de joueurs minimum"),h.style.marginTop=iScreenScale+"px",h.style.marginBottom="0px",y.appendChild(h);var g=document.createElement("div");g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("Minimum number of players before the game begins.","Nombre minimum de joueurs pour que la partie commence"),y.appendChild(g),v.appendChild(y),x.appendChild(v);var v=document.createElement("div");v.style.display="inline-block";var C=document.createElement("input");C.id="option-minPlayers",C.name="option-minPlayers",C.type="number",C.setAttribute("min",2),C.setAttribute("max",99),C.setAttribute("step",1),C.setAttribute("required",!0),C.style.backgroundColor="#F6F6F6",C.style.width=6*iScreenScale+"px",C.value=e&&e.minPlayers?e.minPlayers:defaultGameOptions.minPlayers,C.style.fontSize=3*iScreenScale+"px",C.style.marginTop=Math.round(1.5*iScreenScale)+"px",v.appendChild(C),x.appendChild(v),u.appendChild(x),c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");isOnline||(c.style.display="none");var u=document.createElement("td");u.setAttribute("colspan",2);var x=document.createElement("div");x.style.display="flex",x.style.flexDirection="row",x.style.alignItems="center";var v=document.createElement("div");v.style.paddingLeft=3*iScreenScale+"px",v.style.paddingRight=3*iScreenScale+"px";var y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-maxPlayers");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.innerHTML=toLanguage("Maximum number of players","Nombre de joueurs maximum"),h.style.marginTop=iScreenScale+"px",h.style.marginBottom="0px",y.appendChild(h);var g=document.createElement("div");g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("Maximum number of players that can join the game.","Nombre maximum de joueurs qui peuvent rejoindre la partie"),y.appendChild(g),v.appendChild(y),x.appendChild(v);var v=document.createElement("div");v.style.display="inline-block";var C=document.createElement("input");C.id="option-maxPlayers",C.name="option-maxPlayers",C.type="number",C.setAttribute("min",2),C.setAttribute("max",99),C.setAttribute("step",1),C.setAttribute("required",!0),C.style.backgroundColor="#F6F6F6",C.style.width=6*iScreenScale+"px",C.value=e&&e.maxPlayers?e.maxPlayers:defaultGameOptions.maxPlayers,C.style.fontSize=3*iScreenScale+"px",C.style.marginTop=Math.round(1.5*iScreenScale)+"px",v.appendChild(C),x.appendChild(v),u.appendChild(x),c.appendChild(u),d.appendChild(c);var c=document.createElement("tr"),u=document.createElement("td");u.setAttribute("colspan",2);var x=document.createElement("div");x.style.display="flex",x.style.flexDirection="row",x.style.alignItems="center";var v=document.createElement("div");v.style.paddingLeft=3*iScreenScale+"px",v.style.paddingRight=3*iScreenScale+"px";var y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-cc");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.innerHTML=toLanguage("Class","Cylindr\xE9e"),h.style.marginTop=iScreenScale+"px",h.style.marginBottom="0px",y.appendChild(h),v.appendChild(y),x.appendChild(v);var v=document.createElement("div");v.style.display="inline-block";var w=document.createElement("select");w.id="option-cc",w.name="option-cc",w.style.backgroundColor="black",w.style.width=12*iScreenScale+"px",w.style.fontSize=Math.round(2.5*iScreenScale)+"px",w.style.marginTop=Math.round(1.5*iScreenScale)+"px";var I=[50,100,150,150,200],z=[!1,!1,!1,!0,!1];isOnline||(I=[150,150,200],z=[!1,!0,!1]);var B=!1,M=150;e&&e.cc&&(M=e.cc);var L=!1;e&&e.mirror&&(L=!0);for(var f=0;f<I.length;f++){var H=I[f],A=z[f],S=document.createElement("option");S.value=H+(A?"m":""),S.innerHTML=H+"cc"+(A?toLanguage(" mirror"," miroir"):""),M==H&&L==A&&(S.setAttribute("selected",!0),B=!0),w.appendChild(S)}if(isOnline){var S=document.createElement("option");S.value=-1,S.innerHTML=toLanguage("More...","Plus..."),w.appendChild(S),B||l(w,M,L),w.currentValue=w.value,w.onchange=function(){handleCcSelectChange(this,o,function(e,t,i){l(e,t,i)})}}v.appendChild(w),x.appendChild(v),u.appendChild(x),c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");isOnline||(c.style.display="none");var u=document.createElement("td");u.setAttribute("colspan",2);var x=document.createElement("div");x.style.display="flex",x.style.flexDirection="row",x.style.alignItems="center";var v=document.createElement("div");v.style.paddingLeft=3*iScreenScale+"px",v.style.paddingRight=3*iScreenScale+"px";var y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-itemDistrib");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.innerHTML=toLanguage("Item distribution","Distribution des objets"),h.style.marginTop=iScreenScale+"px",h.style.marginBottom="0px",y.appendChild(h),v.appendChild(y),x.appendChild(v);var v=document.createElement("div");v.style.display="inline-block";var w=document.createElement("select");w.id="option-itemDistrib",w.name="option-itemDistrib",w.style.backgroundColor="black",w.style.width=24*iScreenScale+"px",w.style.fontSize=Math.round(2.5*iScreenScale)+"px",w.style.marginTop=Math.round(1.5*iScreenScale)+"px";for(var _=getItemMode(),f=0,S;f<itemDistributions[_].length;f++)S=document.createElement("option"),S.value=f,S.innerHTML=itemDistributions[_][f].name,w.appendChild(S);for(var f=0,S;f<customItemDistrib[_].length;f++)S=document.createElement("option"),S.value=JSON.stringify(customItemDistrib[_][f]),S.innerHTML=customItemDistrib[_][f].name,w.appendChild(S);if(e&&e.itemDistrib){var T=JSON.stringify(e.itemDistrib);if(w.value=T,w.value!==T){var S=document.createElement("option");S.value=T,S.innerHTML=toLanguage("Custom","Personnalis\xE9"),w.insertBefore(S,w.firstChild),w.selectedIndex=0}}var S=document.createElement("option");S.value=-1,S.innerHTML=toLanguage("Custom...","Personnalis\xE9..."),w.appendChild(S),w.currentValue=w.value,w.onchange=function(){if(-1==this.value){this.value=this.currentValue,selectedItemDistrib=isNaN(this.currentValue)?JSON.parse(this.currentValue):itemDistributions[_][this.currentValue];var e;selectedItemDistrib.value&&(e=Object.assign({},selectedItemDistrib,{untitled:!0}));var t=this;selectItemScreen(o,function(e){var i=t.querySelector("option");isNaN(i.value)||(i=document.createElement("option"),i.innerHTML=toLanguage("Custom","Personnalis\xE9"),t.insertBefore(i,t.firstChild)),i.value=JSON.stringify(e),t.selectedIndex=0,t.currentValue=t.value},e)}else this.currentValue=this.value},v.appendChild(w),x.appendChild(v),u.appendChild(x),c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");c.id="option-doubleItems-ctn",isOnline||(c.style.display="none");var u=document.createElement("td");u.style.textAlign="center",u.style.width=8*iScreenScale+"px";var m=document.createElement("input");m.style.transform=m.style.WebkitTransform=m.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",m.id="option-doubleItems",m.name="option-doubleItems",m.type="checkbox",e&&0==e.doubleItems&&(m.checked=!0),u.appendChild(m),c.appendChild(u);var u=document.createElement("td"),y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-doubleItems");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.style.marginBottom="0px",h.innerHTML=toLanguage("Disable double items","D\xE9sactiver les double objets"),y.appendChild(h);var g=document.createElement("div");g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("If checked, you can only hold one item in reserve","Si coch\xE9, vous ne pouvez garder qu'un seul objet en r\xE9serve"),y.appendChild(g),u.appendChild(y),u.style.padding=Math.round(1.5*iScreenScale)+"px 0",c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");isOnline||(c.style.display="none");var u=document.createElement("td");u.style.textAlign="center",u.style.width=8*iScreenScale+"px";var m=document.createElement("input");m.style.transform=m.style.WebkitTransform=m.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",m.id="option-cpu",m.name="option-cpu",m.type="checkbox",e&&e.cpu&&(m.checked=!0),m.onchange=function(){if(this.checked){document.getElementById("option-cpuCount-ctn").style.display="",isBattle||(document.getElementById("option-cpuLevel-ctn").style.display=""),document.getElementById("option-cpuNames-ctn").style.display="",document.getElementById("option-cpuChars-ctn").style.display="";var e=document.getElementById("option-cpuCount");e.value=Math.max(e.value,3);var t=this.parentNode.parentNode;setTimeout(function(){e.select(),p.scrollTop=t.offsetTop},1)}else document.getElementById("option-cpuCount-ctn").style.display="none",document.getElementById("option-cpuLevel-ctn").style.display="none",document.getElementById("option-cpuNames-ctn").style.display="none",document.getElementById("option-cpuChars-ctn").style.display="none"},u.appendChild(m),c.appendChild(u);var u=document.createElement("td"),y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-cpu");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.style.marginBottom="0px",h.innerHTML=toLanguage("Add CPUs","Ajouter des ordis"),y.appendChild(h);var g=document.createElement("div");g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("If enabled, bots will be added to the game if there is not enough players","Si activ\xE9, des bots seront ajout\xE9s \xE0 la partie s'il n'y a pas assez de joueurs"),y.appendChild(g),u.appendChild(y),u.style.padding=Math.round(1.5*iScreenScale)+"px 0",c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");c.id="option-cpuCount-ctn",e&&e.cpu||(c.style.display="none");var u=document.createElement("td");u.setAttribute("colspan",2);var x=document.createElement("div");x.style.display="flex",x.style.flexDirection="row",x.style.alignItems="center";var v=document.createElement("div");v.style.paddingLeft=3*iScreenScale+"px",v.style.paddingRight=3*iScreenScale+"px";var y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-cpuCount");var h=document.createElement("h1");h.style.marginLeft=Math.round(1.5*iScreenScale)+"px",h.style.fontSize=3*iScreenScale+"px",h.innerHTML=toLanguage("Total number of participants","Nombre total de participants"),h.style.marginTop=iScreenScale+"px",h.style.marginBottom="0px",y.appendChild(h);var g=document.createElement("div");g.style.paddingLeft=Math.round(1.5*iScreenScale)+"px",g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("If there isn't enough players, bots will be added to match the specified number of participants","S'il n'y a pas assez de joueurs, des bots seront ajout\xE9s pour matcher le nombre de participants sp\xE9cifi\xE9"),y.appendChild(g),v.appendChild(y),x.appendChild(v);var v=document.createElement("div");v.style.display="inline-block",v.style.marginRight=3*iScreenScale+"px";var C=document.createElement("input");C.id="option-cpuCount",C.name="option-cpuCount",C.type="number",C.setAttribute("min",2),C.setAttribute("max",12),C.setAttribute("step",1),C.setAttribute("required",!0),C.style.backgroundColor="#F6F6F6",C.style.width=6*iScreenScale+"px",C.value=e&&e.cpuCount?e.cpuCount:defaultGameOptions.cpuCount,C.style.fontSize=3*iScreenScale+"px",C.style.marginTop=Math.round(1.5*iScreenScale)+"px",v.appendChild(C),x.appendChild(v),u.appendChild(x),c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");c.id="option-cpuLevel-ctn",e&&e.cpu&&!isBattle||(c.style.display="none");var u=document.createElement("td");u.setAttribute("colspan",2);var x=document.createElement("div");x.style.display="flex",x.style.flexDirection="row",x.style.alignItems="center";var v=document.createElement("div");v.style.paddingLeft=3*iScreenScale+"px",v.style.paddingRight=3*iScreenScale+"px";var y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-cpuLevel");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.innerHTML=toLanguage("CPU difficulty","Difficult\xE9 des ordis"),h.style.marginLeft=Math.round(1.5*iScreenScale)+"px",h.style.marginTop=iScreenScale+"px",h.style.marginBottom="0px",y.appendChild(h),v.appendChild(y),x.appendChild(v);var v=document.createElement("div");v.style.display="inline-block";var w=document.createElement("select");w.id="option-cpuLevel",w.name="option-cpuLevel",w.style.backgroundColor="black",w.style.width=14*iScreenScale+"px",w.style.fontSize=Math.round(2.5*iScreenScale)+"px",w.style.marginTop=Math.round(1.5*iScreenScale)+"px";for(var P=[toLanguage("Impossible","Impossible"),toLanguage("Extreme","Extr\xEAme"),toLanguage("Difficult","Difficile"),toLanguage("Medium","Moyen"),toLanguage("Easy","Facile")],f=0,S;f<P.length;f++)S=document.createElement("option"),S.value=f-2,S.innerHTML=P[f],w.appendChild(S);w.value=e&&e.cpuLevel?e.cpuLevel:0,v.appendChild(w),x.appendChild(v),u.appendChild(x),c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");c.id="option-cpuNames-ctn",e&&e.cpu||(c.style.display="none");var u=document.createElement("td");u.setAttribute("colspan",2);var x=document.createElement("div");x.style.display="flex",x.style.flexDirection="row",x.style.alignItems="center";var v=document.createElement("div");v.style.paddingLeft=3*iScreenScale+"px",v.style.paddingRight=3*iScreenScale+"px";var y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-cpuNames");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.innerHTML=toLanguage("CPU names","Noms des ordis"),h.style.marginLeft=Math.round(1.5*iScreenScale)+"px",h.style.marginTop=iScreenScale+"px",h.style.marginBottom="0px",y.appendChild(h),v.appendChild(y),x.appendChild(v);var v=document.createElement("div");v.style.display="inline-block";var N=document.createElement("input");N.type="button",N.id="option-cpuNames",N.name="option-cpuNames",N.value=toLanguage("Set...","Sp\xE9cifier..."),N.style.backgroundColor="black",N.style.width=14*iScreenScale+"px",N.style.padding=Math.round(.2*iScreenScale)+"px "+Math.round(1*iScreenScale)+"px",N.style.fontSize=Math.round(2*iScreenScale)+"px",N.style.marginTop=Math.round(1.5*iScreenScale)+"px",e&&e.cpuNames&&(N.dataset.value=JSON.stringify(e.cpuNames)),N.onclick=function(){var e=+this.form.elements["option-cpuCount"].value;if(2<e){var t=this,i=this.dataset.value?JSON.parse(this.dataset.value):[];selectCpuNamesScreen(o,function(e){t.dataset.value=JSON.stringify(e)},{names:i,count:e-2})}},v.appendChild(N),x.appendChild(v),u.appendChild(x),c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");c.id="option-cpuChars-ctn",e&&e.cpu||(c.style.display="none");var u=document.createElement("td");u.setAttribute("colspan",2);var x=document.createElement("div");x.style.display="flex",x.style.flexDirection="row",x.style.alignItems="center";var v=document.createElement("div");v.style.paddingLeft=3*iScreenScale+"px",v.style.paddingRight=3*iScreenScale+"px";var y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-cpuChars");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.innerHTML=toLanguage("CPU characters","Persos des ordis"),h.style.marginLeft=Math.round(1.5*iScreenScale)+"px",h.style.marginTop=iScreenScale+"px",h.style.marginBottom="0px",y.appendChild(h),v.appendChild(y),x.appendChild(v);var v=document.createElement("div");v.style.display="inline-block";var N=document.createElement("input");N.type="button",N.id="option-cpuChars",N.name="option-cpuChars",N.value=toLanguage("Set...","Sp\xE9cifier..."),N.style.backgroundColor="black",N.style.width=14*iScreenScale+"px",N.style.padding=Math.round(.2*iScreenScale)+"px "+Math.round(1*iScreenScale)+"px",N.style.fontSize=Math.round(2*iScreenScale)+"px",N.style.marginTop=Math.round(1.5*iScreenScale)+"px",e&&e.cpuChars&&(N.dataset.value=JSON.stringify(e.cpuChars)),N.loadCpuChars=function(e){e&&(this.dataset.value=JSON.stringify(e)),o.style.visibility=""},N.onclick=function(){var e=+this.form.elements["option-cpuCount"].value;2<e&&(this.dataset.cpuChars=1,o.style.visibility="hidden",selectPlayerScreen(2,!1,e))},v.appendChild(N),x.appendChild(v),u.appendChild(x),c.appendChild(u),d.appendChild(c);var c=document.createElement("tr"),u=document.createElement("td");u.style.textAlign="center",u.style.width=8*iScreenScale+"px";var m=document.createElement("input");m.style.transform=m.style.WebkitTransform=m.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",m.id="option-timeTrial",m.name="option-timeTrial",m.type="checkbox",e&&e.timeTrial&&(m.checked=!0),!isOnline||isBattle?c.style.display="none":(m.onclick=function(){document.getElementById("option-noBumps-ctn").style.display=this.checked?"none":""},function(e){setTimeout(function(){e.onclick()},1)}(m)),u.appendChild(m),c.appendChild(u);var u=document.createElement("td"),y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-timeTrial");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.style.marginBottom="0px",h.innerHTML=toLanguage("Time Trial mode","Mode Contre-la-montre"),y.appendChild(h);var g=document.createElement("div");g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("If enabled, the game is played like a time trial: no item boxes, no collisions with other players (they are ghosts), and you start with 3 shrooms.","Si activ\xE9, la partie se d\xE9roule comme en CLM : pas de bo\xEEtes \xE0 objets, pas de collisions avec les autres joueurs (ce sont des fant\xF4mes), et vous commencez avec 3 champis."),y.appendChild(g),u.appendChild(y),u.style.padding=Math.round(1.5*iScreenScale)+"px 0",c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");c.id="option-noBumps-ctn",isOnline||(c.style.display="none");var u=document.createElement("td");u.style.textAlign="center",u.style.width=8*iScreenScale+"px";var m=document.createElement("input");m.style.transform=m.style.WebkitTransform=m.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",m.id="option-noBumps",m.name="option-noBumps",m.type="checkbox",e&&e.noBumps&&(m.checked=!0),u.appendChild(m),c.appendChild(u);var u=document.createElement("td"),y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-noBumps");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.style.marginBottom="0px",h.innerHTML=toLanguage("Disable kart bumps","D\xE9sactiver la collisions entre karts"),y.appendChild(h);var g=document.createElement("div");g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("If checked, karts are not impacted when they hit each other (bumps)","Si coch\xE9, les karts ne sont pas impact\xE9s lorsqu'ils se rentrent dedans (bumps)"),y.appendChild(g),u.appendChild(y),u.style.padding=Math.round(1.5*iScreenScale)+"px 0",c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");c.id="option-noJump-ctn",isOnline||(c.style.display="none");var u=document.createElement("td");u.style.textAlign="center",u.style.width=8*iScreenScale+"px";var m=document.createElement("input");m.style.transform=m.style.WebkitTransform=m.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",m.id="option-noJump",m.name="option-noJump",m.type="checkbox",e&&e.noJump&&(m.checked=!0),u.appendChild(m),c.appendChild(u);var u=document.createElement("td"),y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-noJump");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.style.marginBottom="0px",h.innerHTML=toLanguage("Disable jumps","D\xE9sactiver les sauts"),y.appendChild(h);var g=document.createElement("div");g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("If checked, it becomes impossible to jump, drift or make tricks","Si coch\xE9, il est impossible de faire des sauts, d\xE9rapages ou figures"),y.appendChild(g),u.appendChild(y),u.style.padding=Math.round(1.5*iScreenScale)+"px 0",c.appendChild(u),d.appendChild(c);var c=document.createElement("tr");c.id="option-noRd-ctn",isOnline||(c.style.display="none");var u=document.createElement("td");u.style.textAlign="center",u.style.width=8*iScreenScale+"px";var m=document.createElement("input");m.style.transform=m.style.WebkitTransform=m.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",m.id="option-noRd",m.name="option-noRd",m.type="checkbox",e&&e.noRd&&(m.checked=!0),u.appendChild(m),c.appendChild(u);var u=document.createElement("td"),y=document.createElement("label");y.style.cursor="pointer",y.setAttribute("for","option-noRd");var h=document.createElement("h1");h.style.fontSize=3*iScreenScale+"px",h.style.marginBottom="0px",h.innerHTML=toLanguage("Disable Reverse Drift","D\xE9sactiver le Reverse Drift"),y.appendChild(h);var g=document.createElement("div");g.style.fontSize=2*iScreenScale+"px",g.style.color="white",g.innerHTML=toLanguage("If checked, the famous MKPC drifting technique is blocked","Si coch\xE9, la fameuse technique de d\xE9rapage de MKPC est bloqu\xE9e"),y.appendChild(g),u.appendChild(y),u.style.padding=Math.round(1.5*iScreenScale)+"px 0",c.appendChild(u),d.appendChild(c),p.appendChild(d),r.appendChild(p);var g=document.createElement("div");g.style.textAlign="center",g.style.marginTop=2*iScreenScale+"px";var R=document.createElement("input");R.type="submit",R.value=toLanguage("Validate","Valider"),R.style.fontSize=3*iScreenScale+"px",R.style.width=18*iScreenScale+"px",g.appendChild(R),r.appendChild(g),o.appendChild(r);var D=document.createElement("input");D.type="button",D.value=toLanguage("Cancel","Annuler"),D.style.fontSize=2*iScreenScale+"px",D.style.position="absolute",D.style.left=2*iScreenScale+"px",D.style.top=35*iScreenScale+"px",D.onclick=function(){o.innerHTML="",oContainers[0].removeChild(o),t(null)},o.appendChild(D);var E=document.createElement("a");isOnline||(E.style.display="none"),E.href="#null",E.style.color="#CCF",E.innerHTML=toLanguage("Load options...","Charger des options..."),E.style.fontSize=Math.round(1.6*iScreenScale)+"px",E.style.position="absolute",E.style.right=3*iScreenScale+"px",E.style.top=35*iScreenScale+4+"px",E.onclick=function(i){function n(e){var i;try{i=new URLSearchParams(new URL(e).search).get("key")}catch(t){}return null==i?void alert(toLanguage("Invalid URL","URL invalide")):void(s.innerHTML="",xhr("getPrivGameOptions.php","key="+i,function(e){if(o.removeChild(s),!e)return alert(toLanguage("Invalid link","Lien invalide")),!0;try{e=JSON.parse(e)}catch(t){}return o.innerHTML="",oContainers[0].removeChild(o),privateGameOptions(e,t),!0}))}function l(){for(var e=0;e<p.length;e++){var t=p[e],l=document.createElement("div");l.className="saved-link",l.innerHTML="<div class=\"saved-link-data\"><div class=\"saved-link-name\">"+t.name+"</div><div class=\"saved-link-url\">"+t.url+"</div></div><div class=\"saved-link-options\"><button class=\"saved-link-edit\">\u270E</button><button class=\"saved-link-del\">&times;</button></div>",function(e){l.onclick=function(){n(e.url)},l.querySelector(".saved-link-edit").onclick=function(){var t=prompt(toLanguage("New options name:","Renommer ces options :"),e.name);t&&t!==e.name&&(e.name=t,a())},l.querySelector(".saved-link-del").onclick=function(){confirm(toLanguage("Delete options set \""+e.name+"\"?","Supprimer le jeu d'options \""+e.name+"\" ?"))&&(p.splice(p.indexOf(e),1),a())},l.querySelector(".saved-link-options").onclick=function(t){t.stopPropagation()}}(t),r.appendChild(l)}p.length?!shareLink.key&&(s.querySelector(".saved-links-add").style.display="none"):(r.innerHTML="<div class=\"no-link\">"+toLanguage("No saved options","Aucune option sauvegard\xE9e")+"</div>",!shareLink.key&&(s.querySelector(".saved-links-ctn").style.display="none"))}function a(){storeOptionLinks(p),r.innerHTML="",l()}i.preventDefault();var s=document.createElement("div");s.className="fsmask options-load-screen",s.style.fontSize=2*iScreenScale+"px",s.innerHTML="<div><a class=\"close\" href=\"#null\">&times;</a><h1>"+toLanguage("Load private game options","Charger options partie priv\xE9e")+"</h1><div>"+toLanguage("This menu lets you import options from a previous private game.","Ce menu vous permet d'importer des options d'une partie priv\xE9e pr\xE9c\xE9dente.")+"</div><form class=\"private-link-form\"><input type=\"url\" required=\"required\" name=\"private-link\" placeholder=\""+document.location.origin+"/online.php?key=20100620\" /><input type=\"submit\" value=\"Ok\" /></form><div class=\"saved-links-ctn\"><h2>"+toLanguage("Saved options","Options sauvegard\xE9es")+"</h2><div class=\"saved-links\"></div><div class=\"saved-links-add\">\u2606 <a href=\"#null\">"+toLanguage("Save current private link options","Sauvegarder les options actuelles")+"</a></div></div></div>",s.querySelector(".private-link-form").onsubmit=function(t){t.preventDefault(),n(t.target.elements["private-link"].value)};var r=s.querySelector(".saved-links"),p=loadOptionLinks();l();var d=s.querySelector(".close");d.style.left=71*iScreenScale+5+"px",d.onclick=function(t){t.preventDefault(),o.removeChild(s)},s.querySelector(".saved-links-add a").onclick=function(t){t.preventDefault();var e=prompt(toLanguage("Name for your options set:","Nom pour le jeu d'options :"));e&&(p.push({name:e,url:document.location.href}),s.querySelector(".saved-links-add").style.display="none",a())},o.appendChild(s)},o.appendChild(E),oContainers[0].appendChild(o)}function loadOptionLinks(){var e=localStorage.getItem("privgameopts");return e?JSON.parse(e):[]}function storeOptionLinks(e){e.sort(function(e,t){return e.name.localeCompare(t.name)}),localStorage.setItem("privgameopts",JSON.stringify(e))}function privateLink(e){var t=document.createElement("div"),i=t.style;i.width=80*iScreenScale+"px",i.height=39*iScreenScale+"px",i.border="solid 1px black",i.backgroundColor="black",t.appendChild(toTitle(toLanguage("Private game","Partie priv\xE9e"),0));var n=isCustomOptions(e);xhr("privateGame.php",n?"options="+encodeURIComponent(JSON.stringify(e)):null,function(e){if(e){var i=shareLink.url,l=shareLink.params.slice(0);l.push("key="+e);var o=i+"?"+l.join("&"),a=document.createElement("div");if(a.style.position="absolute",a.style.left="0px",a.style.top=12*iScreenScale+"px",a.style.width=80*iScreenScale+"px",a.style.textAlign="center",a.style.fontSize=3*iScreenScale+"px",a.style.color="#CFC",a.innerHTML=language?"The following private link has been generated:<br /><a href=\""+o+"\" style=\"color:AAF\">"+o+"</a><br /><br />Enjoy game :)":"Le lien priv\xE9 suivant a \xE9t\xE9 g\xE9n\xE9r\xE9 :<br /><a href=\""+o+"\" style=\"color:AAF\">"+o+"</a><br /><br />Bonne partie :)",t.appendChild(a),n){var s=document.createElement("input");s.type="button",s.style.position="absolute",s.style.right=1*iScreenScale+"px",s.style.top=33*iScreenScale+"px",s.style.fontSize=Math.round(1.7*iScreenScale)+"px",s.value="\u2606 "+toLanguage("Save game options...","Sauvegarder options partie priv\xE9e"),s.onclick=function(){var e=prompt(toLanguage("Options name:","Nom des options :"));if(e){var i=loadOptionLinks(),n={name:e,url:o};i.push(n),storeOptionLinks(i),t.removeChild(s),t.appendChild(r),p.onclick=function(l){l.preventDefault(),i.splice(i.indexOf(n),1),storeOptionLinks(i),t.removeChild(r),t.appendChild(s)}}},t.appendChild(s);var r=document.createElement("div");r.style.color="white",r.style.position="absolute",r.style.left=1*iScreenScale+"px",r.style.width=78*iScreenScale+"px",r.style.top=33*iScreenScale+"px",r.style.textAlign="center",r.style.fontSize=2*iScreenScale+"px",r.innerHTML=toLanguage("Options saved, you can access them by clicking on &quot;Load options...&quot; in private game options screen ","Options sauvegard\xE9es, vous pourrez y acc\xE9der en cliquannt sur &quot;Charger des options...&quot; dans les options de partie priv\xE9e ");var p=document.createElement("a");p.href="#null",p.style.color="#ccf",p.style.textDecoration="none",p.innerHTML=toLanguage("[Undo]","[Annuler]"),r.appendChild(p)}return!0}return!1}),oContainers[0].appendChild(t)}function selectTypeScreen(){var e=document.createElement("div"),t=e.style;t.width=80*iScreenScale+"px",t.height=39*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black";var n=new Image;n.src="images/mariokart.png",n.style.position="absolute",n.style.width=Math.round(42.5*iScreenScale)+"px",n.style.height=5*iScreenScale+"px",n.style.left=Math.round((80-42.5)/2*iScreenScale)+"px",n.style.top=2*iScreenScale+"px",e.appendChild(n);var t=e.style;if(t.width=80*iScreenScale+"px",t.height=39*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black",oContainers[0].appendChild(e),"MK"==page){var l=11,o=document.createElement("input");o.type="button",o.value="Grand Prix",o.style.fontSize=3*iScreenScale+"px",o.style.position="absolute",o.style.left=10*iScreenScale+"px",o.style.top=l*iScreenScale+"px",o.style.width=29*iScreenScale+"px",o.onclick=function(){course="GP",e.innerHTML="",oContainers[0].removeChild(e),selectPlayerScreen(0)},e.appendChild(o);var o=document.createElement("input");o.type="button",o.value=toLanguage("Time trial","Contre-la-montre"),o.style.fontSize=3*iScreenScale+"px",o.style.position="absolute",o.style.left=41*iScreenScale+"px",o.style.top=l*iScreenScale+"px",o.style.width=29*iScreenScale+"px",o.onclick=function(){course="CM",e.innerHTML="",oContainers[0].removeChild(e),selectPlayerScreen(0)},e.appendChild(o);var o=document.createElement("input");o.type="button",o.value=toLanguage("VS","Course VS"),o.style.fontSize=3*iScreenScale+"px",o.style.position="absolute",o.style.left=iScreenScale+"px",o.style.top=(l+8)*iScreenScale+"px",o.style.width=29*iScreenScale+"px",o.onclick=function(){course="VS",e.innerHTML="",oContainers[0].removeChild(e),selectNbJoueurs()},e.appendChild(o);var o=document.createElement("input");o.type="button",o.value=toLanguage("Battle","Bataille"),o.style.fontSize=3*iScreenScale+"px",o.style.position="absolute",o.style.left=50*iScreenScale+"px",o.style.top=(l+8)*iScreenScale+"px",o.style.width=29*iScreenScale+"px",o.onclick=function(){course="BB",e.innerHTML="",oContainers[0].removeChild(e),selectNbJoueurs()},e.appendChild(o);var o=document.createElement("input");o.type="button",o.value=toLanguage("Track builder","\xC9diteur de circuit"),o.style.fontSize=3*iScreenScale+"px",o.style.position="absolute",o.style.left=10*iScreenScale+"px",o.style.top=(l+16)*iScreenScale+"px",o.style.width=29*iScreenScale+"px",o.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),selectTypeCreate()},e.appendChild(o);var o=document.createElement("input");o.type="button",o.value=toLanguage("Online race","Course en ligne"),o.style.fontSize=3*iScreenScale+"px",o.style.position="absolute",o.style.left=41*iScreenScale+"px",o.style.top=(l+16)*iScreenScale+"px",o.style.width=29*iScreenScale+"px",o.onclick=function(){course="VS",e.innerHTML="",oContainers[0].removeChild(e),selectOnlineScreen()},e.appendChild(o);var o=document.createElement("input");o.type="button",o.value=toLanguage("Home","Accueil"),o.style.fontSize=2*iScreenScale+"px",o.style.position="absolute",o.style.left=2*iScreenScale+"px",o.style.top=35*iScreenScale+2+"px",o.onclick=function(){document.location.href="index.php"},e.appendChild(o)}else{var l=12,a=[toLanguage("VS","Course VS")],s=["VS"];if(isSingle||(a.unshift("Grand Prix"),s.unshift("GP")),(hasChallenges()||myCircuit)&&(a.push(toLanguage("Challenges","D\xE9fis")),s.push("CH")),(nid||!isSingle)&&(a.push(toLanguage("Time Trial","Contre-la-montre")),s.push("CM")),nid&&(!isSingle||!complete||cShared)&&(a.push(toLanguage("Online race","Course en ligne")),s.push("CL")),!isSingle&&cupScore){var r=new Image;r.src="images/cups/cup"+(4-cupScore)+".png",r.style.width=Math.round(4*iScreenScale)+"px",r.style.height=Math.round(4*iScreenScale)+"px",r.style.position="absolute",5>a.length?(r.style.left=3*iScreenScale+"px",r.style.top=Math.round((l+4)*iScreenScale)+"px"):(r.style.left=5*iScreenScale+"px",r.style.top=Math.round((l-1)*iScreenScale)+"px"),r.className="pixelated",e.appendChild(r)}for(i=0;i<a.length;i++){var o=document.createElement("input");if(o.type="button",o.value=a[i],o.style.position="absolute",4>a.length)n.style.top=3*iScreenScale+"px",o.style.left=20*iScreenScale+"px",o.style.top=Math.round((l+6.5*i)*iScreenScale)+"px",o.style.width=38*iScreenScale+"px",o.style.fontSize=Math.round(3.5*iScreenScale)+"px";else if(4==a.length)n.style.top=4*iScreenScale+"px",o.style.left=(8+36*(i%2))*iScreenScale+"px",o.style.top=(l+4+8*Math.floor(i/2))*iScreenScale+"px",o.style.width=28*iScreenScale+"px",o.style.fontSize=3*iScreenScale+"px";else{var p=[[10,l-1],[40,l-1],[25,l+7],[10,l+15],[40,l+15]],d=p[i];o.style.left=d[0]*iScreenScale+"px",o.style.top=d[1]*iScreenScale+"px",o.style.fontSize=3*iScreenScale+"px",o.style.width=29*iScreenScale+"px"}o.dataset||(o.dataset={}),o.dataset.course=s[i],o.onclick=function(){course=this.dataset.course,"CL"==course?document.location.href=onlineModeLink():(e.innerHTML="",oContainers[0].removeChild(e),"VS"==course?selectNbJoueurs():"CH"==course?selectChallengesScreen():selectPlayerScreen(0))},e.appendChild(o)}var o=document.createElement("input");o.type="button",o.value=toLanguage("Back","Retour"),o.style.fontSize=2*iScreenScale+"px",o.style.position="absolute",o.style.left=2*iScreenScale+"px",o.style.top=35*iScreenScale+"px",o.onclick=function(){exitCircuit()},e.appendChild(o)}var c=document.createElement("img");c.src="images/english.png",c.alt="En",c.style.position="absolute",c.style.left=68*iScreenScale+"px",c.style.top=35*iScreenScale+"px",c.style.width=4*iScreenScale+"px",c.style.height=Math.round(8*iScreenScale/3)+"px";var u=document.createElement("img");u.src="images/french.png",c.alt="Fr",u.style.position="absolute",u.style.left=74*iScreenScale+"px",u.style.top=35*iScreenScale+"px",u.style.width=4*iScreenScale+"px",u.style.height=Math.round(8*iScreenScale/3)+"px";var m=language?c:u,y=language?u:c;m.style.border="solid 1px #FEFF3F",y.style.border="solid 1px transparent",y.style.cursor="pointer",y.onmouseover=function(){y.style.border="solid 1px #FEFF3F"},y.onmouseout=function(){y.style.border="solid 1px transparent"},y.onclick=function(){language=!language,xhr("setLanguage.php","nLanguage="+1*language,function(e){return 1==e&&(location.reload(),!0)})},e.appendChild(c),e.appendChild(u),updateMenuMusic(0)}function selectMainPage(){"OL"===page?mId?selectPlayerScreen(0):connexion():"MK"===page?selectTypeScreen():"CI"===page||"MA"===page?nid?selectTypeScreen():(course="VS",selectNbJoueurs()):"BA"===page||"AR"===page?(course="BB",selectNbJoueurs()):void 0}function selectNbJoueurs(e){if(clSelected&&!e)return void selectPlayerScreen(0);var t=document.createElement("div"),n=t.style;n.width=80*iScreenScale+"px",n.height=39*iScreenScale+"px",n.border="solid 1px black",n.backgroundColor="black",t.appendChild(toTitle(toLanguage("Number of players","Nombre de joueurs"),.5));var l=document.createElement("input");l.type="button",l.value=toLanguage("Back","Retour"),l.style.fontSize=2*iScreenScale+"px",l.style.position="absolute",l.style.left=2*iScreenScale+"px",l.style.top=35*iScreenScale+"px",l.onclick=function(){isBattle||isCup&&!nid?exitCircuit():(t.innerHTML="",oContainers[0].removeChild(t),selectTypeScreen())},t.appendChild(l);var o=isBattle&&cShared;for(i=1;2>=i;i++){var l=document.createElement("input");l.type="button",l.id="select-nbj-"+i,l.value=i+(2>i?"  ":" ")+toLanguage("player","joueur")+(2>i?" ":"s"),l.style.fontSize=4*iScreenScale+"px",l.style.position="absolute",l.style.left=(o?26:27)*iScreenScale+"px",l.style.top=((o?7:10)+i*(o?7:8))*iScreenScale+"px",o&&(l.style.width=22*iScreenScale+"px"),l.onclick=function(){if(t.innerHTML="",oContainers[0].removeChild(t),"2"==this.value.charAt(0)){clSelected=null;var e=oContainers[0].cloneNode(!1);e.style.left=12+80*iScreenScale+"px",oContainers.push(e)}selectPlayerScreen(0)},t.appendChild(l)}if(o){var l=document.createElement("input");l.type="button",l.value=toLanguage(" Online mode ","Mode en ligne"),l.style.fontSize=3*iScreenScale+"px",l.style.position="absolute",l.style.left=26*iScreenScale+"px",l.style.top=30*iScreenScale+"px",l.style.width=22*iScreenScale+"px",l.style.paddingTop=Math.round(.5*iScreenScale)+"px",l.style.paddingBottom=Math.round(.5*iScreenScale)+"px",l.onclick=function(){document.location.href=onlineModeLink()},t.appendChild(l)}if(oContainers[0].appendChild(t),(myCircuit||hasChallenges())&&(!nid||isBattle)){var l=document.createElement("input");l.type="button",l.value=toLanguage("Challenges...","D\xE9fis..."),l.style.fontSize=2*iScreenScale+"px",l.style.position="absolute",l.style.right=2*iScreenScale+"px",l.style.top=35*iScreenScale+"px",l.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),selectChallengesScreen()},t.appendChild(l)}updateMenuMusic(0)}function selectOnlineScreen(e){var t=document.createElement("div"),i=t.style;i.width=80*iScreenScale+"px",i.height=39*iScreenScale+"px",i.border="solid 1px black",i.backgroundColor="black",t.appendChild(toTitle(toLanguage("Online mode","Mode en ligne"),2));var n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),selectTypeScreen()},t.appendChild(n);var n=document.createElement("input");n.type="button",n.value=toLanguage("More options...","Plus d'options..."),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=60*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),privateGameOptions(e,function(t){t&&(e=t,!isCustomOptions(e)&&(e=null)),selectOnlineScreen(e)})},t.appendChild(n);var n=document.createElement("input");n.type="button",n.value=language?"VS mode":"Course VS",n.style.fontSize=Math.round(3.5*iScreenScale)+"px",n.style.position="absolute",n.style.left=22*iScreenScale+"px",n.style.top=17*iScreenScale+"px",n.style.width=36*iScreenScale+"px",n.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),openOnlineMode(!1,e)},t.appendChild(n);var n=document.createElement("input");n.type="button",n.value=language?"Battle mode":"Bataille de ballons",n.style.fontSize=Math.round(3.5*iScreenScale)+"px",n.style.position="absolute",n.style.left=22*iScreenScale+"px",n.style.top=25*iScreenScale+"px",n.style.width=36*iScreenScale+"px",n.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),openOnlineMode(!0,e)},t.appendChild(n),oContainers[0].appendChild(t),updateMenuMusic(0)}function onlineModeLink(){return"online.php?"+(isMCups?"mid="+nid:(isSingle?complete?"i":"id":complete?"cid":"sid")+"="+nid)+(isBattle?"&battle":"")}function openOnlineMode(e,t){t?xhr("onlineOptions.php","options="+encodeURIComponent(JSON.stringify(t)),function(t){return!!t&&(document.location.href="online.php?"+(e?"battle&":"")+("key="+t),!0)}):document.location.href="online.php"+(e?"?battle":"")}function openChallengeEditor(){document.location.href=clId&&!0?"challenges.php?cl="+clId:document.location.href.replace(/\/(\w+)\.php\?(.+)$/g,"/challenges.php?page=$1&$2")}function getCreationId(e){return"CI"===page||"AR"===page?e.id:e.map}function getCreationTable(){return"CI"===page||"AR"===page?"mkcircuits":"MA"===page?"circuits":"BA"===page?"arenes":""}function selectTypeCreate(){var e=document.createElement("div"),t=e.style;t.width=80*iScreenScale+"px",t.height=39*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black",e.appendChild(toTitle(toLanguage("Track builder","\xC9diteur de circuit")));var n=[{name:toLanguage("Quick mode","Mode simplifi\xE9"),description:toLanguage("Create a track in a few clicks thanks to ready-made pieces","Cr\xE9ez un circuit en quelques clics gr\xE2ce \xE0 des pi\xE8ces toutes faites"),thumbnail:"help/mode-simple.png"},{name:toLanguage("Complete mode","Mode complet"),description:toLanguage("Create the track entirely from an image you drew yourself","Cr\xE9ez enti\xE8rement le circuit \xE0 partir d'une image dessin\xE9e par vous-m\xEAme"),thumbnail:"help/mode-complete.png"}],l=document.createElement("div");l.style.position="absolute",l.style.left=4*iScreenScale+"px",l.style.top=9*iScreenScale+"px",l.style.width=72*iScreenScale+"px";for(let t=0;t<n.length;t++){var o=n[t],a=document.createElement("div");a.innerHTML="<img src=\"images/"+o.thumbnail+"\" alt=\""+o.name+"\" style=\"height: "+10*iScreenScale+"px\" /><div style=\"padding: "+iScreenScale+"px "+Math.round(1.5*iScreenScale)+"px\"><h2 style=\"font-size: 1.5em; margin: 0\">"+o.name+"</h2><div style=\"color: white\">"+o.description+"</div></div>",a.style.display="flex",a.style.direction="column",a.style.alignItems="center",a.style.width="100%",a.style.fontSize=Math.round(1.9*iScreenScale)+"px",a.style.margin=Math.round(1.5*iScreenScale)+"px 0",a.className="fakebtn",a.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),selectTrackCreate(t)},l.appendChild(a)}e.appendChild(l);var s=document.createElement("a");s.style.color="#CCF",s.style.fontSize=Math.round(2.5*iScreenScale)+"px",s.style.position="absolute",s.style.left=toLanguage(30,29)*iScreenScale+"px",s.style.top=35*iScreenScale+"px",s.href="creations.php",s.onclick=function(){},s.innerHTML=toLanguage("List of creations","Liste des cr\xE9ations"),e.appendChild(s),oContainers[0].appendChild(e);var r=document.createElement("input");r.type="button",r.value=toLanguage("Back","Retour"),r.style.fontSize=2*iScreenScale+"px",r.style.position="absolute",r.style.left=2*iScreenScale+"px",r.style.top=35*iScreenScale+"px",r.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),selectTypeScreen()},e.appendChild(r),updateMenuMusic(0)}function selectTrackCreate(e){var t=document.createElement("div"),n=t.style;n.width=80*iScreenScale+"px",n.height=39*iScreenScale+"px",n.border="solid 1px black",n.backgroundColor="black";var l=toTitle(e?toLanguage("Complete track builder","\xC9diteur complet"):toLanguage("Quick track builder","\xC9diteur simplifi\xE9"),0);l.style.fontSize=Math.round(7*iScreenScale)+"px",t.appendChild(l);var o=[{name:toLanguage("Circuit","Circuit"),url:e?"draw.php":"create.php",thumbnail:"help/build-circuit.png"},{name:toLanguage("Cup - Circuits","Coupe - Circuits"),url:e?"completecup.php":"simplecup.php",thumbnail:"help/build-cup-circuit.png"},{name:toLanguage("Multicup - Circuits","Multicoupe - Circuits"),url:e?"completecups.php":"simplecups.php",thumbnail:"help/build-multicup-circuit.png"},{name:toLanguage("Arena","Ar\xE8ne"),url:e?"course.php":"arene.php",thumbnail:"help/build-arena.png"},{name:toLanguage("Cup - Arenas","Coupe - Ar\xE8nes"),url:e?"completecup.php?battle":"simplecup.php?battle",thumbnail:"help/build-cup-arena.png"},{name:toLanguage("Multicup - Arenas","Multicoupe - Ar\xE8nes"),url:e?"completecups.php?battle":"simplecups.php?battle",thumbnail:"help/build-multicup-arena.png"}],a=document.createElement("div");a.style.display="grid",a.style.position="absolute",a.style.left=14*iScreenScale+"px",a.style.top=9*iScreenScale+"px",a.style.width=60*iScreenScale+"px",a.style.display="grid",a.style.gridTemplateColumns=14*iScreenScale+"px "+18*iScreenScale+"px "+20*iScreenScale+"px",a.style.columnGap=2*iScreenScale+"px",a.style.fontSize=2*iScreenScale+"px",a.style.textAlign="center",a.style.backgroundColor="#000C",a.style.paddingBottom="1px",a.style.zIndex=1;for(var e=0;e<o.length;e++){var s=o[e],r=document.createElement("a");r.href=s.url,r.onclick=function(){},r.style.display="block",r.style.paddingTop=Math.round(iScreenScale/2)+"px",r.style.paddingBottom=Math.round(iScreenScale/4)+"px",r.style.marginBottom=Math.round(iScreenScale/4)+"px",r.style.color="#EEE",r.style.textDecoration="none",r.style.borderRadius=Math.round(iScreenScale/2)+"px",r.innerHTML="<img src=\"images/"+s.thumbnail+"\" style=\"width: "+10*iScreenScale+"px; height: "+9*iScreenScale+"px\" alt=\""+s.name+"\" /><div style=\"margin-top: "+Math.round(iScreenScale/2)+"px\">"+s.name+"</div>",r.onmouseover=function(){this.style.backgroundColor="rgb(38 85 177)"},r.onmouseout=function(){this.style.backgroundColor=""},r.style.cursor="pointer",a.appendChild(r)}t.appendChild(a);var p=document.createElement("a");p.style.color="#CCF",p.style.fontSize=Math.round(2.5*iScreenScale)+"px",p.style.position="absolute",p.style.left=toLanguage(30,29)*iScreenScale+"px",p.style.top=36*iScreenScale+"px",p.href="creations.php",p.onclick=function(){},p.innerHTML=toLanguage("List of creations","Liste des cr\xE9ations"),t.appendChild(p),oContainers[0].appendChild(t);var d=document.createElement("input");d.type="button",d.value=toLanguage("Back","Retour"),d.style.fontSize=2*iScreenScale+"px",d.style.position="absolute",d.style.left=2*iScreenScale+"px",d.style.top=36*iScreenScale+"px",d.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),selectTypeCreate()},t.appendChild(d),oContainers[0].appendChild(t),updateMenuMusic(0)}function selectPlayerScreen(IdJ,newP,nbSels,additionalOptions){function tourner(e){var t=Math.round(5*jScreenScale*(e.naturalWidth/768)),i=parseFloat(e.style.left);if(i>-21*t)e.style.left=i-t+"px";else if(e.naturalWidth){var n=Math.min(5*e.naturalWidth/768,5.8);e.style.left=-Math.round(jScreenScale*(5*e.naturalWidth/768-n)/2)+"px"}else e.style.left="0px";rotateHandler=setTimeout(function(){tourner(e)},100)}function createPersoSelector(e){var t=document.createElement("div");t.style.backgroundColor="#78D0F8",t.style.position="absolute",t.style.width=5*jScreenScale+"px",t.style.height=5*jScreenScale+"px",t.style.borderTop="double 4px black",t.style.borderLeft="double 4px #F8F8F8",t.style.borderRight="double 4px #F8F8F8",t.style.borderBottom="solid 5px #00B800",t.style.cursor="pointer",t.id="perso-selector-"+e;var n=document.createElement("div");n.style.position="absolute",n.style.display="inline-block",n.style.width=5*jScreenScale+"px",n.style.height=5*jScreenScale+"px",n.style.overflow="hidden";var l=new Image;if(l.style.height=5*jScreenScale+"px",l.style.position="absolute",l.className="pixelated",pUnlockMap[e]){for(var o=!0,a=0;a<strPlayer.length;a++)if(strPlayer[a]==e){o=!1;break}l.src=o?getSpriteSrc(e):getStarSrc(e),l.alt=e,l.style.left=-(30*jScreenScale)+"px",l.j=IdJ,l.onload=function(){var e=Math.min(5*this.naturalWidth/768,5.8),t=Math.min(5*this.naturalHeight/32,5.8);n.style.width=Math.round(e*jScreenScale)+"px",n.style.height=Math.round(t*jScreenScale)+"px",this.style.width=24*Math.round(5*this.naturalWidth/768*jScreenScale)+"px",this.style.height=Math.round(5*this.naturalHeight/32*jScreenScale)+"px",this.style.left=-Math.round(6*Math.round(5*jScreenScale*this.naturalWidth/768)+jScreenScale*(5*this.naturalWidth/768-e)/2)+"px",this.style.top=Math.round((t-5*this.naturalHeight/32)*jScreenScale/2)+"px",n.style.left=Math.round((5-e)/2*jScreenScale)+"px",n.style.top=Math.round(1+(5-t)/2*jScreenScale)+"px"},t.onmouseover=function(){cTable.style.display="block";var e=n.firstChild;hTd2.innerHTML=toPerso(e.alt);for(var t=0;t<dCaracteristiques.length;t++)dCaracteristiques[t].style.width=5*iScreenScale*(8*cp[e.alt][t]+1)+"px";clearTimeout(rotateHandler),tourner(e)},t.onmouseout=function(){cTable.style.display="none";var e=n.firstChild;if(e.naturalWidth){var t=Math.min(5*e.naturalWidth/768,5.8);e.style.left=-Math.round(6*Math.round(5*jScreenScale*e.naturalWidth/768)+jScreenScale*(5*e.naturalWidth/768-t)/2)+"px"}else e.style.left=-(30*jScreenScale)+"px";clearTimeout(rotateHandler)},t.onclick=function(){clearTimeout(rotateHandler);var e=t.firstChild.firstChild;strPlayer[e.j]=e.alt;var n="";if(isOnline||("VS"==course?(iDificulty=4+.5*selectedDifficulty,n="difficulty="+selectedDifficulty+"&players="+fInfos.nbPlayers+"&team="+fInfos.teams):n="players="+fInfos.nbPlayers+"&team="+fInfos.teams),oScr.innerHTML="",e.j++,oContainers[0].removeChild(oScr),document.body.removeChild(cTable),addMyPersos=function(){},oItemSelect?(selectedItemDistrib=modeItemDistributions[oItemSelect.value],localStorage.setItem("itemset."+itemMode,+oItemSelect.value)):selectedItemDistrib=modeItemDistributions[0],oPointSelect?(selectedPtDistrib=modePtDistributions[oPointSelect.value],localStorage.setItem("ptset",+oPointSelect.value)):selectedPtDistrib=modePtDistributions[0],oDoubleItemCheckbox?(oDoubleItemsEnabled=!oDoubleItemCheckbox.checked,selectedDoubleItems=oDoubleItemsEnabled,oDoubleItemsEnabled?localStorage.removeItem("doubleitems"):localStorage.setItem("doubleitems","0")):oDoubleItemsEnabled=!0,oClassSelect?(selectedCc=parseInt(oClassSelect.value),selectedMirror=oClassSelect.value.endsWith("m"),fSelectedClass=getRelSpeedFromCc(+selectedCc),bSelectedMirror=selectedMirror,"hidden"!==oClassSelect.type&&(localStorage.setItem("cc",selectedCc),selectedMirror?localStorage.setItem("mirror",1):localStorage.removeItem("mirror"))):(fSelectedClass=1,bSelectedMirror=!1),e.j==(isCustomSel?nbSels:oContainers.length)){if(isOnline){if(isCustomSel){var l=document.querySelector("[data-cpu-chars]");return strPlayer.splice(0,2),l.loadCpuChars(strPlayer),void(strPlayer.length=0)}aPlayers=[strPlayer[0]],iRaceCount=0}else if("CM"==course)aPlayers=[];else{aPlayers=[];var o;if(isCustomSel){for(var a=strPlayer.length-1;a>=oContainers.length;a--)aPlayers.push(strPlayer[a]);strPlayer.splice(oContainers.length)}else if(selectedOpponents){for(var a=0;a<selectedOpponents.length;a++)aPlayers.push(selectedOpponents[a]);o=function(e){for(var t=0,n=!1,l=function(){!t&&n&&e(),t--},o=0,a;o<selectedOpponents.length;o++)a=selectedOpponents[o],isCustomPerso(a,{callback:l})?t++:!cp[a]&&baseCp0[a]&&(cp[a]=baseCp0[a]);n=!0,l()}}else{var a=0;for(joueurs in cp)pUnlockMap[joueurs]&&(aPlayers.push(joueurs),a++);aPlayers.sort(function(){return .5-Math.random()});var s="GP"==course?8:fInfos.nbPlayers;if(aPlayers.length<s){var r=aPlayers.length;aPlayers.length*=Math.ceil(s/aPlayers.length);for(var a=r;a<aPlayers.length;a++)aPlayers[a]=aPlayers[a%r]}else for(var a=0,p;a<aPlayers.length;a++){p=aPlayers[a];for(var d=0;d<strPlayer.length;d++)if(strPlayer[d]==p){aPlayers.splice(a,1),a--;break}}var c=aPlayers.length-s+strPlayer.length;aPlayers.splice(0,c)}aPlaces=[],aTeams=[],resetScores(),"GP"!=course&&(selectedPlayers=fInfos.nbPlayers,selectedTeams=fInfos.teams,xhr("updateCourseOptions.php",n,function(e){return 1==e}))}if(isOnline){var u={},m={nbTeams:1,minPlayers:1,maxPlayers:1,localScore:1,ptDistrib:1,friendly:1,cpu:1,cpuLevel:1,cpuNames:1,cpuChars:1,doubleItems:1};for(var y in shareLink.options)m[y]||(u[y]=shareLink.options[y]);enableSpectatorMode||!isCustomOptions(u)||shareLink.accepted||shareLink.player==identifiant?searchCourse({enableSpectatorMode:enableSpectatorMode}):acceptRulesScreen()}else{function e(){isTeamPlay()?selectTeamScreen(0):selectTrackScreen()}o?o(e):e()}}else selectPlayerScreen(e.j,void 0,nbSels);var h=/^cp-\w+-(\d+)$/g.exec(e.alt);h&&!t.dataset.autoset&&xhr("selectPerso.php","id="+h[1],function(){return!0})}}else l.src="images/kart_locked.png";return n.appendChild(l),t.appendChild(n),t}function showCharacters(e){for(var t=0;t<charSelectors.length;t++)charSelectors[t].remove();charSelectors=[];for(var n=Math.min(nBasePersos-24*e,24),t=0;t<n;t++){var l=t%charsPerLine,o=Math.floor(t/charsPerLine);l-=o<lines-1?(charsPerLine-1)/2:(n-1)%charsPerLine/2,o-=(lines-1)/2;var a=createPersoSelector(aPlayers[t+24*e]);a.style.left=Math.round((midPersoX+l*tilePersoX)*iScreenScale)+"px",a.style.top=Math.round((midPersoY+o*tilePersoY)*iScreenScale-8)+"px",charSelectors.push(a),oScr.appendChild(a)}}function goBack(){if(oScr.innerHTML="",oContainers[0].removeChild(oScr),document.body.removeChild(cTable),isCustomSel){if(isOnline){strPlayer.length=0;var e=document.querySelector("[data-cpu-chars]");e.loadCpuChars(null)}else selectPlayerScreen(0);}else if(displayCommands(),isOnline)quitter();else if("VS"==course||"BB"==course){for(var t=1;t<oContainers.length;t++)oContainers.splice(t,1);selectNbJoueurs(!0)}else selectTypeScreen()}function addMyPersos(e){var t=cp;for(var n in cp={},baseCp)cp[n]=baseCp[n];customPersos=baseCustomPersos();for(var l=0;l<e.length;l++){var o=e[l],a=o.sprites;cp[a]||(cp[a]=[]),cp[a][0]=o.acceleration,cp[a][1]=o.speed,cp[a][2]=o.handling,cp[a][3]=o.mass,customPersos[a]=o}for(n in aPlayers=[],cp)aPlayers.push(n);for(var n in t)cp[n]||(cp[n]=t[n]);for(var l=0,a;l<e.length;l++){a=e[l].sprites,pUnlockMap[a]=1;var s=createPersoSelector(a);if(newP&&!l&&s.onclick)return void s.onclick();s.style.left=myPersosOffset*iScreenScale+"px",s.style.top=(baseY+7*l)*iScreenScale-8+"px",oScr.insertBefore(s,pDiv)}oScr.style.visibility="visible"}var isCustomSel=void 0!==nbSels,force=-1===IdJ;if(force&&(IdJ=0),!IdJ){for(joueurs in strPlayer=[],aPlayers=[],cp)aPlayers.push(joueurs);updateCommandSheet()}var itemMode=getItemMode(),modeItemDistributions=itemDistributions[itemMode].concat(customItemDistrib[itemMode]),modePtDistributions=ptDistributions.concat(customPtDistrib);fInfos||(fInfos={});var oScr=document.createElement("div"),selectedOpponents;newP&&(oScr.style.visibility="hidden");var oStyle=oScr.style;oStyle.width=80*iScreenScale+"px",oStyle.height=39*iScreenScale+"px",oStyle.border="solid 1px black",oStyle.backgroundColor="black";var shrinkAll=("VS"==course||"BB"==course)&&!clSelected,oTitle;if(isCustomSel){var oMsg;oMsg=isOnline?toLanguage("Choose CPU","Choisissez ordi")+" "+(IdJ-1):IdJ>=oContainers.length?toLanguage("Choose CPU","Choisissez ordi")+" "+(IdJ+1-oContainers.length):1==oContainers.length?toLanguage("Choose player","Choisissez joueur"):toLanguage("Choose player ","Choisissez joueur ")+(IdJ+1),oTitle=toTitle(oMsg,-1),oTitle.style.color="#F90"}else oTitle=toTitle(toLanguage("Select a player","Choisissez un joueur"),-1);shrinkAll&&(oTitle.style.fontSize=Math.round(7.5*iScreenScale)+"px"),oScr.appendChild(oTitle);var baseY=shrinkAll?8:10,customCharsEnabled=0!==cupOpts.customchars,cTable=document.createElement("table");cTable.style.display="none",cTable.style.position="absolute",cTable.style.zIndex=2,cTable.style.top=36*iScreenScale+16+"px",cTable.style.left=25*iScreenScale-60+"px",cTable.style.textAlign="left",cTable.style.fontSize=2*iScreenScale+"px",cTable.style.color="white",cTable.style.backgroundColor="black",cTable.style.backgroundColor="rgba(0,0,0, 0.8)",cTable.setAttribute("cellpadding",2),cTable.setAttribute("cellspacing",2),document.body.appendChild(cTable);var hTr=document.createElement("tr"),hTd1=document.createElement("td");hTd1.innerHTML="&nbsp;",hTr.appendChild(hTd1);var hTd2=document.createElement("td");hTd2.innerHTML="&nbsp;",hTd2.style.fontWeight="bold",hTr.appendChild(hTd2),cTable.appendChild(hTr);for(var sCaracteristiques=[toLanguage("Acceleration","Acc\xE9l\xE9ration"),toLanguage("Max speed","Vitesse max"),toLanguage("Handling","Maniabilit\xE9"),toLanguage("Weight","Poids")],dCaracteristiques=[],i=0;i<sCaracteristiques.length;i++){var oTr=document.createElement("tr"),oTd1=document.createElement("td");oTd1.className="rgt",oTd1.innerHTML=sCaracteristiques[i]+" :",oTr.appendChild(oTd1);var oTd2=document.createElement("td");dCaracteristiques[i]=document.createElement("div"),dCaracteristiques[i].style.backgroundColor="#838057",dCaracteristiques[i].style.border="solid 1px silver",dCaracteristiques[i].style.height=2*iScreenScale+"px",dCaracteristiques[i].innerHTML="&nbsp;",oTd2.appendChild(dCaracteristiques[i]),oTr.appendChild(oTd2),cTable.appendChild(oTr)}var jScreenScale=iScreenScale,maxCharsPerPage=24,charsPerLine=8,maxShownChars=Math.min(nBasePersos,maxCharsPerPage),minPersoX=8,maxPersoX=58.4,rotateHandler,oItemSelect,oPointSelect,oClassSelect,oDoubleItemCheckbox;if(!customCharsEnabled){var shiftX=5;minPersoX+=5,maxPersoX+=5}nBasePersos>maxCharsPerPage&&(minPersoX+=3,maxPersoX+=3);var minPersoY=baseY,maxPersoY=baseY+14,midPersoX=(minPersoX+maxPersoX)/2,midPersoY=(minPersoY+maxPersoY)/2,lines=Math.ceil(maxShownChars/charsPerLine);charsPerLine=Math.ceil(maxShownChars/lines);var tilePersoX=Math.min(9,(maxPersoX-minPersoX)/(charsPerLine-1)),tilePersoY=Math.min(8,(maxPersoY-minPersoY)/(lines-1));tilePersoX=Math.min(tilePersoX,1.2*tilePersoY);var charSelectors=[],curPage=0,myPersosOffset=nBasePersos>maxCharsPerPage?73:67,pages=Math.ceil(nBasePersos/24);if(showCharacters(curPage),customCharsEnabled){var pDiv=document.createElement("div");pDiv.style.backgroundColor="#78D0F8",pDiv.style.position="absolute",pDiv.style.width=5*iScreenScale+"px",pDiv.style.height=5*iScreenScale+"px",pDiv.style.left=myPersosOffset*iScreenScale+"px",pDiv.style.top=(baseY+14)*iScreenScale-8+"px",pDiv.style.borderTop="double 4px black",pDiv.style.borderLeft="double 4px #F8F8F8",pDiv.style.borderRight="double 4px #F8F8F8",pDiv.style.borderBottom="solid 5px #00B800",pDiv.style.overflow="hidden";var pPImg=new Image;pPImg.style.height=5*iScreenScale+"px",pPImg.style.position="absolute",pPImg.src="images/kart_persos.png",pPImg.style.cursor="pointer",pPImg.title=language?"Character editor":"\xC9diteur de personnages",pPImg.className="pixelated",pPImg.onclick=function(){window.open("choosePerso.php","chose","scrollbars=1, resizable=1, width=500, height=500")},pDiv.appendChild(pPImg),oScr.appendChild(pDiv)}if(oContainers[0].appendChild(oScr),isOnline)if(isCustomSel);else{var aDeconnexion=document.createElement("a");aDeconnexion.style.color="white",aDeconnexion.style.fontSize=2*iScreenScale+"px",aDeconnexion.style.position="absolute",aDeconnexion.style.left=24*iScreenScale+"px",aDeconnexion.style.top=34*iScreenScale+"px",aDeconnexion.innerHTML=toLanguage("Log out","D\xE9connexion"),aDeconnexion.href="#null",aDeconnexion.onclick=function(){return oScr.innerHTML="",oContainers[0].removeChild(oScr),document.body.removeChild(cTable),displayCommands(),mPseudo="",mCode="",connexion(),xhr("deco.php",null,function(){return!0}),!1},oScr.appendChild(aDeconnexion);var eClassement=document.createElement("a");if(eClassement.style.fontSize=2*iScreenScale+"px",eClassement.style.position="absolute",eClassement.style.left=41*iScreenScale+"px",eClassement.style.top=34*iScreenScale+"px",eClassement.innerHTML=toLanguage("Rankings","Classement"),shareLink.options&&shareLink.options.localScore?(eClassement.title=toLanguage("Private game ranking","Classement partie priv\xE9e"),eClassement.style.color="#CF8",eClassement.setAttribute("href","localscores.php"+window.location.search)):(eClassement.style.color="white",eClassement.setAttribute("href","bestscores.php"+("BB"==course?"?battle":""))),eClassement.onclick=function(){},oScr.appendChild(eClassement),!shareLink.key){var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Private game...","Partie priv\xE9e..."),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=62*iScreenScale+"px",oPInput.style.top=34*iScreenScale+"px",oPInput.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),privateGame()},oScr.appendChild(oPInput)}else if(shareLink.player==identifiant){var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Private game options...","Options partie priv\xE9e..."),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=56*iScreenScale+"px",oPInput.style.top=34*iScreenScale+"px",oPInput.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),privateGameOptions(shareLink.options,function(e){e&&(isCustomOptions(e)||isCustomOptions(shareLink.options))?xhr("privateGameOptions.php","key="+shareLink.key+"&options="+encodeURIComponent(JSON.stringify(e)),function(t){return 1==t&&(shareLink.options||(shareLink.options={}),shareLink.options.team=e.team,shareLink.options.manualTeams=e.manualTeams,shareLink.options.friendlyFire=e.friendlyFire,shareLink.options.nbTeams=e.nbTeams,shareLink.options.teamOpts=e.teamOpts,shareLink.options.localScore=e.localScore,shareLink.options.friendly=e.friendly,shareLink.options.minPlayers=e.minPlayers,shareLink.options.maxPlayers=e.maxPlayers,shareLink.options.cc=e.cc,shareLink.options.mirror=e.mirror,shareLink.options.itemDistrib=e.itemDistrib,shareLink.options.ptDistrib=e.ptDistrib,shareLink.options.cpu=e.cpu,shareLink.options.cpuCount=e.cpuCount,shareLink.options.cpuLevel=e.cpuLevel,shareLink.options.cpuNames=e.cpuNames,shareLink.options.cpuChars=e.cpuChars,shareLink.options.timeTrial=e.timeTrial,shareLink.options.noBumps=e.noBumps,shareLink.options.noJump=e.noJump,shareLink.options.noRd=e.noRd,shareLink.options.doubleItems=e.doubleItems,selectedTeams=e.team,selectPlayerScreen(0),!0)}):selectPlayerScreen(0)})},oScr.appendChild(oPInput)}}var enableSpectatorMode=!1,oTeamsDiv,oParticipantsDiv;if(isOnline&&!isCustomSel){additionalOptions&&additionalOptions.enableSpectatorMode&&(enableSpectatorMode=!0);var $spectatorModeCtn=document.createElement("div");$spectatorModeCtn.style.position="absolute",$spectatorModeCtn.style.left=toLanguage(24,21)*iScreenScale+"px",$spectatorModeCtn.style.top=29*iScreenScale+"px",$spectatorModeCtn.style.fontSize=Math.round(2*iScreenScale)+"px",$spectatorModeCtn.style.display="flex",$spectatorModeCtn.style.alignItems="center";var $spectatorModeLabel=document.createElement("label");$spectatorModeLabel.style.display="inline-flex",$spectatorModeLabel.style.alignItems="center",$spectatorModeLabel.style.cursor="pointer",$spectatorModeLabel.style.gap=Math.round(.5*iScreenScale)+"px",$spectatorModeLabel.style.marginRight=iScreenScale+"px";var $spectatorModeCheckbox=document.createElement("input");$spectatorModeCheckbox.type="checkbox",$spectatorModeCheckbox.checked=enableSpectatorMode,$spectatorModeCheckbox.style.transform="scale("+iScreenScale/8+")",$spectatorModeCheckbox.style.transformOrigin="center",$spectatorModeCheckbox.style.marginRight=iScreenScale-5+"px",$spectatorModeCheckbox.onclick=function(){enableSpectatorMode=this.checked},$spectatorModeLabel.appendChild($spectatorModeCheckbox);var $spectatorModeCheckboxText=document.createElement("span");$spectatorModeCheckboxText.innerHTML=toLanguage("Join in spectator mode","Rejoindre en mode spectateur"),$spectatorModeLabel.appendChild($spectatorModeCheckboxText),$spectatorModeCtn.appendChild($spectatorModeLabel);var $spectatorModeHelp=document.createElement("a");$spectatorModeHelp.href="#null",$spectatorModeHelp.style.color="#CCF",$spectatorModeHelp.innerHTML="[?]",$spectatorModeHelp.style.cursor="help",$spectatorModeHelp.onclick=function(){return!1},$spectatorModeHelp.dataset.noselect="1",$spectatorModeCtn.appendChild($spectatorModeHelp),addFancyTitle({elt:$spectatorModeHelp,title:toLanguage("Check this to see races<br />without playing on them","Cochez cette case pour voir<br />les courses sans y participer"),style:function(e){return{left:e.left-10*iScreenScale+"px",top:e.top+4*iScreenScale+"px",backgroundColor:"rgba(51,51,160, 0.95)"}}}),oScr.appendChild($spectatorModeCtn)}else if("VS"==course||"BB"==course){function e(e,t,n){void 0===n&&(n=t);for(var l=e.getElementsByTagName("option"),o=0,a;o<l.length;o++)if(a=l[o].value,a==t){e.selectedIndex=o;break}else if(-1==a||parseInt(a)>parseInt(t)){var s=document.createElement("option");s.value=t,s.innerHTML=n,e.insertBefore(s,l[o]),e.selectedIndex=o;break}e.value=t}var oForm=document.createElement("form");if(oForm.onsubmit=function(){return!1},oForm.style.position="absolute",oForm.style.top=(baseY+21)*iScreenScale-5+"px",oForm.style.left=18*iScreenScale+"px",oForm.style.fontSize=2*iScreenScale+"px",oForm.style.zIndex=2,IdJ||newP||(iDificulty=selectedDifficulty,fInfos.nbPlayers=selectedPlayers,fInfos.teams=selectedTeams,fInfos.nbteams=+selectedNbTeams,fInfos.friendlyFire=!!selectedFriendlyFire),"VS"==course){var oDiffDiv=document.createElement("label");oDiffDiv.appendChild(document.createTextNode(toLanguage("Difficulty: ","Difficult\xE9 : ")));var iDifficulties=[toLanguage("Easy","Facile"),toLanguage("Medium","Moyen"),toLanguage("Difficult","Difficile"),toLanguage("Extreme","Extr\xEAme"),toLanguage("Impossible","Impossible")],oSelect=document.createElement("select");oSelect.name="difficulty",oSelect.style.width="auto",oSelect.style.fontSize=2*iScreenScale+"px",oSelect.style.marginRight="10px",oSelect.onchange=function(){selectedDifficulty=this.selectedIndex};for(var i=0,oOption;i<iDifficulties.length;i++)oOption=document.createElement("option"),oOption.value=i,oOption.innerHTML=iDifficulties[i],selectedDifficulty==i&&(oOption.selected="selected"),oSelect.appendChild(oOption);oDiffDiv.appendChild(oSelect),oForm.appendChild(oDiffDiv)}else iDificulty=4.5;oTeamsDiv=document.createElement("label"),oTeamsDiv.appendChild(document.createTextNode(toLanguage("Teams: ","\xC9quipes : ")));var oSelect=document.createElement("select");oSelect.name="difficulty",oSelect.style.width=15*iScreenScale+15+"px",oSelect.style.fontSize=2*iScreenScale+"px",oSelect.onchange=function(){fInfos.teams=this.selectedIndex};for(var iTeams=[toLanguage("No teams","Chacun pour soi"),toLanguage("Team Game","Match par \xE9quipes")],i=0,oOption;i<iTeams.length;i++)oOption=document.createElement("option"),oOption.value=i,oOption.innerHTML=iTeams[i],selectedTeams==i&&(oOption.selected="selected"),oSelect.appendChild(oOption);oTeamsDiv.appendChild(oSelect),oForm.appendChild(oTeamsDiv),oParticipantsDiv=document.createElement("label"),oParticipantsDiv.style.display="block",oParticipantsDiv.appendChild(document.createTextNode(toLanguage("Number of participants","Nombre de participants ")+": "));var oSelect=document.createElement("select");oSelect.name="nbj",oSelect.style.width=3*iScreenScale+20+"px",oSelect.style.fontSize=2*iScreenScale+"px";for(var i=2,oOption;8>=i;i++)oOption=document.createElement("option"),oOption.value=i,oOption.innerHTML=i,oSelect.appendChild(oOption);var oOption=document.createElement("option");oOption.value=-1,oOption.innerHTML=toLanguage("More...","Plus..."),oSelect.appendChild(oOption),e(oSelect,fInfos.nbPlayers),oSelect.onchange=function(){if(-1==this.value){var t=parseInt(prompt(toLanguage("Number of players:","Nombre de joueurs :")));!isNaN(t)&&1<t?e(this,Math.min(t,999)):(!isNaN(t)&&alert(toLanguage("Invalid value","Valeur invalide")),e(this,fInfos.nbPlayers))}fInfos.nbPlayers=parseInt(this.value)},oParticipantsDiv.appendChild(oSelect);var oChoosePerso=document.createElement("a");if(oChoosePerso.innerHTML=toLanguage("Choose characters...","Choix des persos..."),oChoosePerso.href="#null",oChoosePerso.style.display="inline-block",oChoosePerso.style.marginLeft=2*iScreenScale+"px",oChoosePerso.style.color="white",oChoosePerso.onclick=function(){return iDificulty=selectedDifficulty,selectedPlayers=fInfos.nbPlayers,selectedTeams=fInfos.teams,oItemSelect&&localStorage.setItem("itemset."+itemMode,+oItemSelect.value),clearTimeout(rotateHandler),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,!1,fInfos.nbPlayers),!1},oParticipantsDiv.appendChild(oChoosePerso),oForm.appendChild(oParticipantsDiv),!clSelected){function t(t,i,n){e(t,i+(n?"m":""),i+"cc"+(n?toLanguage(" mirror"," miroir"):""))}var oClassDiv=document.createElement("label");oClassDiv.style.display="block",oClassDiv.appendChild(document.createTextNode(toLanguage("Class","Cylindr\xE9e ")+": ")),oClassSelect=document.createElement("select"),oClassSelect.name="cc",oClassSelect.style.width=10*iScreenScale+"px",oClassSelect.style.fontSize=2*iScreenScale+"px";for(var oClasses=[50,100,150,150,200],oMirrors=[!1,!1,!1,!0,!1],isSelectedCc=!1,i=0;i<oClasses.length;i++){var oClass=oClasses[i],oMirror=oMirrors[i],oClassOption=document.createElement("option");oClassOption.value=oClass+(oMirror?"m":""),oClassOption.innerHTML=oClass+"cc"+(oMirror?toLanguage(" mirror"," miroir"):""),selectedCc==oClass&&selectedMirror==oMirror&&(oClassOption.setAttribute("selected",!0),isSelectedCc=!0),oClassSelect.appendChild(oClassOption)}oClassSelect.style.marginRight="10px";var oClassOption=document.createElement("option");oClassOption.value=-1,oClassOption.innerHTML=toLanguage("More...","Plus..."),oClassSelect.appendChild(oClassOption),oClassSelect.onchange=function(){handleCcSelectChange(this,oScr,function(e,i,n){t(e,i,n)})},isSelectedCc||t(oClassSelect,selectedCc,selectedMirror),oClassSelect.currentValue=oClassSelect.value,oClassDiv.appendChild(oClassSelect);var moreOptions=document.createElement("a");moreOptions.href="#null",moreOptions.style.color="white",moreOptions.innerHTML=toLanguage("More options...","Plus d'options..."),moreOptions.style.marginLeft=1*iScreenScale+"px",moreOptions.onclick=function(){return oMoreOptionsScreen.style.display="block",!1},oClassDiv.appendChild(moreOptions),oForm.appendChild(oClassDiv);var oMoreOptionsScreen=document.createElement("div");oMoreOptionsScreen.style.position="absolute",oMoreOptionsScreen.style.width="100%",oMoreOptionsScreen.style.height="100%",oMoreOptionsScreen.style.left="0px",oMoreOptionsScreen.style.top="0px",oMoreOptionsScreen.style.backgroundColor="#000",additionalOptions&&additionalOptions.openOptions||(oMoreOptionsScreen.style.display="none"),oMoreOptionsScreen.style.zIndex=3;var oMoreOptionsTitle=toTitle(toLanguage("More options","Plus d'options"),2);oMoreOptionsScreen.appendChild(oMoreOptionsTitle),oScr.appendChild(oMoreOptionsScreen);var oScroll=document.createElement("div");oScroll.style.maxHeight=24*iScreenScale+"px",oScroll.style.overflow="auto",oScroll.style.position="absolute",oScroll.style.left="0px",oScroll.style.top=12*iScreenScale+"px",oScroll.style.width=80*iScreenScale+"px";var oTable=document.createElement("table");oTable.style.marginLeft="auto",oTable.style.marginRight="auto",oScroll.appendChild(oTable);var oTr=document.createElement("tr"),oTd=document.createElement("td");oTd.setAttribute("colspan",2);var cDiv=document.createElement("div");cDiv.style.display="flex",cDiv.style.flexDirection="row",cDiv.style.alignItems="center";var tDiv=document.createElement("div");tDiv.style.paddingLeft=3*iScreenScale+"px",tDiv.style.paddingRight=3*iScreenScale+"px";var oLabel=document.createElement("label");oLabel.style.cursor="pointer",oLabel.setAttribute("for","option-itemDistrib");var oH1=document.createElement("h1");oH1.style.fontSize=3*iScreenScale+"px",oH1.innerHTML=toLanguage("Item distribution :","Distribution des objets :"),oH1.style.marginTop=iScreenScale+"px",oH1.style.marginBottom="0px",oLabel.appendChild(oH1),tDiv.appendChild(oLabel),cDiv.appendChild(tDiv);var tDiv=document.createElement("div");tDiv.style.display="inline-block",oItemSelect=document.createElement("select"),oItemSelect.id="option-itemDistrib",oItemSelect.name="option-itemDistrib",oItemSelect.style.backgroundColor="black",oItemSelect.style.width=24*iScreenScale+"px",oItemSelect.style.fontSize=Math.round(2.5*iScreenScale)+"px",oItemSelect.style.marginTop=Math.round(1.5*iScreenScale)+"px";for(var i=0,oItemOption;i<modeItemDistributions.length;i++)oItemOption=document.createElement("option"),oItemOption.value=i,oItemOption.innerHTML=modeItemDistributions[i].name,oItemSelect.appendChild(oItemOption);var oItemOption=document.createElement("option");oItemOption.value=-1,oItemOption.innerHTML=toLanguage("Custom...","Personnalis\xE9..."),oItemSelect.appendChild(oItemOption),oItemSelect.currentValue=oItemSelect.value,oItemSelect.onchange=function(){-1==this.value?(this.value=this.currentValue,selectedItemDistrib=modeItemDistributions[this.currentValue],selectItemScreen(oScr,function(e){customItemDistrib[itemMode].push(e),localStorage.setItem("itemsets",JSON.stringify(customItemDistrib)),localStorage.setItem("itemset."+itemMode,modeItemDistributions.length),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,newP,nbSels,{openOptions:!0})})):(this.currentValue=this.value,selectedItemDistrib=modeItemDistributions[this.value],oItemCustomActions.style.display=this.value>=itemDistributions[itemMode].length?"inline-block":"none")},tDiv.appendChild(oItemSelect);var oItemCustomActions=document.createElement("div");oItemCustomActions.style.display="none",oItemCustomActions.style.marginLeft=1*iScreenScale+"px";var oItemCustomEdit=document.createElement("input");oItemCustomEdit.type="button",oItemCustomEdit.style.backgroundColor="rgb(51, 160, 51)",oItemCustomEdit.style.color="white",oItemCustomEdit.style.fontSize=Math.round(2.5*iScreenScale)+"px",oItemCustomEdit.value="\u270E",oItemCustomEdit.onclick=function(){selectItemScreen(oScr,function(e){customItemDistrib[itemMode][oItemSelect.value-itemDistributions[itemMode].length]=e,localStorage.setItem("itemsets",JSON.stringify(customItemDistrib)),localStorage.setItem("itemset."+itemMode,+oItemSelect.value),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,newP,nbSels,{openOptions:!0})},modeItemDistributions[oItemSelect.value])},oItemCustomActions.appendChild(oItemCustomEdit);var oItemCustomDel=document.createElement("input");oItemCustomDel.type="button",oItemCustomDel.style.marginLeft=Math.round(.5*iScreenScale)+"px",oItemCustomDel.style.backgroundColor="rgb(204, 51, 51)",oItemCustomDel.style.color="white",oItemCustomDel.value="\xD7",oItemCustomDel.style.fontSize=Math.round(2.5*iScreenScale)+"px",oItemCustomDel.onclick=function(){var e=modeItemDistributions[oItemSelect.value].name;confirm(toLanguage("Delete item set \""+e+"\"?","Supprimer le set \""+e+"\" ?"))&&(customItemDistrib[itemMode].splice(oItemSelect.value-itemDistributions[itemMode].length,1),localStorage.setItem("itemsets",JSON.stringify(customItemDistrib)),localStorage.setItem("itemset."+itemMode,0),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,newP,nbSels,{openOptions:!0}))},oItemCustomActions.appendChild(oItemCustomDel),tDiv.appendChild(oItemCustomActions);var selectedItemSetId=localStorage.getItem("itemset."+itemMode);selectedItemSetId&&(oItemSelect.selectedIndex=selectedItemSetId,oItemSelect.onchange()),cDiv.appendChild(tDiv),oTd.appendChild(cDiv),oTr.appendChild(oTd),oTable.appendChild(oTr);var oTable=document.createElement("table");if(oTable.style.marginLeft="auto",oTable.style.marginRight="auto",oScroll.appendChild(oTable),"BB"!=course){var oTr=document.createElement("tr"),oTd=document.createElement("td");oTd.setAttribute("colspan",2);var cDiv=document.createElement("div");cDiv.style.display="flex",cDiv.style.flexDirection="row",cDiv.style.alignItems="center";var tDiv=document.createElement("div");tDiv.style.paddingLeft=3*iScreenScale+"px",tDiv.style.paddingRight=3*iScreenScale+"px";var oLabel=document.createElement("label");oLabel.style.cursor="pointer",oLabel.setAttribute("for","option-ptDistrib");var oH1=document.createElement("h1");oH1.style.fontSize=3*iScreenScale+"px",oH1.innerHTML=toLanguage("Point distribution :","Distribution des points :"),oH1.style.marginTop=iScreenScale+"px",oH1.style.marginBottom="0px",oLabel.appendChild(oH1),tDiv.appendChild(oLabel),cDiv.appendChild(tDiv);var tDiv=document.createElement("div");tDiv.style.display="inline-block",oPointSelect=document.createElement("select"),oPointSelect.id="option-ptDistrib",oPointSelect.name="option-ptDistrib",oPointSelect.style.backgroundColor="black",oPointSelect.style.width=24*iScreenScale+"px",oPointSelect.style.fontSize=Math.round(2.5*iScreenScale)+"px",oPointSelect.style.marginTop=Math.round(1.5*iScreenScale)+"px";for(var i=0,oPtOption;i<modePtDistributions.length;i++)oPtOption=document.createElement("option"),oPtOption.value=i,oPtOption.innerHTML=modePtDistributions[i].name,oPointSelect.appendChild(oPtOption);var oPtOption=document.createElement("option");oPtOption.value=-1,oPtOption.innerHTML=toLanguage("Custom...","Personnalis\xE9..."),oPointSelect.appendChild(oPtOption),oPointSelect.currentValue=oPointSelect.value,oPointSelect.onchange=function(){-1==this.value?(this.value=this.currentValue,selectedPtDistrib=modePtDistributions[this.currentValue],selectPtScreen(oScr,function(e){customPtDistrib.push(e),localStorage.setItem("ptsets",JSON.stringify(customPtDistrib)),localStorage.setItem("ptset",modePtDistributions.length),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectedPlayers=e.value.length,selectPlayerScreen(IdJ,newP,nbSels,{openOptions:!0})},{value:getDefaultPointDistribution(fInfos.nbPlayers)})):(this.currentValue=this.value,selectedPtDistrib=modePtDistributions[this.value],oPtCustomActions.style.display=this.value>=ptDistributions.length?"inline-block":"none")},tDiv.appendChild(oPointSelect);var oPtCustomActions=document.createElement("div");oPtCustomActions.style.display="none",oPtCustomActions.style.marginLeft=1*iScreenScale+"px";var oPtCustomEdit=document.createElement("input");oPtCustomEdit.type="button",oPtCustomEdit.style.backgroundColor="rgb(51, 160, 51)",oPtCustomEdit.style.color="white",oPtCustomEdit.style.fontSize=Math.round(2.5*iScreenScale)+"px",oPtCustomEdit.value="\u270E",oPtCustomEdit.onclick=function(){selectPtScreen(oScr,function(e){customPtDistrib[oPointSelect.value-ptDistributions.length]=e,localStorage.setItem("ptsets",JSON.stringify(customPtDistrib)),localStorage.setItem("ptset",+oPointSelect.value),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,newP,nbSels,{openOptions:!0})},modePtDistributions[oPointSelect.value])},oPtCustomActions.appendChild(oPtCustomEdit);var oPtCustomDel=document.createElement("input");oPtCustomDel.type="button",oPtCustomDel.style.marginLeft=Math.round(.5*iScreenScale)+"px",oPtCustomDel.style.backgroundColor="rgb(204, 51, 51)",oPtCustomDel.style.color="white",oPtCustomDel.value="\xD7",oPtCustomDel.style.fontSize=Math.round(2.5*iScreenScale)+"px",oPtCustomDel.onclick=function(){var e=modePtDistributions[oPointSelect.value].name;confirm(toLanguage("Delete point set \""+e+"\"?","Supprimer le set \""+e+"\" ?"))&&(customPtDistrib.splice(oPointSelect.value-ptDistributions.length,1),localStorage.setItem("ptsets",JSON.stringify(customPtDistrib)),localStorage.setItem("ptset",0),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,newP,nbSels,{openOptions:!0}))},oPtCustomActions.appendChild(oPtCustomDel),tDiv.appendChild(oPtCustomActions);var selectedPtSetId=localStorage.getItem("ptset");selectedPtSetId&&(oPointSelect.selectedIndex=selectedPtSetId,oPointSelect.onchange()),cDiv.appendChild(tDiv),oTd.appendChild(cDiv),oTr.appendChild(oTd),oTable.appendChild(oTr)}var oTr=document.createElement("tr"),oTd=document.createElement("td");oTd.style.textAlign="center",oTd.style.width=8*iScreenScale+"px",oTd.style.paddingLeft=2*iScreenScale+"px";var oDoubleItemCheckbox=document.createElement("input");oDoubleItemCheckbox.style.transform=oDoubleItemCheckbox.style.WebkitTransform=oDoubleItemCheckbox.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",oDoubleItemCheckbox.id="option-doubleItems",oDoubleItemCheckbox.name="option-doubleItems",oDoubleItemCheckbox.type="checkbox",oDoubleItemCheckbox.checked=!selectedDoubleItems,oTd.appendChild(oDoubleItemCheckbox),oTr.appendChild(oTd);var oTd=document.createElement("td"),oLabel=document.createElement("label");oLabel.style.cursor="pointer",oLabel.setAttribute("for","option-doubleItems");var oH1=document.createElement("h1");oH1.style.fontSize=3*iScreenScale+"px",oH1.style.margin=Math.round(.5*iScreenScale)+"px auto",oH1.innerHTML=toLanguage("Disable double items","D\xE9sactiver les double objets"),oLabel.appendChild(oH1),oTd.appendChild(oLabel),oTd.style.padding=Math.round(1.5*iScreenScale)+"px 0",oTr.appendChild(oTd),oTable.appendChild(oTr),oMoreOptionsScreen.appendChild(oScroll);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Back","Retour"),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=4*iScreenScale+"px",oPInput.style.top=32*iScreenScale+"px",oPInput.onclick=function(){oMoreOptionsScreen.style.display="none"},oMoreOptionsScreen.appendChild(oPInput)}else{var ccConstraint=getCcConstraint(clSelected);ccConstraint&&(oClassSelect=document.createElement("input"),oClassSelect.type="hidden",oClassSelect.value=ccConstraint)}oScr.appendChild(oForm),isCustomSel&&(oForm.style.display="none")}else if("CM"==course){if(!clSelected){var oDiv=document.createElement("div");oDiv.style.position="absolute",oDiv.style.left=10*iScreenScale-10+"px",oDiv.style.top=32*iScreenScale+"px",oDiv.style.width=60*iScreenScale+"px",oDiv.style.fontSize=3*iScreenScale+"px",oDiv.style.textAlign="center";var oLabel=document.createElement("label");oLabel.innerHTML=toLanguage("Class: ","Cylindr\xE9e : "),oClassSelect=document.createElement("select"),oClassSelect.name="cc",oClassSelect.style.width=12*iScreenScale+"px",oClassSelect.style.fontSize=3*iScreenScale+"px";for(var oClasses=[150,200],i=0;i<oClasses.length;i++){var oClass=oClasses[i],oClassOption=document.createElement("option");oClassOption.value=oClass,oClassOption.innerHTML=oClass+"cc",selectedCc==oClass&&oClassOption.setAttribute("selected",!0),oClassSelect.appendChild(oClassOption)}oLabel.appendChild(oClassSelect),oDiv.appendChild(oLabel),oScr.appendChild(oDiv)}else{var ccConstraint=getCcConstraint(clSelected);(150==ccConstraint||200==ccConstraint)&&(oClassSelect=document.createElement("input"),oClassSelect.type="hidden",oClassSelect.value=ccConstraint)}if(isSingle){var oClassement=document.createElement("input");oClassement.type="button",oClassement.value=toLanguage("Rankings","Classement"),oClassement.style.position="absolute",oClassement.style.left=57*iScreenScale+"px",oClassement.style.top=Math.round(32.25*iScreenScale)+"px",oClassement.style.fontSize=Math.round(2.5*iScreenScale)+"px",oClassement.style.position="absolute",oClassement.style.width=18*iScreenScale+"px",oClassement.onclick=function(){fSelectedClass=getRelSpeedFromCc(+oClassSelect.value),openRankings()},oScr.appendChild(oClassement)}}if(isCustomSel){var oStepCtn=document.createElement("div");oStepCtn.style.position="absolute",oStepCtn.style.left="0px",oStepCtn.style.width=80*iScreenScale+"px",oStepCtn.style.textAlign="center",oStepCtn.style.top=(baseY+22)*iScreenScale+"px";var oStepBack=document.createElement("input");oStepBack.type="button",oStepBack.style.fontSize=3*iScreenScale+"px";var progress=IdJ,lastProgress=nbSels;isOnline&&(progress-=2,lastProgress-=2),progress?(oStepBack.value="\u25C4",oStepBack.style.marginRight=3*iScreenScale+"px"):(oStepBack.style.width="0px",oStepBack.value="\xA0",oStepBack.style.visibility="hidden"),oStepBack.onclick=function(){clearTimeout(rotateHandler),oScr.innerHTML="",oContainers[0].removeChild(oScr),strPlayer.pop(),selectPlayerScreen(IdJ-1,!1,nbSels)},oStepCtn.appendChild(oStepBack);var oStepValue=document.createElement("span");oStepValue.style.fontSize=3*iScreenScale+"px",oStepValue.innerHTML=toLanguage("Character","Perso")+" "+(progress+1)+"/"+lastProgress,oStepCtn.appendChild(oStepValue),oStepBack.style.color=oStepValue.style.color="#F90",oScr.appendChild(oStepCtn)}if(nBasePersos>maxCharsPerPage){var lastPageButton=document.createElement("input");lastPageButton.type="button",lastPageButton.value="\u25C4",lastPageButton.style.position="absolute",lastPageButton.style.padding=0,lastPageButton.style.left=Math.round((minPersoX-4)*iScreenScale)+"px",lastPageButton.style.top=Math.round(midPersoY*iScreenScale-8)+"px",lastPageButton.style.width=Math.round(3*iScreenScale)+"px",lastPageButton.style.height=Math.round(5*jScreenScale)+8+"px",lastPageButton.style.fontSize=Math.round(2.5*iScreenScale-4)+"px",lastPageButton.style.textAlign="center",oScr.appendChild(lastPageButton),lastPageButton.onclick=function(){curPage=(curPage-1)%pages,0>curPage&&(curPage+=pages),showCharacters(curPage)};var nextPageButton=document.createElement("input");nextPageButton.type="button",nextPageButton.value="\u25BA",nextPageButton.style.position="absolute",nextPageButton.style.padding=0,nextPageButton.style.left=Math.round((maxPersoX+6)*iScreenScale)+8+"px",nextPageButton.style.top=Math.round(midPersoY*iScreenScale-8)+"px",nextPageButton.style.width=Math.round(3*iScreenScale)+"px",nextPageButton.style.height=Math.round(5*jScreenScale)+8+"px",nextPageButton.style.fontSize=Math.round(2.5*iScreenScale-4)+"px",nextPageButton.style.textAlign="center",oScr.appendChild(nextPageButton),nextPageButton.onclick=function(){curPage=(curPage+1)%pages,showCharacters(curPage)}}var oPInput=document.createElement("input");if(oPInput.type="button",oPInput.value=toLanguage("Back","Retour"),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=2*iScreenScale+"px",oPInput.style.top=35*iScreenScale+"px",isOnline&&(oPInput.style.top=34*iScreenScale+"px"),oPInput.onclick=goBack,isCustomSel&&(oPInput.style.color="#F90"),oScr.appendChild(oPInput),clSelected&&clSelected.autoset&&(clSelected.autoset.selectedOpponents&&(selectedOpponents=clSelected.autoset.selectedOpponents,oParticipantsDiv&&(oParticipantsDiv.style.display="none")),0===clSelected.autoset.selectedTeams&&oTeamsDiv&&(oTeamsDiv.style.display="none"),clSelected.autoset.selectedPerso)){if(force)return void goBack();var persoKey=clSelected.autoset.selectedPerso,customCharCb;if(isCustomPerso(persoKey,{forceReload:!0,callback:function(){customCharCb()}}))return customCharCb=function(){pUnlockMap[persoKey]=1;var e=createPersoSelector(persoKey);e.dataset.autoset=1,e.onclick()},void(oScr.style.visibility="hidden");var persoSelector=document.getElementById("perso-selector-"+persoKey);if(persoSelector&&persoSelector.onclick)return void persoSelector.onclick()}newP&&(myPersosCache=void 0),customCharsEnabled&&(myPersosCache?addMyPersos(myPersosCache):xhr("myPersos.php",null,function(res){var newPersos=[];try{newPersos=eval(res)}catch(t){}return newPersos.length?(addMyPersos(newPersos),myPersosCache=newPersos,!0):(oScr.style.visibility="visible",!0)})),selectPerso=function(e){clearTimeout(rotateHandler),oScr.innerHTML="",oContainers[0].removeChild(oScr),xhr("selectPerso.php","id="+e,function(){return selectPlayerScreen(IdJ,!0,nbSels),!0})},updateMenuMusic(isOnline?0:1)}function handleCcSelectChange(t,i,n){if(-1==t.value){var l=showGamePopup({container:i,elements:["<label>"+toLanguage("Class","Cylindr\xE9e&nbsp;")+": <input type=\"number\" style=\"font-size: "+Math.round(2.5*iScreenScale)+"px\" name=\"cc\" value=\""+parseInt(t.currentValue)+"\" style=\"width: 3em\" required min=\"1\" max=\"999\" /></label>","<label><input type=\"checkbox\" style=\"transform: scale("+Math.round(iScreenScale/4)+")\" name=\"mirror\" "+(t.currentValue.endsWith("m")?" checked=\"checked\"":"")+" />&nbsp;"+toLanguage("Mirror","Miroir")+"</label>"],submitVal:toLanguage("Validate","Valider"),submit:function(i){var e=+i.target.elements.cc.value,l=+i.target.elements.mirror.checked;n(t,e,l),t.currentValue=t.value},close:function(){t.value=t.currentValue}});l.querySelector("input[name=\"cc\"]").select()}else t.currentValue=t.value}function selectItemScreen(e,t,n){function l(e){var t=document.createElement("tr");t.className="item-distrib";var i=document.createElement("td");i.style.paddingRight=iScreenScale+"px",i.style.fontSize=2*iScreenScale+"px",i.innerHTML="#"+(e+1),t.appendChild(i);var l=b[e];l||(l=g[e]);for(var o=0;o<d.length;o++){var a=d[o],i=document.createElement("td");i.style.padding="0px";var s=document.createElement("input");s.type="number",s.value=l[a]||"",s.style.width=Math.round(3.5*iScreenScale)+"px",s.className="noarrow",s.style.backgroundColor="black",s.style.color="white",s.style.textAlign="center",s.style.border="solid 1px white",s.style.fontSize=Math.round(1.8*iScreenScale)+"px",s.style.maxHeight=Math.round(2.5*iScreenScale+1)+"px",s.setAttribute("min",0),s.setAttribute("max",99),s.setAttribute("step",1),s.setAttribute("form","iten-distribution-form"),s.disabled=n.readOnly,i.style.padding="0px",i.appendChild(s),t.appendChild(i)}var i=document.createElement("td");i.style.paddingRight=iScreenScale+"px";var p=document.createElement("input");return p.type="button",p.value="\xD7",p.style.fontSize=2*iScreenScale+"px",p.style.lineHeight=2*iScreenScale+"px",p.style.padding=Math.round(iScreenScale/4-1)+" "+Math.round(iScreenScale/2+2)+"px",p.onclick=function(){if(!(1>=C.length)){r.removeChild(t);for(var e=0;e<C.length;e++)C[e].querySelector("td").innerHTML="#"+(e+1);k.style.display=""}},n.readOnly&&(p.style.display="none"),i.appendChild(p),t.appendChild(i),t}function o(e){var t=[];if(e&&!C.length)return alert(toLanguage("You must have at least 1 row in your table","Votre table doit comporter au moins 1 ligne")),null;for(var n=0;n<C.length;n++){for(var l={},o=!1,a=C[n].querySelectorAll(".item-distrib input[type=\"number\"]"),s=0,r;s<d.length;s++)r=a[s],0<r.value&&(l[d[s]]=+r.value,o=!0);if(e&&!o)return alert(toLanguage("You must enter at least 1 item for rank #"+(n+1),"Vous devez sp\xE9cifier au moins 1 objet pour la position #"+(n+1))),null;t.push(l)}return t}function a(e){T.algorithm&&(e.algorithm=T.algorithm),T["prevent-blueshell-x2"]||(e.blueshellx2=1),T["prevent-lightning-x2"]||(e.lightningx2=1),T["blueshell-cooldown"]||(e.blueshelldelay=0),T["lightning-cooldown"]||(e.lightningdelay=0),T["lightning-start"]||(e.lightningstart=1),T["blueshell-start"]||(e.blueshellstart=1),T["prevent-doubleitem-x2"]||(e.doubleitemx2=1)}n=n||{};var s=document.createElement("div");s.style.position="absolute",s.style.width="100%",s.style.height="100%",s.style.left="0px",s.style.top="0px",s.style.zIndex=4,s.style.backgroundColor="#000";var r=document.createElement("table");r.style.color="white",r.style.textAlign="center",r.style.position="absolute",r.style.left=5*iScreenScale+"px",r.setAttribute("cellpadding",0),r.setAttribute("cellspacing",0);var p=getItemMode(),d={},c=itemDistributions[p].concat(customItemDistrib[p]);selectedItemDistrib.value&&-1==c.indexOf(selectedItemDistrib)&&c.push(selectedItemDistrib);for(var u=0,m;u<c.length;u++){m=c[u];for(var y=0;y<m.value.length;y++)for(var h in m.value[y])d[h]=1}d=Object.keys(d);var g=c[0].value,b=selectedItemDistrib;b.value&&(b=b.value),b.length||(b=g);var f=document.createElement("tr");f.appendChild(document.createElement("td"));for(var u=0;u<d.length;u++){var x=document.createElement("td"),v=document.createElement("img");v.src="images/items/"+d[u]+".png",v.alt=d[u],v.style.width=2*iScreenScale+"px",x.appendChild(v),f.appendChild(x)}f.appendChild(document.createElement("td")),r.appendChild(f);for(var C=r.getElementsByClassName("item-distrib"),u=0;u<b.length;u++)r.appendChild(l(u));var k=document.createElement("tr");C.length>=g.length&&(k.style.display="none");var x=document.createElement("td");x.setAttribute("colspan",d.length+1),k.appendChild(x),x=document.createElement("td"),x.style.paddingRight=iScreenScale+"px";var E=document.createElement("input");E.type="button",E.value="+",E.style.fontSize=2*iScreenScale+"px",E.style.lineHeight=2*iScreenScale+"px",E.style.padding=Math.round(iScreenScale/4-1)+" "+Math.round(iScreenScale/2+2)+"px",E.onclick=function(){r.insertBefore(l(C.length),k),C.length>=g.length&&(k.style.display="none")},n.readOnly&&(E.style.display="none"),x.appendChild(E),k.appendChild(x),r.appendChild(k),s.appendChild(r);var w=document.createElement("input");w.type="button",n.readOnly?w.value=toLanguage("Back","Retour"):(w.style.color="#f90",w.value=toLanguage("Cancel","Annuler")),w.style.position="absolute",w.style.left=2*iScreenScale+"px",w.style.top=36*iScreenScale+"px",w.style.fontSize=2*iScreenScale+"px",w.onclick=function(){e.removeChild(s)},s.appendChild(w);var S=document.createElement("form");S.style.position="absolute",S.id="iten-distribution-form",S.style.right=5*iScreenScale+"px",S.style.top=35*iScreenScale+4+"px",S.style.fontSize=Math.round(2.5*iScreenScale)+"px",S.onsubmit=function(){var l={value:o(!0)};if(!l.value)return!1;if(!n.untitled){var r;if(n.name)r=n.name;else{for(var c={},u=customItemDistrib[p],m=0;m<u.length;m++)c[u[m].name]=1;var y;for(y=1;c["Distribution "+y];y++);r="Distribution "+y}if(l.name=prompt(toLanguage("Set name","Nom du set"),r),!l.name)return!1}a(l),e.removeChild(s);try{t(l)}catch(t){console.error(t)}return!1};var T={algorithm:n.algorithm||"","prevent-blueshell-x2":1!=n.blueshellx2,"prevent-lightning-x2":1!=n.lightningx2,"blueshell-cooldown":0!=n.blueshelldelay,"lightning-cooldown":0!=n.lightningdelay,"lightning-start":1!=n.lightningstart,"blueshell-start":1!=n.blueshellstart,"prevent-doubleitem-x2":1!=n.doubleitemx2};if(!n.readOnly||function(){var e={};for(var t in a(e),e)return!0;return!1}()){var I=document.createElement("a");I.innerHTML=n.readOnly?toLanguage("Advanced options...","Options avanc\xE9es..."):toLanguage("More options...","Plus d'options..."),I.href="#null",I.style.color="white",I.style.position="relative",I.style.marginRight=6*iScreenScale+"px",I.style.top=-Math.round(iScreenScale/4)+"px",I.style.fontSize=Math.round(2*iScreenScale)+"px",I.onclick=function(t){t.preventDefault();var i=document.createElement("div");i.className="fsmask item-options-screen",i.style.fontSize=2*iScreenScale+"px",i.innerHTML="<form><div class=\"item-options\"><div class=\"item-optgroup\"><div class=\"item-option\"><label for=\"item-options-algorithm\">"+toLanguage("Distribution based on","Distribution bas\xE9e sur")+"</label><div><select id=\"item-options-algorithm\" name=\"algorithm\"><option value=\"rank\">"+toLanguage("Player rank","Position du joueur")+"</option><option value=\"dist\">"+toLanguage("Distance to 1st","Distance au 1er")+"</option><option value=\"\">"+toLanguage("Rank+distance","Position+distance")+"</option></select></div></div></div><div class=\"item-optgroup\"><h2>"+toLanguage("Concurrent items","Objets simultan\xE9s")+"</h2><div class=\"item-option\"><div><input type=\"checkbox\" id=\"item-options-blueshell\" name=\"prevent-blueshell-x2\" /></div><label for=\"item-options-blueshell\">"+toLanguage("Prevent 2 players from having a blue shell","Emp\xEAcher 2 joueurs d'avoir une carapace bleue")+"</label></div><div class=\"item-option\"><div><input type=\"checkbox\" id=\"item-options-lightning\" name=\"prevent-lightning-x2\" /></div><label for=\"item-options-lightning\">"+toLanguage("Prevent 2 players from having a lightning item","Emp\xEAcher 2 joueurs d'avoir un \xE9clair")+"</label></div></div><div class=\"item-optgroup\"><h2>"+toLanguage("Cooldown","Cooldown")+"</h2><div class=\"item-option\"><div><input type=\"checkbox\" id=\"item-options-blueshell2\" name=\"blueshell-cooldown\" /></div><label for=\"item-options-blueshell2\">"+toLanguage("Min time frame of 30s between 2 blue shells","Emp\xEAcher 2 carapaces bleues \xE0 moins de 30s d'intervalle")+"</label></div><div class=\"item-option\"><div><input type=\"checkbox\" id=\"item-options-lightning2\" name=\"lightning-cooldown\" /></div><label for=\"item-options-lightning2\">"+toLanguage("Min time frame of 30s between 2 lightnings","Emp\xEAcher 2 \xE9clairs \xE0 moins de 30s d'intervalle")+"</label></div><div class=\"item-option\"><div><input type=\"checkbox\" id=\"item-options-lightning0\" name=\"lightning-start\" /></div><label for=\"item-options-lightning0\">"+toLanguage("No lightning item before 25s of race","Pas d'\xE9clair avant 25s de course")+"</label></div><div class=\"item-option\"><div><input type=\"checkbox\" id=\"item-options-blueshell0\" name=\"blueshell-start\" /></div><label for=\"item-options-blueshell0\">"+toLanguage("No blue shell before 25s of race","Pas de carapace bleue avant 25s de course")+"</label></div></div><div class=\"item-optgroup\"><h2>"+toLanguage("Double items","Double objets")+"</h2><div class=\"item-option\"><div><input type=\"checkbox\" id=\"item-options-doubleitem\" name=\"prevent-doubleitem-x2\" /></div><label for=\"item-options-doubleitem\">"+toLanguage("Prevent a player from having twice the same item","Emp\xEAcher un joueur d'avoir le m\xEAme objet en double")+"</label></div></div></div><div class=\"item-submit\"><a href=\"#null\">"+toLanguage("Back","Retour")+"</a><input type=\"submit\" value=\""+toLanguage("Validate","Valider")+"\" /></siv></form>",i.querySelector(".item-submit a").onclick=function(){return s.removeChild(i),!1};var l=i.querySelector("form");for(var o in l.onsubmit=function(t){for(var e in t.preventDefault(),T){var n=l.elements[e];T[e]="checkbox"===n.type?n.checked:n.value}s.removeChild(i)},T){var a=l.elements[o];n.readOnly&&(a.disabled=!0),"checkbox"===a.type?a.checked=!!T[o]:a.value=T[o]}n.readOnly&&(i.querySelector(".item-submit input[type=\"submit\"]").style.display="none"),s.appendChild(i)},S.appendChild(I)}if(!n.readOnly){var z=document.createElement("input");z.type="submit",z.style.fontSize=2*iScreenScale+"px",z.value=toLanguage("Validate!","Valider !"),z.style.marginLeft=iScreenScale+"px",S.appendChild(z);var B=document.createElement("a");if(B.href="#null",B.style.color="#CCF",B.innerHTML=toLanguage("Export/Import...","Exporter/importer"),B.style.fontSize=Math.round(1.6*iScreenScale)+"px",B.style.marginLeft=Math.round(2.5*iScreenScale)+"px",B.style.position="relative",B.style.top=-Math.round(iScreenScale/2)+"px",B.onclick=function(t){t.preventDefault();var n=document.createElement("div");n.className="fsmask item-export-screen",n.style.fontSize=2*iScreenScale+"px",n.innerHTML="<div><div class=\"tab-buttons\"><div class=\"tab-button tab-button-selected\">"+toLanguage("Export","Exporter")+"</div><div class=\"tab-button\">"+toLanguage("Import","Importer")+"</div></div><div class=\"tabs\"><form class=\"tab tab-export tab-selected\"><div class=\"tab-export-desc\">"+toLanguage("<strong>Export:</strong> Copy this text to share this distribution with other players.","<strong>Exporter :</strong> Copiez ce texte pour partager cette distribution avec d'autres joueurs.")+"</div><div class=\"tab-export-input\"><textarea disabled>"+JSON.stringify(o())+"</textarea></div><div class=\"tab-export-submit\"><a href=\"#null\">"+toLanguage("Back","Retour")+"</a><input type=\"submit\" value=\""+toLanguage("Copy","Copier")+"\" /></div></form><form class=\"tab tab-import\"><div class=\"tab-export-desc\">"+toLanguage("<strong>Import:</strong> Paste a new text to import distribution shared by another player.","<strong>Importer :</strong> Collez un texte pour importer la distribution d'un autre joueur.")+"</div><div class=\"tab-export-input\"><textarea></textarea></div><div class=\"tab-export-submit\"><a href=\"#null\">"+toLanguage("Back","Retour")+"</a><input type=\"submit\" value=\""+toLanguage("Validate","Valider")+"\" /></div></form></div></div>";for(var a=n.querySelectorAll(".tab-buttons .tab-button"),p=n.querySelectorAll(".tabs .tab"),c=0;c<a.length;c++)(function(e){a[e].onclick=function(){n.querySelector(".tab-buttons .tab-button-selected").classList.remove("tab-button-selected"),a[e].classList.add("tab-button-selected"),n.querySelector(".tabs .tab-selected").classList.remove("tab-selected"),p[e].classList.add("tab-selected")}})(c);n.querySelector(".tab-export .tab-export-submit a").onclick=function(t){t.preventDefault(),s.removeChild(n)},n.querySelector(".tab-import .tab-export-submit a").onclick=function(t){t.preventDefault(),s.removeChild(n)},n.querySelector(".tab.tab-export").onsubmit=function(t){t.preventDefault();var e=t.currentTarget,i=e.querySelector("textarea");i.disabled=!1,i.select(),document.execCommand("copy"),i.disabled=!0;var n=e.querySelector("input[type=\"submit\"]"),l=n.value;n.disabled=!0,n.value=toLanguage("Copied","Copi\xE9 \u2714"),setTimeout(function(){n.value=l,n.disabled=!1},500)},n.querySelector(".tab.tab-import").onsubmit=function(t){t.preventDefault();var e=t.currentTarget,o=e.querySelector("textarea");importedDistrib=JSON.parse(o.value),s.removeChild(n);for(var a=0;a<importedDistrib.length;a++){a>=C.length&&r.insertBefore(l(C.length),k);for(var p=importedDistrib[a],c=C[a].querySelectorAll(".item-distrib input[type=\"number\"]"),u=0,m;u<d.length;u++)m=d[u],c[u].value=p[m]||""}for(;C.length>importedDistrib.length;)r.removeChild(C[C.length-1]);k.style.display=C.length>=g.length?"none":""},s.appendChild(n)},S.appendChild(B),-1===d.indexOf("carapacenoire")){s.tabIndex=0,s.style.outline="none";var M="";s.onkeydown=function(i){var l=i.key;if(1===l.length){if(l=l.toLowerCase(),M+=l,!"darkshell".startsWith(M))return M="",void("darkshell".startsWith(l)&&(M=l));if("darkshell"===M&&confirm("Enable dark shell item?"))return g[g.length-1].carapacenoire=0,e.removeChild(s),void selectItemScreen(e,t,n)}},setTimeout(function(){s.focus()},1)}}s.appendChild(S),e.appendChild(s)}function selectPtScreen(e,t,n){function l(e){var t=document.createElement("label");t.style.display="table-row";var i=document.createElement("div");i.innerHTML=toLanguage("Rank #"+(e+1),"Position #"+(e+1)),i.style.display="table-cell",i.style.verticalAlign="middle",i.style.textAlign="right",t.appendChild(i);var l=document.createElement("div");l.style.display="table-cell",l.style.verticalAlign="middle";var o=document.createElement("input");o.style.fontSize=Math.round(1.5*iScreenScale)+"px",o.name="pt[]",o.type="number",o.style.width=8*iScreenScale+"px",o.setAttribute("max",9999),o.setAttribute("min",0),o.value=null==n.value[e]?0:n.value[e],o.setAttribute("required","required"),l.appendChild(o),t.appendChild(l),c.appendChild(t)}n=n||{};var o=document.createElement("div");o.style.position="absolute",o.style.width="100%",o.style.height="100%",o.style.left="0px",o.style.top="0px",o.style.zIndex=4,o.style.backgroundColor="#000";var a=document.createElement("form");a.onsubmit=function(){var l=this.elements["pt[]"];l.length||(l=[l]);for(var a=[],s=0;s<l.length;s++)a.push(+l[s].value);var r={value:a};if(!n.untitled){var p;if(n.name)p=n.name;else{for(var c={},s=0;s<customPtDistrib.length;s++)c[customPtDistrib[s].name]=1;var u;for(u=1;c["Distribution "+u];u++);p="Distribution "+u}if(r.name=prompt(toLanguage("Set name","Nom du set"),p),!r.name)return!1}return e.removeChild(o),t(r),!1},a.style.textAlign="center";var s=document.createElement("label");s.style.display="block",s.style.marginTop=Math.round(.5*iScreenScale)+"px",s.style.marginBottom=iScreenScale+"px";var r=document.createElement("span");r.innerHTML=toLanguage("Number of participants:","Nombre de participants :"),r.style.marginRight=iScreenScale+"px",r.style.fontSize=Math.round(2.25*iScreenScale)+"px",s.appendChild(r);var p=document.createElement("input");p.type="number",p.setAttribute("max",999),p.setAttribute("min",2),p.style.fontSize=2*iScreenScale+"px",p.style.width=5*iScreenScale+8+"px",p.value=n.value.length,p.onchange=function(){for(var e=+this.value,t=c.childNodes;e>t.length;)l(t.length);for(;e<t.length;)c.removeChild(t[t.length-1])},s.appendChild(p),a.appendChild(s);var d=document.createElement("div");d.style.maxHeight=30*iScreenScale+"px",d.style.overflowX="hidden",d.style.overflowY="auto",d.style.fontSize=Math.round(2*iScreenScale)+"px";var c=document.createElement("div");c.style.display="table",c.style.marginTop=Math.round(.5*iScreenScale)+"px",c.style.marginBottom=Math.round(.5*iScreenScale)+"px",c.style.marginLeft=c.style.marginRight="auto",c.style.borderSpacing=iScreenScale+"px";for(var u=0;u<n.value.length;u++)l(u);d.appendChild(c),a.appendChild(d);var m=document.createElement("input");m.type="submit",m.style.fontSize=Math.round(2.5*iScreenScale)+"px",m.style.marginTop=iScreenScale+"px",m.value=toLanguage("Validate","Valider"),a.appendChild(m),o.appendChild(a);var y=document.createElement("input");y.type="button",y.value=toLanguage("Back","Retour"),y.style.fontSize=2*iScreenScale+"px",y.style.position="absolute",y.style.left=2*iScreenScale+"px",y.style.top=35*iScreenScale+"px",y.onclick=function(){e.removeChild(o)},o.appendChild(y),e.appendChild(o),d.querySelector("[name=\"pt[]\"]").select()}function selectCpuNamesScreen(e,t,n){n=n||{};var l=document.createElement("div");l.style.position="absolute",l.style.width="100%",l.style.height="100%",l.style.left="0px",l.style.top="0px",l.style.zIndex=2,l.style.backgroundColor="#000";var o=document.createElement("form");o.style.height=35*iScreenScale+"px",o.style.overflowX="hidden",o.style.overflowY="auto",o.style.fontSize=Math.round(2.5*iScreenScale)+"px",o.style.textAlign="center",o.onsubmit=function(){e.removeChild(l);var n=this.elements["cpu[]"];n.length||(n=[n]);for(var o=[],a=0;a<n.length;a++)o.push(n[a].value);return t(o),!1};var a=document.createElement("div");a.style.display="table",a.style.marginTop=Math.round(.5*iScreenScale)+"px",a.style.marginBottom=Math.round(.5*iScreenScale)+"px",a.style.marginLeft=a.style.marginRight="auto",a.style.borderSpacing=iScreenScale+"px";for(var s=0,r;s<n.count;s++){r=document.createElement("label"),r.style.display="table-row";var p=document.createElement("div");p.innerHTML=toLanguage("CPU "+(s+1)+" name","Nom ordi "+(s+1)),p.style.display="table-cell",p.style.verticalAlign="middle",p.style.textAlign="right",r.appendChild(p);var d=document.createElement("div");d.style.display="table-cell",d.style.verticalAlign="middle";var c=document.createElement("input");c.style.fontSize=2*iScreenScale+"px",c.name="cpu[]",c.type="text",c.setAttribute("size",10),c.setAttribute("maxlength",30),c.value=null==n.names[s]?"CPU "+(s+1):n.names[s],c.setAttribute("required","required"),d.appendChild(c),r.appendChild(d),a.appendChild(r)}o.appendChild(a);var u=document.createElement("input");u.type="submit",u.style.fontSize=3*iScreenScale+"px",u.value=toLanguage("Validate","Valider"),o.appendChild(u),l.appendChild(o);var m=document.createElement("input");m.type="button",m.value=toLanguage("Back","Retour"),m.style.fontSize=2*iScreenScale+"px",m.style.position="absolute",m.style.left=2*iScreenScale+"px",m.style.top=35*iScreenScale+"px",m.onclick=function(){e.removeChild(l)},l.appendChild(m),e.appendChild(l),o.querySelector("[name=\"cpu[]\"]").select()}function isCustomOptions(e){if(e)for(var t in defaultGameOptions)if(void 0!==e[t]&&e[t]!=defaultGameOptions[t])return!0;return!1}function hasChallenges(){for(var e in challenges)for(var t in challenges[e])return!0}function isTeamPlay(){return"BB"===course||"VS"===course?selectedTeams:0}function setupTeamColors(){selectedTeamOpts||(selectedTeamOpts=[]);for(var e=0;e<selectedNbTeams;e++)selectedTeamOpts[e]||(selectedTeamOpts[e]={color:e});for(var t in cTeamColors={},oTeamColors){cTeamColors[t]=[];for(var e=0;e<selectedTeamOpts.length;e++)cTeamColors[t][e]=oTeamColors[t][selectedTeamOpts[e].color]}for(var e=0;e<selectedTeamOpts.length;e++)selectedTeamOpts[e].name&&(cTeamColors.name[e]=escapeSpecialChars(selectedTeamOpts[e].name))}function getRelSpeedFromCc(e){for(var t=0;t<ccInterpolations.length;t++)if(e<ccInterpolations[t][0])return ccInterpolations[t-1][1]+(ccInterpolations[t][1]-ccInterpolations[t-1][1])*(e-ccInterpolations[t-1][0])/(ccInterpolations[t][0]-ccInterpolations[t-1][0]);return ccInterpolations[ccInterpolations.length-1][1]}function getCcConstraint(e){for(var t=e.data.constraints,n=0,l;n<t.length;n++)if(l=t[n],"cc"===l.type)return l.value+(l.mirror?"m":"")}function getActualCc(){for(var e=0;e<ccInterpolations.length;e++)if(fSelectedClass<ccInterpolations[e][1])return Math.round(ccInterpolations[e-1][0]+(ccInterpolations[e][0]-ccInterpolations[e-1][0])*(fSelectedClass-ccInterpolations[e-1][1])/(ccInterpolations[e][1]-ccInterpolations[e-1][1]));return ccInterpolations[ccInterpolations.length-1][0]}function cappedRelSpeed(e){var t=e&&void 0!==e.size?e.size:1;return Math.min(Math.max(fSelectedClass*t,.37),2.7)}function getMirrorFactor(){return bSelectedMirror?-1:1}function selectTeamScreen(e){e||(aTeams.length=0);var t=document.createElement("div"),n=t.style;n.width=80*iScreenScale+"px",n.height=39*iScreenScale+"px",n.border="solid 1px black",n.backgroundColor="black";var l=toLanguage("Select team","S\xE9lectionner \xE9quipe");1<strPlayer.length&&(l+=" ("+toLanguage("P","J")+(e+1)+")");var o=toTitle(l,.5);1<strPlayer.length&&(o.style.fontSize=Math.round(7*iScreenScale)+"px"),t.appendChild(o);var a=document.createElement("input");a.type="button",a.value=toLanguage("Back","Retour"),a.style.fontSize=2*iScreenScale+"px",a.style.position="absolute",a.style.left=2*iScreenScale+"px",a.style.top=35*iScreenScale+"px",a.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),selectPlayerScreen(-1)},t.appendChild(a);var s=oTeamColors.name.map(function(e){return toLanguage(e+" team","\xC9quipe "+e.toLowerCase())}),r=Math.max(2,Math.round(fInfos.nbteams/2)),p=Math.ceil(fInfos.nbteams/r);for(h=0;h<fInfos.nbteams;h++){var a=document.createElement("input");a.type="button",a.value=s[h],a.style.color=oTeamColors.light[h],a.i=h,a.style.fontSize=(2>=r?4:3)*iScreenScale+"px",a.style.position="absolute";var d=h%p,c=Math.floor(h/p),u=Math.min(h+p-h%p,fInfos.nbteams)-(h-h%p);a.style.left=(25+32*(d-(u-1)/2))*iScreenScale+"px",a.style.top=(2>=r?12+8*c:11+6*c)*iScreenScale+"px",a.style.width=30*iScreenScale+"px",a.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t);var n=+this.i;if(aTeams.push(n),selectedNbTeams=fInfos.nbteams,selectedFriendlyFire=fInfos.friendlyFire,localStorage.setItem("nbTeams",selectedNbTeams),selectedFriendlyFire?localStorage.setItem("friendlyFire",selectedFriendlyFire):localStorage.removeItem("friendlyFire"),aTeams.length>=strPlayer.length){for(var l=Array(selectedNbTeams).fill(0),n=0;n<strPlayer.length;n++)l[aTeams[n]]++;for(;;){var o=Math.min(...l),a=Math.max(...l);if(o===a)break;var s=l.indexOf(o);aTeams.push(s),l[s]++}var r=aTeams.length;aTeams.length=strPlayer.length+aPlayers.length;for(var p=r;p<aTeams.length;p++)aTeams[p]=(p+n+aPlayers.length)%selectedNbTeams;selectTrackScreen()}else selectTeamScreen(e+1)},t.appendChild(a)}var m=document.createElement("label");m.style.position="absolute",m.style.left=5*iScreenScale+"px",m.style.top=29*iScreenScale+"px",m.style.width=70*iScreenScale+"px",m.style.textAlign="center",m.style.fontSize=Math.round(2.2*iScreenScale)+"px",m.innerHTML=toLanguage("Number of teams: ","Nombre d'\xE9quipes : ");var y=document.createElement("select");y.style.width=5*iScreenScale+"px",y.style.fontSize=Math.round(2.2*iScreenScale)+"px";for(var h=2,g;h<=s.length;h++)g=document.createElement("option"),g.value=h,g.innerHTML=h,y.appendChild(g);y.value=fInfos.nbteams,y.onchange=function(){fInfos.nbteams=+this.value,t.innerHTML="",oContainers[0].removeChild(t),selectTeamScreen(0)},m.appendChild(y),t.appendChild(m);var m=document.createElement("label");m.style.position="absolute",m.style.left=5*iScreenScale+"px",m.style.top=Math.round(32.5*iScreenScale)+"px",m.style.width=70*iScreenScale+"px",m.style.textAlign="center",m.style.fontSize=Math.round(2.2*iScreenScale)+"px";var b=document.createElement("input");b.type="checkbox",b.checked=fInfos.friendlyFire,b.onchange=function(){fInfos.friendlyFire=this.checked},b.style.width=Math.round(2.2*iScreenScale)+"px",b.style.height=Math.round(2.2*iScreenScale)+"px",b.style.position="relative",b.style.top=Math.round(.35*iScreenScale)+"px",b.style.marginRight=iScreenScale+"px",m.appendChild(b);var f=document.createElement("span");f.innerHTML=toLanguage("Friendly fire ","Friendly fire "),m.appendChild(f);var x=document.createElement("a");x.href="#null",x.style.textDecoration="none",x.style.color="white",x.innerHTML="[?]",x.onclick=function(){return alert(toLanguage("If enabled, your items can hit your teammates","Si activ\xE9, vos objets peuvent toucher les joueurs de votre \xE9quipe")),!1},m.appendChild(x),t.appendChild(m),oContainers[0].appendChild(t),updateMenuMusic(1)}function selectTrackScreen(){selectMapScreen()}function selectGamersScreen(){!isOnline&&isTeamPlay()?selectTeamScreen(0):selectPlayerScreen(-1)}function acceptRulesScreen(){var e=document.createElement("div"),t=e.style;t.width=80*iScreenScale+"px",t.height=39*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black";var i;i=shareLink.options["public"]?toTitle(toLanguage("Game rules","R\xE8gles parties"),0):toTitle(toLanguage("Private game rules","R\xE8gles partie priv\xE9e"),0),i.style.fontSize=7*iScreenScale+"px",e.appendChild(i);var n=document.createElement("div");n.style.position="absolute",n.style.left="0px",n.style.top=9*iScreenScale+"px",n.style.width=80*iScreenScale+"px";var l=document.createElement("div");l.style.maxHeight=24*iScreenScale+"px",l.style.overflow="auto";var o=document.createElement("div");o.style.textAlign="center",o.style.color="#F90",o.style.fontSize=2*iScreenScale+"px",o.style.lineHeight=3*iScreenScale+"px",o.innerHTML=shareLink.options["public"]?"\u26A0 "+toLanguage("Games from this mode have special rules","Les parties de ce mode utilisent des r\xE8gles sp\xE9cifiques"):"\u26A0 "+toLanguage("Games from this private link have special rules","Les parties de ce lien priv\xE9 utilisent des r\xE8gles sp\xE9cifiques"),l.appendChild(o);var a=document.createElement("table");if(a.style.marginLeft="auto",a.style.marginRight="auto",shareLink.options.team){var s=document.createElement("tr"),r=document.createElement("td"),p=document.createElement("label");p.setAttribute("for","option-teams");var d=document.createElement("h1");d.style.fontSize=3*iScreenScale+"px",d.style.marginTop="0px",d.style.marginBottom="0px",d.innerHTML=toLanguage("Team games","Parties par \xE9quipe"),p.appendChild(d);var o=document.createElement("div");o.style.fontSize=2*iScreenScale+"px",o.style.color="white";var c=shareLink.options.nbTeams||defaultGameOptions.nbTeams;o.innerHTML=toLanguage(c+" teams are selected in each game. You object: defeat the opposing team"+(2<c?"s":"")+".",c+" \xE9quipes sont s\xE9lectionn\xE9es \xE0 chaque partie. Votre objectif : vaincre "+(2<c?"les \xE9quipes adverses":"l'\xE9quipe adverse")+"."),p.appendChild(o),r.appendChild(p),s.appendChild(r),a.appendChild(s)}if(shareLink.options.manualTeams){var s=document.createElement("tr"),r=document.createElement("td"),p=document.createElement("label");r.appendChild(p);var d=document.createElement("h1");d.style.fontSize=3*iScreenScale+"px",d.innerHTML=toLanguage("Manual selection","S\xE9lection manuelle"),d.style.marginBottom="0px",p.appendChild(d);var o=document.createElement("div");o.style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("Teams are selected manually by one of the players.","Les \xE9quipes sont s\xE9lectionn\xE9es manuellement par l'un des joueurs."),p.appendChild(o),r.appendChild(p),s.appendChild(r),a.appendChild(s)}if(shareLink.options.friendlyFire){var s=document.createElement("tr"),r=document.createElement("td"),p=document.createElement("label");r.appendChild(p);var d=document.createElement("h1");d.style.fontSize=3*iScreenScale+"px",d.innerHTML=toLanguage("Friendly fire","Friendly fire"),d.style.marginBottom="0px",p.appendChild(d);var o=document.createElement("div");o.style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("Your items can hit your teammates","Vos objets peuvent toucher les joueurs de votre \xE9quipe"),p.appendChild(o),r.appendChild(p),s.appendChild(r),a.appendChild(s)}if(shareLink.options.cc||shareLink.options.mirror){var s=document.createElement("tr"),r=document.createElement("td"),p=document.createElement("label");r.appendChild(p);var d=document.createElement("h1");d.style.fontSize=3*iScreenScale+"px",d.innerHTML=toLanguage("Class","Cylindr\xE9e"),d.style.marginBottom="0px",p.appendChild(d);var o=document.createElement("div");o.style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=(shareLink.options.cc||150)+"cc"+(shareLink.options.mirror?toLanguage(" mirror"," miroir"):""),p.appendChild(o),r.appendChild(p),s.appendChild(r),a.appendChild(s)}if(shareLink.options.itemDistrib){var s=document.createElement("tr"),r=document.createElement("td"),p=document.createElement("label");r.appendChild(p);var d=document.createElement("h1");d.style.fontSize=3*iScreenScale+"px",d.innerHTML=toLanguage("Item distribution","Distribution des objets"),d.style.marginBottom="0px",p.appendChild(d);var o=document.createElement("div");if(o.style.fontSize=2*iScreenScale+"px",o.style.color="white",isNaN(shareLink.options.itemDistrib)){var u=shareLink.options.itemDistrib;u.value||(u={value:u}),o.innerHTML=toLanguage("Custom distribution <a href=\"#null\">[Show]</a>","Distribution personnalis\xE9e <a href=\"#null\">[Voir]</a>");var m=o.querySelector("a");m.style.color="#CCF",m.onclick=function(){return selectedItemDistrib=u,selectItemScreen(e,function(){},Object.assign({},u,{readOnly:!0})),!1}}else{var y=getItemMode(),u=itemDistributions[y][shareLink.options.itemDistrib];o.innerHTML=u.value.length?u.name:toLanguage("No item","Aucun objet")}p.appendChild(o),r.appendChild(p),s.appendChild(r),a.appendChild(s)}if(shareLink.options.cpuCount){var s=document.createElement("tr"),r=document.createElement("td"),p=document.createElement("label");r.appendChild(p);var d=document.createElement("h1");d.style.fontSize=3*iScreenScale+"px",d.innerHTML=toLanguage("Possible addition of bots","Ajout possible de bots"),d.style.marginBottom="0px",p.appendChild(d);var o=document.createElement("div");o.style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("If there are not enough players, some bots will be added to the game so that there are at least <strong>"+shareLink.options.cpuCount+"</strong> participants.","S'il n'y a pas assez de joueurs, des bots seront ajout\xE9s \xE0 la partie pour qu'il y ait au minimum <strong>"+shareLink.options.cpuCount+"</strong> participants"),p.appendChild(o),r.appendChild(p),s.appendChild(r),a.appendChild(s)}if(shareLink.options.timeTrial){var s=document.createElement("tr"),r=document.createElement("td"),p=document.createElement("label");r.appendChild(p);var d=document.createElement("h1");d.style.fontSize=3*iScreenScale+"px",d.innerHTML=toLanguage("Time trial mode","Mode Contre-le-montre"),d.style.marginBottom="0px",p.appendChild(d);var o=document.createElement("div");o.style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("Games are played like in time trial: no item boxes, no collisions with other players (they are ghosts), and you start with 3 shrooms.","Les parties se d\xE9roulent comme en CLM : pas de bo\xEEtes \xE0 objets, pas de collisions avec les autres joueurs (ce sont des fant\xF4mes), et vous commencez avec 3 champis."),p.appendChild(o),r.appendChild(p),s.appendChild(r),a.appendChild(s)}if(shareLink.options.noBumps){var s=document.createElement("tr"),r=document.createElement("td"),p=document.createElement("label");r.appendChild(p);var d=document.createElement("h1");d.style.fontSize=3*iScreenScale+"px",d.innerHTML=toLanguage("No collisions between karts","Pas de collisions entre les karts"),d.style.marginBottom="0px",p.appendChild(d);var o=document.createElement("div");o.style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("Karts are not impacted when they hit each other","Les karts ne sont pas impact\xE9s lorsqu'ils se rentrent dedans"),p.appendChild(o),r.appendChild(p),s.appendChild(r),a.appendChild(s)}if(shareLink.options.noJump){var s=document.createElement("tr"),r=document.createElement("td"),p=document.createElement("label");r.appendChild(p);var d=document.createElement("h1");d.style.fontSize=3*iScreenScale+"px",d.innerHTML=toLanguage("No kart jumps","Sauts d\xE9sactiv\xE9s"),d.style.marginBottom="0px",p.appendChild(d);var o=document.createElement("div");o.style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("It's impossible to perform a jump, drift or trick","Il est impossible de faire des sauts, d\xE9rapages ou figures"),p.appendChild(o),r.appendChild(p),s.appendChild(r),a.appendChild(s)}if(shareLink.options.noRd){var s=document.createElement("tr"),r=document.createElement("td"),p=document.createElement("label");r.appendChild(p);var d=document.createElement("h1");d.style.fontSize=3*iScreenScale+"px",d.innerHTML=toLanguage("No Reverse Drift","Pas de Reverse Drift"),d.style.marginBottom="0px",p.appendChild(d);var o=document.createElement("div");o.style.fontSize=2*iScreenScale+"px",o.style.color="white",o.innerHTML=toLanguage("The famous MKPC drifting technique is blocked","La fameuse technique de d\xE9rapage de MKPC est bloqu\xE9e"),p.appendChild(o),r.appendChild(p),s.appendChild(r),a.appendChild(s)}l.appendChild(a),n.appendChild(l);var o=document.createElement("div");o.style.textAlign="center",o.style.marginTop=2*iScreenScale+"px";var h=document.createElement("input");h.type="button",h.value=toLanguage("Accept and play","Accepter et jouer"),h.style.fontSize=3*iScreenScale+"px",h.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),shareLink.accepted=!0,searchCourse()},o.appendChild(h),n.appendChild(o),e.appendChild(n);var g=document.createElement("input");g.type="button",g.value=toLanguage("Back","Retour"),g.style.fontSize=2*iScreenScale+"px",g.style.position="absolute",g.style.left=2*iScreenScale+"px",g.style.top=35*iScreenScale+"px",g.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),selectPlayerScreen(0)},e.appendChild(g),oContainers[0].appendChild(e)}function selectChallengesScreen(){var e=document.createElement("div"),t=e.style;t.width=80*iScreenScale+"px",t.height=39*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black";var n=toTitle(toLanguage("Challenges","D\xE9fis"),0);n.style.fontSize=7*iScreenScale+"px",e.appendChild(n);var l=document.createElement("div");l.style.position="absolute",l.style.left="0px",l.style.top=9*iScreenScale+"px",l.style.width=80*iScreenScale+"px";var o=document.createElement("div");o.style.maxHeight=24*iScreenScale+"px",o.style.overflowX="hidden",o.style.overflowY="auto";var a=hasChallenges(),s;if(a){if(document.getElementById("comment-connect")){var r=document.createElement("div");r.style.width=75*iScreenScale+"px",r.style.marginLeft="auto",r.style.marginRight="auto",r.style.marginBottom=Math.round(1.5*iScreenScale)+"px",r.style.textAlign="center",r.innerHTML=language?"You are not connected. The challenges you complete will not be saved. <a href=\"forum.php\" target=\"_blank\" style=\"color:white\">Click here</a> to log in or register.":"Vous n'\xEAtes pas connect\xE9. Les d\xE9fis r\xE9ussis ne seront pas sauvegard\xE9s. <a href=\"forum.php\" target=\"_blank\" style=\"color:white\">Cliquez ici</a> pour vous connecter ou vous inscrire.",r.style.fontSize=Math.round(1.8*iScreenScale)+"px",o.appendChild(r)}var p=document.createElement("table");p.style.width=77*iScreenScale+"px",p.style.marginLeft="auto",p.style.marginRight="auto",p.style.borderCollapse="collapse";var d=[],c=[];for(var u in challenges)for(var m in challenges[u])for(var y=challenges[u][m],h=y.list,g=0;g<h.length;g++){var b=h[g],f={creation:y,challenge:b,type:u,cid:m};null==b.order?c.push(f):d.push(f)}d.sort(function(e,t){return e.challenge.order-t.challenge.order}),d=d.concat(c);for(var g=0,x;g<d.length;g++){function t(t,i,n){e.innerHTML="",oContainers[0].removeChild(e),clSelected=t,clSelected.trackId=i,clSelected.trackType=n,localStorage.removeItem("itemset."+getItemMode()),xhr("challengeTry.php","challenge="+t.id,function(e){if(!e)return!1;try{e=JSON.parse(e)}catch(t){return!1}for(var t in clSelected.autoset=e,course="",e)window[t]=e[t];return course?selectPlayerScreen(0):selectMainPage(),delete window.selectedPerso,showClSelectedPopup(),!0})}var f=d[g],y=f.creation,u=f.type,m=f.cid,b=f.challenge;if(y.main&&!x)s=y.id;else if(y!==x){x=y;var v=document.createElement("tr");v.style.border="solid 1px white";var C=document.createElement("td");C.setAttribute("colspan",2);var k=document.createElement("h1"),E="";"mcup"===u?E=toLanguage("Multicup","Multicoupe"):"cup"===u?E=toLanguage("Cup","Coupe"):"track"===u?E=isBattle?toLanguage("Arena","Ar\xE8ne"):toLanguage("Track","Circuit"):void 0,k.innerHTML=E+" <span style=\"color:#FDB\">"+escapeSpecialChars(y.name)+"</span>",k.style.textAlign="center",k.style.margin="0px",k.style.fontSize=Math.round(4*iScreenScale)+"px",k.style.paddingTop=Math.round(.5*iScreenScale)+"px",k.style.paddingBottom=Math.round(.5*iScreenScale)+"px",k.style.backgroundColor="#fa7c1b",k.style.color="white",C.appendChild(k),v.appendChild(C),p.appendChild(v)}var w="active"==b.status&&b.succeeded,S=w?"#9E9":"white",v=document.createElement("tr");v.style.border="solid 1px "+S,w&&(v.style.backgroundColor="#031");var C=document.createElement("td");if(C.style.padding=iScreenScale+" "+iScreenScale+"px",b.name){var k=document.createElement("h1");k.style.fontSize=3*iScreenScale+"px",k.style.marginTop="0px",k.style.marginBottom="0px",k.innerText=b.name,C.appendChild(k)}var T=document.createElement("div");if(T.style.fontSize=b.name||b.description.extra?2*iScreenScale+"px":Math.round(2.5*iScreenScale)+"px",T.style.color=S,T.style.fontWeight="bold",T.innerHTML=b.description.main,C.appendChild(T),b.description.extra){var T=document.createElement("div");T.style.fontSize=Math.round(1.6*iScreenScale)+"px",T.style.color=S,T.innerHTML=b.description.extra,C.appendChild(T)}if("active"!=b.status){var T=document.createElement("div");switch(T.style.fontSize=Math.round(1.6*iScreenScale)+"px",T.style.color="#FC0",b.status){case"pending_completion":T.innerHTML=toLanguage("This challenge is pending completion. Succeed it to publish it.","Ce d\xE9fi est en attente de r\xE9ussite. R\xE9ussissez-le pour le publier.");break;case"pending_publication":T.innerHTML=toLanguage("This challenge is pending publication. Click on &quot;Manage challenges&quot; to publish it.","Ce d\xE9fi est en attente de publication. Cliquez sur &quot;G\xE9rer les d\xE9fis&quot; pour le publier.");break;case"pending_moderation":T.innerHTML=toLanguage("This challenge is pending moderation. It will be published once a validator validates it.","Ce d\xE9fi est en attente de mod\xE9ration. Il sera publi\xE9 d\xE8s qu'un mod\xE9rateur l'aura valid\xE9.");}T.style.fontWeight="bold",C.appendChild(T)}v.appendChild(C);var C=document.createElement("td");if(C.style.padding=iScreenScale+" "+iScreenScale+"px",C.style.width=12*iScreenScale+"px",C.style.textAlign="center",b.succeeded){var I=document.createElement("div");I.innerHTML="<span style=\"color:#CFC;display:inline-block;margin-right:2px\">\u2714</span>"+toLanguage("Completed","R\xE9ussi"),I.style.whiteSpace="nowrap",I.style.fontSize=Math.round(iScreenScale*(language?2:2.2))+"px",I.style.backgroundColor="#33A033",I.style.display="inline-block",I.style.padding="0px "+Math.round(.8*iScreenScale)+"px",I.style.borderRadius=Math.round(.6*iScreenScale)+"px",I.style.color="white",I.style.marginBottom=Math.round(.5*iScreenScale)+"px",I.style.marginTop=Math.round(.5*iScreenScale)+"px",C.appendChild(I)}var z=document.createElement("div"),B=document.createElement("img");B.src="images/challenges/difficulty"+b.difficulty.level+".png",B.alt="D",B.style.width=2*iScreenScale+"px",z.appendChild(B);var M=document.createElement("span");if(M.style.color=b.difficulty.color,M.style.fontSize=Math.round(1.7*iScreenScale)+"px",M.style.position="relative",M.style.top="-1px",M.innerHTML=" "+b.difficulty.name,z.appendChild(M),C.appendChild(z),b.winners.length){var z=document.createElement("div");z.style.cursor="help";var L=document.createElement("img");b.succeeded||(z.style.marginBottom=Math.round(.5*iScreenScale)+"px"),L.src="images/cups/cup1.png",L.alt="W",L.style.width=2*iScreenScale+"px",z.appendChild(L);var M=document.createElement("span");M.style.color="white",M.style.fontSize=Math.round(1.7*iScreenScale)+"px",M.style.position="relative",M.style.top="-2px",M.innerHTML=" "+b.winners.length;for(var H="<small style=\"color:#CFC\">"+toLanguage("Succeeded by:","R\xE9ussi par :")+"</small>",A=0;A<b.winners.length;A++)H+="<br /><span style=\"color:#CFC;display:inline-block;margin-right:2px\">\u2714</span>"+b.winners[A].nick;z.dataset||(z.dataset={}),z.dataset.title=H,z.appendChild(M);var _;z.onmouseover=function(){if(!_){_=document.createElement("div"),_.className="ranking_activeplayertitle",_.innerHTML=this.dataset.title,_.style.position="fixed",_.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",_.style.borderRadius=iScreenScale+"px",_.style.zIndex=10,_.style.backgroundColor="rgba(51,160,51, 0.95)",_.style.color="white",_.style.fontSize=Math.round(1.8*iScreenScale)+"px",_.style.lineHeight=Math.round(2*iScreenScale)+"px",_.style.visibility="hidden",$mkScreen.appendChild(_);var e=this.getBoundingClientRect();_.style.left=Math.round(e.left+(this.scrollWidth-_.scrollWidth)/2)+"px",_.style.top=e.top+this.scrollHeight+5+"px",_.style.visibility="visible"}},z.onmouseout=function(){_&&($mkScreen.removeChild(_),_=void 0)},C.appendChild(z)}if(b.succeeded){var P=document.createElement("a");P.href="#null",P.innerHTML=toLanguage("Replay","Rejouer"),P.style.color="white",P.style.fontSize=Math.round(1.7*iScreenScale)+"px",function(e,i,n){P.onclick=function(){return t(e,i,n),!1}}(b,m,u),C.appendChild(P)}else{var N=document.createElement("input");N.type="button",N.value=toLanguage("Take up","Relever"),N.style.width=11*iScreenScale+"px",N.style.fontSize=Math.round(2.4*iScreenScale)+"px",function(e,i,n){N.onclick=function(){t(e,i,n)}}(b,m,u),C.appendChild(N)}v.appendChild(C),p.appendChild(v)}o.appendChild(p)}else{o.style.textAlign="center";var T=document.createElement("div");T.style.fontSize=3*iScreenScale+"px",T.style.marginTop=3*iScreenScale+"px",T.style.marginBottom=2*iScreenScale+"px",T.style.marginLeft="auto",T.style.marginRight="auto",T.style.width=60*iScreenScale+"px",T.style.color="white",T.innerHTML=toLanguage("This circuit has no challenges. Create some right now, it's fast and easy!","Ce circuit ne comporte aucun d\xE9fi. Cr\xE9ez-en d\xE8s maintenant, c'est facile et rapide !"),o.appendChild(T);var R=document.createElement("input");R.type="button",R.style.fontSize=3*iScreenScale+"px",R.style.paddingLeft=2*iScreenScale+"px",R.style.paddingRight=2*iScreenScale+"px",R.value=toLanguage("Go to challenge editor","Acc\xE9der \xE0 l'\xE9diteur de d\xE9fis"),R.onclick=function(){openChallengeEditor()},o.appendChild(R)}l.appendChild(o),e.appendChild(l);var D=document.createElement("input");if(D.type="button",D.value=toLanguage("Back","Retour"),D.style.fontSize=2*iScreenScale+"px",D.style.position="absolute",D.style.left=2*iScreenScale+"px",D.style.top=35*iScreenScale+"px",D.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),selectMainPage()},e.appendChild(D),a){if(myCircuit){var D=document.createElement("input");D.type="button",D.value=toLanguage("Manage challenges...","G\xE9rer les d\xE9fis..."),D.style.fontSize=2*iScreenScale+"px",D.style.position="absolute",D.style.right=2*iScreenScale+"px",D.style.top=35*iScreenScale+"px",D.onclick=function(){openChallengeEditor()},e.appendChild(D)}if(clRewards.length){var P=document.createElement("a");s?P.href="persoLocked.php?cl="+s:"undefined"!=typeof commentType&&"undefined"!=typeof commentCircuit&&(P.href="persoLocked.php?cltype="+commentType+"&clrace="+commentCircuit),P.target="_blank",P.style.color="white",P.style.textDecoration="none",P.onclick=function(){return window.open(this.href,"persoLock","scrollbars=1, resizable=1, width=500, height=500"),!1};var F=document.createElement("img");F.src="images/challenges/unlocking.png",F.alt=toLanguage("Unlocking characters","Persos \xE0 d\xE9bloquer"),F.style.height=2*iScreenScale+"px",F.style.marginRight=Math.round(.55*iScreenScale)+"px",F.style.position="relative",F.style.top=Math.round(.2*iScreenScale)+"px",P.appendChild(F);var V=0;if(myCircuit)P.innerHTML+=clRewards.length;else{for(var g=0;g<clRewards.length;g++)clRewards[g].unlocked&&V++;P.innerHTML+=V+"/"+clRewards.length}P.style.fontSize=2*iScreenScale+"px",P.style.position="absolute",P.style.right=(myCircuit?22:2)*iScreenScale+"px",P.style.top=35*iScreenScale+"px",P.dataset||(P.dataset={});var O=clRewards.length-V,q=1<O?"s":"";0>=O?(P.dataset.title=toLanguage("All characters unlocked,<br />congratulations!","Tous les persos ont \xE9t\xE9<br />d\xE9bloqu\xE9s, f\xE9licitations !"),P.style.color="#0F8",P.style.fontWeight="bold"):V?P.dataset.title=toLanguage(O,"Plus que "+O)+" "+toLanguage("character"+q+" left to unlock","perso"+q+" \xE0 d\xE9bloquer"):P.dataset.title=O+" "+toLanguage("character"+q+" to unlock","perso"+q+" \xE0 d\xE9bloquer");var _;P.onmouseover=function(){if(this.style.opacity=.7,!_){_=document.createElement("div"),_.className="ranking_activeplayertitle",_.style.textAlign="center",_.innerHTML=this.dataset.title,_.style.position="fixed",_.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",_.style.borderRadius=iScreenScale+"px",_.style.zIndex=10,_.style.backgroundColor="rgba(102,153,160, 0.95)",_.style.color="white",_.style.fontSize=Math.round(1.8*iScreenScale)+"px",_.style.lineHeight=Math.round(2*iScreenScale)+"px",_.style.visibility="hidden",$mkScreen.appendChild(_);var e=this.getBoundingClientRect();_.style.left=Math.round(e.left+(this.scrollWidth-_.scrollWidth)/2)+"px",_.style.top=e.top-_.scrollHeight-5+"px",_.style.visibility="visible"}},P.onmouseout=function(){this.style.opacity="",_&&($mkScreen.removeChild(_),_=void 0)},e.appendChild(P)}}oContainers[0].appendChild(e)}function searchCourse(e){function t(){g&&(g--,!g&&xhr("getCourse.php",v?x:f,function(e){if(!e)return!1;try{e=JSON.parse(e)}catch(t){return!1}if(!!e.found){var t=r.checked;if(l.innerHTML="",oContainers[0].removeChild(l),t){var i=document.createElement("embed");i.src="musics/mkalert.wav",i.setAttribute("loop",!1),i.setAttribute("autostart",!0),i.style.position="absolute",i.style.left="-1000px",i.style.top="-1000px",document.body.appendChild(i);var n=new Date().getTime();alert(toLanguage("Opponents have been found !\nGood luck !","Des adversaires ont \xE9t\xE9 trouv\xE9s !\nBonne chance !")),e.time-=Math.round((new Date().getTime()-n)/1e3),document.body.removeChild(i)}handleMatchmakingSuccess(e)}else if(g=10,e.nb_players)2>e.nb_players&&(e.nb_players=2),document.getElementById("nb-active-players").innerHTML=e.nb_players+" "+toLanguage("players","joueurs"),h.style.display="none",y.style.display="block";else if(e.pending_players){var o=document.getElementById("nb-pending-players");o.dataset.pendingCourse=e.pending_course,o.innerHTML=e.pending_players+" "+toLanguage("player","joueur")+(1<e.pending_players?"s":"");var a=e.min_players-e.pending_players;1>a&&(a=1),document.getElementById("nb-missing-players").innerHTML=a+" "+toLanguage("player","joueur")+(1<a?"s":""),y.style.display="none",h.style.display="block"}else y.style.display="none",h.style.display="none";return!0})),d--,-4>=d&&(d=0),c.style.left=Math.round(d*b)+"px",setTimeout(t,100)}function n(e,t){var i;e.dataset||(e.dataset={}),addFancyTitle({elt:e,title:"...",style:function(e){return i=e,{left:e.left+iScreenScale+"px",top:e.bottom+iScreenScale+"px",backgroundColor:"rgba(51,160,51, 0.95)"}},onShow:function(n){var l=f;e.dataset.pendingCourse&&(l+=(l?"&":"")+"&course="+e.dataset.pendingCourse),xhr("getCourseDetails.php",l,function(e){if(!$mkScreen.contains(n))return!0;var l=JSON.parse(e),o=l[t].map(function(e){return e.name});if(o.length){var a=o.join("<br />");n.innerHTML=a,n.style.left=Math.max(iScreenScale,Math.round(i.left+(i.width-n.scrollWidth)/2))+"px"}else n.style.visibility="hidden";return!0})}})}e=e||{};var l=document.createElement("div"),o=l.style;o.width=80*iScreenScale+"px",o.height=39*iScreenScale+"px",o.border="solid 1px black",o.backgroundColor="black";var a=document.createElement("div");a.style.position="absolute",a.style.left="0px",a.style.top=4*iScreenScale+"px",a.style.width=80*iScreenScale+"px",a.style.fontSize=4*iScreenScale+"",a.style.textAlign="center",a.innerHTML=toLanguage("Searching for other players<br />Please wait...","Recherche d'autres joueurs<br />Veuillez patienter..."),l.appendChild(a);var s=document.createElement("label");s.style.position="absolute",s.style.left="0px",s.style.top=15*iScreenScale-9+"px",s.style.width=80*iScreenScale+"px",s.style.textAlign="center";var r=document.createElement("input");r.type="checkbox",r.id="iAlert",r.style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+iScreenScale/6+") translateY(8%)",r.style.transformOrigin=r.style.WebkitTransformOrigin=r.style.MozTransformOrigin="bottom right",s.appendChild(r);var p=document.createElement("span");p.setAttribute("for","iAlert"),p.style.fontSize=2*iScreenScale+"pt",p.style.marginLeft="5px",p.innerHTML=toLanguage("Notify me when opponents have been found","M'alerter lorsque des adversaires ont \xE9t\xE9 trouv\xE9s"),s.appendChild(p),l.appendChild(s);var d=0,c=document.createElement("div");c.style.position="absolute",c.style.left="0px",c.style.top=21*iScreenScale+"px",c.style.width=2*(41*iScreenScale)+"px",c.style.height=Math.round(8.5*iScreenScale)+"px",c.style.overflow="hidden";for(var u=0,m;41>u;u++)m=document.createElement("img"),m.src="images/cLoading.png",m.className="pixelated",m.style.width=2*iScreenScale+"px",m.style.position="absolute",m.style.left=2*(u*iScreenScale)+"px",m.style.top="0px",c.appendChild(m);l.appendChild(c);var y=document.createElement("div");y.style.position="absolute",y.style.left="0px",y.style.top=Math.round(17.5*iScreenScale)+"px",y.style.width=80*iScreenScale+"px",y.style.textAlign="center",y.style.fontSize=2*iScreenScale+"px",y.style.color="#0B0",y.style.display="none",y.style.backgroundColor="rgba(0,0,0, 0.7)",y.innerHTML=toLanguage("<span id=\"nb-active-players\" style=\"color:#0E0;text-decoration:underline;cursor:pointer\"></span> currently online. You'll join them as soon as they finish their "+(isBattle?"battle":"race"),"<span id=\"nb-active-players\" style=\"color:#0E0;text-decoration:underline;cursor:pointer\"></span> actuellement en ligne. Vous les rejoindrez une fois leur partie termin\xE9e"),l.appendChild(y);var h=document.createElement("div");h.style.position="absolute",h.style.left="0px",h.style.top=Math.round(17.5*iScreenScale)+"px",h.style.width=80*iScreenScale+"px",h.style.textAlign="center",h.style.fontSize=2*iScreenScale+"px",h.style.color="#0B0",h.style.display="none",h.style.backgroundColor="rgba(0,0,0, 0.7)",h.innerHTML=toLanguage("<span id=\"nb-pending-players\" style=\"color:#0E0;text-decoration:underline;cursor:pointer\"></span> currently waiting, <span id=\"nb-missing-players\" style=\"color:#0E0\"></span> left before the game begins...","<span id=\"nb-pending-players\" style=\"color:#0E0;text-decoration:underline;cursor:pointer\"></span> actuellement en attente. Plus que <span id=\"nb-missing-players\" style=\"color:#0E0\"></span> pour que la partie commence"),l.appendChild(h);var g=1,b=iScreenScale/2,f=getOnlineCourseParams(e),x=f+(f?"&":"")+"nojoin",v=!!e.enableSpectatorMode;t(),n(y.querySelector("#nb-active-players"),"active_players"),n(h.querySelector("#nb-pending-players"),"pending_players"),shareLink.key||xhr("sendCourseNotifs.php",null,function(){return!0});var C=document.createElement("input");C.type="button",C.value=toLanguage("Back","Retour"),C.style.fontSize=2*iScreenScale+"px",C.style.position="absolute",C.style.left=2*iScreenScale+"px",C.style.top=35*iScreenScale+"px",C.onclick=function(){t=function(){},l.innerHTML="",oContainers[0].removeChild(l),selectPlayerScreen(0,void 0,void 0,{enableSpectatorMode:v})},l.appendChild(C),oContainers[0].appendChild(l);var k=document.createElement("div");k.style.position="absolute",k.style.left=28*iScreenScale+"px",k.style.top=34*iScreenScale+"px",k.style.fontSize=Math.round(2.5*iScreenScale)+"px",k.style.display="flex",k.style.alignItems="center";var E=document.createElement("label");E.style.display="inline-flex",E.style.alignItems="center",E.style.cursor="pointer",E.style.gap=Math.round(.5*iScreenScale)+"px",E.style.marginRight=iScreenScale+"px";var w=document.createElement("input");w.type="checkbox",w.checked=v,w.style.transform="scale("+iScreenScale/6+")",w.style.transformOrigin="center",w.style.marginRight=Math.round(1.5*iScreenScale-6)+"px",w.onclick=function(){v=this.checked},E.appendChild(w);var S=document.createElement("span");S.innerHTML=toLanguage("Spectator mode","Mode spectateur"),E.appendChild(S),k.appendChild(E);var T=document.createElement("a");T.href="#null",T.style.color="#CCF",T.innerHTML="[?]",T.style.cursor="help",T.onclick=function(){return!1},T.dataset.noselect="1",k.appendChild(T),addFancyTitle({elt:T,title:toLanguage("Check this to see races<br />without playing on them","Cochez cette case pour voir<br />les courses sans y participer"),style:function(e){return{left:e.left-10*iScreenScale+"px",top:e.top-6*iScreenScale+"px",backgroundColor:"rgba(51,51,160, 0.95)"}}}),l.appendChild(k),updateMenuMusic(0)}function getOnlineCourseParams(e){var t="";return isCup?isMCups?t+="mid="+nid:isSingle?t+=(complete?"i":"id")+"="+nid+(isBattle?"&battle":""):t+=(complete?"c":"s")+"id="+nid:isBattle&&(t+="battle"),shareLink.key&&(t+=(t?"&":"")+"key="+shareLink.key),e.spectator?t+=(t?"&":"")+"spectator="+e.spectator:e.course&&(t+=(t?"&":"")+"course="+e.course),t}function handleMatchmakingSuccess(e){1>e.time&&(e.time=1),e.spectator&&(setSpectatorId(e.spectator),e.spectatorState&&(onlineSpectatorState=e.spectatorState)),selectMapScreen({racecountdown:e.time-5}),dRest(),setTimeout(setChat,1)}function addFancyTitle(e){var t=e.elt,i,n;t.onmouseover=function(){if(!i){if(t.style.opacity=.9,i=document.createElement("div"),i.className="ranking_activeplayertitle",i.innerHTML=e.title,i.style.position="fixed",i.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",i.style.borderRadius=iScreenScale+"px",i.style.zIndex=10,i.style.color="white",i.style.fontSize=Math.round(1.8*iScreenScale)+"px",i.style.lineHeight=Math.round(2*iScreenScale)+"px",i.style.visibility="hidden",$mkScreen.appendChild(i),e.style){var l=t.getBoundingClientRect();Object.assign(i.style,e.style(l))}i.style.visibility="visible",clearInterval(n),n=setInterval(function(){!i||document.body.contains(t)||($mkScreen.removeChild(i),clearInterval(n),i=void 0)},1e3),e.onShow&&e.onShow(i)}},t.onmouseout=function(){i&&(t.style.opacity="",$mkScreen.removeChild(i),clearInterval(n),i=void 0)}}function chooseRandMap(){"MK"==page?"BB"==course?chooseWithin(NBCIRCUITS,12):chooseWithin(0,NBCIRCUITS):isSingle?choose(1):isBattle?isCup?chooseWithin(0,aAvailableMaps.length):chooseWithin(NBCIRCUITS,12):chooseWithin(0,NBCIRCUITS)}function chooseWithin(e,t){for(var n={},l=e+1;l<=e+t;l++)n[l]=1;for(var l=0;l<aTracksHist.length;l++)delete n[aTracksHist[l]];return n=Object.keys(n),!n.length&&aTracksHist.length?(aTracksHist=aTracksHist.slice(aTracksHist.length-Math.floor(t/2)),chooseWithin(e,t)):choose(n[Math.floor(Math.random()*n.length)],!0)}function selectMapScreen(e){function t(e,i){if(document.getElementById("maps")&&document.getElementById("maps").alt==i){0==i%4?i-=3:i++;var n=document.getElementById("dMaps"),l=mapNameOf(e,i-1);n.appendChild(l),document.getElementById("maps").alt=i,document.getElementById("maps").src=getMapSelectorSrc(i-1),setTimeout(function(){try{n.removeChild(l)}catch(t){return}t(e,i)},1e3)}}function n(){document.getElementById("dMaps").style.display="none",document.getElementById("dMaps").innerHTML="",s.innerHTML="",oContainers[0].removeChild(s)}if(e||(e={}),"undefined"!=typeof shareLink&&(bSelectedMirror=shareLink.options&&shareLink.options.mirror),isOnline&&(setSRest(),document.getElementById("waitrace").style.visibility="visible",null!=e.racecountdown&&(document.getElementById("racecountdown").innerHTML=e.racecountdown)),isCup&&!isMCups)return void selectRaceScreen(0);if(clSelected&&!e.force)switch(clSelected.trackType){case"cup":var l=cupIDs.indexOf(clSelected.trackId);if(-1!==l)return void selectRaceScreen(4*l);break;case"track":var o=aAvailableMaps.find(function(e){var t=oMaps[e],i="CI"===page?t.id:t.map;return i==clSelected.trackId});if(o){var a=oMaps[o],l=Math.floor((a.ref-1)/4);return void selectRaceScreen(4*l)}}var s=document.createElement("div"),r=s.style,p=!0;r.width=80*iScreenScale+"px",r.height=39*iScreenScale+"px",r.border="solid 1px black",r.backgroundColor="black","BB"==course?s.appendChild(toTitle(toLanguage("Choose stage","Choisissez une ar\xE8ne"),.5)):s.appendChild(toTitle(toLanguage("Choose cup","Choisissez la coupe"),.5));var d=document.createElement("input");d.type="button",d.value=toLanguage("Back","Retour"),d.style.fontSize=2*iScreenScale+"px",d.style.position="absolute",d.style.left=2*iScreenScale+"px",d.style.top=isOnline?30*iScreenScale+"px":35*iScreenScale+"px",d.onclick=function(){pause&&!isOnline?(removeMenuMusic(!1),quitter()):(p=!1,n(),isOnline&&(document.getElementById("waitrace").style.visibility="hidden"),chatting=!1,hideSpectatorLink(),selectGamersScreen())};var c=document.createElement("div");c.style.position="absolute",c.style.zIndex=20002,c.style.top=Math.round(35.5*iScreenScale-6)+"px",c.style.left=25*iScreenScale-5+"px",c.style.width=25*iScreenScale+6+"px",c.style.height=Math.round(3.9*iScreenScale)+"px",c.style.border="solid 1px white",c.style.color="white",c.style.backgroundColor="black",c.style.borderBottom="none",c.style.textAlign="center",c.style.display="none",c.style.flexDirection="column",c.style.justifyContent="center";var u=document.createElement("div");u.style.maxHeight=Math.round(3.9*iScreenScale)+"px",u.style.overflow="hidden",c.appendChild(u),s.appendChild(c),s.appendChild(d),"GP"!=course&&oContainers[0].appendChild(s),document.getElementById("dMaps").style.top=40*iScreenScale+"px",document.getElementById("dMaps").style.left=7+25*iScreenScale+"px",document.getElementById("dMaps").style.width=25*iScreenScale+"px",document.getElementById("dMaps").style.height=10*iScreenScale+"px";var m=["champi","etoile","carapace","carapacebleue","speciale","carapacerouge","banane","feuille","megachampi","eclair","upchampi","fireflower","bobomb","minichampi","egg","iceflower","plume","cloudchampi"],y=6,h;"BB"==course?(h=(aAvailableMaps.length-NBCIRCUITS)/4,!isCup&&(m=["snes","gba","ds"])):h=NBCIRCUITS/4;var g=Math.ceil(h/y),b=h,f=0,x=g,v=cupOpts.lines;if(v){if(cupOpts.pages){if(!e.page&&(e.page=0,e.cup)){e.cup/=4;for(var C=0,k=0;k+v[C]<=e.cup;)k+=v[C],C++;for(;cupOpts.pages[e.page]<=C;)e.page++;delete e.cup}var E=e.page;f=0<E?cupOpts.pages[E-1]:0,x=E<cupOpts.pages.length?cupOpts.pages[E]:v.length,b=0;for(var w=f;w<x;w++)b+=v[w]}else x=v.length;g=x-f}y=Math.ceil(b/g);var S=y;if(v){S=0;for(var w=0;w<v.length;w++)S=Math.max(S,v[w])}var T=Math.min(Math.round(10.5/Math.pow(Math.max(b/5,g,.5),.6)),16/g,60/S),I=Math.min(4,20/S),z=4/g,B=38;isCup||"BB"!=course||(T=Math.round(1.5*T),I=Math.round(2*I),B-=3);for(var M=0,L=0,w=0;w<h;w++){var H,A,_;if(v?(_=v[L],H=M,A=L,M++,M>=v[L]&&(M=0,L++)):(_=Math.min(y,h-(w-w%y)),H=w%y,A=Math.floor(w/y)),A>=x)break;if(A-=f,!(0>A)){var P=document.createElement("img");P.className="pixelated",P.style.width=T*iScreenScale+"px",P.style.height=T*iScreenScale+"px",P.style.cursor="pointer",P.style.position="absolute";var N=(80+I+1)/2+(H-_/2)*(T+I),R=(z+B)/2+(A-g/2)*(T+z);P.style.left=Math.round(N*iScreenScale)+"px",P.style.top=Math.round(R*iScreenScale)+"px",cupOpts.icons?"number"==typeof cupOpts.icons[w]?P.src="images/cups/"+m[cupOpts.icons[w]]+".gif":function(e,t){P.onload=function(){this.naturalWidth>this.naturalHeight?(this.style.width=T*iScreenScale+"px",this.style.top=Math.round((t+T*(1-this.naturalHeight/this.naturalWidth)/2)*iScreenScale)+"px",this.style.height="auto"):(this.style.width="auto",this.style.height=T*iScreenScale+"px",this.style.left=Math.round((e+T*(1-this.naturalWidth/this.naturalHeight)/2)*iScreenScale)+"px")},P.src=cupOpts.icons[w]}(N,R):P.src="images/cups/"+m[w%m.length]+".gif",P.alt="BB"==course?w+NBCIRCUITS/4:w;var D=iScreenScale;if(P.onmouseover=function(){var e=new Image;e.src=getMapSelectorSrc(w),e.alt=4*this.alt+4,e.style.border="double 4px white",e.style.width="100%",e.style.height="100%",e.className="pixelated",bSelectedMirror&&(e.className+=" mirrored"),e.id="maps",document.getElementById("dMaps").appendChild(e),document.getElementById("dMaps").style.display="block",t(D,4*this.alt+4);var i=cupPayloads[this.alt];if(i){u.innerHTML="";var n=i.name;if(n){var l=i.prefix;if(l){var o=document.createElement("span");o.innerText=l,o.style.fontSize="0.7em",u.appendChild(o)}var a=document.createElement("span");a.innerText=n,u.appendChild(a);var s=l?l+n:n,r=Math.min(Math.max(8/Math.sqrt(s.length),1.45),3);c.style.fontSize=Math.round(r*iScreenScale)+"px",c.style.display="flex",u.style.display="flex",u.style.alignItems="center",u.style.justifyContent="center",u.style.gap="0.25em"}}},P.onmouseout=function(){document.getElementById("dMaps").style.display="none",document.getElementById("dMaps").innerHTML="",c.style.display="none"},P.onclick=function(){n(),selectRaceScreen(4*this.alt)},!isCup&&"BB"==course){var F=[toLanguage("SNES Stages","Ar\xE8nes SNES"),toLanguage("GBA Stages","Ar\xE8nes GBA"),toLanguage("DS Stages","Ar\xE8nes DS")],V=document.createElement("div");V.style.position="absolute",V.style.left=Math.round((N-I/2)*iScreenScale)+"px",V.style.top=Math.round((R+.9*T)*iScreenScale)+"px",V.style.width=(T+I)*iScreenScale+"px",V.style.fontSize=3*iScreenScale+"px",V.style.color="white",V.style.textAlign="center",V.innerHTML=F[w],s.appendChild(V)}if(s.appendChild(P),"GP"==course){var O=1*ptsGP.charAt(w);if(O){var q=new Image;q.src="images/cups/cup"+(4-O)+".png",q.style.width=Math.round(4*iScreenScale*T/7)+"px",q.style.height=Math.round(4*iScreenScale*T/7)+"px",q.style.position="absolute",q.style.left=Math.round((N+4*T/7)*iScreenScale)+"px",q.style.top=Math.round((R+4*T/7)*iScreenScale)+"px",q.className="pixelated",s.appendChild(q)}}else if(isMCups&&!isOnline){var W=document.createElement("a");W.style.position="absolute",W.style.left=Math.round((N+5*T/7)*iScreenScale)+"px",W.style.top=Math.round((R+5*T/7)*iScreenScale)+"px",W.style.backgroundColor="rgba(0,50,128, 0.5)",W.style.padding="4px",W.style.borderRadius="50%",W.href="?cid="+cupIDs[w],W.title=toLanguage("Link to this cup","Lien vers cette coupe"),W.onmouseover=function(){this.style.backgroundColor="rgba(0,102,153, 0.8)"},W.onmouseout=function(){this.style.backgroundColor="rgba(0,50,128, 0.5)"};var X=document.createElement("img");X.src="images/clink.png",X.style.width=Math.round(2*(T*iScreenScale)/7)+"px",W.appendChild(X),s.appendChild(W)}}}if("VS"==course||"BB"==course){var d=document.createElement("input");d.type="button",d.value=toLanguage("Random","Al\xE9atoire"),d.style.fontSize=3*iScreenScale+"px",d.style.position="absolute",d.style.left=34*iScreenScale-10+"px",d.style.top=30*iScreenScale+"px",d.onclick=function(){p=!1,n(),chooseRandMap()},s.appendChild(d)}else if("GP"==course)oContainers[0].appendChild(s);else if("CM"==course){var d=document.createElement("input");d.type="button",d.value=toLanguage("Rankings","Classement"),d.style.fontSize=3*iScreenScale+"px",d.style.position="absolute",d.style.left=33*iScreenScale-10+"px",d.style.top=30*iScreenScale+"px",d.onclick=openRankings,s.appendChild(d)}if(showRaceCountIfRelevant(s),cupOpts.pages&&cupOpts.pages.length){var G=document.createElement("input");G.type="button",G.value="\u25C4",G.style.fontSize=Math.round(2.5*iScreenScale)+"px",G.style.position="absolute",G.style.left=72*iScreenScale+"px",G.style.top=(isOnline?31:34)*iScreenScale+"px",G.className="disablable",G.onclick=function(){e.page--,n(),selectMapScreen(e)},G.disabled=0>=e.page,s.appendChild(G);var K=document.createElement("input");K.type="button",K.value="\u25BA",K.style.fontSize=Math.round(2.5*iScreenScale)+"px",K.style.position="absolute",K.style.left=76*iScreenScale+"px",K.style.top=(isOnline?31:34)*iScreenScale+"px",K.className="disablable",K.onclick=function(){e.page++,n(),selectMapScreen(e)},K.disabled=e.page>=cupOpts.pages.length,s.appendChild(K)}isOnline&&(handleSpectatorLink(function(){p=!1,n()}),setTimeout(function(){p&&(n(),chooseRandMap())},1e3*document.getElementById("racecountdown").innerHTML)),updateMenuMusic(1)}function setMapSrc(e,t,n,i){isCup?setTimeout(function(){e.src=i},100*(n-t)):e.src=i}function rankingsLink(e){var t=getActualCc();return"MK"===page?"classement.php?map="+e.map+"&cc="+t:"CI"===page?"classement.php?circuit="+e.id+"&cc="+t:"MA"===page?"classement.php?draw="+e.map+"&cc="+t:void 0}function globalRankingsLink(){var e=getActualCc();return isMCups?"classement.php?mcup="+nid+"&cc="+e:"MK"===page?"classement.php?cc="+e:"CI"===page?"classement.php"+(isSingle?"?circuit="+nid:"?scup="+nid)+"&cc="+e:"MA"===page?"classement.php"+(isSingle?"?draw="+nid:"?ccup="+nid)+"&cc="+e:void 0}function openRankings(){open(globalRankingsLink())}function exitCircuit(){var e=document.getElementById("changeRace"),t=document.getElementById("supprRace");e&&!t?e.click():document.location.href="index.php"}function showRaceCountIfRelevant(e){if("CM"!=course&&iRaceCount&&isLocalScore()){var t=document.createElement("div"),i="BB"==course?toLanguage("Battle","Bataille"):toLanguage("Race","Course");t.innerHTML=i+" "+(iRaceCount+1),t.style.fontSize=2*iScreenScale+"px",t.style.position="absolute",t.style.color="#ccc",t.style.right=3*iScreenScale+"px",t.style.top=(isOnline?isSingle||isMCups||!isCup?31:27:35)*iScreenScale+"px",e.appendChild(t)}}function appendContainers(){for(var e=1;e<oContainers.length;e++)$mkScreen.appendChild(oContainers[e])}function selectRaceScreen(e){if(isOnline||!isSingle&&"GP"!=course){var t=document.createElement("div"),n=t.style,l=!0;n.width=80*iScreenScale+"px",n.height=39*iScreenScale+"px",n.border="solid 1px black",n.backgroundColor="black",oContainers[0].appendChild(t),"BB"==course?t.appendChild(toTitle(toLanguage("Choose stage","Choisissez une ar\xE8ne"),isSingle?2.5:.5)):t.appendChild(toTitle(toLanguage("Choose track","Choisissez un circuit"),isSingle?2.5:.5));var o=document.createElement("input");o.type="button",o.value=toLanguage("Back","Retour"),o.style.fontSize=2*iScreenScale+"px",o.style.position="absolute",o.style.left=2*iScreenScale+"px",o.style.top=isOnline?30*iScreenScale+"px":35*iScreenScale+"px",o.onclick=function(){l=!1,t.innerHTML="",oContainers[0].removeChild(t),isOnline&&isCup&&!isMCups?(document.getElementById("waitrace").style.visibility="hidden",chatting=!1,hideSpectatorLink(),selectPlayerScreen(0)):"BB"==course?!isCup||isMCups?selectMapScreen({force:!0,cup:e}):pause?(removeMenuMusic(!1),quitter()):selectGamersScreen():isCup&&!isMCups?pause?(removeMenuMusic(!1),quitter()):selectGamersScreen():selectMapScreen({force:!0,cup:e})},t.appendChild(o);for(var a=iScreenScale,s=clSelected&&"track"===clSelected.trackType?clSelected.trackId:null,r=isSingle?e+1:e+4,p=e,d,c;p<r;p++){c=document.createElement("div"),c.style.width=25*iScreenScale+"px",c.style.height=10*iScreenScale+"px",c.style.cursor="pointer",c.style.position="absolute";var u=p-e;isSingle?(c.style.left=27*iScreenScale+"px",c.style.top=15*iScreenScale+"px"):(c.style.left=(-33/2+25*(u-2*Math.floor(u/2))+(u-2*Math.floor(u/2)))*iScreenScale+30*iScreenScale+"px",c.style.top=10*iScreenScale+11*iScreenScale*Math.floor(u/2)+"px"),c.map=aAvailableMaps[p],c.ref=p+1;var m=new Image;if(setMapSrc(m,e,p,getMapSelectorSrc(p)),m.style.width="100%",m.style.height="100%",m.style.border="double 4px silver",m.className="pixelated",bSelectedMirror&&(m.className+=" mirrored"),c.appendChild(m),c.appendChild(mapNameOf(a,p)),isCup&&!isOnline){var y=document.createElement("a");y.style.position="absolute",y.style.right="-3px",y.style.top="5px",y.style.backgroundColor="rgba(0,50,128, 0.5)",y.style.padding="4px",y.style.borderRadius="50%";var h=oMaps[aAvailableMaps[p]];y.href=complete?"?i="+h.map:"?id="+h.id,y.title=toLanguage("Link to this "+(isBattle?"arena":"circuit"),"Lien vers "+(isBattle?"cette ar\xE8ne":"ce circuit")),y.onclick=function(t){t.stopPropagation()},y.onmouseover=function(){this.style.backgroundColor="rgba(0,102,153, 0.8)"},y.onmouseout=function(){this.style.backgroundColor="rgba(0,50,128, 0.5)"},y.dataset.noselect="1";var g=document.createElement("img");g.src="images/clink.png",g.style.width=2*iScreenScale+"px",y.appendChild(g),c.appendChild(y)}c.onclick=function(){l=!1,t.innerHTML="",oContainers[0].removeChild(t),isOnline?choose(this.ref):"CM"==course?loadGhostScreen(this.map):(appendContainers(),resetGame(this.map))};var b=oMaps[c.map],f="CI"===page?b.id:b.map;f==s&&(d=c),t.appendChild(c)}if(isCup&&!isSingle&&!isMCups){var o=document.createElement("input");o.type="button",o.value="CM"==course?toLanguage("Rankings","Classement"):toLanguage("Random","Al\xE9atoire"),o.style.position="absolute",isOnline?(o.style.fontSize=2*iScreenScale+"px",o.style.left=67*iScreenScale+"px",o.style.top=30*iScreenScale+"px"):(o.style.fontSize=3*iScreenScale+"px",o.style.left=34*iScreenScale-10+"px",o.style.top=34*iScreenScale+"px"),o.onclick=function(){"CM"==course?openRankings():(l=!1,t.innerHTML="",oContainers[0].removeChild(t),chooseRandMap())},t.appendChild(o)}if(showRaceCountIfRelevant(t),isOnline&&(setSRest(),handleSpectatorLink(function(){l=!1,t.innerHTML="",oContainers[0].removeChild(t)}),setTimeout(function(){l&&(t.innerHTML="",oContainers[0].removeChild(t),chooseRandMap())},1e3*document.getElementById("racecountdown").innerHTML)),d)return void d.click()}else{if("GP"==course)if("MK"!=page)iDificulty=5;else{var x=Math.floor(e/4)%5;iDificulty=40>e?Math.min(4.5+x/7,5):Math.min(4.6+x/7,5)}return(e++,strMap="map"+e,"CM"==course)?void loadGhostScreen(strMap):(appendContainers(),void resetGame(strMap))}updateMenuMusic(1)}function choose(map,rand){function refreshTab(reponse){if(null!=waitHandler){if(reponse){if(-1!=reponse){function backToSearch(){$mkScreen.removeChild(oTable),leaveRaceWheelScreen()}var rCode;try{rCode=eval(reponse)}catch(t){return!1}choixJoueurs=rCode[0];for(var trs=oTBody.getElementsByTagName("tr");trs.length;)oTBody.removeChild(trs[0]);var nbChoices=0;for(i=0;i<choixJoueurs.length;i++)if(!choixJoueurs[i][7]){var oTr=document.createElement("tr"),oTd=document.createElement("td"),isChoix=choixJoueurs[i][2],isRandom=choixJoueurs[i][3];oTd.innerHTML=isChoix?isRandom?"???":dCircuits[isChoix-1]:toLanguage("Not chosen","Non choisi"),onlineSpectatorId&&choixJoueurs[i][0]==identifiant&&(isChoix?(setSpectatorId(void 0),hideSpectatorLink()):oTd.style.display="none"),oTr.appendChild(oTd),oTBody.appendChild(oTr),nbChoices++}if(-1==rCode[1]){if(onlineSpectatorState)return setSpectatorId(void 0),backToSearch(),!0;rePosSpectatorLink(),waitHandler=setTimeout(waitForChoice,1e3)}else{hideSpectatorLink();var gameRules=rCode[4];if(nbChoices>=gameRules.minPlayers){function e(){var n=!0;if(cCursor==rCode[1]){for(var l=0,o=cTime,a=0;a<nbChoices;a++)o=Math.round(1.05*o),l+=o;l>=tThen-new Date().getTime()&&(n=!1)}n?(trs[cCursor].style.backgroundColor="",trs[cCursor].style.color="",cCursor++,cCursor==nbChoices&&(cCursor=0),trs[cCursor].style.backgroundColor="#F80",trs[cCursor].style.color="white",cTime=Math.round(1.05*cTime),setTimeout(e,cTime)):t(0)}function t(e){trs[cCursor].style.backgroundColor=e%2?"":"#F80",trs[cCursor].style.color=e%2?"":"white",4>e?setTimeout(function(){t(e+1)},100):setTimeout(function(){$mkScreen.removeChild(oTable),proceedOnlineRaceSelection(rCode)},500),1==e&&(trs[cCursor].getElementsByTagName("td")[0].innerHTML=dCircuits[choixJoueurs[cCursor][2]-1])}if(aPlayers=[],aIDs=[],aPlaces=[],aPseudos=[],aControllers=[],shareLink.options&&shareLink.options.cpu){var cpuLevel=shareLink.options.cpuLevel||0;cpuLevel=2-cpuLevel,iDificulty=4+.5*cpuLevel,isBattle&&(iDificulty=4.5)}for(fSelectedClass=gameRules.cc?getRelSpeedFromCc(gameRules.cc):1,bSelectedMirror=!!gameRules.mirror,0<=gameRules.raceCount&&(iRaceCount=gameRules.raceCount),aTeams=[],i=0;i<choixJoueurs.length;i++){var aID=choixJoueurs[i][0];if(aID!=identifiant){aIDs.push(aID);var sPlayerName=choixJoueurs[i][1];aPlayers.push(sPlayerName),isCustomPerso(sPlayerName),cp[sPlayerName]||(cp[sPlayerName]=[.5,.5,.5,.5]),aPlaces.push(choixJoueurs[i][4]),aPseudos.push(choixJoueurs[i][5]),aTeams.push(choixJoueurs[i][6]),aControllers.push(choixJoueurs[i][7])}else aPlaces.unshift(choixJoueurs[i][4]),aPseudos.unshift(choixJoueurs[i][5]),aTeams.unshift(choixJoueurs[i][6])}if(selectedTeams=-1==aTeams.indexOf(-1),selectedTeams||(aTeams.length=0),shareLink.options&&shareLink.options.itemDistrib)if(isNaN(shareLink.options.itemDistrib))selectedItemDistrib=shareLink.options.itemDistrib;else{var itemMode=getItemMode();selectedItemDistrib=itemDistributions[itemMode][shareLink.options.itemDistrib].value}selectedPtDistrib=shareLink.options&&shareLink.options.ptDistrib?shareLink.options.ptDistrib:ptDistributions[0],oDoubleItemsEnabled=!(shareLink.options&&0==shareLink.options.doubleItems);var tNow=new Date().getTime();tnCourse=tNow+rCode[2],isSingle?rCode[2]=0:gameRules.manualTeams?playerIsSelecter()?rCode[2]=0:rCode[2]-=gameRules.selectionTime:tnCourse+=5e3;var tThen=tNow+rCode[2];connecte=rCode[3]+1;var cCursor=0,cTime=50;oMap=oMaps[aAvailableMaps[choixJoueurs[rCode[1]][2]-1]],onlineSpectatorState?($mkScreen.removeChild(oTable),setTimeout(function(){proceedOnlineRaceSelection(rCode)},500)):e()}else{if(onlineSpectatorState)return setSpectatorId(void 0),backToSearch(),!0;var oDiv=document.createElement("div");oDiv.style.position="absolute",oDiv.style.left=10*iScreenScale+10+"px",oDiv.style.top=20*iScreenScale+10+"px",oDiv.style.fontSize=2*iScreenScale+"pt",oDiv.innerHTML=1<nbChoices||onlineSpectatorId?toLanguage("Sorry, there are not enough players to begin the race...","D&eacute;sol&eacute;, il n'y a pas assez de joueurs pour commencer la course..."):toLanguage("Sorry, all your opponents have left the race...","D&eacute;sol&eacute;, tous vos adversaires ont quitt&eacute; la course..."),oDiv.appendChild(document.createElement("br"));var nSearch=document.createElement("a");nSearch.style.color="white",nSearch.innerHTML=toLanguage("Search for new players","Rechercher de nouveaux joueurs"),nSearch.setAttribute("href","#null"),nSearch.onclick=function(){return $mkScreen.removeChild(oDiv),backToSearch(),!1},oDiv.appendChild(nSearch),oDiv.appendChild(document.createElement("br"));var nSearch=document.createElement("a");nSearch.style.color="white",nSearch.innerHTML=toLanguage("Back to Mario Kart PC","Retour \xE0 Mario Kart PC"),nSearch.setAttribute("href","index.php"),oDiv.appendChild(nSearch),$mkScreen.appendChild(oDiv),1>=choixJoueurs.length&&(chatting=!1,stopVocChat()),clearInterval(startMusicHandler),window.onbeforeunload=void 0}}}else iDeco();return!0}return!1}}function playerIsSelecter(){for(var e=0,t;e<choixJoueurs.length;e++)if(choixJoueurs[e][0]==shareLink.player){t=choixJoueurs[e];break}return t||(t=choixJoueurs[0]),t[0]==identifiant}function proceedOnlineRaceSelection(e){var t=e[4],i=aAvailableMaps[choixJoueurs[e[1]][2]-1];selectedNbTeams=t.nbTeams||defaultGameOptions.nbTeams,selectedTeamOpts=t.teamOpts||defaultGameOptions.teamOpts,selectedFriendlyFire=!!t.friendlyFire,selectedNbTeams>choixJoueurs.length&&(selectedNbTeams=choixJoueurs.length,selectedTeamOpts&&(selectedTeamOpts.length=selectedNbTeams)),t.manualTeams?(setupTeamColors(),selectOnlineTeams(i,choixJoueurs,playerIsSelecter())):resetGame(i)}function rePosSpectatorLink(){var e=document.getElementById("spectatormode");if(e){var t=oTable.getBoundingClientRect();e.style.top=Math.max(t.bottom+5,38*iScreenScale+15)+"px"}}function waitForChoice(){var e=[];onlineSpectatorId&&e.push("spectator="+onlineSpectatorId),"BB"==course&&e.push("battle"),xhr("getMap.php",e.join("&"),refreshTab)}if(!isOnline)return appendContainers(),void resetGame("map"+map);var choixJoueurs=[],oTable=document.createElement("table");oTable.className="online-track-sel",oTable.border=1,oTable.setAttribute("cellspacing",2),oTable.setAttribute("cellpadding",2),oTable.style.position="absolute",oTable.style.fontSize=2*iScreenScale+"pt",oTable.style.textAlign="center",oTable.style.left=25*iScreenScale+"px",oTable.style.top=2*iScreenScale+"px",oTable.style.width=30*iScreenScale+"px",onlineSpectatorState&&(oTable.style.display="none");var oTBody=document.createElement("tbody");onlineSpectatorId?(waitHandler=setTimeout(waitForChoice,1),!onlineSpectatorState&&showSpectatorLink({toggled:!0,click:function(){clearTimeout(waitHandler),waitHandler=null,$mkScreen.removeChild(oTable)}})):(xhr("chooseMap.php","joueur="+strPlayer+"&map="+map+("BB"==course?"&battle":"")+(rand?"&rand":""),refreshTab),hideSpectatorLink(),window.onbeforeunload=function(){return language?"Caution, if you leave the game, you are considered loser":"Attention, si vous quittez la partie, vous \xEAtes consid\xE9r\xE9 comme perdant"});var waitHandler=0;oTable.appendChild(oTBody),$mkScreen.appendChild(oTable),document.getElementById("waitrace").style.visibility="hidden",updateMenuMusic(1),formulaire.dataset.disabled=1,bMusic&&(startMusicHandler=setInterval(function(){oMapImg&&(loadMapMusic(),clearInterval(startMusicHandler))},onlineSpectatorState?10:500))}function leaveRaceWheelScreen(){clearRaceWheenScreen(),removeMenuMusic(),removeGameMusics(),chatting=!1,iRaceCount=0;var e={enableSpectatorMode:!!onlineSpectatorId};setSpectatorId(void 0),searchCourse(e)}function clearRaceWheenScreen(){clearInterval(startMusicHandler),formulaire.dataset.disabled="",hideSpectatorLink()}function setSpectatorId(e){onlineSpectatorId=e,onlineSpectatorId||(onlineSpectatorState=void 0),rtcService&&rtcService.setSpectatorId(onlineSpectatorId)}function selectOnlineTeams(e,t,n){function l(e,t,i){var n=document.createElement("div");n.id="online-teams-confirm",n.style.position="absolute",n.style.left=0,n.style.top=0,n.style.width=80*iScreenScale+"px",n.style.height=39*iScreenScale+"px",n.style.backgroundColor="rgba(0,0,0, 0.5)",n.style.zIndex=6e4;var l=document.createElement("div");l.style.position="absolute",l.style.zIndex=6e4,l.style.left=Math.round(80*iScreenScale/2)+"px",l.style.top=Math.round(39*iScreenScale/2)+"px",l.style.width=40*iScreenScale+"px",l.style.transform=l.style.WebkitTransform=l.style.MozTransform="translate(-50%, -50%)",l.style.backgroundColor="gray",l.style.border="solid 1px silver",l.onclick=function(e){e.stopPropagation()};var o=document.createElement("div");o.style.marginTop=iScreenScale+"px",o.style.marginBottom=Math.round(iScreenScale/2)+"px",o.style.fontSize=Math.round(2.5*iScreenScale)+"px",o.style.textAlign="center",o.style.marginLeft=2*iScreenScale+"px",o.style.marginRight=2*iScreenScale+"px",o.style.color="#FE9",o.innerHTML=e,l.appendChild(o);var a=document.createElement("div");a.style.marginBottom=iScreenScale+"px",a.style.textAlign="center",a.style.marginLeft=Math.round(1.5*iScreenScale)+"px",a.style.marginRight=Math.round(1.5*iScreenScale)+"px",a.style.fontSize=Math.round(1.8*iScreenScale)+"px",a.style.color="white",a.innerHTML=t,l.appendChild(a);var s=document.createElement("div");s.style.textAlign="center",s.style.marginBottom=iScreenScale+"px";var r=document.createElement("input");r.type="button",r.style.marginRight=Math.round(iScreenScale/2)+"px",r.value="Ok",r.style.fontSize=Math.round(2*iScreenScale)+"px",r.onclick=function(){return d.removeChild(n),i(),!1},s.appendChild(r);var p=document.createElement("input");return p.type="button",p.value=toLanguage("Cancel","Annuler"),p.style.marginLeft=Math.round(iScreenScale/2)+"px",p.style.fontSize=Math.round(2*iScreenScale)+"px",p.onclick=n.onclick=function(){return d.removeChild(n),!1},s.appendChild(p),l.appendChild(s),n.appendChild(l),d.appendChild(n),setTimeout(function(){r.focus()},1),n}function o(e){f.innerHTML="";for(var t=E.reduce(function(e,t){return Math.max(e,t.length)},0),n=0,l;n<t;n++){l=document.createElement("tr");for(var o=0;o<selectedNbTeams;o++){var s=document.createElement("td"),r=E[o][n];if(r){selectedTeams?(s.style.backgroundColor=cTeamColors.contrast[o],s.style.color=cTeamColors.primary[o]):(s.style.backgroundColor="#ccc",s.style.color="#222"),2<selectedNbTeams?(s.style.paddingLeft=Math.round(2.5*iScreenScale)+"px",s.style.paddingRight=Math.round(2.5*iScreenScale)+"px"):(s.style.paddingLeft=3*iScreenScale+"px",s.style.paddingRight=3*iScreenScale+"px"),s.style.position="relative",s.style.textAlign="center",s.style.userSelect="none";var p=document.createElement("span");if(p.style.display="block",p.style.top="1px",p.style.position="relative",p.innerHTML=r[5],p.style.whiteSpace="nowrap",p.style.textOverflow="ellipsis",p.style.overflow="hidden",p.style.width=2<selectedNbTeams?Math.round(13.5*iScreenScale)+"px":16*iScreenScale+"px",s.appendChild(p),e)for(var d=0,c;2>d;d++)c=document.createElement("span"),c.innerHTML=d?"\u25C0":"\u25B6",c.style.position="absolute",d?c.style.left="0px":c.style.right="0px",c.style.top="48%",c.style.color="#F80",c.style.padding=Math.round(iScreenScale/2)+"px",c.style.transform=c.style.WebkitTransform=c.style.MozTransform="translateY(-50%)",c.style.cursor="pointer",c.style.opacity=.9,c.onmouseover=function(){this.style.opacity=.45},c.onmouseout=function(){this.style.opacity=.9},c.dataset||(c.dataset={}),c.dataset.i=n,c.dataset.j=o,c.dataset.k=d,c.onclick=a,s.appendChild(c)}else{var u=document.createElement("div");u.style.width=20*iScreenScale+"px",s.appendChild(u)}l.appendChild(s)}f.appendChild(l)}var m=E.reduce(function(e,t){return e+(t.length?1:0)},0);m>=selectedNbTeams?(w.style.opacity=1,w.disabled=!1,w.style.cursor=""):(w.style.opacity=.4,w.disabled=!0,w.style.cursor="not-allowed")}function a(){function e(p,c,u){var m=p;if(p+=u,p>c)d.removeChild(n),o(!0);else{r.style.left=Math.round(20*iScreenScale*p/c*a)+"px";var y=c/2;m<y&&p>=y&&(r.style.backgroundColor=cTeamColors.contrast[s],r.style.color=cTeamColors.primary[s]);for(var h=f.getElementsByTagName("tr"),g=0;g<selectedNbTeams;g++)if(g===i||g===s)for(var b=g==i,x=b?l+1:l,v;x<h.length;x++)v=h[x].getElementsByTagName("td"),v[g].style.top=Math.round(3*iScreenScale*p/c*(b?-1:1))+"px";z=setTimeout(function(){e(p,c,u)},u)}}var n=document.createElement("div");n.style.position="absolute",n.style.left="0px",n.style.top="0px",n.style.width=80*iScreenScale+"px",n.style.height=80*iScreenScale+"px",n.style.zIndex=5e4,d.appendChild(n);var l=+this.dataset.i,i=+this.dataset.j,a=+this.dataset.k?-1:1,t=E[i][l];E[i].splice(l,1);var s=(i+a+selectedNbTeams)%selectedNbTeams;E[s].splice(Math.min(l,E[s].length),0,t);var r=this.parentNode;r.style.backgroundColor="#ccc",e(0,150,20)}function s(t){tnCourse=new Date().getTime()+t.time;for(var n=t.teams,l={},a=0;a<selectedNbTeams;a++)for(var s=0;s<E[a].length;s++)l[E[a][s][0]]=E[a][s];for(var a=0;a<n.length;a++)l[n[a].id][6]=n[a].team;var r=strPlayer.length;onlineSpectatorId&&(r=0);for(var a=0;a<r;a++)aTeams[a]=l[identifiant][6];for(var a=0;a<aPlayers.length;a++){var p=aIDs[a],c=a+r;aTeams[c]=l[p][6]}selectedTeams=-1==aTeams.indexOf(-1);for(var a=0;a<selectedNbTeams;a++)E[a].length=0;if(selectedTeams)for(var a=0;a<n.length;a++)E[n[a].team].push(l[n[a].id]);else for(var a=0;a<n.length;a++)E[a%selectedNbTeams].push(l[n[a].id]);o(!1),y.removeChild(w),d.removeChild(x);var u=document.createElement("div");u.style.textAlign="center",u.style.fontSize=3*iScreenScale+"px",u.style.marginTop=iScreenScale+"px",u.style.color="#DFC",u.innerHTML=selectedTeams?toLanguage("Teams have been selected !","Les \xE9quipes ont \xE9t\xE9 s\xE9lectionn\xE9es !"):toLanguage("Mode &quot;no teams&quot; selected. In this game, you're playing for yourself!","Mode &quot;Chacun pour soi&quot; s\xE9lectionn\xE9. Cette partie se d\xE9roulera sans \xE9quipes"),y.appendChild(u),y.style.display="block",connecte=t.connect+1;var m=tnCourse-new Date().getTime();setTimeout(function(){d.innerHTML="",oContainers[0].removeChild(d),resetGame(e)},onlineSpectatorState?0:Math.min(t.previewTime,m-1e3))}function r(){oContainers[0].removeChild(d),d.innerHTML="";var e=document.createElement("div");e.style.position="absolute",e.style.left=10*iScreenScale+10+"px",e.style.top=15*iScreenScale+10+"px",e.style.fontSize=2*iScreenScale+"pt",e.innerHTML=toLanguage("The game has been cancelled by the teams selector.","Partie annul\xE9e par le s\xE9lectionneur des \xE9quipes."),e.appendChild(document.createElement("br"));var t=document.createElement("a");t.style.color="white",t.innerHTML=toLanguage("Search for new players","Rechercher de nouveaux joueurs"),t.setAttribute("href","#null"),t.onclick=function(){return $mkScreen.removeChild(e),leaveRaceWheelScreen(),!1},e.appendChild(t),e.appendChild(document.createElement("br"));var t=document.createElement("a");t.style.color="white",t.innerHTML=toLanguage("Back to Mario Kart PC","Retour \xE0 Mario Kart PC"),t.setAttribute("href","index.php"),e.appendChild(t),$mkScreen.appendChild(e),clearInterval(startMusicHandler),window.onbeforeunload=void 0}function p(){y.style.display="none",x.style.display="none";var e=document.getElementById("online-teams-confirm");e&&d.removeChild(e),document.getElementById("waitteam").style.visibility="hidden"}var d=document.createElement("div"),c=d.style;c.width=80*iScreenScale+"px",c.height=39*iScreenScale+"px",c.border="solid 1px black",c.backgroundColor="black";var u=selectedTeamOpts&&selectedTeamOpts.some(function(e){return e.name}),m=toTitle(toLanguage("Team selection","S\xE9lection des \xE9quipes"),.5);u?(m.style.top="0px",m.style.fontSize=Math.round(5*iScreenScale)+"px"):m.style.fontSize=Math.round(7*iScreenScale)+"px",d.appendChild(m);var y=document.createElement("div");if(y.style.display="none",y.style.position="absolute",y.style.zIndex=5e4,y.style.left=iScreenScale+"px",y.style.top=10*iScreenScale+"px",y.style.width=78*iScreenScale+"px",y.style.height=29*iScreenScale+"px",y.style.overflow="auto",y.style.textAlign="center",u){y.style.top=7.5*iScreenScale+"px",y.style.paddingTop=2.5*iScreenScale+"px";var h=document.createElement("div");h.style.position="absolute",h.style.left=iScreenScale+"px",h.style.top="0px",h.style.width=78*iScreenScale+"px",h.style.textAlign="center",h.style.fontSize=2*iScreenScale+"px",h.style.whiteSpace="nowrap",h.style.color="white";for(var g=0,b;g<selectedNbTeams;g++)b=document.createElement("div"),b.style.width=2<selectedNbTeams?Math.round(18.5*iScreenScale)+"px":22*iScreenScale+"px",b.style.display="inline-block",b.style.overflow="hidden",b.style.whiteSpace="nowrap",b.style.textOverflow="ellipsis",b.style.textAlign="center",b.innerHTML=cTeamColors.name[g],h.appendChild(b);y.appendChild(h)}var f=document.createElement("table");f.style.marginLeft="auto",f.style.marginRight="auto",f.style.fontSize=2<selectedNbTeams?2*iScreenScale+"px":Math.round(2.4*iScreenScale)+"px";var x=document.createElement("div");x.style.zIndex=50002,x.style.display="none",x.style.position="absolute",x.style.right=3*iScreenScale+"px",x.style.bottom=5*iScreenScale+"px";var v=document.createElement("input");v.type="button",v.style.display="block",v.style.marginTop=Math.round(iScreenScale/2)+"px",v.value=toLanguage("No teams","Chacun pour soi"),v.style.fontSize=2*iScreenScale+"px",v.style.width=18*iScreenScale+"px",v.style.textAlign="center",v.onclick=function(){l(toLanguage("No teams?","Jouer sans \xE9quipes ?"),toLanguage("Please confirm that you want to play without teams","Confirmez que vous souhaitez jouer en mode <em>chacun pour soi</em>."),function(){clearTimeout(I);var e="noteams";isBattle&&(e+="&battle"),isSingle&&(e+="&single"),p(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(t){return!1}return s(t),!0})})},x.appendChild(v);var C=document.createElement("input");C.type="button",C.style.display="block",C.style.marginTop=Math.round(iScreenScale/2)+"px",C.value=toLanguage("Cancel game","Annuler la partie"),C.style.fontSize=2*iScreenScale+"px",C.style.width=18*iScreenScale+"px",C.style.color="#F60",C.style.textAlign="center",C.onclick=function(){l(toLanguage("Cancel game?","Annuler la partie ?"),toLanguage("Caution, you're about to cancel the game <strong style=\"color:#FEB\">for all players</strong>. Use this option if you're waiting for more players for example.","Attention, vous \xEAtes sur le point d'annuler la partie <strong style=\"color:#FEB\">pour tous les joueurs</strong>. Utilisez cette option si vous attendez plus de joueurs par exemple."),function(){clearTimeout(I);var e="cancel";isBattle&&(e+="&battle"),p(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;try{JSON.parse(e)}catch(t){return!1}return r(),!0})})},x.appendChild(C),d.appendChild(x);for(var E=Array(selectedNbTeams),g=0;g<selectedNbTeams;g++)E[g]=[];for(var g=0;g<t.length;g++)E[t[g][6]].push(t[g]);var w=document.createElement("input");w.type="button",w.style.fontSize=3*iScreenScale+"px",w.style.marginTop=iScreenScale+"px",w.value=toLanguage("Validate","Valider"),w.onclick=function(){clearTimeout(I);for(var e="",t=0,n=0;n<selectedNbTeams;n++)for(var l=0;l<E[n].length;l++)t&&(e+="&"),e+="j"+E[n][l][0]+"="+n,t++;isBattle&&(e+="&battle"),isSingle&&(e+="&single"),p(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(t){return!1}return s(t),!0})},y.appendChild(f),y.appendChild(w),d.appendChild(y);var S=new Date().getTime(),T=tnCourse-S-2e3,I,z;if(n)setSRest("team"),document.getElementById("teamcountdown").innerHTML=Math.round(T/1e3),document.getElementById("waitteam").style.visibility="visible",dRest("team"),I=setTimeout(function(){clearTimeout(z);var e="";isBattle&&(e="battle"),p(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(t){return!1}return s(t),!0})},1e3*document.getElementById("teamcountdown").innerHTML),o(!0),y.style.display="block",x.style.display="block";else{function e(){for(var e=B.getElementsByTagName("img"),t=new Date().getTime(),i=Math.round(41*Math.min((t-S)/T,1));L<i;)e[L].style.opacity=1,L++}function t(){xhr("getTeams.php",onlineSpectatorId?"spectator="+onlineSpectatorId:"",function(i){if(d.style.visibility="",!i)return!1;var n;try{n=JSON.parse(i)}catch(t){return!1}switch(n.state){case"selecting_teams":e(),setTimeout(t,1e3);break;case"teams_selected":d.removeChild(h),d.removeChild(B),s(n);break;default:d.removeChild(h),d.removeChild(B),r();}return!0})}d.style.visibility="hidden";var h=document.createElement("div");h.style.position="absolute",h.style.left=6*iScreenScale+"px",h.style.top=12*iScreenScale+"px",h.style.fontSize=Math.round(2.5*iScreenScale)+"px",h.style.color="#DFC",h.innerHTML=language?" &nbsp; Teams are being selected... Please don't leave the game":"Les \xE9quipes sont en cours de s\xE9lection... Ne pas quitter la partie.",d.appendChild(h);var B=document.createElement("div");B.style.position="absolute",B.style.left="0px",B.style.top=19*iScreenScale+"px",B.style.width=2*(41*iScreenScale)+"px",B.style.height=Math.round(8.5*iScreenScale)+"px",B.style.overflow="hidden";for(var g=0,M;41>g;g++)M=document.createElement("img"),M.src="images/cLoading.png",M.className="pixelated",M.style.width=2*iScreenScale+"px",M.style.position="absolute",M.style.left=2*(g*iScreenScale)+"px",M.style.top="0px",M.style.opacity=.5,B.appendChild(M);d.appendChild(B);var L=0;t()}onlineSpectatorState&&(d.style.opacity=0,setTimeout(function(){d.style.opacity=""},1e3)),oContainers[0].appendChild(d)}function iDeco(){var e=document.createElement("div");e.style.position="absolute",e.style.left=15*iScreenScale+"px",e.style.top=8*iScreenScale+"px",e.style.width=50*iScreenScale+"px",e.style.height=15*iScreenScale+"px",e.style.fontSize=3*iScreenScale+"px",e.style.backgroundColor="gray",e.style.color="white",e.style.border="solid 1px silver",e.style.fontWeight="bold",e.style.textAlign="center",e.style.paddingTop=5*iScreenScale+"px",e.style.zIndex=2e4,e.innerHTML=toLanguage("You have been disconnected","Vous avez &eacute;t&eacute; d&eacute;connect&eacute;");for(var t=0;2>t;t++)e.appendChild(document.createElement("br"));var n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=3*iScreenScale+"px",n.onclick=function(){location.reload()},e.appendChild(n),$mkScreen.appendChild(e),chatting=!1,hideSpectatorLink();var l=document.getElementById("waitrace");l&&(l.style.visibility="hidden"),window.onbeforeunload=void 0,n.focus()}function dRest(e){if(e||(e="race"),isOnline){var t=document.getElementById(e+"countdown").innerHTML-1;if(document.getElementById(e+"countdown").innerHTML=t,t&&"visible"==document.getElementById("wait"+e).style.visibility)return void(dRestHandlers[e]||(dRestHandlers[e]=setInterval(function(){dRest(e)},1e3)))}dRestHandlers[e]&&(clearTimeout(dRestHandlers[e]),delete dRestHandlers[e])}function setSRest(e){if(e||(e="race"),isOnline){var t=document.getElementById("wait"+e);if(!t){var i={race:toLanguage("There are <strong id=\"racecountdown\">30</strong> seconds left to choose the next race","Il vous reste <span id=\"racecountdown\">30</span> secondes pour choisir la prochaine course"),team:toLanguage("There are <strong id=\"teamcountdown\">10</strong> seconds left to choose the teams","Il vous reste <span id=\"teamcountdown\">10</span> secondes pour choisir les \xE9quipes")};t=document.createElement("div"),t.id="wait"+e,t.className="wait",t.innerHTML=i[e],document.getElementById("mariokartcontainer").appendChild(t)}t.style.left=2*iScreenScale+10+"px",t.style.top=35*iScreenScale+10+"px",t.style.minWidth=76*iScreenScale+"px",t.style.fontSize=3*iScreenScale+"px"}}function showSpectatorLink(t){hideSpectatorLink();var i=document.createElement("div");i.id="spectatormode",i.style.left=2*iScreenScale+10+"px",i.style.top=38*iScreenScale+15+"px",i.style.width=76*iScreenScale+"px",i.style.fontSize=Math.round(2.25*iScreenScale)+"px";var n=document.createElement("img");n.src="images/ic_spectator.png",n.alt="Toggle",n.style.height=Math.round(1.75*iScreenScale)+"px",n.style.marginRight=Math.round(iScreenScale/4)+"px",i.appendChild(n);var l=document.createElement("a");l.href="#null";var o=!1;t.toggled?(l.innerHTML=toLanguage("Exit spectator mode","Quitter le mode spectateur"),l.onclick=function(i){i.preventDefault(),o||(o=!0,t.click(),xhr("getCourse.php",getOnlineCourseParams({spectator:onlineSpectatorId}),function(e){if(!e)return!1;try{e=JSON.parse(e)}catch(t){return!1}return e.found?(clearRaceWheenScreen(),setSpectatorId(void 0),handleMatchmakingSuccess(e)):(choose(),hideSpectatorLink(),showExitSpectatorFailMessage()),!0}))}):(l.title=toLanguage("You'll see games but not play on it","Vous verrez les parties mais ne jouerez pas dedans"),l.innerHTML=toLanguage("Switch to spectator mode","Passer en mode spectateur"),l.onclick=function(i){i.preventDefault(),o||(o=!0,t.click(),xhr("spectatorMode.php","",function(e){return 0<e?(setSpectatorId(+e),o=!1,choose(),!0):(iDeco(),!0)}))}),i.appendChild(l),document.getElementById("mariokartcontainer").appendChild(i)}function hideSpectatorLink(){var e=document.getElementById("spectatormode");e&&document.getElementById("mariokartcontainer").removeChild(e)}function handleSpectatorLink(e){return onlineSpectatorId?(e(),document.getElementById("waitrace").style.visibility="hidden",void xhr("spectatorMode.php","spectator="+onlineSpectatorId+(onlineSpectatorState?"&state="+onlineSpectatorState:""),function(){return choose(),!0})):void showSpectatorLink({click:e})}function showExitSpectatorFailMessage(){function e(){return n-=.05,0>=n?void document.body.removeChild(t):void(t.style.opacity=n,setTimeout(e,100))}var t=document.createElement("div");t.style.position="absolute",t.style.left=10+2*iScreenScale+"px",t.style.width=76*iScreenScale+"px",t.style.top=38*iScreenScale+15+"px",t.style.fontSize=2*iScreenScale+"px",t.style.textAlign="center";var i=document.createElement("div");i.style.color="#dc7",i.style.backgroundColor="#430",i.style.display="inline-block",i.style.padding=Math.round(.5*iScreenScale)+" "+iScreenScale+"px",i.style.borderRadius=iScreenScale+"px",i.innerHTML=toLanguage("Sorry, it's too late to join the race","D\xE9sol\xE9, il est trop tard pour rejoindre la course"),t.appendChild(i),document.body.appendChild(t);var n=1;setTimeout(e,1500)}function connexion(){var e=document.createElement("div"),t=e.style;t.width=80*iScreenScale+"px",t.height=39*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black",e.appendChild(toTitle(toLanguage("Connection","Connexion"),-.5));var i=document.createElement("form"),n,l,o;i.style.position="absolute",i.style.left=16*iScreenScale+"px",i.style.top=10*iScreenScale+"px",i.onsubmit=function(){return b.style.visibility="hidden",o.disabled=!0,xhr("testcode.php","pseudo="+n.value+"&code="+l.value,function(t){if(!t||isNaN(t))return!1;var i=1*t;return i?(identifiant=i,mId=i,mPseudo=n.value,mCode=l.value,e.innerHTML="",oContainers[0].removeChild(e),selectPlayerScreen(0)):(b.style.visibility="visible",o.disabled=!1),!0}),!1};var a=document.createElement("table");a.border=2,a.setAttribute("cellpadding",1),a.setAttribute("cellspacing",2);var s=document.createElement("tr"),r=document.createElement("td");r.style.textAlign="right";var p=document.createElement("label");p.style.fontSize=3*iScreenScale+"px",p.setAttribute("for","iPseudo"),p.innerHTML=toLanguage("&nbsp; Username:","&nbsp; Pseudo :"),r.appendChild(p);var d=document.createElement("td");n=document.createElement("input"),n.type="text",n.name="iPseudo",n.id="iPseudo",n.value=mPseudo,n.style.fontSize=3*iScreenScale+"px",n.style.backgroundColor="#FE7",d.appendChild(n),s.appendChild(r),s.appendChild(d);var c=document.createElement("tr"),u=document.createElement("td");u.style.textAlign="right";var m=document.createElement("label");m.style.fontSize=3*iScreenScale+"px",m.setAttribute("for","iCode"),m.innerHTML=toLanguage("Password:","Code :"),u.appendChild(m);var y=document.createElement("td");l=document.createElement("input"),l.type="password",l.name="iCode",l.id="iCode",l.value=mCode,l.style.fontSize=3*iScreenScale+"px",l.style.backgroundColor="#FE7",y.appendChild(l),c.appendChild(u),c.appendChild(y);var h=document.createElement("tr"),g=document.createElement("td");g.setAttribute("colspan",2),g.style.textAlign="center",o=document.createElement("input"),o.type="submit",o.style.fontSize=4*iScreenScale+"px",o.value=toLanguage("Submit","Valider"),g.appendChild(o),h.appendChild(g),a.appendChild(s),a.appendChild(c),a.appendChild(h),i.appendChild(a),e.appendChild(i);var b=document.createElement("div");b.style.color="red",b.style.fontSize=2*iScreenScale+"pt",b.style.position="absolute",b.style.left=21*iScreenScale+"px",b.style.top=31*iScreenScale+"px",b.innerHTML=toLanguage("Incorrect username or password","Pseudo ou mot de passe incorrect"),b.style.visibility="hidden",e.appendChild(b);var f=document.createElement("a");f.style.color="white",f.style.fontSize=2*iScreenScale+"pt",f.style.position="absolute",f.style.left=20*iScreenScale+"px",f.style.top=35*iScreenScale+"px",f.innerHTML=toLanguage("Register","Inscription"),f.setAttribute("href","inscription.php"+("BB"==course?"?battle":"")),e.appendChild(f);var x=document.createElement("a");x.style.color="white",x.style.fontSize=2*iScreenScale+"pt",x.style.position="absolute",x.style.left=45*iScreenScale+"px",x.style.top=35*iScreenScale+"px",x.innerHTML=toLanguage("Rankings","Classement"),x.setAttribute("href","bestscores.php"+("BB"==course?"?battle":"")),e.appendChild(x);var v=document.createElement("input");v.type="button",v.value=toLanguage("Back","Retour"),v.style.fontSize=2*iScreenScale+"px",v.style.position="absolute",v.style.left=2*iScreenScale+"px",v.style.top=35*iScreenScale+"px",v.onclick=quitter,e.appendChild(v),oContainers[0].appendChild(e),updateMenuMusic(0)}function loadGhostScreen(map){var oMap=oMaps[map];return isChallengeTtCompatible()?void(document.body.style.cursor="progress",xhr("ghostsave.php","map="+getCreationId(oMap)+"&type="+getCreationTable()+"&cc="+getActualCc(),function(reponse){var ghostSaves;try{ghostSaves=eval(reponse)}catch(t){return!1}return ghostSaves?selectFantomeScreen(ghostSaves,oMap.ref-1):selectFantomeScreen(void 0,oMap.ref-1),!0})):(gPersos.length=0,void resetGame(aAvailableMaps[oMap.ref-1]))}function selectFantomeScreen(ghostsData,map,otherGhostsData){function writeTime(e,t,i,n,l,o){if(l||(l=oPImg),o||(o=oPersoTime),l.src=getSpriteSrc(e),o.innerHTML=timeStr(i),oSpan.innerText=t,oSpan.title=t,oTable.style.left=Math.round((80*iScreenScale+20-oTable.offsetWidth)/2)+"px",oTable.style.top=Math.round((28*iScreenScale-oTable.offsetHeight)/2)+"px",o==oPersoTime){for(var a="<small style=\"color:#CCF\">"+toLanguage("Lap times:","Temps au tour :")+"</small>",s=0;s<n.length;s++)a+="<br /><span style=\"color:#CCF;display:inline-block\">"+(s+1)+".</span> "+timeStr(n[s]);oPersoLapTimes.dataset.title=a}}function multiGhosts(e){function t(){k.innerHTML=f,S.value=toLanguage("Face with "+f+" ghost"+(1<f?"s":""),"Affronter "+f+" fant\xF4me"+(1<f?"s":"")),C.disabled=1>=f,E.disabled=f>=gIDs.length}oScr.innerHTML="";var n=gID-3,l=gID+4;0>n?l-=n:l>e.length&&(n-=l-e.length),n=Math.max(n,0),l=Math.min(l,e.length),gIDs=[],gIDs.length=l-n;for(var o=0,s=n;s<l;s++){gIDs[o]=s;var r=document.createElement("div");r.className="igScr",r.style.position="absolute",r.style.left=s>=n+6?20*iScreenScale+"px":40*(o%2*iScreenScale)+"px",r.style.top=(1+7*Math.floor(o/2))*iScreenScale+"px",r.style.width=40*iScreenScale+"px";var p=document.createElement("table");p.setAttribute("border","2px"),p.style.marginLeft="auto",p.style.marginRight="auto",p.style.borderStyle="double",p.style.borderColor="gray",p.style.width=24*iScreenScale+"px",p.style.height=4*iScreenScale+"px";var d=document.createElement("tr"),c=document.createElement("td");c.style.width=3*iScreenScale+"px",c.style.paddingRight="5px";var u=document.createElement("div");u.style.position="relative",u.style.width=3*iScreenScale+"px",u.style.height=3*iScreenScale+"px",u.style.margin="0px auto",u.style.overflow="hidden";var m=new Image;m.style.height=3*iScreenScale+"px",m.onload=function(){var e=this.scrollWidth/24;this.parentNode.style.width=Math.round(e)+"px",this.style.left=-Math.round(6*e)+"px"},m.style.position="absolute",m.className="pixelated",ghostsData&&(m.alt=ghostsData[1]),m.nb=s,m.style.left=-(18*iScreenScale)+"px",m.style.top="0px",u.appendChild(m),c.appendChild(u),d.appendChild(c);var y=document.createElement("td");y.style.textAlign="center",y.style.fontSize=Math.round(3.5*iScreenScale)+"px",y.style.color="white",writeTime(e[gIDs[o]][1],e[gIDs[o]][2],e[gIDs[o]][3],e[gIDs[o]][4],m,y);var h=document.createElement("input");h.type="button",h.value="\u2190",h.style.fontSize=4*iScreenScale+"px",h.style.position="absolute",h.style.left=Math.round(2.5*iScreenScale-8)+"px",h.style.top=Math.round(.25*iScreenScale)+"px",function(t,i,n){h.onclick=function(){gIDs[t]--,0>gIDs[t]&&(gIDs[t]=e.length-1),writeTime(e[gIDs[t]][1],e[gIDs[t]][2],e[gIDs[t]][3],e[gIDs[t]][4],i,n)}}(o,m,y),r.appendChild(h);var g=document.createElement("input");g.type="button",g.value="\u2192",g.style.fontSize=4*iScreenScale+"px",g.style.position="absolute",g.style.left=32.5*iScreenScale+"px",g.style.top=Math.round(.25*iScreenScale)+"px",function(t,i,n){g.onclick=function(){gIDs[t]++,gIDs[t]>=e.length&&(gIDs[t]=0),writeTime(e[gIDs[t]][1],e[gIDs[t]][2],e[gIDs[t]][3],e[gIDs[t]][4],i,n)}}(o,m,y),r.appendChild(g),d.appendChild(y),p.appendChild(d),r.appendChild(p),oScr.appendChild(r),o++}var f=gIDs.length,x=document.createElement("div");x.style.textAlign="center",x.style.position="absolute",x.style.left=2*iScreenScale+"px",x.style.top=29*iScreenScale+"px",x.style.width=76*iScreenScale+"px",x.style.color="white";var v=document.createElement("span");v.style.fontSize=Math.round(2.5*iScreenScale)+"px",v.innerHTML=toLanguage("Number of ghosts:","Nombre de fant\xF4mes :"),v.style.marginRight=Math.round(1.2*iScreenScale)+"px",x.appendChild(v);var C=document.createElement("input");C.type="button",C.value="-",C.style.fontSize=3*iScreenScale+"px",C.onclick=function(){f--;var e=oScr.querySelectorAll(".igScr");e[f].style.visibility="hidden",t()};var k=document.createElement("span");k.style.fontSize=Math.round(2.5*iScreenScale)+"px",k.style.marginLeft=k.style.marginRight=Math.round(1.5*iScreenScale)+"px";var E=document.createElement("input");E.type="button",E.value="+",E.onclick=function(){var e=oScr.querySelectorAll(".igScr");e[f].style.visibility="visible",f++,t()},C.className=E.className="disablable",C.style.borderRadius=E.style.borderRadius="50%",C.style.fontSize=C.style.lineHeight=E.style.fontSize=E.style.lineHeight=3*iScreenScale+"px",C.style.width=C.style.height=E.style.width=E.style.height=4*iScreenScale+"px",x.appendChild(C),x.appendChild(k),x.appendChild(E),oScr.appendChild(x);var w=document.createElement("input");w.type="button",w.value=toLanguage("Back","Retour"),w.style.fontSize=2*iScreenScale+"px",w.style.position="absolute",w.style.left=2*iScreenScale+"px",w.style.top=36*iScreenScale+"px",w.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),selectFantomeScreen(ghostsData,map,{times:e,id:gID})},oScr.appendChild(w);var S=document.createElement("input");S.type="button",t(),S.style.fontSize=Math.round(2.5*iScreenScale)+"px",S.style.position="absolute",S.style.right=5*iScreenScale-10+"px",S.style.top=35*iScreenScale+"px",S.onclick=function(){gIDs.length=f,seeGhost(!1)},oScr.appendChild(S);var T=document.createElement("input");T.type="button",T.value=toLanguage("See race","Voir la course"),T.style.fontSize=Math.round(2.5*iScreenScale)+"px",T.style.position="absolute",T.style.right=33*iScreenScale-10+"px",T.style.top=35*iScreenScale+"px",T.onclick=function(){gIDs.length=f,seeGhost(!0)},oScr.appendChild(T)}function showGhosts(){if(gTimes.length){for(i=0;i<gTimes.length-1;i++){var e=i;for(j=i+1;j<gTimes.length;j++)gTimes[j][3]<gTimes[e][3]&&(e=j);var t=gTimes[e];gTimes[e]=gTimes[i],gTimes[i]=t}if(-1==gID)if(ghostsData){for(gID=gTimes.length-1;gID&&gTimes[gID][3]>=ghostsData[3];)gID--;!gID&&1<gTimes.length&&gTimes[gID][0]===ghostsData[0]&&gID++}else gID=0;var n=Math.round(11.5*iScreenScale),l=Math.round(5*iScreenScale),o=document.createElement("input");o.id="fGauche",o.type="button",o.value="\u2190",o.style.fontSize=4*iScreenScale+"px",o.style.position="absolute",o.style.left=13*iScreenScale+"px",o.style.top=n+"px",o.style.height=l+"px",o.onclick=function(){for(var e=0;2>e&&(gID--,0>gID&&(gID=gTimes.length-1),!!ghostsData)&&gTimes[gID][0]===ghostsData[0];e++);writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4])},oScr.appendChild(o);var a=document.createElement("input");a.id="ffGauche",a.type="button",a.value="\u23EE",a.style.fontSize=4*iScreenScale+"px",a.style.position="absolute",a.style.left=5*iScreenScale+"px",a.style.top=n+"px",a.style.height=l+"px",a.onclick=function(){gID=0,writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4])},oScr.appendChild(a);var s=document.createElement("input");s.id="fDroite",s.type="button",s.value="\u2192",s.style.fontSize=4*iScreenScale+"px",s.style.position="absolute",s.style.left=64*iScreenScale+"px",s.style.top=n+"px",s.style.height=l+"px",s.onclick=function(){for(var e=0;2>e&&(gID++,gID>=gTimes.length&&(gID=0),writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4]),!!ghostsData)&&gTimes[gID][0]===ghostsData[0];e++);},oScr.appendChild(s);var r=document.createElement("input");r.id="ffDroite",r.type="button",r.value="\u23ED",r.style.fontSize=4*iScreenScale+"px",r.style.position="absolute",r.style.left=72*iScreenScale+"px",r.style.top=n+"px",r.style.height=l+"px",r.onclick=function(){gID=gTimes.length-1,writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4])},oScr.appendChild(r),ghostsData?oScr.style.visibility="visible":oContainers[0].appendChild(oScr),writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4]),OPFace&&(OPFace.style.display="none"),document.body.style.cursor="default",OPFace7=document.createElement("input"),OPFace7.type="button",OPFace7.value=toLanguage("7 ghosts...","7 fant\xF4mes..."),OPFace7.style.fontSize=2*iScreenScale+"px",OPFace7.style.position="absolute",OPFace7.style.right=2*iScreenScale+"px",OPFace7.style.top=36*iScreenScale+"px";var p;OPFace7.onmouseover=function(){p||(p=document.createElement("div"),p.style.position="absolute",p.style.textAlign="center",p.style.fontSize=2*iScreenScale+"px",p.style.width=30*iScreenScale+"px",p.style.right=2*iScreenScale+"px",p.style.bottom=4*iScreenScale+"px",p.style.backgroundColor="rgba(204,192,178,0.95)",p.style.padding=Math.round(iScreenScale/2)+" "+iScreenScale+"px",p.style.color="#363330",p.innerHTML=toLanguage("Play with 7 ghosts with the same level as the ghost above","Affronter 7 fant\xF4mes du m\xEAme niveau que le fant\xF4me ci-dessus"),p.style.borderBottomLeftRadius=iScreenScale+"px",p.style.borderTopRightRadius=iScreenScale+"px",oScr.appendChild(p))},OPFace7.onmouseout=function(){p&&(oScr.removeChild(p),p=null)},OPFace7.onclick=function(){p&&(oScr.removeChild(p),p=null),multiGhosts(gTimes)},oScr.appendChild(OPFace7)}else if(ghostsData)alert(language?"No other record for this circuit yet":"Aucun autre record pour ce circuit"),oScr.style.visibility="visible",gID=-1,document.body.style.cursor="default";else{oScr.innerHTML="";try{oContainers[0].removeChild(oScr)}catch(t){}document.body.style.cursor="default",gPersos.length=0,resetGame(aAvailableMaps[map])}}function otherGhosts(){document.body.style.cursor="progress",ghostsData&&(oScr.style.visibility="hidden"),xhr("otherghosts.php","map="+getCreationId(oMaps[aAvailableMaps[map]])+"&type="+getCreationTable()+"&cc="+getActualCc(),function(reponse){if(reponse){try{gTimes=eval(reponse)}catch(t){return!1}return showGhosts(),!0}return!1})}function seeGhost(replay){if(replay&&(pause=!0,fInfos.replay=!0,gSelectedPerso=strPlayer[0]),-1==gID)oScr.innerHTML="",oContainers[0].removeChild(oScr),gOverwriteRecord=1,replay?(strPlayer[0]=ghostsData[1],iRecord=ghostsData[3],iLapTimes=ghostsData[4],iTrajet=ghostsData[5]):(gPersos=[ghostsData[1]],iLapTimes=ghostsData[4],jTrajets=[ghostsData[5]]),resetGame(aAvailableMaps[map]);else{oScr.innerHTML="",oContainers[0].removeChild(oScr),document.body.style.cursor="progress";var xhrUrl,xhrData;if(gIDs){xhrUrl="ghostsrace.php",xhrData="";for(var i=0;i<gIDs.length;i++)i&&(xhrData+="&"),xhrData+="id"+i+"="+gTimes[gIDs[i]][0]}else xhrUrl="ghostrace.php",xhrData="id="+gTimes[gID][0];xhr(xhrUrl,xhrData,function(reponse){if(reponse){var gCourse;try{gCourse=eval(reponse)}catch(t){return!1}if(gIDs){replay&&(strPlayer[0]=gTimes[gIDs[0]][1],iRecord=gTimes[gIDs[0]][3],iLapTimes=gTimes[gIDs[0]][4],iTrajet=gCourse[0]),gPersos=[];for(var i=0;i<gIDs.length;i++)gPersos.push(gTimes[gIDs[i]][1]);jTrajets=gCourse}else replay?(strPlayer[0]=gTimes[gID][1],iRecord=gTimes[gID][3],iLapTimes=gTimes[gID][4],iTrajet=gCourse):(gPersos=[gTimes[gID][1]],iLapTimes=gTimes[gID][4],jTrajets=[gCourse]);return resetGame(aAvailableMaps[map]),!0}return!1})}}var oScr=document.createElement("div"),oStyle=oScr.style;oStyle.width=80*iScreenScale+"px",oStyle.height=39*iScreenScale+"px",oStyle.border="solid 1px black",oStyle.backgroundColor="black";var oTitle=toTitle(lCircuits[map],.5);oTitle.style.fontSize=Math.round(7*iScreenScale)+"px",oTitle.style.left=2*iScreenScale+"px",oTitle.style.width=78*iScreenScale+"px",oTitle.style.whiteSpace="nowrap",oTitle.style.overflow="hidden",oTitle.style.textOverflow="ellipsis",oScr.appendChild(oTitle);var oTable=document.createElement("table");oTable.setAttribute("border","4px"),oTable.style.borderStyle="double",oTable.style.borderColor="gray",oTable.style.height=8*iScreenScale+"px",oTable.style.position="absolute",oTable.style.left=22*iScreenScale+"px",oTable.style.top=10*iScreenScale+"px",oTable.style.width=35*iScreenScale+"px";var oGhost=document.createElement("tr"),oPersoImage=document.createElement("td");oPersoImage.style.width=5*iScreenScale+"px",oPersoImage.style.paddingRight="6px";var cDiv=document.createElement("div");cDiv.style.textAlign="center";var oDiv=document.createElement("div");oDiv.style.position="relative",oDiv.style.width=5*iScreenScale+"px",oDiv.style.height=5*iScreenScale+"px",oDiv.style.marginLeft="auto",oDiv.style.marginRight="auto",oDiv.style.overflow="hidden";var oPImg=new Image;oPImg.style.height=5*iScreenScale+"px",oPImg.style.position="absolute",oPImg.className="pixelated",ghostsData&&(oPImg.alt=ghostsData[1]),oPImg.nb=i,oPImg.style.left=-(30*iScreenScale)+"px",oPImg.onload=function(){var e=this.scrollWidth/24;this.parentNode.style.width=Math.round(e)+"px",this.style.left=-Math.round(6*e)+"px"},oPImg.style.top="0px",oDiv.appendChild(oPImg),cDiv.appendChild(oDiv);var oSpan=document.createElement("span");oSpan.style.display="inline-block",oSpan.style.color="white",oSpan.style.minWidth=10*iScreenScale+"px",oSpan.style.maxWidth=Math.round(13.5*iScreenScale)+"px",oSpan.style.fontSize=Math.round(1.8*iScreenScale)+"px",oSpan.style.overflow="hidden",oSpan.style.textOverflow="ellipsis",oSpan.style.whiteSpace="nowrap",cDiv.appendChild(oSpan),oPersoImage.appendChild(cDiv),oGhost.appendChild(oPersoImage);var oTimeTd=document.createElement("td");oTimeTd.style.textAlign="center",oTimeTd.style.whiteSpace="nowrap";var oPersoTime=document.createElement("span");oPersoTime.style.fontSize=Math.round(5.5*iScreenScale)+"px",oPersoTime.style.color="white",oPersoTime.style.marginLeft=2*iScreenScale+"px",oTimeTd.appendChild(oPersoTime);var oPersoLapTimes=document.createElement("img");oPersoLapTimes.src="images/about.png",oPersoLapTimes.style.position="relative",oPersoLapTimes.style.top=-Math.round(.5*iScreenScale)+"px",oPersoLapTimes.style.width=Math.round(2.5*iScreenScale)+"px",oPersoLapTimes.style.marginLeft=iScreenScale+"px",oPersoLapTimes.style.marginRight=2*iScreenScale+"px",oPersoLapTimes.dataset||(oPersoLapTimes.dataset={}),oTimeTd.appendChild(oPersoLapTimes);var $fancyTitle;oPersoLapTimes.onmouseover=function(){if(!$fancyTitle){$fancyTitle=document.createElement("div"),$fancyTitle.className="ranking_activeplayertitle",$fancyTitle.innerHTML=this.dataset.title,$fancyTitle.style.position="absolute",$fancyTitle.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",$fancyTitle.style.borderRadius=iScreenScale+"px",$fancyTitle.style.zIndex=10,$fancyTitle.style.backgroundColor="rgba(60,109,165, 0.95)",$fancyTitle.style.color="white",$fancyTitle.style.fontSize=Math.round(1.8*iScreenScale)+"px",$fancyTitle.style.lineHeight=Math.round(2*iScreenScale)+"px",$fancyTitle.style.visibility="hidden",$mkScreen.appendChild($fancyTitle);var e=this.getBoundingClientRect();$fancyTitle.style.left=Math.round(e.left+(this.scrollWidth-$fancyTitle.scrollWidth)/2)+"px",$fancyTitle.style.top=e.top+this.scrollHeight+5+"px",$fancyTitle.style.visibility="visible"}},oPersoLapTimes.onmouseout=function(){$fancyTitle&&($mkScreen.removeChild($fancyTitle),$fancyTitle=void 0)},gRecord=ghostsData?ghostsData[3]:void 0;var gID=-1,gTimes,gIDs;oGhost.appendChild(oTimeTd),oTable.appendChild(oGhost),oScr.appendChild(oTable);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Face with this ghost","Affronter ce fant\xF4me"),oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=22*iScreenScale-10+"px",oPInput.style.top=20*iScreenScale+"px",oPInput.style.width=37*iScreenScale+31+"px",oPInput.onclick=function(){seeGhost(!1)},oScr.appendChild(oPInput);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("See race","Voir la course"),oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=22*iScreenScale-10+"px",oPInput.style.top=25*iScreenScale+"px",oPInput.style.width=37*iScreenScale+31+"px",oPInput.onclick=function(){seeGhost(!0)},oScr.appendChild(oPInput);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Play alone","Jouer seul"),oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=22*iScreenScale-10+"px",oPInput.style.top=30*iScreenScale+"px",oPInput.style.width=37*iScreenScale+31+"px",oPInput.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),gPersos.length=0,resetGame(aAvailableMaps[map])},oScr.appendChild(oPInput);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Back","Retour"),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=2*iScreenScale+"px",oPInput.style.top=36*iScreenScale+"px",oPInput.onclick=function(){-1!=gID&&ghostsData?(writeTime(ghostsData[1],ghostsData[2],ghostsData[3],ghostsData[4]),oScr.removeChild(document.getElementById("fGauche")),oScr.removeChild(document.getElementById("ffGauche")),oScr.removeChild(document.getElementById("fDroite")),oScr.removeChild(document.getElementById("ffDroite")),oScr.removeChild(OPFace7),OPFace.style.display="",gID=-1):(oScr.innerHTML="",oContainers[0].removeChild(oScr),isSingle?selectPlayerScreen(0):selectRaceScreen(map-map%4))},oScr.appendChild(oPInput);var OPFace,OPFace7;if(ghostsData){var OPFace=document.createElement("input");OPFace.type="button",OPFace.value=toLanguage("Face with another player...","Affronter un autre joueur..."),OPFace.style.fontSize=2*iScreenScale+"px",OPFace.style.position="absolute",OPFace.style.right=2*iScreenScale+"px",OPFace.style.top=36*iScreenScale+"px",OPFace.onclick=otherGhosts,oScr.appendChild(OPFace),oContainers[0].appendChild(oScr),ghostsData&&writeTime(ghostsData[1],ghostsData[2],ghostsData[3],ghostsData[4]),document.body.style.cursor="default",otherGhostsData&&(gID=otherGhostsData.id,gTimes=otherGhostsData.times,showGhosts())}else otherGhosts();updateMenuMusic(1)}function isChallengeTtCompatible(){if(!clSelected)return!0;var e=challengeRules[clSelected.data.goal.type];return e.is_tt_compatible}function escapeSpecialChars(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function stripSpecialChars(e){return e.replace(/&[#\w]+;/g,"_").replace(/<\w+>(.+?)<\/\w+>/g,"$1")}function mapNameOf(e,t){var i=document.createElement("div"),n=isCup?Math.min(Math.max(9/Math.sqrt(stripSpecialChars(lCircuits[t]).length),1.4),4):2.1;i.style.fontSize=Math.round(e*n)+"px",i.className="mapname",i.style.textAlign="center",i.innerHTML=dCircuits[t];var l=i.querySelector("small");return l&&(l.style.fontSize=2*iScreenScale+"px"),i}function addOption(e,t,n,l,o,a){document.getElementById(e).innerHTML=t.replace(/ /g,"&nbsp;"),document.getElementById(n).innerHTML="";var s=document.createElement("select");s.name=l;for(var r=0,p;r<o.length;r++){var d=document.createElement("option"),c=o[r][0];d.value=c,d.innerHTML=o[r][1],c==a&&(p=r),s.appendChild(d)}s.selectedIndex=p,document.getElementById(n).appendChild(s)}function optionOf(e){return formulaire?1*formulaire.elements[e].value:baseOptions[e]}function displayCommands(e){var t=document.getElementById("commandes");if(t){if(isMobile()){if(document.getElementById("commandes-edit"))return;e=""}var i=!e;t.innerHTML=(i?"":"<div class=\"commandes-list\">"+e+"</div>")+"<img src=\"images/edit-controls.png\" alt=\"Edit\" id=\"commandes-edit\""+(i?" class=\"nocommand\"":"")+" title=\""+toLanguage("More settings","Plus de param\xE8tres")+"\" />",document.getElementById("commandes-edit").onclick=function(){editCommands()}}}function updateCommandSheet(){function e(e,t){var i=language?"P":"J";return 1==oContainers.length?e:i+"1 : "+e+"; "+i+"2 : "+t+""}function t(e){var t=i[e],l=t[0];return t[1]&&n&&(l=t[1]),getKeyName(l)}var i=getCommands(null,2),n=navigator.platform&&0<=navigator.platform.toUpperCase().indexOf("MAC");displayCommands("<strong>"+toLanguage("Move","Se diriger")+"</strong> : "+e(t("up")+t("left")+t("down")+t("right"),t("up_p2")+t("left_p2")+t("down_p2")+t("right_p2"))+"<br /><span style=\"line-height:13px\"><strong>"+toLanguage("Use item","Utiliser un objet")+"</strong> : "+e(t("item"),t("item_p2"))+"<br /><strong>"+toLanguage("Item backwards","Objet en arri\xE8re")+"</strong> : "+e(t("item_back"),t("item_back_p2"))+"<br />"+("BB"==course?"":"<strong>"+toLanguage("Item forwards","Objet en avant")+"</strong> : "+e(t("item_fwd"),t("item_fwd_p2"))+"</span><br />")+"<strong>"+toLanguage("Jump/drift","Sauter/d\xE9raper")+"</strong> : "+e(t("jump"),t("jump_p2"))+("BB"==course?"<br /><strong>"+toLanguage("Inflate a balloon","Gonfler un ballon")+"</strong> : "+e(t("balloon"),t("balloon_p2")):"")+"<br /><strong>"+toLanguage("Rear/Front view","Vue arri&egrave;re/avant")+"</strong> : "+e(t("rear"),t("rear_p2"))+"<br /><strong>"+toLanguage("Pause","Mettre en pause")+"</strong> : "+t("pause")+"<br /><strong>"+toLanguage("Quit","Quitter")+"</strong> : "+t("quit"))}function editCommands(e){function t(e,t){var i=document.createElement("label"),n=document.createElement("input");n.type="checkbox",n.checked=!!G[e],i.appendChild(n);var l=document.createElement("span");l.innerHTML=t,i.appendChild(l),n.onclick=function(){this.checked?G[e]=1:delete G[e],localStorage.setItem("settings",JSON.stringify(G))},W.appendChild(i)}clearInterval(pollingGamepadsHandler);var n=!!e;e=e||{};var l=e.currentTab||0,o=e.selectedPlayer||0,a=e.selectedDevice||"keyboard",s=document.getElementById("control-editor-mask");if(s&&(document.body.removeChild(s),!n))return void(document.querySelector("#commandes strong")&&updateCommandSheet());s=document.createElement("div"),s.id="control-editor-mask",s.onclick=function(){editCommands()};var r=document.createElement("div");r.className="control-editor",r.onclick=function(t){t.stopPropagation()};var p=document.createElement("div");p.className="control-header";var d=document.createElement("div");d.innerHTML=toLanguage("Game settings","Param\xE8tres du jeu"),p.appendChild(d);var c=document.createElement("button");c.className="control-close",c.innerHTML="&times;",c.onclick=function(){editCommands()},p.appendChild(c),r.appendChild(p);var u=document.createElement("div");u.className="control-tabs";for(var m=[toLanguage("Edit controls","Modifier les contr\xF4les"),toLanguage("Advanced settings","Param\xE8tres avanc\xE9s")],y=0;y<m.length;y++)(function(t){var i=document.createElement("div");t||(i.className="control-tab-active"),i.innerHTML=m[t],i.onclick=function(){document.querySelector(".control-tabs .control-tab-active").classList.remove("control-tab-active"),this.classList.add("control-tab-active"),document.querySelector(".control-window .control-window-active").classList.remove("control-window-active"),document.querySelectorAll(".control-window > div")[t].classList.add("control-window-active"),l=t,e.currentTab=l},u.appendChild(i)})(y);r.appendChild(u);var h=document.createElement("div");h.className="control-window";var g=document.createElement("div");if(g.className="control-window-active",!e.pc&&isMobile()){var b=localStorage.getItem("settings.ctrl");b=b?JSON.parse(b):{};var f=document.createElement("div");f.className="control-main-title",f.innerHTML=toLanguage("Command interface","Interface de commandes"),g.appendChild(f);var x=document.createElement("div");x.className="control-type-values";for(var v=[{id:"keyboard",name:toLanguage("Virtual Keyboard","Clavier virtuel"),description:toLanguage("Shows buttons that behave like keys in a keyboard","Affiche des boutons pour simuler les touches d'un clavier"),dropdown:function(e){var t=document.createElement("label"),i=document.createElement("span");i.innerHTML=toLanguage("Keyboard layout:","Disposition des touches :"),t.appendChild(i);var n=document.createElement("select"),l={"":toLanguage("Default","Par d\xE9faut"),h_sym:toLanguage("Horizontal symmetry","Sym\xE9trie horizontale"),v_sym:toLanguage("Vertical symmetry","Sym\xE9trie verticale"),vh_sym:toLanguage("Both symmetries","Sym\xE9trie mixte"),old:toLanguage("Old version","Ancienne version")},o=b.layout||"";for(var a in l){var s=document.createElement("option");s.value=a,a===o&&(s.selected="selected"),s.innerHTML=l[a],n.appendChild(s)}t.appendChild(n),n.onchange=function(){this.value?b.layout=this.value:delete b.layout,localStorage.setItem("settings.ctrl",JSON.stringify(b))},e.appendChild(t)}},{id:"gestures",name:toLanguage("Touch controls","Contr\xF4les tactiles"),description:toLanguage("Swipe the screen to go in the desired direction. Controls similar to Mario Kart Tour","Balayez l'\xE9cran pour vous diriger dans la direction souhait\xE9e. Contr\xF4les similaires \xE0 Mario Kart Tour"),dropdown:function(e){var t=document.createElement("a");t.className="control-touch-help",t.href="#null",t.innerHTML=toLanguage("How touch controls work...","Aide sur les contr\xF4les tactiles..."),t.onclick=function(){return window.open("helpTouchCtrls.php","help","scrollbars=1, resizable=1, width=500, height=500"),!1},e.appendChild(t)}},{id:"external",name:toLanguage("External controller","Contr\xF4leur externe"),description:toLanguage("Connect an external keyboard or gamepad","Connetez un clavier ou une manette externe"),dropdown:function(t){var i=document.createElement("a");i.className="control-ext-settings",i.href="#null",i.innerHTML=toLanguage("Controller settings...","Param\xE8tres du contr\xF4lleur..."),i.onclick=function(){return e.pc=!0,editCommands(e),!1},t.appendChild(i)}}],C=b.mode||"keyboard",y=0;y<v.length;y++)(function(e){var t=document.createElement("div");t.className="control-type-value";var i=document.createElement("label"),n=document.createElement("div");n.className="control-type-input";var l=document.createElement("input");l.type="radio",l.name="control-type",n.appendChild(l),l.onclick=function(){b.mode=e.id,localStorage.setItem("settings.ctrl",JSON.stringify(b));for(var i;i=document.querySelector(".control-type-value.selected");)i.classList.remove("selected");t.classList.add("selected")},e.id===C&&l.click(),i.appendChild(n);var o=document.createElement("div");o.className="control-type-explain";var a=document.createElement("div");a.className="control-type-name",a.innerHTML=e.name,o.appendChild(a);var s=document.createElement("div");s.className="control-type-desc",s.innerHTML=e.description,o.appendChild(s),i.appendChild(o),t.appendChild(i);var r=document.createElement("div");r.className="control-type-extra",e.dropdown&&e.dropdown(r),t.appendChild(r),x.appendChild(t)})(v[y]);g.appendChild(x);var k=document.createElement("div");k.className="control-main-title",k.innerHTML=toLanguage("Other options","Autres options"),g.appendChild(k);var E=document.createElement("div");E.className="control-misc-values";var w=[{key:"autoacc",label:toLanguage("Auto-accelerate","Acc\xE9l\xE9rer automatiquement"),defaultVal:1},{key:"vitem",label:toLanguage("Touch game screen to send an item","Toucher l'\xE9cran de jeu pour lancer un objet"),defaultVal:1},{key:"gyroscope",label:toLanguage("Rotate the screen to turn, like with a steering wheel","Pivotez l'\xE9cran pour tourner, comme avec un volant"),defaultVal:0,onCheck:function(e){e&&"DeviceOrientationEvent"in window&&DeviceOrientationEvent.requestPermission&&DeviceOrientationEvent.requestPermission()}}];w.forEach(function(e){var t=document.createElement("label"),i=document.createElement("input");i.type="checkbox";var n=e.key;i.checked=n in b?b[n]:e.defaultVal,t.appendChild(i);var l=document.createElement("span");l.innerHTML=e.label,t.appendChild(l),i.onclick=function(){var t=+this.checked;t===e.defaultVal?delete b[n]:b[n]=t,localStorage.setItem("settings.ctrl",JSON.stringify(b)),e.onCheck&&e.onCheck(t)},E.appendChild(t)}),g.appendChild(E);var S=document.createElement("div");S.className="control-reset";var T=document.createElement("a");T.href="#null",T.innerHTML=toLanguage("Reset settings","R\xE9tablir les param\xE8tres par d\xE9faut"),T.onclick=function(){return confirm(toLanguage("Reset settings to default?","R\xE9initiliser les param\xE8tres \xE0 ceux par d\xE9faut ?"))&&(localStorage.removeItem("settings.ctrl"),editCommands(e)),!1},S.appendChild(T),g.appendChild(S)}else{var I=document.createElement("div");I.className="control-command-tabs";var z=document.createElement("div");z.className="control-players";for(var y=0;2>y;y++)(function(t){var i=document.createElement("a");i.href="#null",i.className="control-command-tab "+(t===o?"control-command-tab-selected":""),i.innerHTML=toLanguage("Player ","Joueur ")+(t+1),i.onclick=function(){return o!==t&&(e.selectedPlayer=t,editCommands(e),!1)},z.appendChild(i)})(y);I.appendChild(z);var B=document.createElement("div");B.className="control-input-devices";for(var M=[{id:"keyboard",label:toLanguage("Keyboard","Clavier")},{id:"gamepad",label:toLanguage("Gamepad","Manette")}],y=0;y<M.length;y++)(function(t){var i=document.createElement("a");i.href="#null",i.className="control-command-tab "+(t.id===a?"control-command-tab-selected":""),i.innerHTML=t.label,i.onclick=function(){return a!==t.id&&(e.selectedDevice=t.id,editCommands(e),!1)},B.appendChild(i)})(M[y]);I.appendChild(B),g.appendChild(I);var L=[{name:toLanguage("Move forward","Avancer"),key:"up"},{name:toLanguage("Move back","Reculer"),key:"down"},{name:toLanguage("Turn left","Tourner \xE0 gauche"),key:"left"},{name:toLanguage("Turn right","Tourner \xE0 droite"),key:"right"},{name:toLanguage("Use item","Utiliser un objet"),key:"item"},{name:toLanguage("Item backwards","Objet en arri\xE8re"),key:"item_back"},{name:toLanguage("Item forwards","Objet en avant"),key:"item_fwd"},{name:toLanguage("Jump/drift","Sauter/d\xE9raper"),key:"jump"},{name:toLanguage("Inflate balloon","Gonfler un ballon"),key:"balloon"},{name:toLanguage("Rear view","Vue arri\xE8re"),key:"rear"},{name:toLanguage("Pause","Pause"),key:"pause"},{name:toLanguage("Quit","Quitter"),key:"quit"}],H=getCommands(a,o+1),A="";if(o){A="_p2";for(var y=0,_;y<L.length;y++)_=L[y].key+A,H[_]&&(L[y].key=_)}var P=JSON.parse(localStorage.getItem(getLocalControlKey(a))||"{}"),N=navigator.platform&&0<=navigator.platform.toUpperCase().indexOf("MAC"),R="gamepad"===a;if(R&&void 0===P["_id"+A]){var D=document.createElement("div");D.className="control-editor-empty",D.innerHTML="<div class=\"control-editor-empty-title\">\uD83C\uDFAE</div>",D.innerHTML+="<div>"+toLanguage("Connect a gamepad and press any button to continue","Connectez une manette et appuyez sur n'importe quel bouton pour continuer")+"</div>",g.appendChild(D),clearInterval(pollingGamepadsHandler),pollingGamepadsHandler=setInterval(function(){for(var t=navigator.getGamepads(),n=0,l;n<t.length;n++)if(l=t[n],l){var o=getGamepadPressedBtns(l);o.length&&(P["_id"+A]=l.index,P["_name"+A]=l.id,localStorage.setItem(getLocalControlKey(a),JSON.stringify(P)),refreshGameControls(),editCommands(e))}},100)}else{if(R){var F=document.createElement("div");F.className="control-gamepad-reset";var V=document.createElement("span");V.innerHTML="<strong>"+toLanguage("Selected:","S\xE9l\xE9ctionn\xE9 :")+"</strong> "+P["_name"+A],F.appendChild(V);var O=document.createElement("a");O.href="#null",O.innerHTML=toLanguage("[Reset]","[R\xE9initiliser]"),O.onclick=function(){if(confirm(toLanguage("Reset controller selection?","R\xE9initialiser la s\xE9lection de la manette ?"))){delete P["_id"+A],delete P["_name"+A];for(var t=0;t<L.length;t++)delete P[L[t].key];localStorage.setItem(getLocalControlKey(a),JSON.stringify(P)),refreshGameControls(),editCommands(e)}return!1},F.appendChild(O),g.appendChild(F)}var q=document.createElement("div");q.className="control-editor-grid";for(var y=0;y<L.length;y++)(function(t){var i=H[t.key],n=i;"keyboard"===a&&(n=i[0],i[1]&&N&&(n=i[1]));var l=document.createElement("div"),s=document.createElement("div");s.className="control-label",s.innerHTML=t.name,l.appendChild(s);var r=document.createElement("button");switch(r.className="control-input",r.innerHTML=getKeyName(n,a),r.onfocus=function(){if(this.innerHTML="...",R){var e={},l=!1;clearInterval(pollingGamepadsHandler),pollingGamepadsHandler=setInterval(function(){var s=findGamePadById(P,o);if(s){for(var p=getGamepadPressedBtns(s),d=0,c;d<p.length;d++)c=p[d],e[c.key]=c;if(p.length)l=!0;else if(l){clearInterval(pollingGamepadsHandler);var u=[];for(var m in e){var c=e[m],y;switch(c.type){case"stick":for(y||(y=[],u.push(y));y.length<c.id;)y.push(0);y[c.id]=c.value;break;case"button":u.push(c.id);}}n=u,P[t.key]=n,localStorage.setItem(getLocalControlKey(a),JSON.stringify(P)),refreshGameControls(),r.blur()}}},67)}},r.onblur=function(){clearInterval(pollingGamepadsHandler),this.innerHTML=getKeyName(n,a)},r.onclick=function(){this.focus()},a){case"keyboard":r.onkeydown=function(i){i.preventDefault(),i.stopPropagation(),n=i.keyCode,P[t.key]=n,localStorage.setItem(getLocalControlKey(a),JSON.stringify(P)),refreshGameControls(),this.blur()};break;case"gamepad":}l.appendChild(r),q.appendChild(l)})(L[y]);g.appendChild(q);var S=document.createElement("div");S.className="control-reset";var T=document.createElement("a");T.href="#null",T.innerHTML=toLanguage("Reset controls","R\xE9tablir les contr\xF4les par d\xE9faut"),T.onclick=function(){return confirm(toLanguage("Reset to default controls?","Confirmer la r\xE9initialisation des contr\xF4les ?"))&&(localStorage.removeItem(getLocalControlKey(a)),refreshGameControls(),editCommands(e)),!1},S.appendChild(T),g.appendChild(S)}}h.appendChild(g);var W=document.createElement("div");W.className="control-settings";var X=document.createElement("div");X.className="control-settings-info",X.innerHTML=toLanguage("Graphics settings","Param\xE8tres graphiques"),W.appendChild(X);var G=localStorage.getItem("settings");G=G?JSON.parse(G):{};var K={ld:toLanguage("Don't display heavy elements (trees, decors)","D\xE9sactiver l'affichage des \xE9l\xE9ments lourds (arbres, d\xE9cors)"),nogif:toLanguage("Disable animation in gif-format tracks","D\xE9sactiver les animations des circuits au format gif"),nowater:toLanguage("Disable water animation (Palm Shore Arena)","D\xE9sactiver l'animation de l'eau (DS Feuille de Palmier)"),nomap:toLanguage("Disable mini-map display","D\xE9sactiver l'affichage de la mini-map")};for(var U in K)t(U,K[U]);{var Y=document.createElement("label");Y.style.marginLeft="5px";var J=document.createElement("span");J.innerHTML=toLanguage("Quality:","Qualit\xE9 :"),Y.appendChild(J);var Q=document.createElement("select");Q.style.width="auto",Q.style.marginLeft="6px",Q.onchange=function(){MarioKartControl.setQuality(+this.value)};for(var $=[[5,toLanguage("Pixelated","Pixelis\xE9")],[4,toLanguage("Low","Inf\xE9rieure")],[2,toLanguage("Medium","Moyenne")],[1,toLanguage("High","Sup\xE9rieure")]],y=0;y<$.length;y++){var Z=$[y],ee=document.createElement("option");ee.value=Z[0],ee.innerHTML=Z[1],Q.appendChild(ee)}localStorage.getItem("iQuality")&&(Q.value=localStorage.getItem("iQuality")),Y.appendChild(Q),W.appendChild(Y)}t("spd",toLanguage("Enable speedometer","Activer le compteur de vitesse"));var X=document.createElement("div");X.className="control-settings-info",X.innerHTML=toLanguage("Sound settings","Param\xE8tres sonores"),W.appendChild(X);var te={music:toLanguage("Music volume","Volume musique"),sfx:toLanguage("SFX volume","Volume bruitages")},ie=localStorage.getItem("settings.vol");for(var U in ie=ie?JSON.parse(ie):{},te)(function(e){var t=document.createElement("label");t.className="control-setting-range";var i=document.createElement("span");i.innerHTML=te[e],t.appendChild(i);var n=document.createElement("input");n.type="range",n.min=0,n.max=1,n.step=.05;var l=ie[e];null==l&&(l=1),n.value=l,t.appendChild(n);var o=document.createElement("span");o.innerHTML=Math.round(100*l)+"%",o.style.width="2em",t.appendChild(o),n.onchange=function(){ie[e]=+this.value,localStorage.setItem("settings.vol",JSON.stringify(ie)),o.innerHTML=Math.round(100*ie[e])+"%",updateVolumeSettings(ie)},W.appendChild(t)})(U);if(1<iFps){function e(){oe.style.display=0==G.framerad?"none":"block"}var ne=getFrameSettings(G),X=document.createElement("div");X.className="control-settings-info",X.innerHTML=toLanguage("Framerate settings","Param\xE8tres FPS"),W.appendChild(X);var le=ne.framerad||ne.defaultframerad,oe;{var Y=document.createElement("label");Y.style.display="inline-block";var ae=document.createElement("input");ae.type="checkbox",ae.checked=0!=G.framerad,Y.appendChild(ae);var J=document.createElement("span");J.innerHTML=toLanguage("Enable motion trail","Activer le motion trail"),Y.appendChild(J),ae.onclick=function(){this.checked?le?G.framerad=le:delete G.framerad:G.framerad=0,localStorage.setItem("settings",JSON.stringify(G)),e()},W.appendChild(Y)}{oe=document.createElement("div"),oe.className="motion-trail-settings";{var Y=document.createElement("label"),J=document.createElement("span");J.innerHTML=toLanguage("Frame&nbsp;count:","Nb&nbsp;frames&nbsp;:"),Y.appendChild(J);var Q=document.createElement("select");Q.style.width="auto",Q.style.marginLeft="6px",Q.onchange=function(){G.framerad=this.value,localStorage.setItem("settings",JSON.stringify(G))};for(var y=1;10>y;y++){var Z=$[y],ee=document.createElement("option");ee.value=y,ee.innerHTML=y,Q.appendChild(ee)}Q.value=le,Y.appendChild(Q),oe.appendChild(Y)}{var Y=document.createElement("label"),J=document.createElement("span");J.innerHTML=toLanguage("Opacity:","Opacit\xE9&nbsp;:"),Y.appendChild(J);var se=document.createElement("input");se.type="number",se.setAttribute("step","0.01"),se.style.width="50px",se.style.marginLeft="6px",se.onchange=function(){G.frameopacity=Math.min(1,Math.max(0,this.value)),this.value=G.frameopacity,localStorage.setItem("settings",JSON.stringify(G))},se.value=ne.frameopacity,Y.appendChild(se),oe.appendChild(Y)}{var Y=document.createElement("label"),J=document.createElement("span");J.innerHTML=toLanguage("Blur:","Flou&nbsp;:"),Y.appendChild(J);var se=document.createElement("input");se.type="number",se.setAttribute("step","0.1"),se.style.width="42px",se.style.marginLeft="6px",se.onchange=function(){G.frameblur=Math.min(10,Math.max(0,this.value)),this.value=G.frameblur,localStorage.setItem("settings",JSON.stringify(G))},se.value=ne.frameblur,Y.appendChild(se),J=document.createElement("span"),J.innerHTML=toLanguage("&nbsp;px","&nbsp;px"),Y.appendChild(J),oe.appendChild(Y)}W.appendChild(oe)}e();{var Y=document.createElement("label");Y.style.marginLeft="5px";var J=document.createElement("span");J.innerHTML=toLanguage("Interframe interpolation:","Interpolation inter-frames :"),Y.appendChild(J);var Q=document.createElement("select");Q.style.width="85px",Q.style.marginLeft="6px",Q.onchange=function(){G.frameint=this.value,localStorage.setItem("settings",JSON.stringify(G))};for(var $=[["ease_out_linear",toLanguage("Linear &nbsp; &nbsp; &nbsp; (Smoothest)","Lin\xE9aire &nbsp; (Tr\xE8s fluide)")],["ease_out_quad",toLanguage("Quadratic (Smooth)","Quadratique (Fluide)")],["ease_out_cubic",toLanguage("Cubic &nbsp; &nbsp; &nbsp; &nbsp; (Medium)","Cubique &nbsp; &nbsp; (Moyen)")],["ease_out_quart",toLanguage("Quartic &nbsp; &nbsp; (Sharp)","Quartique &nbsp; (Saccad\xE9)")],["ease_out_exp",toLanguage("Exponential (Sharpest)","Exponentiel (Tr\xE8s saccad\xE9)")]],y=0;y<$.length;y++){var Z=$[y],ee=document.createElement("option");ee.value=Z[0],ee.innerHTML=Z[1],Q.appendChild(ee)}Q.value=ne.frameint,Y.appendChild(Q),W.appendChild(Y)}}var S=document.createElement("div");S.className="control-reset";var T=document.createElement("a");T.href="#null",T.innerHTML=toLanguage("Reset settings","R\xE9tablir les param\xE8tres par d\xE9faut"),T.onclick=function(){return confirm(toLanguage("Reset settings to default?","R\xE9initiliser les param\xE8tres \xE0 ceux par d\xE9faut ?"))&&(localStorage.removeItem("settings"),localStorage.removeItem("settings.vol"),localStorage.removeItem("iQuality"),editCommands(e)),!1},S.appendChild(T),W.appendChild(S),h.appendChild(W),r.appendChild(h),s.appendChild(r),document.body.appendChild(s),h.style.width=h.scrollWidth+"px",l&&document.querySelectorAll(".control-tabs > div")[l].click()}function getKeyName(e,t){switch(t){case"gamepad":for(var n=[],l=0,o;l<e.length;l++)if(o=e[l],"object"==typeof o&&o.length)for(var a=0;a<o.length;a++)0<o[a]?n.push(a%2?"\u2193":"\u2192"):0>o[a]&&n.push(a%2?"\u2191":"\u2190");else"number"==typeof o&&n.push("("+o+")");return n.join("+");break;default:return this.keyMatching||(this.keyMatching=["","","","Break","","","","","Backspace","Tab","","","Clear","Enter","","","Shift","Ctrl","Alt","Pause","CapsLock","Hangul","","","","Hanja","",toLanguage("Escape","\xC9chap"),"Conversion","Non-conversion","","",toLanguage("Spacebar","Espace"),"PageUp","PageDown","End","Home","&larr;","&uarr;","&rarr;","&darr;","Select","Print","Execute",toLanguage("Print Screen","ImpEcr"),"Inser",toLanguage("Delete","Suppr"),"Help","0","1","2","3","4","5","6","7","8","9",":","=","&lt;","=","","SS","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Meta","Meta","Meta","","Sleep","0","1","2","3","4","5","6","7","8","9","&times;","+",".","-",".","/","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NumLock","ScrollLock","","","","","","","","","","","","","","","^","!","\u061B","#","$","\xD9","PageDown","PageUp","Refresh",")","*","~","Home","-","Vol. down","Vol. up","Next","Previous","Stop","Play/pause","@","Mute","Vol. down","Vol. up","","","\xD1","=",",","#",".","/","%","\xB0",",","","","","","","","","","","","","","","","","","","","","","","","","","{","\\","}","'","`","Meta","AltGr","&lt;","","","","Compose","\xC7","","Forward","Back","Non-conversion","","","","","Alphanumeric","","Hiragana","Half-width","Kanji","","","","","","","Unlock Trackpad","","","","Toggle Touchpad"]),this.keyMatching[e]?this.keyMatching[e]:"#"+e;}}function getGamepadPressedBtns(e){var t=[];if(e.axes)for(var n=0;n<e.axes.length;n++)Math.abs(e.axes[n])>=.75&&t.push({key:"stick."+n,type:"stick",id:n,value:e.axes[n]});if(e.buttons)for(var n=0;n<e.buttons.length;n++)e.buttons[n]&&e.buttons[n].pressed&&t.push({key:"button."+n,type:"button",id:n});return t}function isGamepadControlSubset(e,t){for(var n=0,l;n<e.length;n++)if(l=e[n],t.every(function(e){return e.key!==l.key||e.value!==l.value}))return!1;return!0}function getLocalControlKey(e){return e&&"keyboard"!==e?"controls."+e:"controls"}function findGamePadById(e,t){if(e){var n=navigator.getGamepads(),l="";t&&(l="_p2");for(var o=0,a;o<n.length;o++)if(a=n[o],a&&a.id===e["_name"+l]&&a.index===e["_id"+l])return a;for(var o=0,a;o<n.length;o++)if(a=n[o],a&&a.id===e["_name"+l])return a;for(var o=0,a;o<n.length;o++)if(a=n[o],a&&a.index===e["_id"+l])return a}}function getCommands(e,t){t=t||strPlayer.length;var n;if("gamepad"!==e)n={up:[38],down:[40],left:[37],right:[39],item:[32],item_back:[67],item_fwd:[86],jump:[17,18],balloon:[16],rear:[88],pause:[80],quit:[27],cheat:[120,33,57,105]},1<t&&(n.up_p2=[69],n.down_p2=[68],n.left_p2=[83],n.right_p2=[70],n.item_p2=[toLanguage(65,81)],n.item_back_p2=[toLanguage(87,65)],n.item_fwd_p2=[82],n.jump_p2=[71],n.balloon_p2=[84],n.rear_p2=[toLanguage(87,90)]);else if(n={up:[1],down:[0],left:[[-1]],right:[[1]],item:[6],item_back:[[0,1],6],item_fwd:[[0,-1],6],jump:[7],balloon:[2],rear:[3],pause:[9],quit:[16]},1<t)for(var l=["up","down","left","right","item","item_back","item_fwd","jump","balloon","rear"],o=0,a;o<l.length;o++)a=l[o],n[a+"_p2"]=JSON.parse(JSON.stringify(n[a]));var s=n,r=localStorage.getItem(getLocalControlKey(e));if(r){r=JSON.parse(r);for(var p in r)s[p]=r[p],(!e||"keyboard"===e)&&(s[p]=[s[p]])}return s}function getGameControls(){var e={keyboard:{}},t=getCommands("keyboard");for(var n in t)for(var l=0,o;l<t[n].length;l++)o=t[n][l],e.keyboard[o]||(e.keyboard[o]=n);if(t=getCommands("gamepad"),"_id"in t||oPlayers[1]&&"_id_p2"in t){for(var a=[[]],l=0;l<oPlayers.length;l++)a[l]=[];var s=Object.values(t).length;for(var n in t)if(!n.startsWith("_")){var r=0;if(n.endsWith("_p2")&&(r=1,n=n.substring(0,n.length-3)),a[r]){for(var p=[],l=0,d;l<t[n].length;l++)if(d=t[n][l],"object"==typeof d&&d.length)for(var c=0;c<d.length;c++)0<Math.abs(d[c])&&p.push({key:"stick."+c,type:"stick",id:c,value:d[c],isPressed:function(e){return Math.sign(e.value)===Math.sign(this.value)}});else"number"==typeof d&&p.push({key:"button."+d,type:"button",id:d,isPressed:function(){return!0}});a[r].push({priority:p.length-a[r].length/s,key:n,value:p})}}for(var l=0;l<a.length;l++)a[l].sort(function(e,t){return t.priority-e.priority});e.gamepad=a.map(function(e,n){var i=n?"_p2":"";return{_id:t["_id"+i],_name:t["_name"+i],controls:e.map(function(e){return{key:e.key,inputs:e.value}})}})}return e}function initGamepadMenuEvents(){function e(e,t){if(t[e]=!0,!n[e])if(oPlayers.length){var i=document.getElementById("infos0");i&&i.onkeydown&&i.contains(document.activeElement)&&("ArrowUp"===e?i.onkeydown({keyCode:38}):"ArrowDown"===e?i.onkeydown({keyCode:40}):"Enter"===e?(document.activeElement.click(),i.onkeydown({keyCode:13})):void 0)}else document.onkeydown({key:e})}if(gamepadMenuEventsHandler)return!1;if(!gameControls.gamepad)return!1;var t=navigator.getGamepads();if(!t.some(Boolean))return!1;var n={},l=[];return gamepadMenuEventsHandler=setInterval(function(){var t=getGamepadInputsData(0,l);if(t){for(var o=t.pressedBtnsRaw,a=t.pressActions,s={},r=0,p;r<o.length;r++)if(p=o[r],"stick"===p.type){var d=null;d=p.id%2?0<p.value?"ArrowDown":"ArrowUp":0<p.value?"ArrowRight":"ArrowLeft",e(d,s)}for(var c=0;c<a.length;c++){var u=a[c],m=u.key;if(!n[m]){var d=null;"up"===m?d="Enter":"down"===m?d="_Back":void 0,d&&e(d,s)}}n=s}},67),window.gamePadEventListener&&(window.removeEventListener("gamepadconnected",window.gamePadEventListener),window.gamePadEventListener=void 0),!0}function refreshGameControls(){return gameControls=getGameControls(),initGamepadMenuEvents()}function toLanguage(e,t){return language?e:t}function toPlace(e){var t;if(language){var i=e%100;if(10<=i&&20>i)t="th";else switch(e%10){case 1:t="st";break;case 2:t="nd";break;case 3:t="rd";break;default:t="th";}}else t=1==e?"er":"e";return e+"<sup>"+t+"</sup>"}function toTitle(e,t){var i=document.createElement("div");return i.style.width=80*iScreenScale+"px",i.style.fontSize=Math.round(8*iScreenScale)+"px",i.style.fontWeight="normal",i.style.position="absolute",i.style.left="0px",i.style.top=Math.round(t*iScreenScale)+"px",i.style.textAlign="center",i.style.color="#FEFF3F",i.innerHTML=e,i.style.fontFamily="Tahoma",i}function ucwords(e){return e.replace(/(^([a-zA-Z\p{M}]))|([ -][a-zA-Z\p{M}])/g,function(e){return e.toUpperCase()})}function toPerso(e){if(isCustomPerso(e))return customPersos[e].name;var t=e;return language?"maskass"==e?t="shy guy":"skelerex"==e?t="dry bones":"harmonie"==e?t="rosalina":"roi_boo"==e?t="king boo":"frere_marto"==e?t="hammer bro":"bowser_skelet"==e?t="dry bowser":"flora_piranha"==e&&(t="petey piranha"):"frere_marto"==e&&(t="fr\xE8re marto"),t=t.replace(/_/g," "),t=ucwords(t),t}function isMobile(){return isMobileCache}function isChatting(){if(!isOnline)return!1;var e=document.querySelector("form.online-chat-answer input[name=\"rMessage\"]");return!!e&&document.activeElement==e}function onButtonTouch(t){t&&t.preventDefault(),this.style.backgroundColor="#603",this.dataset.pressed="1",navigator.vibrate(30);for(var e=this.dataset.key.split(","),n=0;n<e.length;n++)doPressKey(e[n]);return!1}function onButtonPress(){this.style.backgroundColor="",this.dataset.pressed="";for(var e=this.dataset.key.split(","),t=0;t<e.length;t++)doReleaseKey(e[t])}function setChat(){function removeBlockDialog(){return!!oBlockDialog&&(oChat.removeChild(oBlockDialog),oBlockDialog=null,!0)}function showMemberList(title,blockedFn,onSelect){if(!removeBlockDialog()){oBlockDialog=document.createElement("div"),oBlockDialog.className="online-chat-blockdialog",oBlockDialog.style.position="absolute",oBlockDialog.style.left="85px",oBlockDialog.style.top="8%",oBlockDialog.style.width="200px",oBlockDialog.style.border="double 4px silver",oBlockDialog.style.backgroundColor="#222";var oBlockTitle=document.createElement("h1");oBlockTitle.innerHTML=title,oBlockDialog.appendChild(oBlockTitle);var oBlockClose=document.createElement("input");oBlockClose.type="button",oBlockClose.onclick=function(){removeBlockDialog()},oBlockClose.value="\xD7",oBlockDialog.appendChild(oBlockClose);var oBlockMembers=document.createElement("div");oBlockMembers.className="online-chat-blockdialog-members",xhr("listCoursePlayers.php",onlineSpectatorId?"spectator="+onlineSpectatorId:"",function(reponse){if(reponse){try{var rCode=eval(reponse)}catch(t){return!1}for(var i=0;i<rCode.length;i++){var memberId=rCode[i][0],memberPseudo=rCode[i][1],memberBlocked=blockedFn(rCode[i]),oBlockMember=document.createElement("div");oBlockMember.dataset||(oBlockMember.dataset={}),oBlockMember.dataset.id=memberId,oBlockMember.dataset.blocked=memberBlocked?"1":"",oBlockMember.innerHTML=memberPseudo,oBlockMember.onclick=function(){var e=this;onSelect(this.dataset.id,!this.dataset.blocked,function(){e.dataset.blocked=e.dataset.blocked?"":"1"})},oBlockMembers.appendChild(oBlockMember)}return!0}return!1}),oBlockDialog.appendChild(oBlockMembers),oChat.appendChild(oBlockDialog)}}function refreshChat(){chatting?xhr("chat.php","lastmsg="+iChatLastMsg+(onlineSpectatorId?"&spectator="+onlineSpectatorId:""),function(reponse){if(reponse){try{var rCode=eval(reponse)}catch(t){return!1}if(-1!=rCode){for(var cPlayers=rCode[0],currentConnectedPlayers={},i=0,cPlayer;i<cPlayers.length;i++){if(cPlayer=cPlayers[i],currentConnectedPlayers[cPlayer.id]=1,cPlayer.id===identifiant){cPlayerPeers[cPlayer.id]!==cPlayer.peer&&"inline-block"===vChatActions.style.display&&(cPlayerPeers[cPlayer.id]&&function(e){vChatActions.style.display="none",rtcService.quitVocChat({callback:function(){delete cPlayerPeers[e],rtcService.joinVocChat({success:function(){vChatActions.style.display="inline-block"},error:function(){vConnectes.style.display=""},muted:!!vcaMute.dataset.muted})}})}(cPlayer.id),cPlayerPeers[cPlayer.id]=cPlayer.peer);continue}var sNom=jConnectes.querySelector("[data-player='"+cPlayer.id+"']");sNom||(sNom=document.createElement("div"),!sNom.dataset&&(sNom.dataset={}),sNom.dataset.player=cPlayer.id,sNom.className="online-chat-playerlistelt",sNom.innerHTML="<span class=\"online-chat-playerlistname\"></span><div class=\"online-chat-playerlisticon\"><img class=\"online-chat-spectator\" alt=\"Spectator\" title=\""+toLanguage("Spectator mode","Mode spectateur")+"\" src=\"images/ic_spectator.png\" /><div class=\"online-chat-playerlisticonwrapper\"><div class=\"online-chat-playerlistvolume\"></div><img alt=\"Voc\" /></div></div>",jConnectes.appendChild(sNom));var isIcon=!1;if(sNom.querySelector(".online-chat-playerlistname").innerText=cPlayer.name,cPlayer.spectator?(sNom.querySelector(".online-chat-spectator").style.display="",isIcon=!0):sNom.querySelector(".online-chat-spectator").style.display="none",cPlayer.peer){isIcon=!0,sNom.querySelector(".online-chat-playerlisticonwrapper").style.display="",sNom.querySelector(".online-chat-playerlisticonwrapper img").src="images/"+(cPlayer.muted?"ic_muted":"ic_voc")+".png";var cPeer=rtcService.getPeer(cPlayer.peer);if(cPeer&&cPeer.audio&&!cPeer.recorderHandler&&function(e,t){if(t){var i=new AudioContext,n=i.createAnalyser();i.createMediaStreamSource(e.audio.srcObject).connect(n);var o=new Uint8Array(n.fftSize);e.recorderHandler=setInterval(function(){if(!e.audio.parentNode||!document.body.contains(t)||!cPlayerPeers[identifiant])return clearInterval(e.recorderHandler),delete e.recorderHandler,n.disconnect(),t.style.width="",t.style.height="",t.style.left="",void(t.style.top="");n.getByteTimeDomainData(o);for(var a=0,s=0;s<o.length;s++)a+=Math.abs(o[s]-128);a/=o.length;var r=Math.pow(a/128,.15),p=6+18*r;14>p&&(p=0);var d=(16-p)/2;t.style.width=Math.round(p)+"px",t.style.height=Math.round(p)+"px",t.style.left=Math.round(d-1)+"px",t.style.top=Math.round(d+1)+"px"},300)}}(cPeer,sNom.querySelector(".online-chat-playerlistvolume")),cPlayerPeers[cPlayer.id]=cPlayer.peer,cPlayer.ignored)rtcService.removePeer(cPlayer.peer);else{var lastUpdate;rtcService.addPeer(cPlayer.peer,{loading:function(){vcLoading.style.display="",lastUpdate=++vcLoading.dataset.lastUpdate},success:function(){vcLoading.dataset.lastUpdate==lastUpdate&&(vcLoading.style.display="none")},error:function(){vcLoading.dataset.lastUpdate==lastUpdate&&(vcLoading.style.display="none")}})}}else sNom.querySelector(".online-chat-playerlisticonwrapper").style.display="none",rtcService.removePeer(cPlayerPeers[cPlayer.id]),delete cPlayerPeers[cPlayer.id];sNom.querySelector(".online-chat-playerlisticon").style.display=isIcon?"":"none"}for(var cPlayerId in cPlayerPeers)currentConnectedPlayers[cPlayerId]||(rtcService.removePeer(cPlayerPeers[cPlayerId],{disconnectReceiver:!0}),delete cPlayerPeers[cPlayerId]);for(var sNoms=jConnectes.querySelectorAll("[data-player]"),i=0,sNom;i<sNoms.length;i++)sNom=sNoms[i],currentConnectedPlayers[sNom.dataset.player]||jConnectes.removeChild(sNom);var messages=rCode[1];if(messages.length){var lastMsgId=messages.length-1;iChatLastMsg=messages[lastMsgId][2];for(var i=0;i<=lastMsgId;i++)addMsgToChat(messages[i][0],messages[i][1]);for(var pMessages=oMessages.getElementsByTagName("p"),cMessages=oMessages.getElementsByClassName("online-chat-message");40<pMessages.length+cMessages.length;)oMessages.removeChild(pMessages[0])}setTimeout(refreshChat,1e3)}else chatting=!1,stopVocChat();return!0}return!1}):document.body.removeChild(oChat)}function addMsgToChat(e,t){var i=oMessages.children[oMessages.children.length-1],n;if(!i||i.dataset.pseudo!==e||i.dataset.lastts<Date.now()-4e4){n=document.createElement("p"),n.dataset.pseudo=e,n.dataset.lastts=Date.now();var l=document.createElement("div");l.className="online-chat-pseudo",l.innerHTML=e,n.appendChild(l)}var o=document.createElement("div");o.style.color="white",o.className="online-chat-message",o.style.fontWeight="normal",o.innerHTML=t,n&&n.appendChild(o);var a=oMessages.scrollHeight-oMessages.clientHeight<=oMessages.scrollTop+1;n?oMessages.appendChild(n):(i.dataset.lastts=Date.now(),i.appendChild(o)),a&&(oMessages.scrollTop=oMessages.scrollHeight-oMessages.clientHeight)}if(!chatting){chatting=!0;for(var oChats=document.getElementsByClassName("online-chat");oChats.length;)document.body.removeChild(oChats[0]);var oChat=document.createElement("div");oChat.className="online-chat";var oConnectes=document.createElement("p");oConnectes.className="online-chat-connecteds";var oPlayersListCtn=document.createElement("div");oPlayersListCtn.className="online-chat-playerlistctn";var iConnectes=document.createElement("span");iConnectes.innerHTML=toLanguage("Currently online: ","Actuellement en ligne : "),oPlayersListCtn.appendChild(iConnectes);var jConnectes=document.createElement("span");jConnectes.style.color="white",oPlayersListCtn.appendChild(jConnectes),oConnectes.appendChild(oPlayersListCtn);var oChatActions=document.createElement("div");oChatActions.className="online-chat-actions";var vConnectes=document.createElement("button");vConnectes.className="disablable",vConnectes.title=language?"Join voice chat":"Rejoindre salon vocal";var viConnectes=document.createElement("img");viConnectes.alt="Voc",viConnectes.src="images/ic_voc.png",vConnectes.appendChild(viConnectes),vConnectes.onclick=function(){function t(){vtConnectes.nodeValue=language?"Voice chat":"Chat vocal",vConnectes.disabled=!1}rtcService.joinVocChat({success:function(){vConnectes.style.display="none",vChatActions.style.display="inline-block",vcLoading.style.display="";var e=++vcLoading.dataset.lastUpdate;setTimeout(function(){vcLoading.dataset.lastUpdate==e&&(vcLoading.style.display="none")},1e3),t()},error:function(i){alert((language?"Unable to join voice chat:":"Impossible de rejoindre le chat vocal : ")+i),t()},muted:!!vcaMute.dataset.muted}),vConnectes.disabled=!0,vtConnectes.nodeValue=language?"Joining...":"Chargement..."},vConnectes.onmouseover=function(){viConnectes.src="images/ic_voc_h.png"},vConnectes.onmouseout=function(){viConnectes.src="images/ic_voc.png"};var vtConnectes=document.createTextNode(language?"Voice chat":"Chat vocal");vConnectes.appendChild(vtConnectes),vConnectes.style.marginRight="10px",oChatActions.appendChild(vConnectes);var vChatActions=document.createElement("div");vChatActions.className="vocal-chat-actions",vChatActions.style.display="none";var vcaMute=document.createElement("button");vcaMute.title=language?"Mute":"Muet";var vcaiMute=document.createElement("img");vcaiMute.src="images/ic_mic.png",vcaMute.appendChild(vcaiMute),vcaMute.onmouseover=function(){vcaiMute.src=vcaMute.dataset.muted?"images/ic_muted_h.png":"images/ic_mic_h.png"},vcaMute.onmouseout=function(){vcaiMute.src=vcaMute.dataset.muted?"images/ic_muted.png":"images/ic_mic.png"},vcaMute.onclick=function(){function e(){vcaMute.disabled=!1}vcaMute.disabled=!0,vcaMute.dataset.muted?(vcaMute.dataset.muted="",rtcService.toggleMute(!1,e),vcaiMute.src="images/ic_mic.png"):(vcaMute.dataset.muted=1,rtcService.toggleMute(!0,e),vcaiMute.src="images/ic_muted.png")},vChatActions.appendChild(vcaMute);var vcaHangup=document.createElement("button");vcaHangup.title=language?"Hang up":"Raccrocher";var vcaiHangup=document.createElement("img");vcaiHangup.src="images/ic_hangup.png",vcaHangup.appendChild(vcaiHangup),vcaHangup.onmouseover=function(){vcaiHangup.src="images/ic_hangup_h.png"},vcaHangup.onmouseout=function(){vcaiHangup.src="images/ic_hangup.png"},vcaHangup.onclick=function(){cPlayerPeers={},rtcService.quitVocChat({callback:function(){vConnectes.style.display=""}}),vChatActions.style.display="none"},vChatActions.appendChild(vcaHangup);var vcLoading=document.createElement("span");vcLoading.className="vocal-chat-loading",vcLoading.style.display="none",vcLoading.dataset||(vcLoading.dataset={}),vcLoading.dataset.lastUpdate=0;var vciLoading=document.createElement("img");vciLoading.src="images/ic_loading.png",vcLoading.appendChild(vciLoading),vChatActions.appendChild(vcLoading),oChatActions.appendChild(vChatActions);var bConnectes=document.createElement("button");bConnectes.title=language?"Ignore player...":"Ignorer un joueur...",bConnectes.onmouseover=function(){biConnectes.src="images/ic_block_h.png"},bConnectes.onmouseout=function(){biConnectes.src="images/ic_block.png"},oChatActions.appendChild(bConnectes);var oBlockDialog;bConnectes.onclick=function(){return showMemberList(language?"Ignore member":"Ignorer un membre",function(e){return e[2]},function(e,t,i){xhr(t?"ignore.php":"unignore.php","member="+e,function(e){return 1==e}),i()}),!1};var biConnectes=document.createElement("img");if(biConnectes.alt="Block",biConnectes.src="images/ic_block.png",bConnectes.appendChild(biConnectes),bConnectes.appendChild(document.createTextNode(language?"Ignore...":"Ignorer...")),oChatActions.appendChild(bConnectes),mIsModerator){var mConnectes=document.createElement("button");mConnectes.title=language?"Mute player (admin)":"Muter un joueur (admin)",mConnectes.onmouseover=function(){miConnectes.src="images/ic_mute_h.png"},mConnectes.onmouseout=function(){miConnectes.src="images/ic_mute.png"},mConnectes.onclick=function(){return showMemberList(language?"Mute member":"Muter un membre",function(e){return e[3]},function(e,t,i){var n=1;t&&(n=prompt(language?"Mute for (minutes):":"Muter pendant (minutes) :",10)),0<n&&(xhr(t?"mute.php":"unmute.php","member="+e+"&duration="+n,function(e){return 1==e}),i())}),!1};var miConnectes=document.createElement("img");miConnectes.alt="Mute",miConnectes.src="images/ic_mute.png",mConnectes.appendChild(miConnectes),mConnectes.appendChild(document.createTextNode(language?"Mute...":"Muter...")),oChatActions.appendChild(mConnectes)}oConnectes.appendChild(oChatActions);var oCloseChatCtn=document.createElement("div");oCloseChatCtn.className="online-chat-closectn";var oCloseChat=document.createElement("button");oCloseChat.className="online-chat-close",oCloseChat.innerHTML="&times",oCloseChat.onclick=function(){oChat.classList.add("online-chat-closed")},oCloseChatCtn.appendChild(oCloseChat);var oOpenChat=document.createElement("button");oOpenChat.className="online-chat-open",oOpenChat.innerHTML="\u25A1",oOpenChat.onclick=function(){oChat.classList.remove("online-chat-closed")},oCloseChatCtn.appendChild(oOpenChat),oChat.appendChild(oCloseChatCtn);var oMessages=document.createElement("div");oMessages.className="online-chat-messages";var oRepondre=document.createElement("form");oRepondre.className="online-chat-answer";var rMessage=document.createElement("input");rMessage.type="text",rMessage.name="rMessage",rMessage.onkeydown=function(t){38==t.keyCode?this.blur():t.stopPropagation()},rMessage.onkeyup=function(t){t.stopPropagation()};var rEnvoi=document.createElement("input");rEnvoi.type="submit",rEnvoi.value=toLanguage("Send","Envoyer"),oRepondre.appendChild(rMessage),oRepondre.appendChild(rEnvoi),oRepondre.onsubmit=function(){if(rMessage.value){var e=rMessage.value;xhr("parler.php","msg="+encodeURIComponent(e).replace(/\+/g,"%2B")+(onlineSpectatorId?"&spectator="+onlineSpectatorId:""),function(t){var i;switch(+t){case-1:i=toLanguage("inappropriate words","mots inappropri\xE9s");break;case-2:i=toLanguage("spam","spam");break;case-3:i=toLanguage("too long","trop long");break;case-4:addMsgToChat(mPseudo,e);}if(i){var n=document.createElement("p");n.className="chatlog",n.innerHTML="<em>"+toLanguage("Message not sent (reason: "+i+")","Message non envoy\xE9 (raison : "+i+")")+"</em>",oMessages.appendChild(n),oMessages.scrollTop=oMessages.scrollHeight-oMessages.clientHeight}return!0}),rMessage.value=""}return!1},oChat.appendChild(oConnectes),oChat.appendChild(oMessages),oChat.appendChild(oRepondre);var iChatLastMsg=0;rtcService||(rtcService=RTCService({spectatorId:onlineSpectatorId})),refreshChat(),vConnectes.disabled=!0,rtcService.getVocChat({callback:function(e){e&&(vConnectes.style.display="none",vChatActions.style.display="inline-block"),vConnectes.disabled=!1}}),document.body.insertBefore(oChat,$mkScreen);try{handleChatPos()}catch(t){console.error(t)}}}function stopVocChat(){rtcService&&(cPlayerPeers={},rtcService.quitVocChat())}function handleChatPos(){if(!document.getElementById("chat-offset-style")){var e=document.getElementById("vPub");if(e.querySelector("ins.adsbygoogle[data-ad-status='filled']")){var t=document.createElement("style");t.id="chat-offset-style",t.setAttribute("type","text/css"),t.innerHTML="@media screen and (max-width: 849px) {.online-chat {margin-top: "+(e.offsetHeight+10)+"px;}}",document.getElementsByTagName("head")[0].appendChild(t)}}}var oMaps=listMaps(),aAvailableMaps=[];for(circuits in"undefined"==typeof Array.isArray&&(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),oMaps){aAvailableMaps.push(circuits);var oMap=oMaps[circuits];oMap.w||(oMap.w=512),oMap.h||(oMap.h=512),oMap.tours||(oMap.tours=3),isCup||oMap.ext||(oMap.ext="png"),oMap.ref=1*circuits.replace("map",""),oMap.aipoints&&oMap.aipoints[0]&&oMap.aipoints[0].length&&!Array.isArray(oMap.aipoints[0][0])&&(oMap.aipoints=[oMap.aipoints]),oMap.horspistes||(oMap.horspistes={},oMap.horspiste&&(oMap.horspistes.herbe=oMap.horspiste,delete oMap.horspiste))}isCup&&4<aAvailableMaps.length&&(isMCups=!0);var iWidth=80,iHeight=39,SPF=67,iRendering=baseOptions.quality,iQuality,iSmooth;resetQuality();var bMusic=!!optionOf("music"),iSfx=!!optionOf("sfx"),iFps=+localStorage.getItem("nbFrames")||1,vSfx=1,vMusic=1;{var vSettings=localStorage.getItem("settings.vol");vSettings&&(vSettings=JSON.parse(vSettings),null!=vSettings.sfx&&(vSfx=vSettings.sfx),null!=vSettings.music&&(vMusic=vSettings.music))}var primaryColor="#FEFF3F",refreshDatas=isOnline,finishing=!1,connecte=1,aIDs=[],tnCourse=0,gameMenu,identifiant;"undefined"!=typeof mId&&(identifiant=mId),"undefined"==typeof cShared&&(cShared="AR"==page&&0<nid),"undefined"!=typeof shareLink&&shareLink.options&&shareLink.options.team&&(selectedTeams=1);var $changeRace=document.getElementById("changeRace"),myCircuit=null!=$changeRace&&(!$changeRace.dataset||!$changeRace.dataset.collab),$mkScreen=document.getElementById("mariokartcontainer");$mkScreen.dataset||($mkScreen.dataset={}),updateCtnFullScreen=function(e){if($mkScreen.dataset.fs=e?1:"",e){var t=Math.min(screen.width/(80*iScreenScale),screen.height/(iHeight*iScreenScale)),n=Math.round(100*t),l=$mkScreen.scrollWidth,o=$mkScreen.style.zoom;if($mkScreen.style.zoom=n+"%",l!=$mkScreen.scrollWidth||o==$mkScreen.style.zoom||100==n){for(var a=0;a<oContainers.length;a++)oContainers[a].style.left=Math.round((screen.width/t-80*iScreenScale)/2+a*(80*iScreenScale+2))+"px",oContainers[a].style.top=Math.round((screen.height/t-iScreenScale*iHeight)/2)+"px";updateHudFullScreen(),updatePlanFullScreen()}else if($mkScreen.style.zoom="",!formulaire||!formulaire.dataset.disabled){var s=window.innerWidth-20,r=window.innerHeight-20,t=Math.round(Math.min(s/80,r/iHeight));$mkScreen.dataset.fakefs=1;for(var a=0;a<oContainers.length;a++)oContainers[a].style.left=Math.round((window.innerWidth-80*t)/2+a*(80*iScreenScale+2))+"px",oContainers[a].style.top=Math.round((window.innerHeight-t*iHeight)/2)+"px";updateHudFullScreen(),updatePlanFullScreen(),$mkScreen.dataset.lastsc||($mkScreen.dataset.lastsc=iScreenScale),setScreenScale(t,!0),window.nsevent||(window.nsevent=function(t){27==t.keyCode&&(t.preventDefault(),updateCtnFullScreen(!1))},window.addEventListener("keydown",window.nsevent))}$mkScreen.className="fullscreen"}else{if($mkScreen.dataset.fakefs&&formulaire&&formulaire.dataset.disabled)return;$mkScreen.style.zoom="",$mkScreen.className="",$mkScreen.dataset.fakefs&&(setScreenScale(+$mkScreen.dataset.lastsc,!0),$mkScreen.dataset.lastsc="",$mkScreen.dataset.fakefs="",window.nsevent&&(window.removeEventListener("keydown",window.nsevent),delete window.nsevent));for(var a=0;a<oContainers.length;a++)oContainers[a].style.left=10+a*(80*iScreenScale+2)+"px",oContainers[a].style.top="";updateHudFullScreen(),updatePlanFullScreen()}};var hudScreens=[],oBgLayers=[],oPlayers=[],oMusicHandler,muteOnBlur,unmuteOnResume,itemDistribution,ptsDistribution;if(!pause){if(!baseCp0){baseCp0={},pUnlockMap={};var i=0;for(joueurs in cp)baseCp0[joueurs]=cp[joueurs],pUnlockMap[joueurs]=pUnlocked[i],i++;if("undefined"!=typeof characterRoster){cp={};for(var i=0,perso;i<characterRoster.length;i++)perso=characterRoster[i],baseCp0[perso.sprites]?cp[perso.sprites]=baseCp0[perso.sprites]:(cp[perso.sprites]=[perso.acceleration,perso.speed,perso.handling,perso.mass],pUnlockMap[perso.sprites]=perso.unlocked)}}for(joueurs in baseCp&&(cp=baseCp),baseCp={},customPersos=baseCustomPersos(),nBasePersos=0,cp)aPlayers.push(joueurs),baseCp[joueurs]=cp[joueurs],nBasePersos++}var strPlayer=[],iDificulty=5,iTeamPlay=selectedTeams,gPersos=[],oMap,fSelectedClass,bSelectedMirror,iRecord,iTrajet,jTrajets,iLapTimes,gRecord,gSelectedPerso,gOverwriteRecord,selectedItemDistrib,selectedPtDistrib,oDoubleItemsEnabled;pause&&(strPlayer=fInfos.player,selectedItemDistrib=fInfos.distribution,selectedPtDistrib=fInfos.ptsdistrib,fSelectedClass=fInfos.cc,bSelectedMirror=fInfos.mirror,oDoubleItemsEnabled=!!fInfos.double_items,oMap=oMaps["map"+fInfos.map],clSelected=fInfos.cl,"CM"==course?(iTrajet=fInfos.my_route,gPersos=fInfos.perso,jTrajets=fInfos.cpu_route,gRecord=fInfos.my_record,gOverwriteRecord=fInfos.ow_record,2==gOverwriteRecord&&(gOverwriteRecord=1),iRecord=fInfos.record,iLapTimes=fInfos.lap_times,gSelectedPerso=fInfos.selPerso):iDificulty=fInfos.difficulty);var oPlanCharacters=[],oPlanObjects=[],oPlanCoins=[],oPlanPoisons=[],oPlanDecor={},oPlanAssets={},oPlanFauxObjets=[],oPlanBananes=[],oPlanBobOmbs=[],oPlanChampis=[],oPlanCarapaces=[],oPlanCarapacesRouges=[],oPlanCarapacesBleues=[],oPlanCarapacesNoires=[],oPlanEtoiles=[],oPlanBillballs=[],oPlanTeams=[],oPlanCharacters2=[],oPlanObjects2=[],oPlanCoins2=[],oPlanDecor2={},oPlanAssets2={},oPlanFauxObjets2=[],oPlanBananes2=[],oPlanBobOmbs2=[],oPlanPoisons2=[],oPlanChampis2=[],oPlanCarapaces2=[],oPlanCarapacesRouges2=[],oPlanCarapacesBleues2=[],oPlanCarapacesNoires2=[],oPlanEtoiles2=[],oPlanBillballs2=[],oPlanTeams2=[],customDecorFetchHandlers=[{plan:oPlanDecor,list:{}},{plan:oPlanDecor2,list:{}}],oTeamColors={primary:["blue","red","green","#db1","#f80","magenta"],secondary:["#ccf","#fcc","#cfc","#ff8","#fc8","#f9f"],light:["#69f","#f96","#9f6","#ff7","#fa4","#f8f"],dark:["navy","brown","#030","#330","#630","#303"],contrast:["#abf","#fba","#bfa","#eea","#fd9","#ebe"],name:[toLanguage("Blue","Bleue"),toLanguage("Red","Rouge"),toLanguage("Green","Verte"),toLanguage("Yellow","Jaune"),toLanguage("Orange","Orange"),toLanguage("Magenta","Magenta")],name2:[toLanguage("blue","bleu"),toLanguage("red","rouge"),toLanguage("green","vert"),toLanguage("yellow","jaune"),toLanguage("orange","orange"),toLanguage("magenta","magenta")]},cTeamColors=oTeamColors,$speedometers=[],$speedometerVals=[],assetKeys=["oils","pivots","pointers","flippers","bumpers","flowers"],timer=0,lapTimers=[],oMapImg,oPlanDiv,oPlanDiv2,oPlanCtn,oPlanCtn2,oPlanImg,oPlanImg2,oPlanWidth,oPlanSize,oPlanRealSize,oCharWidth,oObjWidth,oCoinWidth,oExpWidth,oExpBWidth,oPlanWidth2,oPlanSize2,oCharWidth2,oObjWidth2,oCoinWidth2,oExpWidth2,oExpBWidth2,oCharRatio,oPlanRatio,oPlanSea,oPlanSea2,gameSettings,ctrlSettings,oChallengeCpts,timerMS;iScreenScale=optionOf("screenscale");var fMaxRotInc=6,fTurboDriftCpt=80,fTurboDriftCpt2=160,CHAMPI_TYPE_ITEM=1,CHAMPI_TYPE_BOOST=2,aKarts=[],bRunning=!1,bCounting=!1,musicIdInc=0,willPlayEndMusic=!1,isEndMusicPlayed=!1,forceStartMusic=!1,forcePrepareEnding=!1,oLapTimeDiv,mapMusic,lastMapMusic,endingMusic,endGPMusic,challengeMusic,carEngine,carEngine2,carEngine3,carDrift,carSpark;updateVolumeSettings=function(e){var t=vSfx,n=vMusic;null!=e.sfx&&(vSfx=e.sfx),null!=e.music&&(vMusic=e.music);for(var l=document.getElementsByClassName("gamemusic"),o=[],a=0;a<l.length;a++)o.push(l[a]);oMusicEmbed&&!o.includes(oMusicEmbed)&&o.push(oMusicEmbed);for(var s=[oMusicEmbed,mapMusic,lastMapMusic,endingMusic],a=0,r;a<o.length;a++)r=o[a],s.includes(r)?updateMusicVolume(r,vMusic,n):updateMusicVolume(r,vSfx,t)};var $virtualScreens=[],oPressedKeys={},fSpriteScale=0,fLineScale=0,oContainers=[document.createElement("div")],playingCarEngine,oMusicEmbed;oContainers[0].className="game-container",oContainers[0].tabindex=1;var oPrevFrameStates;formulaire=null,updateCtnFullScreen(1==$mkScreen.dataset.fs),function(){for(var e=0,t;2>e;e++)t=document.getElementById("infos"+e),t&&$mkScreen.removeChild(t);var t=document.createElement("table");t.id="infos0",t.setAttribute("cellspacing",1),t.setAttribute("cellpadding",0),t.style.display="none",$mkScreen.appendChild(t)}(),$mkScreen.appendChild(oContainers[0]),pause&&fInfos.player[1]&&(oContainers[1]=oContainers[0].cloneNode(!1),oContainers[1].style.left=12+80*iScreenScale+"px",$mkScreen.appendChild(oContainers[1]));for(var oScreens=[],aStrips=[],iCamHeight=24,iCamDist=32,iViewHeight=-10,fFocal=1/Math.tan(Math.PI*Math.PI/360),iViewCanvasHeight=240,iViewCanvasWidth=600,iViewYOffset=10,prevScreenCur=0,prevScreenOpacity=0,prevScreenFade=0,maxItemHitboxZ=5,itemBehaviors={banane:{size:.67,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("theta"),byteType("countdown")],fadedelay:100,frminv:!0,move:function(e){e.countdown&&handleSpriteLaunch(e,12,.2)}},fauxobjet:{size:1,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("theta"),byteType("countdown")],fadedelay:100,frminv:!0,move:function(e){e.countdown&&handleSpriteLaunch(e,12,.2)}},poison:{size:.54,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("theta"),byteType("countdown")],fadedelay:100,frminv:!0,move:function(e){e.countdown&&handleSpriteLaunch(e,12,.2)}},champi:{size:.54,sync:[floatType("x"),floatType("y"),floatType("z")],fadedelay:100},eclair:{size:1,sync:[intType("owner")],fadedelay:0,sprite:!1,onlineResync:!1,move:function(e){if(void 0===e.countdown){e.countdown=20;var t=aKarts.find(function(t){return t.id==e.owner});if(t){!iSfx||finishing||oPlayers[0].cpu||playSoundEffect("musics/events/lightning.mp3"),$mkScreen.style.opacity=.7;for(var n=0,l;n<aKarts.length;n++)l=aKarts[n],friendlyFire(l,t)||(l.protect?l.megachampi&&!l.etoile&&(l.megachampi=Math.min(l.megachampi,8),l.size=Math.pow(1.05,l.megachampi)):((!isOnline||!n||l.controller==identifiant)&&(l.size=.6),l.mini=Math.round(Math.max(l.mini,110-35*(l.place-1)/(aKarts.length-1))),loseUsingItems(l),l.champi=0,delete l.champiType,l.spin(20),stopDrifting(n),dropCurrentItem(l),handleItemHit(l,"eclair")))}}if(!isOnline||e.id){var o=0==itemDistribution.lightningdelay?-50:-300;e.countdown--,0>=e.countdown&&(e.countdown<o?detruit(e):!e.disabled&&(e.disabled=!0,$mkScreen.style.opacity=1))}},del:function(e){e.disabled||($mkScreen.style.opacity=1)}},bloops:{size:1,sync:[intType("owner")],fadedelay:0,sprite:!1,countdowns:[5,5,15,3,2,3,3,2,2,13,7,5,5,100,15],onlineResync:!1,move:function(e){if(!e.sprites){if(1<items.bloops.length)return void detruit(e);e.countdown=0,e.countstate=0;var t=aKarts.find(function(t){return t.id==e.owner});if(!t)return!1;e.sprites=Array(oPlayers.length);for(var n=0,l;n<aKarts.length;n++)if(l=aKarts[n],l===t||!friendlyFire(l,t)&&!l.protect){if(n<oPlayers.length&&!onlineSpectatorId){var o={bloops:{elt:document.createElement("img"),mine:l===t}},s=o.bloops.elt;if(s.src="images/sprites/sprite_blooper.png",s.className="pixelated",s.style.position="absolute",s.style.width=7*iScreenScale+"px",o.bloops.x=36,o.bloops.y=o.bloops.mine?18:12,s.style.zIndex=19001,s.style.opacity=o.bloops.mine?1:0,1<nbFrames){var p=SPF/1e3;s.style.transition="left "+p+"s ease-out, top "+p+"s ease-out"}oContainers[n].appendChild(s),e.sprites[n]=o}l.bloops=e}e.effective=function(e){return 13==this.countstate&&!e.unbloop&&this.owner!==e.id}}var d=itemBehaviors.bloops,c=d.countdowns[e.countstate],u=e.countdown/c;e.countdown++;for(var m=e.countdown/c,n=0;n<e.sprites.length;n++){var y=e.sprites[n],t=aKarts[n];if(y){var s=y.bloops;if(!s)continue;switch(e.countstate){case 0:s.mine&&(s.y-=2,!u&&iSfx&&!finishing&&playSoundEffect("musics/events/bloops0.mp3"));break;case 1:s.mine&&(s.y-=.5*Math.cos(Math.PI*u/2),s.elt.style.opacity=1-m,e.countdown==c&&(oContainers[n].removeChild(s.elt),delete y.bloops));break;case 3:s.elt.style.opacity=m;break;case 4:u||!iSfx||finishing||n||playSoundEffect("musics/events/bloops.mp3"),s.y+=2;break;case 5:s.y-=2*Math.cos(Math.PI*u/2);break;case 6:var h=.2;s.x+=2,s.y-=2*Math.cos(Math.PI*(u+h)/(1+h));break;case 7:s.x+=2,s.y+=2;break;case 8:s.x+=2,s.y+=2;break;case 9:var g=Math.pow(Math.cos(.45*(Math.PI*u)),1.2);s.x-=6*Math.sin(1.5*Math.PI*u)*g,s.y-=4*Math.cos(1.5*Math.PI*u)*g;break;case 10:s.x+=2,s.y-=2.5*Math.cos(Math.PI*u);break;case 11:s.x-=Math.sin(Math.PI*m/2),s.y-=1;break;case 12:if(s.elt.style.opacity=1-m,!y.ink){function e(e){return Math.random()-e}for(var b=[],f=3e3,x=100,v;0<f;)v=x+Math.random()*(500-x),v>f&&(v=f,v<x&&(v=x)),b.push(v),f-=v;y.ink=[];for(var C=80/iHeight,r=Math.sqrt(b.length*C),a=Math.ceil(r/C),k=r*a/b.length,E=0;E<b.length;E++){var w=(E+.5)*k,S=w/r,T=(Math.floor(S)+.5)*(iHeight/a),I=S%1,z=(Math.floor(S)+.5)/a;I=.5+(I-.5)/2,z=.5+(z-.5)/2;var B=Math.sqrt(b[E]),M={x:w%r*(80/r)+.6*B*e(I),y:T+.5*B*e(z),theta:360*Math.random(),w:B*(1+.1*e(.5)),h:B*(1+.1*e(.5)),margin:1.25};M.y-=1075/(M.w*M.h),y.ink.push(M)}for(var E=0;E<y.ink.length;E++)(function(e){var t,i;t=document.createElement("canvas"),t.style.opacity=.95;var i=document.createElement("img");i.src="images/sprites/sprite_ink.png",i.className="pixelated",i.dataset||(this.dataset={}),t.draw=function(n){if(i.dataset.jTime=n,!!i.dataset.loaded){var l=t.getContext("2d");l.setTransform(1,0,0,1,0,0),l.clearRect(0,0,t.width,t.height);var o=n/e.margin;l.translate(t.width/2,t.height/2),l.rotate(e.theta*Math.PI/180),l.translate(t.width*(1-o)/2,t.height*(1-o)/2),l.drawImage(i,-t.width/2,-t.height/2,t.width*o,t.height*o)}},i.onload=function(){this.dataset.loaded=1,this.dataset.jTime&&t.draw(+this.dataset.jTime)},t.style.zIndex=19e3,t.style.position="absolute",t.style.left=Math.round((e.x-(e.w+e.margin-1)/2)*iScreenScale)+"px",t.style.top=Math.round((e.y-(e.h+e.margin-1)/2)*iScreenScale)+"px",t.width=Math.round(e.w*iScreenScale*e.margin),t.height=Math.round(e.h*iScreenScale*e.margin),oContainers[n].appendChild(t),e.elt=t})(y.ink[E])}for(var E=0,M;E<y.ink.length;E++)M=y.ink[E],M.elt.draw(m);break;case 13:for(var E=0;E<y.ink.length;E++){var M=y.ink[E],L=M.elt;M.y+=20/(M.w*M.h),L.style.top=Math.round((M.y-M.h/2)*iScreenScale)+"px"}break;case 14:for(var E=0;E<y.ink.length;E++){var M=y.ink[E],L=M.elt;M.y+=10/(M.w*M.h),L.style.top=Math.round((M.y-M.h/2)*iScreenScale)+"px",t.unbloop||(L.style.opacity=.95*(1-u))}}s.elt.style.left=iScreenScale*s.x+"px",s.elt.style.top=iScreenScale*s.y+"px"}}if(12<=e.countstate)for(var n=0,t;n<aKarts.length;n++)if(t=aKarts[n],!t.unbloop&&(t.protect||t.champi||t.tombe)&&(t.unbloop=12==e.countstate&&t.protect?5:1),t.unbloop&&5>=t.unbloop){var H=t.unbloop/5;if(t.bloops===e&&e.owner!==t.id)for(var E=0;E<oPlayers.length;E++)t.sprite[E].img.style.filter="brightness("+(.15+.85*H)+")";var y=e.sprites[n];if(y&&y.ink)for(var E=0;E<y.ink.length;E++){var M=y.ink[E],L=M.elt;L.style.opacity=.95*(1-H)}t.unbloop++}switch(e.countstate){case 12:for(var n=0,t;n<aKarts.length;n++)if(t=aKarts[n],!t.unbloop&&t.bloops===e&&e.owner!==t.id)for(var E=0;E<oPlayers.length;E++)t.sprite[E].img.style.filter="brightness("+(1-.85*m)+")";break;case 14:for(var n=0,t;n<aKarts.length;n++)if(t=aKarts[n],!t.unbloop&&t.bloops===e&&e.owner!==t.id)for(var E=0;E<oPlayers.length;E++)t.sprite[E].img.style.filter="brightness("+(.15+.85*m)+")";}e.countdown>=c&&(e.countstate++,e.countdown=0,e.countstate>=d.countdowns.length&&detruit(e))},del:function(e){if(e.sprites){for(var t=0,n;t<e.sprites.length;t++)if(n=e.sprites[t],n){n.bloops&&oContainers[t].removeChild(n.bloops.elt);var l=n.ink;if(l)for(var o=0;o<l.length;o++)oContainers[t].removeChild(l[o].elt)}for(var t=0;t<aKarts.length;t++)if(aKarts[t].bloops===e){for(var o=0;o<oPlayers.length;o++)aKarts[t].sprite[o].img.style.filter="";delete aKarts[t].bloops,delete aKarts[t].unbloop}}}},carapace:{size:.67,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("vx"),floatType("vy"),intType("owner"),byteType("lives")],fadedelay:300,frminv:!0,move:function(e,t){for(var n=cappedRelSpeed(),o=0,a,s;2>o;o++){var r=e.vx*n/2,p=e.vy*n/2;if(!(r||p))a=e.x,s=e.y;else if(a=e.x+r,s=e.y+p,!o)for(var d=0;d<oPlayers.length;d++)e.sprite[d].setState(1-e.sprite[d].getState());var c=e.x,u=e.y,m=a,y=s,h=[e],g;t&&t.onlineSync&&(h=otherPlayerItems(h),g=otherPlayerItems([])),collisionFloor=null,collisionDecorHit=null,collisionItem=e;var b=-1!=e.owner,f;if(b&&(f=inTeleport(c,u))){e.x=f[0],e.y=f[1];var x=f[2]*Math.PI/2,v=Math.hypot(e.vx,e.vy);e.vx=v*Math.sin(x),e.vy=v*Math.cos(x)}else if(b&&tombe(c,u)||touche_banane(c,u,g)||touche_banane(m,y,g)||touche_crouge(c,u,g)||touche_crouge(m,y,g)||touche_cverte(c,u,h)||touche_cverte(m,y,h)||touche_bobomb(c,u,g,{transparent:!0})||touche_bobomb(m,y,g,{transparent:!0})){detruit(e,!0);break}else if(!b||canMoveTo(e.x,e.y,0,r,p)){if(t&&t.checkCollisions&&(t.checkCollisions(e),e.deleted))break;e.x=a,e.y=s,o||tendsToSpeed(e,12,.2)}else{if(e.lives--,collisionDecorHit&&(e.lives=0),0<e.lives){var C=getHorizontality(e.x,e.y,collisionFloor?collisionFloor.z:0,r,p),E=C[0],w=C[1],S=e.vx,T=e.vy,I=S*E+T*w,z=.7;e.vx=z*(2*I*E-S),e.vy=z*(2*I*w-T)}else detruit(e);break}}},checkCollisions:function(e,t){var i=aKarts[t];i.z<maxItemHitboxZ&&touche_cverte_aux(i.x,i.y,e)&&!friendlyHit(i.team,e.team)&&handleHardHit(t)}},bobomb:{size:1,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("theta"),byteType("countdown"),byteType("cooldown")],fadedelay:0,move:function(e){-1!=e.theta&&(e.countdown?handleSpriteLaunch(e,15,.2):(e.z=0,tombe(e.x,e.y)&&detruit(e),30==--e.cooldown&&(e.cooldown-=12),-10>e.cooldown?detruit(e):0>e.cooldown&&handleDecorExplosions(e,touche_bobomb_aux)))},checkCollisions:function(e,t){var i=aKarts[t];if(touche_bobomb_aux(i.x,i.y,e)&&!friendlyHit(i.team,e.team)&&0>=e.cooldown){var n=-5>e.cooldown?42:84;handleExplosionHit(t,n)}},render:function(e,t){if(0>=e.cooldown){if(!t&&1==e.size){for(var i=0,n;i<strPlayer.length;i++)makeSpriteExplode(e,"",i),"block"==e.sprite[i].div.style.display&&(n=i);isOnline||null==n?(e.size=6,playDistSound({x:e.x,y:e.y},"musics/events/boom.mp3",200)):(e.sprite[n].img.onload=function(){bCounting=!1,e.sprite[n].img.onload=void 0,e.size=6,reprendre(!1),playDistSound({x:e.x,y:e.y},"musics/events/boom.mp3",200)},bCounting=!0,interruptGame())}e.sprite[t].div.style.opacity=1+e.cooldown/10}},drop:function(e,t){e.theta=t.rotation+180,e.cooldown=60,e.countdown=1}},"carapace-rouge":{size:.67,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),floatType("theta"),intType("owner"),shortType("aipoint"),byteType("aimap"),intType("target")],fadedelay:300,frminv:!0,move:function(e,t){for(var n=5,o=0,a,s;o<n;o++){var r=(e.heightinc?15:12)*cappedRelSpeed()/n,p;if(-1!=e.owner){if(e.cannon){e.z=(3*e.z+4)/4;var d=e.cannon[0]-e.x,c=e.cannon[1]-e.y,m=Math.hypot(d,c);r=20/n,r<m?(e.x+=d*r/m,e.y+=c*r/m):(e.x=e.cannon[0],e.y=e.cannon[1],delete e.cannon);continue}if(!o)for(var y=0;y<oPlayers.length;y++)e.sprite[y].setState(1-e.sprite[y].getState());if(0<=e.target){var g=aKarts.find(function(t){return t.id==e.target}),b=Math.pow(g.x-e.x,2)+Math.pow(g.y-e.y,2);if(500>b){if(a=g.x,s=g.y,g.using.length&&"fauxobjet"!=g.using[0].type){for(var f=Math.atan2(e.y-s,e.x-a)-(90-g.rotation)*Math.PI/180,x=2*Math.PI;0>f;)f+=x;for(;f>x;)f-=x;if(f>Math.PI&&(f=x-f),Math.abs(f)>Math.PI/2)return(a=g.using[0].x,s=g.using[0].y,e.x=a,e.y=s,"bobomb"===g.using[0].type&&touche_bobomb(a,s,onlyThisItems([g.using[0]])))?void 0:(detruit(e),void(g.using[0]&&detruit(g.using[0],!0)));g.using[0].x-=2*direction(0,g.rotation),g.using[0].y-=2*direction(1,g.rotation)}e.x=a,e.y=s,o=n-1}else{b=Math.sqrt(b);var v=(g.x-e.x)*r/b,C=(g.y-e.y)*r/b;a=e.x+v,s=e.y+C,75<b&&(e.target=-1,e.aipoint=-1,e.aimap=-1)}}else{var v,C;if(0<=e.aipoint){var E=oMap.aipoints[e.aimap],w=E[e.aipoint];v=w[0]-e.x,C=w[1]-e.y;var S=v*v+C*C;100>S&&(e.aipoint<E.length-1?e.aipoint++:e.aipoint=0);var T=Math.sqrt(v*v+C*C)/r;v/=T,C/=T}else if(-1==e.aipoint){if("BB"!=course)for(var I=2e3,z=0,E;z<oMap.aipoints.length;z++){E=oMap.aipoints[z];for(var y=0;y<E.length;y++){var w=E[y],B=(y+1)%E.length,M=E[B],L=projete(e.x,e.y,w[0],w[1],M[0],M[1]);if(0<L&&1>L){var H=w[0]+L*(M[0]-w[0]),A=w[1]+L*(M[1]-w[1]),S=(H-e.x)*(H-e.x)+(A-e.y)*(A-e.y);S<I&&(e.aimap=z,e.aipoint=B,I=S)}}}v=r*direction(0,e.theta),C=r*direction(1,e.theta)}else v=r/2*direction(0,e.theta),C=r/2*direction(1,e.theta);if(a=e.x+v,s=e.y+C,-2!=e.aipoint){for(var _=4e3,g=null,y=0,P;y<aKarts.length;y++)if(P=aKarts[y],P.id!=e.owner&&!friendlyHit(e.team,P.team)&&!P.tombe&&!P.loose){var N=P.x-a,R=P.y-s,b=Math.pow(N,2)+Math.pow(R,2);if(b<_){var D=v*N+C*R;D/=Math.sqrt(b*(v*v+C*C)),.4<D&&(_=b,g=P)}}g&&(e.target=g.id,isOnline&&(g.id==identifiant||g.controller==identifiant||isControlledByPlayer(e.owner))&&syncItems.push(e))}}}else a=e.x,s=e.y;var v=a-e.x,C=s-e.y,F=v||C,V=0<=e.target&&!F,O=[e];if(V)for(var q=0,w;q<items["carapace-rouge"].length;q++)w=items["carapace-rouge"][q],w!==e&&w.x===e.x&&w.y===e.y&&O.push(w);var W;if(t&&t.onlineSync&&(O=otherPlayerItems(O),W=otherPlayerItems([])),-1!=e.owner){if(handleCannon(e,inCannon(e.x,e.y,a,s)),p=inTeleport(e.x,e.y),p){if(a=p[0],s=p[1],e.theta=90*p[2],0<=e.aipoint){var X=oMap.aipoints[e.aimap],G=X[e.aipoint];G&&p===inTeleport(G[0],G[1])&&(e.aipoint++,e.aipoint>=X.length&&(e.aipoint=0))}}else if(!e.z){if(F&&(0<=e.aipoint||0<=e.target)&&!(50<e.stuckSince))for(var y=0,L;4>y;y++)if(L=getHorizontality(e.x,e.y,e.z0||0,v,C,{nullableRes:!0,holes:!0,skipDecor:!0}),L){var K=L[0]*v+L[1]*C,u=1.5-.5*Math.min(Math.abs(K)/r,1);v=L[0]*Math.sign(K)*r*u,C=L[1]*Math.sign(K)*r*u,a=e.x+v,s=e.y+C}else{y?(!e.stuckSince&&(e.stuckSince=0),e.stuckSince++):delete e.stuckSince;break}handleJump(e,sauts(e.x,e.y,v,C))&&o%2&&handleHeightInc(e)}(e.z||e.heightinc)&&!(o%2)&&(!e.heightinc&&(e.heightinc=0),handleHeightInc(e))}if(collisionItem=e,collisionFloor=null,(-1==e.owner||p||(e.z||!tombe(a,s))&&canMoveTo(e.x,e.y,e.z,v,C))&&!touche_banane(a,s,W)&&!touche_banane(e.x,e.y,W)&&!touche_crouge(a,s,O)&&!touche_crouge(e.x,e.y,O)&&!touche_cverte(a,s,W)&&!touche_cverte(e.x,e.y,W)&&!touche_bobomb(a,s,W,{transparent:!0})&&!touche_bobomb(e.x,e.y,W,{transparent:!0}))e.x=a,e.y=s,collisionFloor?e.z0=collisionFloor.z:delete e.z0;else return void detruit(e)}},checkCollisions:function(e,t){var i=aKarts[t];i.z<maxItemHitboxZ&&touche_crouge_aux(i.x,i.y,e)&&!friendlyHit(i.team,e.team)&&handleHardHit(t)}},"carapace-bleue":{size:1,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),intType("target"),byteType("cooldown"),shortType("aipoint"),byteType("aimap")],fadedelay:0,cooldown0:15,cooldown1:2,move:function(e){var t=-1;if(-1!=e.target)for(var i=0;i<aKarts.length;i++)if(aKarts[i].id==e.target){t=i;break}var n=cappedRelSpeed(),l=n*n,o=inTeleport(e.x,e.y);if(o&&(e.x=o[0],e.y=o[1],-1!=e.aipoint)){var a=oMap.aipoints[e.aimap],s=a[e.aipoint];s&&o===inTeleport(s[0],s[1])&&(e.aipoint++,e.aipoint>=a.length&&(e.aipoint=0))}if(-1!=e.aipoint){var p="BB"==course;if(!p)for(var a=oMap.aipoints[e.aimap],d=15*n,c=e.x,u=e.y;0<d;){var m=a[e.aipoint],y=Math.hypot(m[0]-e.x,m[1]-e.y);y>d?(e.x+=(m[0]-e.x)*d/y,e.y+=(m[1]-e.y)*d/y,d=0):(d-=y,e.x=m[0],e.y=m[1],e.aipoint++,e.aipoint===a.length&&(e.aipoint=0))}if(-1==t){t=aKarts.length-1;for(var h=1;h<=aKarts.length;h++)for(var i=0;i<aKarts.length;i++)if(aKarts[i].place==h){(aKarts[i].tours<=oMap.tours||"BB"==course)&&!friendlyHit(e.team,aKarts[i].team)&&(t=i,h=aKarts.length);break}}var g=aKarts[t],b=(g.x-e.x)*(g.x-e.x)+(g.y-e.y)*(g.y-e.y);if((2e4>b||p)&&((-1==e.target&&(!isOnline||g.id==identifiant||g.controller==identifiant)||p)&&(e.target=g.id,isOnline&&syncItems.push(e)),-1!=e.target)){var f=(g.x-c)*(g.x-c)+(g.y-u)*(g.y-u);(5e3>b||b>f||p)&&(e.aipoint=-1)}for(var i=0;i<oPlayers.length;i++)e.sprite[i].setState(1-e.sprite[i].getState())}else if(0<e.cooldown){var g=aKarts[t];if(g){var x=e.x-g.x,v=e.y-g.y,C=x*x+v*v,E=itemBehaviors["carapace-bleue"];if(e.cooldown==E.cooldown0){var d=10*n;if(C>d*d){var w=Math.sqrt(C)/d;x/=w,v/=w;for(var i=0;i<oPlayers.length;i++)e.sprite[i].setState(1-e.sprite[i].getState())}else e.cooldown--}else{if(5>e.cooldown){var S=32;if(0<g.champi?(g.champi<(g.champior?8:16)||g.champiType!==CHAMPI_TYPE_ITEM)&&(S=200):g.turbodrift&&(S=64),S*=l*l,C>S){var w=Math.sqrt(C/S);x/=w,v/=w}}var T=(e.cooldown-E.cooldown1)/(E.cooldown0-E.cooldown1);0>T&&(T=0);var I=8*T,z=8*T,B=2*Math.PI*T,M=g.rotation*Math.PI/180;e.z=23-z*Math.cos(B),x-=I*Math.sin(B)*Math.cos(M),v+=I*Math.sin(B)*Math.sin(M);for(var i=0;i<oPlayers.length;i++)e.sprite[i].setState(Math.round(Math.random()));if(e.cooldown--,!e.cooldown)for(var i=0;i<oPlayers.length;i++)e.sprite[i].setState(0)}e.x-=x,e.y-=v}}else{e.z=0,isOnline&&isControlledByPlayer(e.target)&&-10>e.cooldown&&(e.cooldown=0),e.cooldown--;var L=isOnline&&!isControlledByPlayer(e.target)?-120:-10;e.cooldown<L?detruit(e):handleDecorExplosions(e,touche_cbleue_aux)}},checkCollisions:function(e,t){var i=aKarts[t];if(touche_cbleue_aux(i.x,i.y,e)&&!friendlyHit(i.team,e.team)){var n=-5>e.cooldown?42:84;handleExplosionHit(t,n)}},render:function(e,t){if(0>=e.cooldown){if(!t&&1==e.size){for(var i=0,n;i<strPlayer.length;i++)makeSpriteExplode(e,"0",i),"block"==e.sprite[i].div.style.display&&(n=i);for(var l=-1,i=0;i<aKarts.length;i++)if(aKarts[i].id==e.target){l=i;break}isOnline||null==n?(e.size=8,playDistSound(aKarts[l],"musics/events/boom.mp3",200)):(e.sprite[n].img.onload=function(){bCounting=!1,e.sprite[n].img.onload=void 0,e.size=8,reprendre(!1),playDistSound(aKarts[l],"musics/events/boom.mp3",200)},bCounting=!0,interruptGame())}e.sprite[t].div.style.opacity=Math.max(1+e.cooldown/10,0)}},del:function(){nextBlueShellCooldown=300}},"carapace-noire":{size:1,sync:[byteType("team"),floatType("x"),floatType("y"),floatType("z"),intType("target"),byteType("cooldown"),shortType("aipoint"),byteType("aimap")],fadedelay:0,cooldown0:15,cooldown1:2,move:function(e){var t=-1;if(-1!=e.target)for(var i=0;i<aKarts.length;i++)if(aKarts[i].id==e.target){t=i;break}var n=cappedRelSpeed(),l=n*n;if(-1!=e.aipoint){var o="BB"==course;if(!o)for(var a=oMap.aipoints[e.aimap],s=15*n,p=e.x,d=e.y;0<s;){var c=a[e.aipoint],u=Math.hypot(c[0]-e.x,c[1]-e.y);u>s?(e.x+=(c[0]-e.x)*s/u,e.y+=(c[1]-e.y)*s/u,s=0):(s-=u,e.x=c[0],e.y=c[1],e.aipoint++,e.aipoint===a.length&&(e.aipoint=0))}if(-1==t){t=0;for(var m=aKarts.length;0<m;m--)for(var i=0;i<aKarts.length;i++)if(aKarts[i].place==m&&!aKarts[i].loose){friendlyHit(e.team,aKarts[i].team)||(t=i,m=0);break}}var y=aKarts[t],h=(y.x-e.x)*(y.x-e.x)+(y.y-e.y)*(y.y-e.y);if((2e4>h||o)&&((-1==e.target&&(!isOnline||y.id==identifiant||y.controller==identifiant)||o)&&(e.target=y.id,isOnline&&syncItems.push(e)),-1!=e.target)){var g=(y.x-p)*(y.x-p)+(y.y-d)*(y.y-d);(5e3>h||h>g||o)&&(e.aipoint=-1)}for(var i=0;i<oPlayers.length;i++)e.sprite[i].setState(1-e.sprite[i].getState())}else if(0<e.cooldown){var y=aKarts[t];if(y){var b=e.x-y.x,f=e.y-y.y,x=b*b+f*f,v=itemBehaviors["carapace-noire"];if(e.cooldown==v.cooldown0){var s=10*n;if(x>s*s){var C=Math.sqrt(x)/s;b/=C,f/=C;for(var i=0;i<oPlayers.length;i++)e.sprite[i].setState(1-e.sprite[i].getState())}else e.cooldown--}else{if(5>e.cooldown){var E=32;if(0<y.champi?E=200:y.turbodrift&&(E=64),E*=l*l,x>E){var C=Math.sqrt(x/E);b/=C,f/=C}}var w=(e.cooldown-v.cooldown1)/(v.cooldown0-v.cooldown1);0>w&&(w=0);var S=8*w,T=8*w,I=2*Math.PI*w,z=y.rotation*Math.PI/180;e.z=23-T*Math.cos(I),b-=S*Math.sin(I)*Math.cos(z),f+=S*Math.sin(I)*Math.sin(z);for(var i=0;i<oPlayers.length;i++)e.sprite[i].setState(Math.round(Math.random()));if(e.cooldown--,!e.cooldown)for(var i=0;i<oPlayers.length;i++)e.sprite[i].setState(0)}e.x-=b,e.y-=f}}else{e.z=0,isOnline&&isControlledByPlayer(e.target)&&-10>e.cooldown&&(e.cooldown=0),e.cooldown--;var B=isOnline&&!isControlledByPlayer(e.target)?-70:-10;e.cooldown<B&&detruit(e)}},checkCollisions:function(e,t){var i=aKarts[t];if(touche_cbleue_aux(i.x,i.y,e)&&!friendlyHit(i.team,e.team)){var n=-5>e.cooldown?42:84;handleExplosionHit(t,n)}},render:function(e,t){if(0>=e.cooldown){if(!t&&1==e.size){for(var i=0,n;i<strPlayer.length;i++)makeSpriteExplode(e,"D",i),"block"==e.sprite[i].div.style.display&&(n=i);for(var l=-1,i=0;i<aKarts.length;i++)if(aKarts[i].id==e.target){l=i;break}isOnline||null==n?(e.size=8,playDistSound(aKarts[l],"musics/events/boom.mp3",200)):(e.sprite[n].img.onload=function(){bCounting=!1,e.sprite[n].img.onload=void 0,e.size=8,reprendre(!1),playDistSound(aKarts[l],"musics/events/boom.mp3",200)},bCounting=!0,interruptGame())}e.sprite[t].div.style.opacity=Math.max(1+e.cooldown/10,0)}},del:function(){nextBlueShellCooldown=300}}},itemTypes=["banane","fauxobjet","carapace","bobomb","poison","carapace-rouge","carapace-bleue","carapace-noire","eclair","bloops","champi"],items={},i=0,oViewCanvas,prevScreenDelay;i<itemTypes.length;i++)items[itemTypes[i]]=[];var decorBehaviors={taupe:{spin:20,init:function(e,t,i){3<e.length||(e[3]=0,e[4]=i%2?9:0)},move:function(e){if(e[4]++,0<=e[4])if(!e[4]){for(var t=0;t<oPlayers.length;t++)e[2][t].img.style.display="block";e[3]=0}else if(e[3]+=4>e[4]?2:-1,10==e[4]){e[4]=-20,e[3]=10;for(var t=0;t<oPlayers.length;t++)e[2][t].img.style.display="none"}}},poisson:{spin:20,movable:!0,preinit:function(e,t){t.scope={limite:[]};for(var n=0;n<e.length;n++)t.scope.limite[n]=[0,0]},init:function(e,t,i){if(!(3<e.length)){e[3]=[3,0][i%2],e[4]=[-1,1][i%2]}},move:function(e,t,i,n){if(e[3]+=e[4],!e[3])e[4]=1;else if(3==e[3]){e[4]=-1;for(var l=0;2>l;l++){var a=oPlayers[0].cpu?Math.random():1e4*Math.abs(Math.sin(timer+l))%1,s=Math.floor(9*a)-4;10<Math.abs(n.limite[t][l]+s)&&(s=-s),n.limite[t][l]+=s,e[l]+=s}}}},cheepcheep:{spin:20,movable:!0,preinit:function(e,t){this.preinit=decorBehaviors.poisson.preinit.bind(this),this.init=decorBehaviors.poisson.init.bind(this),this.move_=decorBehaviors.poisson.move.bind(this),this.preinit(e,t)},move:function(e,t,i,n){if(this.move_(e,t,i,n),0==e[3]%3)for(var l=0;l<oPlayers.length;l++)e[2][l].setState(e[3]?1:0)}},plante:{spin:20,init:function(e,t,i){3<e.length||(e[3]=void 0,e[4]=(1+2*i)%8)},move:function(e){if(e[4]++,4==e[4])for(var t=0;t<oPlayers.length;t++)e[2][t].setState(1);else if(8==e[4]){for(var t=0;t<oPlayers.length;t++)e[2][t].setState(0);e[4]=0}}},thwomp:{spin:20,init:function(e,t,i){if(!(3<e.length)){e[3]=[20,0][i%2],e[4]=[0,10][i%2]}},move:function(e){0>e[4]?(e[4]++,!e[4]&&(e[4]=-1,20>e[3]?e[3]+=2:e[4]=20)):e[4]?e[4]--:(e[3]-=8,0>e[3]&&(e[3]=0,e[4]=-15))}},spectre:{spin:20,init:function(e,t,i){decorBehaviors.thwomp.init(e,t,i)},move:function(e){decorBehaviors.thwomp.move(e)}},tree:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=50,e[2][t].h=100,e[2][t].z=.12}},crabe:{spin:20,movable:!0,transparent:!0,preinit:function(){"BB"==course&&(this.dodgable=!0)},init:function(e,t,i){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=3,e[2][n].h=30,e[2][n].w=16*e[2][n].h/17;null==e[4]&&(e[4]=1e4*Math.sin(i+1)%Math.PI);var l=e[5];for(null==l&&(l=137*i%400),e[5]=0;e[5]!=l;)this.move(e)},hSpeed:.7,handleState:function(e,t){if(t%=16,0==t)for(var i=0;i<strPlayer.length;i++)e[2][i].setState(0);else if(4==t||12==t)for(var i=0;i<strPlayer.length;i++)e[2][i].setState(1);else if(8==t)for(var i=0;i<strPlayer.length;i++)e[2][i].setState(2)},move:function(t){var i=t[5]+50,n=Math.min(i%100,99-i%100);if(5<=n){var e=this.hSpeed*Math.cos(t[4]),l=this.hSpeed*Math.sin(t[4]);8>n&&(e*=.5,l*=.5),this.handleState(t,i),100>i%200?(t[0]+=e,t[1]+=l):(t[0]-=e,t[1]-=l)}t[5]++,400<=t[5]&&(t[5]=0)}},goomba:{spin:20,movable:!0,transparent:!0,dodgable:!0,preinit:function(){this.init_=decorBehaviors.crabe.init.bind(this),this.move=decorBehaviors.crabe.move.bind(this)},init:function(e,t,i){this.init_(e,t,i);for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=2,e[2][n].w=32,e[2][n].h=36},handleState:function(e,t){if(t%=8,0==t)for(var i=0;i<strPlayer.length;i++)e[2][i].setState(0);else if(4==t)for(var i=0;i<strPlayer.length;i++)e[2][i].setState(1)},hSpeed:.3},firesnake:{spin:42,minSpeedToSpin:3.2,unbreaking:!0,movable:!0,transparent:!0,dodgable:!0,hitbox:6,hitboxH:7,init:function(e,t,i){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=3,e[2][n].img.style.display="none";e[3]=10,e[4]||(e[4]=(1+50*i)%280),e[5]||(e[5]=0),e[6]||(e[6]=0),e[7]=[e[0],e[1]],e[8]=[e[0],e[1]],e[9]=[e[0],e[1]],e[0]=-10,e[1]=-10},move:function(t,n,i){var o=timer+i;switch(oPlayers[0].cpu&&(o=1e4*Math.random()),t[5]){case 0:if(t[4]--,0>=t[4]){for(var a=0;a<strPlayer.length;a++)t[2][a].img.style.display="block";t[0]=t[7][0]+10*Math.sin(o),t[1]=t[7][1]+10*Math.sin(o+1),t[8][0]=t[0],t[8][1]=t[1],t[9][0]=t[0]+10*Math.sin(o+2),t[9][1]=t[1]+10*Math.sin(o+3),t[3]=50,t[5]=1}break;case 1:if(t[3]-=4,0>=t[3]){t[3]=0,t[4]=20,t[5]=2,t[6]=5;for(var a=0;a<strPlayer.length;a++)t[2][a].setState(1)}var s=t[3]/40;t[9][0]+=s*(t[8][0]-t[9][0]),t[9][1]+=s*(t[8][1]-t[9][1]),t[0]=t[9][0],t[1]=t[9][1];break;case 2:var r=(18-t[4])/18;if(0<=r){var p=i%2?1:-1;if(t[0]=t[9][0]-4*r*p*Math.cos(4*r)+r*Math.sin(o),t[1]=t[9][1]-4*r*p*Math.sin(4*r)+r*Math.sin(o+1),t[3]=Math.max(1.2*Math.sin(4*r)+.3*r*Math.sin(o+1),0),3==t[4]%6)for(var a=0;a<strPlayer.length;a++)t[2][a].setState(3-t[2][a].getState())}t[4]--,0>=t[4]&&(t[5]=3,t[8][0]=t[0],t[8][1]=t[1],t[4]=0,t[9][0]=t[7][0]+10*Math.sin(o),t[9][1]=t[7][1]+10*Math.sin(o+1));break;case 3:t[4]++;var s=Math.min(t[4]/20,1);t[0]=t[8][0]+s*(t[9][0]-t[8][0]),t[1]=t[8][1]+s*(t[9][1]-t[8][1]),t[3]=30*s*(1-s),1==s&&(t[6]--,0>=t[6]?(t[5]=4,t[4]=1):(t[5]=2,t[4]=20,t[5]=2));break;case 4:if(t[4]-=.2,0>t[4]){for(var a=0;a<strPlayer.length;a++)t[2][a].img.style.display="none",t[2][a].img.style.opacity=1,t[2][a].setState(0);t[0]=-10,t[1]=-10,t[4]=50,t[5]=0,t[6]=0}else for(var a=0;a<strPlayer.length;a++)t[2][a].img.style.opacity=t[4];}}},fireplant:{hitbox:7,unbreaking:!0,preinit:function(){oMap.decor.fireball||(oMap.decor.fireball=[]),this.linkedSprite={type:"fireball",start:oMap.decor.fireball.length};for(var e=0;e<oMap.decor[this.type].length;e++)oMap.decor.fireball.push([-1e4,-1e4]);this.linkedSprite.end=oMap.decor.fireball.length},init:function(e,t,i){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=4,e[2][n].w=54,e[2][n].h=40*e[2][n].w/24,e[2][n].z=.16;null==e[4]&&(e[4]=1e4*Math.sin(i+1)%(2*Math.PI)),null==e[5]&&(e[5]=17*i%65),e[6]=e[4],e[7]=0},initcustom:function(e){initCustomDecorSprites(this,e)},move:function(e,t){if(e[5]--,e[4]=e[6]+.5*Math.sin(e[7]),e[7]+=.05,e[7]%=2*Math.PI,-1==e[5])for(var i=0;i<strPlayer.length;i++)e[2][i].setState(e[2][i].getState()+1);else if(-7==e[5]){var n=oMap.decor.fireball[this.linkedSprite.start+t];n[0]=e[0],n[1]=e[1];for(var i=0;i<strPlayer.length;i++)n[2][i].img.style.display="block",n[2][i].setState(0);n[3]=10,n[4]=e[4],n[5]=0,n[6]=35}else if(-9==e[5]){for(var i=0;i<strPlayer.length;i++)e[2][i].setState((e[2][i].getState()+1)%4);e[5]=Math.round(60+10*Math.sin(e[7]))}}},fireball:{spin:42,unbreaking:!0,movable:!0,transparent:!0,hitboxH:6,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=4,e[2][t].img.style.display="none"},move:function(e){if(0<=e[6]){if(e[0]+=7*Math.cos(e[4]),e[1]+=7*Math.sin(e[4]),e[3]+=e[5],0>e[3]&&(e[3]=0,e[5]=5),e[5]-=3,e[6]--,0>e[6]){e[0]=-1e4,e[1]=-1e4;for(var t=0;t<strPlayer.length;t++)e[2][t].img.style.display="none"}else if(0==e[6]%2)for(var t=0;t<strPlayer.length;t++)e[2][t].setState((e[2][t].getState()+3)%4)}}},piranhaplant:{spin:20,preinit:function(){this.init_=decorBehaviors.plante.init.bind(this),this.move=decorBehaviors.plante.move.bind(this)},init:function(e,t,i){this.init_(e,t,i);for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=2,e[2][n].w=32,e[2][n].h=48,e[2][n].z=.1}},firebar:{spin:42,transparent:!0,unbreaking:!0,movable:!0,init:function(e,t,i){for(var n=0;n<strPlayer.length;n++)e[2][n].w=32,e[2][n].h=192,e[2][n].z=.035;null==e[4]&&(e[4]=[[e[0],e[1],0,40],[e[0],e[1],20,40]]),null==e[5]&&(e[5]=Math.round(1e4*Math.abs(Math.sin(i+3)))%e[4].length),null==e[6]&&(e[6]=2*Math.round(1e4*Math.abs(Math.sin(i+2))%1)-1),null==e[7]&&(e[7]=Math.round(1e4*Math.abs(Math.sin(i+1)))%40)},move:function(e){if(e[7])e[7]--;else{var t=e[4][e[5]],i=t[0]-e[0],n=t[1]-e[1],l=t[2]-e[3],o=22/25,a=0<l?4:8,s=Math.hypot(i,n),r=!0;o<s?(e[0]+=i*o/s,e[1]+=n*o/s,r=!1):(e[0]=t[0],e[1]=t[1]);var p=e[3];if(a<Math.abs(l)?(e[3]+=Math.sign(l)*a,r=!1):e[3]=t[2],p!=e[3])for(var d=Math.max(0,1-e[3]/20),c=0,u;c<strPlayer.length;c++)u=e[2][c].img,u.style.transform=u.style.WebkitTransform=u.style.MozTransform="scale("+d+")";r&&(e[7]=t[3],e[5]+=e[6],0>e[5]?(e[5]+=2,e[6]=1):e[5]>=e[4].length&&(e[5]-=2,e[6]=-1))}}},fire3star:{unbreaking:!0,transparent:!0,hidden:!0,preinit:function(e){oMap.decor.fireballs||(oMap.decor.fireballs=[]),this.linkedSprite={type:"fireballs",start:oMap.decor.fireballs.length};for(var t=0,n;t<e.length;t++){if(n=e[t],null==n[3]&&(n[3]=18),null==n[4]){var l=getDecorParams(this,t);n[4]=Math.PI/2+l.dir,isNaN(n[4])&&(n[4]=1e4*Math.sin(t+2)%Math.PI),n[5]=.1}else null==n[5]&&(n[5]=.1*(t%2?1:-1));null==n[6]&&(n[6]=1e4*Math.sin(t+1)%Math.PI);for(var o=[],a=0,s;3>a;a++){s=[];for(var r=0,p;2>r;r++)p=[n[0],n[1],void 0,n[3]],oMap.decor.fireballs.push(p),s.push(p);o.push(s)}var p=[n[0],n[1],void 0,correctZInv(n[3])];oMap.decor.fireballs.push(p),o.push([p]),n[7]=o}this.linkedSprite.end=oMap.decor.fireballs.length},init:function(e,t,i){this.move(e,t,i)},initcustom:function(e){initCustomDecorSprites(this,e)},move:function(e){for(var t=e[0],i=e[1],n=e[3],l=e[4],o=e[5],a=e[6],s=Math.cos(l),p=Math.sin(l),d=e[7],c=0;3>c;c++)for(var u=a+2*c*Math.PI/3,m=Math.cos(u),y=Math.sin(u),h=d[c],g=0;2>g;g++){var b=h[g],f=7.5*(g+1);b[0]=t+f*s*m,b[1]=i-f*p*m,b[3]=correctZInv(n+f*y)}e[6]+=o,e[6]%=2*Math.PI}},firering:{unbreaking:!0,transparent:!0,hidden:!0,preinit:function(e){oMap.decor.fireballs||(oMap.decor.fireballs=[]),this.linkedSprite={type:"fireballs",start:oMap.decor.fireballs.length};for(var t=0,n;t<e.length;t++){if(n=e[t],null==n[3]&&(n[3]=18),null==n[4]){var l=getDecorParams(this,t);n[4]=Math.PI/2+l.dir,isNaN(n[4])&&(n[4]=1e4*Math.sin(t+2)%Math.PI),n[5]=.1}else null==n[5]&&(n[5]=.1*(t%2?1:-1));null==n[6]&&(n[6]=1e4*Math.sin(t+1)%Math.PI);for(var o=[],a=0,s;5>a;a++)s=[n[0],n[1],void 0,n[3]],oMap.decor.fireballs.push(s),o.push(s);n[7]=o}this.linkedSprite.end=oMap.decor.fireballs.length},init:function(e,t,i){this.move(e,t,i)},initcustom:function(e){initCustomDecorSprites(this,e)},move:function(e){for(var t=e[0],i=e[1],n=e[3],l=e[4],o=e[5],a=e[6],s=15,r=Math.cos(l),p=Math.sin(l),d=e[7],c=0;c<d.length;c++){var u=a+2*c*Math.PI/5,m=Math.cos(u),y=Math.sin(u),h=d[c];h[0]=t+s*r*m,h[1]=i-s*p*m,h[3]=correctZInv(n+s*y)}e[6]+=o,e[6]%=2*Math.PI}},fireballs:{unbreaking:!0,transparent:!0,spin:42,movable:!0,hitboxH:6,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=24,e[2][t].h=e[2][t].w}},billball:{hitbox:10,unbreaking:!0,transparent:!0,spin:42,movable:!0,rotatable:!0,dodgable:!0,preinit:function(e){for(var t=0;t<e.length;t++){var n=getDecorParams(this,t),l=e[t];null==l[3]&&(l[3]=3),null==l[4]&&(l[4]=90+180*n.dir/Math.PI,isNaN(l[4])&&(l[4]=180))}for(var t=1,o;4>t;t++)if(o=oMap.decor["billball"+t],o){for(var a=0,l;a<o.length;a++)l=o[a],e.push([l[0],l[1],null,null,180-90*t]);o.length=0}var s=getDecorExtra(this,!0),r=0;if(s.nb){r=e.length;for(var t=r;t<s.nb;t++)e.push(e[t%r].slice(0))}else r=Math.round(4*e.length/5);for(var t=0;t<e.length;t++){var n=getDecorParams(this,t),l=e[t];l[6]=[l[0],l[1],l[3],l[4],n.length||460]}this.initPos=[];for(var t=0,p;t<r;t++)p=e[t][6].slice(),p.push(0),this.initPos.push(p)},init:function(e,t){this.easeInOut=decorBehaviors.truck.easeInOut,null==e[5]&&(e[5]=1+20*t);for(var i=0;i<strPlayer.length;i++)e[2][i].w=80,e[2][i].h=80,e[5]&&(e[0]=-10,e[1]=-10,e[2][i].img.style.display="none")},move:function(e,t){if(!t)for(var i=0,n;i<this.initPos.length;i++)n=this.initPos[i],n[n.length-1]&&n[n.length-1]--;if(0<e[5]){if(e[5]--,0>=e[5]){e[5]=0,e[0]=e[6][0],e[1]=e[6][1];for(var i=0;i<strPlayer.length;i++)e[2][i].img.style.display="block"}}else if(0>e[5]){var l;if(-10>=e[5]){l=1,e[5]=0;for(var i=0,o;100>i;i++){o=oPlayers[0].cpu?Math.floor(Math.random()*this.initPos.length):Math.round(1e4*Math.abs(Math.sin(timer+i)))%this.initPos.length;var n=this.initPos[o];if(!n[n.length-1])break}var a=this.initPos[o];a[a.length-1]=20;for(var i=0;5>i;i++)e[6][i]=this.initPos[o][i];e[0]=e[6][0],e[1]=e[6][1],e[3]=e[6][2],e[4]=e[6][3]}else l=1-e[5]/-10,e[3]=e[6][2]*Math.sqrt(l),e[5]--;for(var i=0;i<oPlayers.length;i++)e[2][i].img.style.opacity=l}else{var s=(180-e[4])*Math.PI/180,r=e[6][4];e[0]+=5*Math.cos(s),e[1]+=5*Math.sin(s),(e[0]-e[6][0])*(e[0]-e[6][0])+(e[1]-e[6][1])*(e[1]-e[6][1])>r*r&&(e[5]=-1)}for(var i=0;i<oPlayers.length;i++){var p=nearestAngleMirrored(getApparentRotation(getPlayerAtScreen(i))+90-e[4],180,360),d=p%180/180;d=this.easeInOut(d),p=180*Math.floor(p/180)+180*d;var c=Math.round(11*p/180)%22;21<c&&(c-=22),e[2][i].setState(c)}}},tortitaupe:{spin:20,preinit:function(){this.init_=decorBehaviors.taupe.init.bind(this),this.move=decorBehaviors.taupe.move.bind(this)},init:function(e,t,i){this.init_(e,t,i);for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=1,e[2][n].w=24,e[2][n].h=36}},topitaupe:{spin:20,preinit:function(){this.init=decorBehaviors.taupe.init.bind(this),this.move=decorBehaviors.taupe.move.bind(this)}},coconut:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=100,e[2][t].h=100,e[2][t].z=.36}},palm:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=100,e[2][t].h=100,e[2][t].z=.38}},mountaintree:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].h=112,e[2][t].w=64*e[2][t].h/126,e[2][t].z=.15}},mariotree:{hidable:!0,hitbox:3,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].h=104,e[2][t].w=e[2][t].h/2,e[2][t].z=.12}},fir:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].h=112,e[2][t].w=e[2][t].h,e[2][t].z=.38}},movingtree:{hitbox:11.5,movable:!0,unbreaking:!0,init:function(e,t,i){for(var n=0;n<strPlayer.length;n++){if(e[2][n].nbSprites=1,e[2][n].w=85,e[2][n].h=139*e[2][n].w/115,e[2][n].z=.12,e[3]=0,!e[4]){var l=i%2?1:-1;e[4]=[[e[0]+25*l,e[1]],[e[0],e[1]-25*l],[e[0]-25*l,e[1]],[e[0],e[1]+25*l]]}null==e[5]&&(e[5]=i%e[4].length),null==e[6]&&(e[6]=0)}},move:function(e){if(e[6])e[6]--;else{var t=e[4][e[5]],i=t[0]-e[0],n=t[1]-e[1];if(1>i*i+n*n)e[5]=(e[5]+1)%e[4].length,e[6]=10;else{var l=Math.hypot(i,n);e[0]+=1.1*i/l,e[1]+=1.1*n/l}}}},sinistertree:{hidable:!0,hitbox:9,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=117,e[2][t].h=126,e[2][t].z=.37}},pokey:{spin:42,movable:!0,dodgable:!0,init:function(e,t,i){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=5,e[2][n].h=82,e[2][n].w=23*e[2][n].h/45,e[2][n].z=.1;e[3]=0,null==e[4]&&(e[4]=[15,15]),2==e[4].length&&e[4].unshift(e[0],e[1]),null==e[5]&&(e[5]=[1e4*Math.sin(i+1)%Math.PI,.025*Math.sign(Math.sin(1+100*i))]),null==e[6]&&(e[6]=Math.floor(1e4*Math.pow(Math.sin(i+1),2))%16),this.repos(e)},repos:function(e){var t=e[5][0],i=e[4];e[0]=i[0]+i[2]*Math.cos(t),e[1]=i[1]+i[3]*Math.sin(t)},move:function(e){e[5][0]=(e[5][0]+e[5][1])%(2*Math.PI),e[6]++;if(0==e[6]%2){var t=e[6]/2,n=[0,1,2,1,0,3,4,3];t>=n.length&&(t=0,e[6]=0);for(var l=0;l<strPlayer.length;l++)e[2][l].setState(n[t])}this.repos(e)}},falltree:{hidable:!0,hitbox:5,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=72,e[2][t].h=150*e[2][t].w/100,e[2][t].z=.24}},peachtree:{hidable:!0,hitbox:5,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=27,e[2][t].h=4*e[2][t].w,e[2][t].z=.01}},box:{breaking:!0,bonus:!0},snowman:{breaking:!0,spin:42},snowball:{hitbox:7,spin:42,unbreaking:!0,movable:!0,defaultspeed:3.5,boostspeed:8,jumpspeed:function(e){return 4+1*e},jumpheight:32,boostspeed:8,spritesize:56,ondie:function(e){return-100<e?"wait":"respawn"},preinit:function(e){e.length&&null==e[0][4]&&(this.init=decorBehaviors.cannonball.init.bind(this),this.move_=decorBehaviors.cannonball.move.bind(this),this.move=function(e,t,i){for(var n=0;n<oPlayers.length;n++)e[2][n].setState((e[2][n].getState()+1)%3);this.move_(e,t,i)},this.setdir=decorBehaviors.cannonball.setdir.bind(this),this.autojump=decorBehaviors.cannonball.autojump.bind(this))},init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=3,e[2][t].w=56,e[2][t].h=56,e[2][t].z=.28;e[3]=0,e[4].unshift([e[0],e[1]]),e[5]=[1,0]},move:function(e){for(var t=3.5,n=t,l=0;l<oPlayers.length;l++)e[2][l].setState((e[2][l].getState()+1)%3);for(;0<n;){var o=e[5][0];if(o<e[4].length){var a=e[4][e[5][0]];a[2]&&n==t&&(n=a[2]);var s=a[0],r=a[1],p=s-e[0],d=r-e[1],c=Math.hypot(p,d);if(e[3]=0,c<n)e[0]=s,e[1]=r,e[5][0]++,n-=c;else if(e[0]+=p*n/c,e[1]+=d*n/c,n=0,a[3]){var u=e[4][e[5][0]-1],m=(1-c/Math.hypot(s-u[0],r-u[1]))/a[3][1];1>m&&(e[3]=4*a[3][0]*m*(1-m))}}else if(n=0,e[5][1]++,10>e[5][1])for(var y=0;y<oPlayers.length;y++)e[2][y].img.style.opacity=1-e[5][1]/10;else if(10==e[5][1]){e[3]=10,e[0]=-100,e[1]=-100;for(var y=0;y<oPlayers.length;y++)e[2][y].img.style.opacity="",e[2][y].img.style.display="none"}else if(104<=e[5][1]){e[5][0]=1,e[5][1]=0,e[0]=e[4][0][0],e[1]=e[4][0][1];for(var y=0;y<oPlayers.length;y++)e[2][y].img.style.display="block";e[3]=0}}}},cannonball:{hitbox:8,spin:42,unbreaking:!0,movable:!0,defaultspeed:5,jumpspeed:function(e){return 6+1.5*e},jumpheight:48,boostspeed:11,spritesize:60,ondie:function(){return"suppr"},setdir:function(e,t,i,n){n=n||e;var l=oMap.w+oMap.h;e[4][0][0]=n[0]+l*t,e[4][0][1]=n[1]+l*i,e[4][1][0]=n[0]-l*t,e[4][1][1]=n[1]-l*i},autojump:function(e,t,i,n){e[6][4]&&n<this.boostspeed&&(t*=this.boostspeed/n,i*=this.boostspeed/n,n=this.boostspeed);var l=Math.hypot(t,i);e[4][2]=[e[0]+t,e[1]+i],e[5][2]={jump:1,loop:[0]},e[6][0]=2,e[6][2]=n,e[6][3]=l,this.setdir(e,t/l,i/l,e[4][2])},init:function(e,t,i){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites||(e[2][n].nbSprites=1,e[2][n].w=this.spritesize,e[2][n].h=this.spritesize,e[2][n].z=.33);if(e[3]=0,!e[4]){e[4]=[[],[]];var l=getDecorParams(this,t),o=l.dir;isNaN(o)&&(o=1e4*Math.sin(i+2)%Math.PI),this.setdir(e,Math.sin(o),Math.cos(o)),e[5]||(e[5]={0:{autoDir:!0,pos0:[e[0],e[1]]},1:{autoDir:!0,loop:[0]}})}e[5]||(e[5]={}),e[6]=[0,0,5]},move:function(e,t,i){var n=e[6][2];for(e[6][4]&&(n=Math.max(this.boostspeed,n),e[6][4]--);0<n;){var o=e[4][e[6][0]],a=o[0],s=o[1],r=e[0],p=e[1],d=a-r,c=s-p,m=Math.hypot(d,c),y=e[5][e[6][0]];if(m<n){if(e[0]=a,e[1]=s,y&&y.loop){var h=y.loop[0];e[6][1]?(e[6][1]--,!e[6][1]&&(h=e[6][0]+1)):y.loop[1]&&(e[6][1]=y.loop[1]),e[6][0]=h}else e[6][0]++;if(e[6][2]=y&&y.speed?y.speed:this.defaultspeed,y&&y.jump){var h=e[4][e[6][0]];e[6][3]=Math.hypot(h[0]-a,h[1]-s)}else e[6][3]=0;e[3]=0,n-=m}else{var g=d*n/m,b=c*n/m;if(y){if(!isNaN(y.flipper)){var f=oMap.flippers[y.flipper];f[3][0]||(f[3][1]=Math.max(0,Math.floor(m/n)-2))}if(y.autoDir)if(0>e[6][1]){for(var x=Math.max(0,1+e[6][1]/10),v=0;v<oPlayers.length;v++)e[2][v].img.style.opacity=x;if(x)e[6][1]--;else switch(this.ondie(e[6][1])){case"wait":e[0]=3*oMap.w,e[1]=3*oMap.h,e[6][1]--;break;case"suppr":oMap.decor[this.type][t][2][0].suppr(),oMap.decor[this.type].splice(t,1);break;case"respawn":for(var v=0;v<oPlayers.length;v++)e[2][v].img.style.opacity="";e[0]=e[5][0].pos0[0],e[1]=e[5][0].pos0[1],e[4]=null,e[5]=null,this.init(e,t,i);}g=0,b=0}else{var C=inCannon(e[0],e[1],e[0]+g,e[1]+b);if(C){var k=17;this.autojump(e,C[0],C[1],k)}if(y.jump||(e[3]=0,e[6][3]=0),!e[3]){var E=oMap.decor[this.type];oMap.decor[this.type]=[];var w=sauts(e[0],e[1],g,b),S;if(collisionFloor=null,collisionItem=null,w){var k=this.jumpspeed(w),T=32*w,I=d*T/m,z=c*T/m;this.autojump(e,I,z,k)}else if(!canMoveTo(e[0],e[1],0,g,b)){var B=getHorizontality(e[0],e[1],collisionFloor?collisionFloor.z:0,g,b),M=Math.hypot(B[0],B[1]),u=B[0]/M,L=B[1]/M,H=g*u+b*L,I=2*H*u-g,z=2*H*L-b,A=Math.hypot(I,z);this.setdir(e,I/A,z/A),g=0,b=0}else if(S=touche_asset(e[0],e[1],e[0]+g,e[1]+b))switch(S[0]){case"bumpers":var u=g,L=b,_=S[1],P=e[0]+u,N=e[1]+L,R=_[1][0],D=_[1][1],F=e[0]-R,V=e[1]-D,O=Math.hypot(F,V),q=F/O,W=V/O,X=u*q+L*W,G=P-X*q,K=N-X*W;u=e[0]+2*(G-e[0])-P,L=e[1]+2*(K-e[1])-N;var U=Math.hypot(u,L);this.setdir(e,u/U,L/U),g=0,b=0;break;case"flippers":var u=g,L=b,_=S[1],P=e[0]+u,N=e[1]+L,Y=_[2][2],J=_[2][3],Q=_[1][0],$=_[1][1],Z=e[0]-Q,ee=e[1]-$,te=Math.hypot(Z,ee),ie=Math.atan2(ee,Z)||0,ne=te*J,le=-ne*Math.sin(ie),oe=ne*Math.cos(ie);u-=le,L-=oe;var ae=Math.cos(Y),se=Math.sin(Y),re=u*ae+L*se,pe=-u+2*re*ae,de=-L+2*re*se;u=pe+le,L=de+oe;var U=Math.hypot(u,L);this.setdir(e,u/U,L/U),g=u,b=L;}else tombe(e[0]+g,e[1]+b)?e[6][1]=-1:accelere(e[0],e[1],g,b)&&(e[6][4]=20);oMap.decor[this.type]=E}}}if(e[0]+=g,e[1]+=b,e[6][3]){var ce=(m-n)/e[6][3];ce=Math.max(Math.min(ce,1),0),e[3]=this.jumpheight*ce*(1-ce)}n=0}}}},truck:{hitbox:8,spin:42,unbreaking:!0,movable:!0,rotatable:!0,dodgable:!0,preinit:function(e){for(var t=0,n;t<e.length;t++){if(n=e[t],null==n[5]){var l=getDecorParams(this,t);n[5]=l.traject}null==n[7]&&(l&&null!=l.speed?n[7]=l.speed:n[7]=1)}},init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=22,e[2][t].w=118,e[2][t].h=56*e[2][t].w/111,e[2][t].z=.72;var i=getDecorExtra(this,!0);if(i.path||(i.path=oMap.aipoints),null==e[6]){var n=1/0,l=null!=e[5];l||(e[5]=0),e[6]=0;for(var o=0;o<i.path.length;o++)if(!(l&&o!=e[5]))for(var a=i.path[o],t=0;t<a.length;t++){var s=a[t],r=(s[0]-e[0])*(s[0]-e[0])+(s[1]-e[1])*(s[1]-e[1]);r<n&&(n=r,e[5]=o,e[6]=t)}}var a=i.path[e[5]];2>a.length&&(!a.length&&(a=[[e[0],e[1]]]),a.push([a[0][0]+.001,a[0][1]+.001]),i.path[e[5]]=a);var s=a[e[6]],p=(e[6]+1)%a.length,d=a[p];0>(s[0]-e[0])*(d[0]-s[0])+(s[1]-e[1])*(d[1]-s[1])&&(e[6]=p,s=d);var c=s[0]-e[0];aimY=s[1]-e[1],e[4]=180*Math.atan2(c,aimY)/Math.PI},move:function(e){var t=4*e[7],n=e[0],l=e[1],o=getDecorExtra(this,!0),a,s;o.path||(o.path=oMap.aipoints);var r=o.path[e[5]];do{var p=r[e[6]];a=p[0]-n,s=p[1]-l;var d=Math.hypot(a,s);d<t?(n+=a,l+=s,t-=d,++e[6]>=r.length&&(e[6]=0)):(n+=a*t/d,l+=s*t/d,t=0)}while(0<t);if(e[0]=n,e[1]=l,a||s){var c=nearestAngle(180*Math.atan2(a,s)/Math.PI,e[4],360),u=8*e[7];e[4]<c-u?e[4]+=u:e[4]>c+u?e[4]-=u:e[4]=c}for(var m=0;m<oPlayers.length;m++){var h=nearestAngleMirrored(getApparentRotation(getPlayerAtScreen(m))-e[4],180,360),n=h%180/180;n=this.easeInOut(n),h=180*Math.floor(h/180)+180*n;var g=Math.round(11*h/180)%22;21<g&&(g-=22),e[2][m].setState(g)}},easeInOut:function(e){return e*=2,1>e?e*e/2:-(--e*(e-2)-1)/2}},movingthwomp:{spin:20,hitbox:8,movable:!0,init:function(e,t){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=3,e[2][n].w=48,e[2][n].h=64;if(null==e[4]){e[4]=[[e[0],e[1],0,20,20],[e[0],e[1],20,5,30],[e[0],e[1],20,30,5],[e[0],e[1],0,20,20]];var l=getDecorParams(this,t);if(!isNaN(l.dir))for(var o=l.length*Math.sin(l.dir),a=l.length*Math.cos(l.dir),t=2;4>t;t++)e[4][t][0]+=o,e[4][t][1]+=a}null==e[5]&&(e[5]=0),null==e[6]&&(e[6]=1),null==e[7]&&(e[7]=0)},move:function(e){if(!e[7]){var t=e[4][e[5]],i=t[0]-e[0],n=t[1]-e[1],l=t[2]-e[3],o=2,a=0<l?2:8,s=Math.hypot(i,n),r=!0;if(o<s?(e[0]+=i*o/s,e[1]+=n*o/s,r=!1):(e[0]=t[0],e[1]=t[1]),a<Math.abs(l)?(e[3]+=Math.sign(l)*a,r=!1):e[3]=t[2],r){e[7]=t[0<e[6]?3:4],e[5]+=e[6],0>e[5]?(e[5]+=2,e[6]=1):e[5]>=e[4].length&&(e[5]-=2,e[6]=-1);var t=e[4][e[5]],p;p=l?0<e[3]?0:2:0;for(var d=0;d<strPlayer.length;d++)e[2][d].setState(p)}}else if(e[7]--,!e[7]){var t=e[4][e[5]],p;if(t[2]!=e[3]&&(p=1),null!=p)for(var d=0;d<strPlayer.length;d++)e[2][d].setState(p)}}},chomp:{hitbox:9,spin:42,unbreaking:!0,movable:!0,init:function(e,t,i){for(var l=0;l<strPlayer.length;l++)e[2][l].nbSprites=8,e[2][l].w=92,e[2][l].h=60*e[2][l].w/70,e[2][l].z=.33;if(null==e[3]&&(e[3]=1e4*Math.abs(Math.sin(i+1))%3),null==e[4]){e[4]=[];for(var o=40,a=6,n=1e4*Math.sin(i+2)%Math.PI,s=2*Math.PI/a*Math.sign(Math.sin(1+80*i)),l=0,r;l<a;l++)r=n+l*s,e[4].push([e[0]+o*Math.cos(r),e[1]+o*Math.sin(r)])}null==e[5]&&(e[5]=0),null==e[6]&&(e[6]=i%2?1:-1)},move:function(e){e[3]+=e[6],0>e[3]&&(e[3]=0,e[6]=1.5),e[6]-=.5;for(var t=2.5;0<t;){var i=e[4][e[5]],n=i[0],l=i[1],o=n-e[0],a=l-e[1],s=Math.hypot(o,a);s<t?(e[0]=n,e[1]=l,e[5]++,e[5]>=e[4].length&&(e[5]=0),t-=s):(e[0]+=o*t/s,e[1]+=a*t/s,t=0)}var i=e[4][e[5]],r=e[4][(e[5]?e[5]:e[4].length)-1],p=180*Math.atan2(i[0]-r[0],i[1]-r[1])/Math.PI;if(!isNaN(p))for(var d=0;d<oPlayers.length;d++){var c=nearestAngleMirrored(getApparentRotation(getPlayerAtScreen(d))-p,180,360),u=Math.round(8*c/360)%8;e[2][d].setState(u)}},easeInOut:function(e){return e*=2,1>e?e*e/2:-(--e*(e-2)-1)/2}},pendulum:{hitbox:8,spin:42,unbreaking:!0,movable:!0,init:function(e,t,i){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=1,e[2][n].w=60,e[2][n].h=3*e[2][n].w,e[2][n].z=.1,e[2][n].div.style.transformOrigin=e[2][n].div.style.WebkitTransformOrigin=e[2][n].div.style.MozTransformOrigin="50% 83%";if(e[5]=[e[0],e[1],0,-1],null==e[4]){e[4]=1e4*Math.sin(i+1)%(Math.PI/3);var l=getDecorParams(this,t),o=l.dir;isNaN(o)?(e[5][2]=1e4*Math.sin(i+1)%Math.PI,e[5][3]=0<Math.sin(1200*(i+1)+1)?1:-1):(e[5][2]=o,e[5][3]=1)}},move:function(e){var t=Math.PI/3,i=e[4],n=e[5][2],l=.99*t;Math.abs(i)>l&&(i=l*Math.sign(i),e[5][3]=-e[5][3]);var o=Math.sqrt(2*(Math.cos(i)-Math.cos(t)));i+=o/16*e[5][3],e[4]=i;e[0]=e[5][0]+30*Math.sin(i)*Math.sin(n),e[1]=e[5][1]+30*Math.sin(i)*Math.cos(n);for(var a=-6*(1-Math.cos(i)),s=0;s<strPlayer.length;s++){var r=getApparentRotation(getPlayerAtScreen(s)),p=-i/5*Math.sin(r*Math.PI/180-n);e[2][s].div.style.transform=e[2][s].div.style.WebkitTransform=e[2][s].div.style.MozTransform="translateY("+a+"%) rotate("+Math.round(180*(p*getMirrorFactor())/Math.PI)+"deg)"}}},fullcustom:{hidable:!0,unbreaking:!0,init:function(e,t,n){if(null==e[4]){var l=getDecorParams(this,t),o=l.dir;void 0===o&&(o=1e4*Math.sin(n+2)%Math.PI),e[4]=180*o/Math.PI}if(bSelectedMirror)for(var t=0;t<oPlayers.length;t++)e[2][t].div.style.transform=e[2][t].div.style.WebkitTransform=e[2][t].div.style.MozTransform="scaleX(-1)";this.move(e)},move:function(e){for(var t=0;t<oPlayers.length;t++){var n=nearestAngle(getApparentRotation(getPlayerAtScreen(t))-e[4],180,360),l=n%180/180;n=180*Math.floor(n/180)+180*l;var o=Math.round(11*n/180)%22;21<o&&(o-=22),e[2][t].setState(o)}}}},DEFAULT_DECOR_HITBOX=5,DEFAULT_DECOR_HITBOX_H=4;for(var type in decorBehaviors)decorBehaviors[type].type=type;var nbFrames=1,syncItems=[],jumpHeight0=1.175,jumpHeight1=jumpHeight0+1e-5,lambdaReturnsTrue=function(){return!0},challengeRules={finish_circuit:{verify:"end_game",is_tt_compatible:!0,reset_on_fail:!0,success:lambdaReturnsTrue},finish_circuit_first:{verify:"end_game",is_tt_compatible:!0,reset_on_fail:!0,success:function(){return"CM"!=course&&1==oPlayers[0].place}},finish_circuit_time:{verify:"end_game",is_tt_compatible:!0,reset_on_fail:!0,success:function(e){return getActualGameTime()<=e.value}},finish_arena:{verify:"end_game",reset_on_fail:!0,success:lambdaReturnsTrue},finish_arena_first:{verify:"end_game",reset_on_fail:!0,success:function(){return 1==oPlayers[0].place}},hit:{verify:"each_hit",initLocalVars:function(){clLocalVars.myItems=[],clLocalVars.nbHits=0},initSelected:function(e){addChallengeHud("hits",{title:toLanguage("Hits","Touch\xE9s"),value:clLocalVars.nbHits,out_of:e.value})},success:function(e){if(clLocalVars.nbHits>=e.value)return!0}},eliminate:{verify:"each_kill",initLocalVars:function(){clLocalVars.myItems=[],clLocalVars.killed=[],clLocalVars.nbKills=0,clLocalVars.nbHits=0},initSelected:function(e){addChallengeHud("kills",{title:toLanguage("Defeated","Elimin\xE9s"),value:clLocalVars.nbKills,out_of:e.value})},success:function(e){if(clLocalVars.nbKills>=e.value)return!0}},survive:{verify:"each_frame",success:function(e){if(getActualGameTime()>=e.value)return!0}},reach_zone:{verify:"each_frame",initLocalVars:function(e){e.zones||(e.zones=classifyByShape(e.value))},success:function(e){for(var t=e.zones,n=oPlayers[0].x,l=oPlayers[0].y,o=t.rectangle,a=0;a<o.length;a++)if(pointInRectangle(n,l,o[a]))return!0;for(var s=t.polygon,a=0;a<s.length;a++)if(pointInPolygon(n,l,s[a]))return!0}},reach_zones:{verify:"each_frame",initLocalVars:function(e){e.zones||(e.zones=classifyByShape(e.value)),clLocalVars.reached=[],clLocalVars.reached.length=e.value.length;for(var t=0;t<clLocalVars.reached.length;t++)clLocalVars.reached[t]=!1;clLocalVars.nbPass=0},initSelected:function(e){addChallengeHud("zones",{title:toLanguage("Zones","Zones"),value:clLocalVars.nbPass,out_of:e.value.length})},success:function(e,t,n){for(var l=e.zones,o=e.value,a=oPlayers[0].x,s=oPlayers[0].y,r=l.rectangle,p=[],d=0;d<r.length;d++)pointInRectangle(a,s,r[d])&&p.push(o.indexOf(r[d]));for(var c=l.polygon,d=0;d<c.length;d++)pointInPolygon(a,s,c[d])&&p.push(o.indexOf(c[d]));p.sort();for(var d=0,u;d<p.length;d++)if(u=p[d],!clLocalVars.reached[u]){if(e.ordered&&u&&!clLocalVars.reached[u-1])break;if(clLocalVars.reached[u]=!0,clLocalVars.nbPass++,iSfx&&n===clSelected&&playSoundEffect("musics/events/clpass.mp3"),updateChallengeHud("zones",clLocalVars.nbPass),clLocalVars.nbPass>=o.length)return!0}}},hit_items:{verify:"each_item",initLocalVars:function(){clLocalVars.nbItems=0,clLocalVars.itemsHit=[],setTimeout(function(){clLocalVars.itemsHit.length=oMap.arme.length})},initSelected:function(){setTimeout(function(){addChallengeHud("items",{title:toLanguage("Items","Objets"),value:clLocalVars.nbItems,out_of:oMap.arme.length})})},success:function(){if(clLocalVars.nbItems>=oMap.arme.length)return!0}},collect_coins:{verify:"each_coin",initLocalVars:function(e){clLocalVars.nbCoins=0,e.nb||(e.nb=e.value.length)},initSelected:function(e){if(!oMap.coins){oMap.coins=[];for(var t=0;t<e.value.length;t++){for(var n=e.value[t],l={x:n[0],y:n[1],theta:2*Math.PI*Math.random(),sprite:new Sprite("coin")},o=0;o<oPlayers.length;o++)l.sprite[o].img.style.width="100%",l.sprite[o].w=24,l.sprite[o].h=24;oMap.coins.push(l)}}addChallengeHud("coins",{title:toLanguage("Coins","Pi\xE8ces"),value:clLocalVars.nbCoins,out_of:e.nb})},success:function(e){if(clLocalVars.nbCoins>=e.nb)return!0}},destroy_decors:{verify:"each_decor_hit",initLocalVars:function(e){if(clLocalVars.nbDecorHits||(clLocalVars.nbDecorHits={}),clLocalVars.nbDecorHits[e.value]=0,!e.nb){var t=oMap.decor[e.value]||[];e.nb=t.length,e.shouldInitToAll=!0}e.shouldInitToAll&&setTimeout(function(){var t=oMap.decor[e.value]||[];e.nb=t.length})},initSelected:function(e){setTimeout(function(){addChallengeHud("decors",{title:toLanguage("Destroyed","D\xE9truit"),value:0,out_of:e.nb})})},success:function(e){if(clLocalVars.nbDecorHits[e.value]>=e.nb)return!0}},gold_cup:{verify:"end_gp",initRuleVars:function(){return{nbcircuits:0}},success:function(e,t){if(clLocalVars.endGP&&4==t.nbcircuits)return 1==oPlayers[0].place},next_circuit:function(e){e.nbcircuits++}},gold_cups:{verify:"end_gp",initRuleVars:function(e){return{challenge:e,nbcircuits:0}},success:function(e,t){if(clLocalVars.endGP&&4==t.nbcircuits)return 1==oPlayers[0].place},post_success:function(e,t){var n=getSessionStorage("cl"+t.challenge.id+".gold_cups");if(n||(n="{}"),n=JSON.parse(n),t.challenge.data.constraints.every(e=>"cc"===e.type))for(var l=0;l<ptsGP.length;l++)3==ptsGP.charAt(l)&&(n[cupIDs[l]]=!0);var o=cupIDs[oMap.ref/4-1];n[o]=!0;for(var a=!0,l=0,s;l<cupIDs.length;l++)if(s=cupIDs[l],!n[s]){a=!1;break}return a?(deleteSessionStorage("cl"+t.challenge.id+".gold_cups"),!0):(setSessionStorage("cl"+t.challenge.id+".gold_cups",JSON.stringify(n)),showChallengePartialSuccess(t.challenge,{nb:Object.keys(n).length,total:cupIDs.length}),!1)},next_circuit:function(e){e.nbcircuits++}},gold_cups_n:{verify:"end_gp",initRuleVars:function(e){return{challenge:e,nbcircuits:0}},success:function(e,t){if(clLocalVars.endGP&&4==t.nbcircuits)return 1==oPlayers[0].place},post_success:function(e,t){var n=getSessionStorage("cl"+t.challenge.id+".gold_cups");if(n||(n="{}"),n=JSON.parse(n),t.challenge.data.constraints.every(e=>"cc"===e.type))for(var l=0;l<ptsGP.length;l++)3==ptsGP.charAt(l)&&(n[cupIDs[l]]=!0);var o=cupIDs[oMap.ref/4-1];n[o]=!0;for(var a=0,l=0,s;l<cupIDs.length;l++)s=cupIDs[l],n[s]&&a++;return a>=e.value?(deleteSessionStorage("cl"+t.challenge.id+".gold_cups"),!0):(setSessionStorage("cl"+t.challenge.id+".gold_cups",JSON.stringify(n)),showChallengePartialSuccess(t.challenge,{nb:Object.keys(n).length,total:e.value}),!1)},next_circuit:function(e){e.nbcircuits++}},finish_circuits_first:{verify:"end_game",initRuleVars:function(){return{nbcircuits:1}},initSelected:function(e,t){t&&t.nbcircuits&&addChallengeHud("races",{title:"BB"==course?toLanguage("Battle","Bataille"):toLanguage("Race","Course"),value:t.nbcircuits,out_of:e.value})},success:function(e,t){return 1==oPlayers[0].place&&(!!(t.nbcircuits>=e.value)||void 0)},next_circuit:function(e){e.nbcircuits++}},pts_greater:{verify:"end_game",initRuleVars:function(){return clGlobalVars.nbcircuits?{}:{nbcircuits:1,initialscore:0}},initSelected:function(e,t){t&&t.nbcircuits&&addChallengeHud("races",{title:"BB"==course?toLanguage("Battle","Bataille"):toLanguage("Race","Course"),value:t.nbcircuits,out_of:e.value})},success:function(e,t){if(t.nbcircuits==e.value&&aScores[0]>=e.pts)return!0},next_circuit:function(e){e.nbcircuits++}},pts_equals:{verify:"end_game",initRuleVars:function(){return clGlobalVars.nbcircuits?{}:{nbcircuits:1}},initSelected:function(e,t){t&&t.nbcircuits&&addChallengeHud("races",{title:"BB"==course?toLanguage("Battle","Bataille"):toLanguage("Race","Course"),value:t.nbcircuits,out_of:e.value})},success:function(e,t){if(t.nbcircuits==e.value&&aScores[0]==e.pts)return!0},next_circuit:function(e){e.nbcircuits++}},game_mode:{success:function(e){return course==["VS","CM"][e.value]}},game_mode_cup:{success:function(e){return course==["GP","VS"][e.value]}},difficulty:{success:function(e){return iDificulty==4+.5*(2-e.value)}},no_teams:{success:function(){return!iTeamPlay}},participants:{success:function(e){return aKarts.length==e.value}},cc:{initRuleVars:function(e,t){return{relSpeed:getRelSpeedFromCc(+t.value)}},success:function(e,t){if(t)return t.relSpeed===fSelectedClass&&(null===e.mirror||!e.mirror==!bSelectedMirror)}},balloons:{success:function(e){return!(oPlayers[0].lost&&clLocalVars.gagnant!=oPlayers[0])&&oPlayers[0].ballons.length+oPlayers[0].reserve>=e.value}},balloons_lost:{initSelected:function(e){addChallengeHud("balloons",{title:toLanguage("Balloons","Ballons"),value:clLocalVars.lostBalloons,out_of:e.value})},success:function(e){return!(oPlayers[0].loose&&clLocalVars.gagnant!=oPlayers[0])&&clLocalVars.lostBalloons<=e.value}},balloons_inflate:{initSelected:function(e){addChallengeHud("inflated",{title:toLanguage("Inflated","Gonfl\xE9s"),value:clLocalVars.inflatedBalloons,out_of:e.value})},success:function(e){return clLocalVars.inflatedBalloons<=e.value}},balloons_player:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0,oPlayers[0].reserve=e.value-oPlayers[0].ballons.length,updateBalloonHud(document.getElementById("compteur0"),oPlayers[0])},success:function(e,t){return!!t.selected}},balloons_cpu:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0;for(var n=oPlayers.length,l;n<aKarts.length;n++)l=aKarts[n],l.reserve=e.value-l.ballons.length},success:function(e,t){return!!t.selected}},no_drift:{success:function(){return!clLocalVars.drifted}},no_rd:{success:function(){return!clLocalVars.revDrifted}},avoid_items:{success:function(){return!clLocalVars.itemsGot}},avoid_item:{initLocalVars:function(){clLocalVars.hitItems||(clLocalVars.hitItems={})},success:function(e){for(var t=0,n;t<e.value.length;t++)if(n=e.value[t],clLocalVars.hitItems[n])return!1;return!0}},no_item:{success:function(){return!clLocalVars.itemsUsed}},no_item_box:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0,oMap.arme=[]},success:function(e,t){return!!t.selected}},avoid_decors:{initLocalVars:function(){clLocalVars.decorsHit||(clLocalVars.decorsHit={})},success:function(e){for(var t in e.value)if(clLocalVars.decorsHit[t])return!1;return!0}},avoid_zones:{initRuleVars:function(){return{hit:!1}},initLocalVars:function(e,t){clLocalVars.zonesHit||(clLocalVars.zonesHit=[]),clLocalVars.zonesHit.push({ruleVars:t,floor:e.floor,zones:classifyByShape(e.value)})},success:function(e,t){return!t.hit}},avoid_walls:{success:function(){return!clLocalVars.touchedWalls}},init_item:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0,e.value?(oPlayers[0].arme=e.value,oPlayers[0].roulette=25,updateObjHud(0)):supprArme(0)},success:function(e,t){return!!t.selected}},item_distribution:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0;for(var n={},l=0;l<e.value.length;l++)n[e.value[l]]=1;itemDistribution.value=[n],itemDistribution.isSetup=!0},success:function(e,t){return!!t.selected}},custom_music:{preinitSelected:function(e){oMap.music=e.value,oMap.yt=e.yt,delete oMap.yt_opts},success:function(){return!0}},character:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0},success:function(e,t,i){var n=oPlayers[0].personnage;return e.custom_id?t.selected&&i.autoset&&n===i.autoset.selectedPerso:n==e.value}},falls:{initRuleVars:function(){return{falls:0}},initSelected:function(e,t){t&&addChallengeHud("falls",{title:toLanguage("Falls","Chutes"),value:clLocalVars.falls+t.falls,out_of:e.value})},success:function(e,t){if(t)return clLocalVars.falls+t.falls<=e.value},next_circuit:function(e){e&&(e.falls+=clLocalVars.falls)}},max_jumps:{initRuleVars:function(){return{jumps:0}},initSelected:function(e,t){t&&addChallengeHud("jumps",{title:toLanguage("Jumps","Sauts"),value:clLocalVars.jumps+t.jumps,out_of:e.value})},success:function(e,t){if(t)return clLocalVars.jumps+t.jumps<=e.value},next_circuit:function(e){e&&(e.jumps+=clLocalVars.jumps)}},max_cannons:{initRuleVars:function(){return{cannons:0}},initSelected:function(e,t){t&&addChallengeHud("cannons",{title:toLanguage("Cannons","Canons"),value:clLocalVars.cannons+t.cannons,out_of:e.value})},success:function(e,t){if(t)return clLocalVars.cannons+t.cannons<=e.value},next_circuit:function(e){e&&(e.cannons+=clLocalVars.cannons)}},no_stunt:{success:function(){return!clLocalVars.stunted}},backwards:{initSelected:function(){clLocalVars.backwardsStart=!0},success:function(){return!clLocalVars.forwards}},without_turning:{success:function(e){return!("right"!==e.value&&clLocalVars.leftTurn)&&!("left"!==e.value&&clLocalVars.rightTurn)}},forwards:{success:function(){return!clLocalVars.backwards}},auto_accelerate:{initSelected:function(){clLocalVars.autoAccelerate=!0},success:function(){return!!clLocalVars.autoAccelerate}},invert_dirs:{initSelected:function(){clLocalVars.invertDirs=!0},success:function(){return!!clLocalVars.invertDirs}},rear_view:{initSelected:function(){clLocalVars.rearView=!0},success:function(){return!!clLocalVars.rearView}},no_minimap:{initSelected:function(){clLocalVars.noMap=!0},success:function(){return!!clLocalVars.noMap}},time:{success:function(e){return getActualGameTime()<=e.value}},time_delay:{initSelected:function(e){clLocalVars.delayedStart=e.value},success:function(e){if(!clLocalVars.startedAt)return!0;var t=(clLocalVars.startedAt-1)*SPF/1e3;return t>=e.value}},start_pos:{initSelected:function(e){if(clLocalVars.startPos=e.value,clLocalVars.isSetup=!0,e.no_cpu){aKarts.length=strPlayer.length;for(var t=0;t<strPlayer.length;t++)document.getElementById("infoPlace"+t).style.display="none"}},success:function(){return!!clLocalVars.startPos}},with_opponents:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0},success:function(e,t){return!!t.selected}},extra_items:{initRuleVars:function(){return{}},initSelected:function(e,t){if(t.selected=!0,clLocalVars.isSetup=!0,e.clear_other){for(var n=0,l;n<oMap.arme.length;n++){l=oMap.arme[n][2].box;for(var o=0,a;o<l.length;o++)a=l[o],a[0].suppr()}oMap.arme=[]}for(var n=0,s;n<e.value.length;n++)s=e.value[n].slice(0),initItemSprite(s),oMap.arme.push(s)},success:function(e,t){return!!t.selected}},extra_decors:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0;for(var n=e.custom_decors||{},l=0;l<e.value.length;l++){var o=e.value[l],a=o.src,s=a,r=n[s];r&&(s=r.type,!oMap.decorparams&&(oMap.decorparams={}),!oMap.decorparams.extra&&(oMap.decorparams.extra={}),!oMap.decorparams.extra[a]&&(oMap.decorparams.extra[a]={}),!oMap.decorparams.extra[a].custom&&(oMap.decorparams.extra[a].custom=r));var p=s.startsWith("assets/");if(p){var d,c;switch(s){case"assets/pivothand":d=["hand",[o.pos[0],o.pos[1],47,8,.5,.5],[0,.5,0,-.038]],c="pointers";break;case"assets/flipper":d=["flipper",[o.pos[0],o.pos[1],40,15,1,.15],[.1875,.5,.59,0,-1.19]],c="flippers";break;case"assets/oil1":case"assets/oil2":var u=s.substring(7);d=[u,[o.pos[0],o.pos[1],7,7,.5,.5],[.5,.5,0]],c="oils";break;case"assets/bumper":var u=s.substring(7);d=[u,[o.pos[0],o.pos[1],24,24],[.5,.5,0]],c="bumpers";}d&&(!oMap[c]&&(oMap[c]=[]),r&&(d[0]=a),oMap[c].push(d))}else oMap.decor[a]||(oMap.decor[a]=[]),oMap.decor[a].push(o.pos.slice(0))}},success:function(e,t){return!!t.selected}},extra_walls:{initRuleVars:function(){return{}},preinitSelected:function(e){oMap.collision||(oMap.collision=[]),oMap.collisionProps||(oMap.collisionProps={});for(var t=e.height||1e3,n=0,l;n<e.value.length;n++)l=e.value[n],oMap.collisionProps[oMap.collision.length]={z:t},oMap.collision.push(l.slice(0))},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0},success:function(e,t){return!!t.selected}},place_items:{initRuleVars:function(){return{}},initSelected:function(e,t){t.selected=!0,clLocalVars.isSetup=!0;for(var n=0,l;n<e.value.length;n++)l=e.value[n],dropNewItem(null,{type:l.src,team:-1,x:l.pos[0],y:l.pos[1],z:0})},success:function(e,t){return!!t.selected}},mini_turbo:{initRuleVars:function(){return{miniTurbo:0}},initSelected:function(e,t){t&&addChallengeHud("miniTurbo",{title:"Mini Turbos",value:clLocalVars.miniTurbo+t.miniTurbo,out_of:e.value})},success:function(e,t){if(t&&t.miniTurbo+clLocalVars.miniTurbo>=e.value)return!0},next_circuit:function(e){e&&(e.miniTurbo+=clLocalVars.miniTurbo)}},super_turbo:{initRuleVars:function(){return{superTurbo:0}},initSelected:function(e,t){t&&addChallengeHud("superTurbo",{title:"Super Turbos",value:clLocalVars.superTurbo+t.superTurbo,out_of:e.value})},success:function(e,t){if(t&&t.superTurbo+clLocalVars.superTurbo>=e.value)return!0},next_circuit:function(e){e&&(e.superTurbo+=clLocalVars.superTurbo)}},stunts:{initRuleVars:function(){return{stunts:0}},initSelected:function(e,t){t&&addChallengeHud("stunts",{title:toLanguage("Tricks","Figures"),value:clLocalVars.stunts+t.stunts,out_of:e.value})},success:function(e,t){if(t&&t.stunts+clLocalVars.stunts>=e.value)return!0},next_circuit:function(e){e&&(e.stunts+=clLocalVars.stunts)}},position:{success:function(e){if(oPlayers[0].place==e.value)return!0}},position_lower:{success:function(e){if(oPlayers[0].place<=e.value)return!0}},with_pts:{verify:"end_game",initRuleVars:function(){return clGlobalVars.nbcircuits?{}:{firstAttempt:!0}},success:function(e,t){if(t.firstAttempt&&aScores[0]>=e.value)return!0}},different_circuits:{initRuleVars:function(){return{played_circuits:{}}},success:function(e,t){return!t.played_circuits[oMap.ref]},next_circuit:function(e){e.played_circuits[oMap.ref]=!0}}},lastState,lastStateTime,interpolateFn,frameHandlers,oSpecCam;challengeRules.different_arenas=challengeRules.different_circuits;var clSelectionFail=!1;window.closeChallengePopup=function(e){var t=document.getElementById("challenge-popup-"+e);if(t){function e(){0<i?(t.style.opacity=i,i-=.2,setTimeout(e,40)):($mkScreen.removeChild(t),focusOnChallengeClose())}clHud&&0===Object.keys(clHud).length&&oChallengeCpts.firstChild&&(oChallengeCpts.innerHTML="");var i=1;e()}},window.publishChallenge=function(e){for(var t in challenges)for(var n in challenges[t])for(var l=challenges[t][n],o=l.list,a=0;a<o.length;a++)o[a].id==e&&(l.main?openChallengeEditor():document.location.href="challenges.php?cl="+l.id)};var metaItemPosition=.5,metaItemRange=1e3,itemDistributions={BB:[{name:toLanguage("Standard","Classique"),value:[{fauxobjet:4,banane:5,carapacerouge:1,carapace:4},{carapace:4,carapacerouge:7,bobomb:2,bananeX3:1},{carapace:1,bobomb:2,carapace:4,carapaceX3:2,banane:1,fauxobjet:1,carapacerouge:4},{carapacerougeX3:1,carapacerouge:2,megachampi:3,etoile:3,champi:3,champior:1,champiX3:1,bloops:1}]},{name:toLanguage("Explosive mode","Mode explosif"),value:[{fauxobjet:1,banane:3,carapacerouge:3,carapace:5},{bananeX3:1,carapacerouge:12,carapace:6,bobomb:4},{carapacerouge:8,carapace:5,bobomb:4,carapaceX3:3},{carapacerouge:7,carapacebleue:4,carapacerougeX3:3,megachampi:5,etoile:5,champi:1,champior:1,champiX3:1,bloops:1}]},{name:toLanguage("Shells","Carapaces"),value:[{carapacerouge:1,carapace:4},{carapacerouge:7,carapace:4},{carapacerouge:4,carapace:4,carapaceX3:2},{carapacerouge:6,carapacebleue:1,carapacerougeX3:3}]},{name:toLanguage("Bob-ombs","Bob-ombs"),value:[{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1}]},{name:toLanguage("Mushrooms","Champis"),value:[{champi:1,poison:1},{megachampi:1,champi:3,champiX3:1},{megachampi:2,champi:2,champior:1,champiX3:2},{megachampi:1,champior:1,champiX3:1}]}],VS:[{name:toLanguage("Standard","Classique"),value:[{fauxobjet:10,banane:6,carapace:6,bananeX3:2,carapacerouge:2},{carapace:8,bananeX3:4,carapacerouge:5,champi:3},{carapaceX3:7,carapacerouge:7,poison:5,champi:5,bobomb:3,bloops:3},{champi:6,poison:4,carapaceX3:6,carapacerouge:5,bobomb:3,bloops:2},{champi:8,carapacerouge:6,bobomb:3,champiX3:2},{bobomb:4,champi:5,carapacerouge:4,champiX3:3,carapacerougeX3:3},{champi:8,carapacerougeX3:7,champiX3:6,megachampi:3},{champiX3:8,carapacerougeX3:8,megachampi:6,etoile:4,champior:2,carapacebleue:5},{megachampi:7,champiX3:6,etoile:5,champior:3,carapacebleue:5},{megachampi:8,champiX3:6,etoile:6,billball:3,champior:3,carapacebleue:5},{etoile:6,megachampi:6,billball:5,champior:4,eclair:5},{billball:4,etoile:3,eclair:6,champior:5}]},{name:toLanguage("Aggressive mode","Mode explosif"),value:[{fauxobjet:5,banane:2,carapace:10,bananeX3:1,carapacerouge:3},{carapace:10,bananeX3:4,carapacerouge:15,carapaceX3:4,champi:1},{carapacerouge:10,carapaceX3:10,champi:2,poison:5,bobomb:10,bloops:3},{carapacerouge:10,carapaceX3:12,champi:3,poison:4,bobomb:8,bloops:2},{carapacerouge:12,champi:4,bobomb:8},{carapacerouge:8,champi:5,bobomb:6,champiX3:1,carapacerougeX3:6},{champi:4,champiX3:3,carapacerougeX3:10,megachampi:3},{champiX3:4,carapacerougeX3:10,megachampi:6,etoile:4,carapacebleue:12},{champiX3:3,megachampi:7,etoile:5,champior:1,carapacebleue:10},{champiX3:3,megachampi:8,etoile:6,champior:1,carapacebleue:10,billball:5},{megachampi:6,etoile:6,champior:1,billball:5,eclair:8},{etoile:3,champior:2,billball:6,eclair:8}]},{name:toLanguage("Shells","Carapaces"),value:[{carapace:6},{carapace:8,carapacerouge:8},{carapace:6,carapacerouge:5},{carapace:6,carapacerouge:7},{carapace:4,carapacerouge:5},{carapace:4,carapacerouge:6,carapaceX3:2,carapacerougeX3:2},{carapace:2,carapacerouge:4,carapaceX3:2,carapacerougeX3:2,carapacebleue:4},{carapace:2,carapacerouge:2,carapaceX3:4,carapacerougeX3:4,carapacebleue:6},{carapacerouge:2,carapaceX3:4,carapacerougeX3:4,carapacebleue:6},{carapaceX3:6,carapacerougeX3:6,carapacebleue:4},{carapaceX3:6,carapacerougeX3:6},{carapaceX3:8,carapacerougeX3:8}]},{name:toLanguage("Bob-ombs","Bob-ombs"),value:[{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1},{bobomb:1}]},{name:toLanguage("Mushrooms","Champis"),value:[{champi:1},{champi:1,poison:1},{champi:4,poison:1,megachampi:1},{champi:3,poison:1,megachampi:1},{champi:3,poison:1,champiX3:1,megachampi:2},{champi:2,champiX3:1,megachampi:2},{champi:1,champiX3:2,megachampi:3},{champiX3:2,megachampi:2,champior:1},{champiX3:1,megachampi:1,champior:1},{champiX3:1,champior:1},{champiX3:1,champior:2},{champior:1}]},{name:toLanguage("None","Aucun"),value:[]}]},ptDistributions=[{name:toLanguage("Default","Par d\xE9faut")}],customItemDistrib=localStorage.getItem("itemsets");customItemDistrib=customItemDistrib?JSON.parse(customItemDistrib):{VS:[],BB:[]};var customPtDistrib=localStorage.getItem("ptsets");customPtDistrib=customPtDistrib?JSON.parse(customPtDistrib):[];var COL_KART=0,COL_OBJ=1,collisionTest,collisionPlayer,collisionTeam,collisionItem,collisionDecor,collisionDecorHit,collisionFloor;Math.hypot||(Math.hypot=function(e,t){return Math.sqrt(e*e+t*t)});var getPlayerAtScreen=function(e){return oPlayers[e]},getScreenPlayerIndex=function(e){return e},oRoulettesPrefixes=["","2"],oArmeKeys=["arme","stash"],fMaxRotInCp=10,previouslyPressedBtns=[],decorPos={},lastErrorTs=0,gameControls={keyboard:{}},clLocalVars,clHud,clSelected,nextBlueShellCooldown,cycleHandler;document.onkeydown=function(t){if(!oPlayers.length){var e=oContainers[0].childNodes[0];if(!e)return;if(document.activeElement&&0<=document.activeElement.tabIndex&&!e.contains(document.activeElement))return;switch(t.key){case"Enter":if(selectedOscrElt){focusIndicator.parentNode===e&&e.removeChild(focusIndicator);var n=selectedOscrElt.value===toLanguage("Back","Retour");releaseOverEvents(),selectedOscrElt.click(),iSfx&&playSoundEffect("musics/events/"+(n?"back":"select")+".mp3")}break;case"_Back":for(var l=e.querySelectorAll("input[type=\"Button\"][value=\""+toLanguage("Back","Retour")+"\"]:not(:disabled)"),o=0;o<l.length;o++){var a=l[o],s=a.getBoundingClientRect();if(0<s.width&&0<s.height){releaseOverEvents(),a.click(),iSfx&&playSoundEffect("musics/events/back.mp3");break}}}if(-1===["ArrowUp","ArrowLeft","ArrowRight","ArrowDown"].indexOf(t.key))return;t.preventDefault(),selectedOscrElt&&!e.contains(selectedOscrElt)&&(selectedOscrElt=void 0);var r=[...e.querySelectorAll("*")].filter(e=>e.onclick).filter(e=>!e.disabled).filter(e=>!e.dataset.noselect).filter(e=>{var t=e.getBoundingClientRect();return 0<t.width&&0<t.height}),p,d,c,u,m,y,h;switch(t.key){case"ArrowUp":c="up",u="down",p="top",d="bottom",y="left",h="right",m=-1;break;case"ArrowDown":c="down",u="up",p="bottom",d="top",y="left",h="right",m=1;break;case"ArrowLeft":c="left",u="right",p=c,d=u,y="top",h="bottom",m=-1;break;case"ArrowRight":c="right",u="left",p=c,d=u,y="top",h="bottom",m=1;}if(selectedOscrElt){for(var g=selectedOscrElt.getBoundingClientRect(),b=e.getBoundingClientRect(),f=1/0,o=0,x,v;o<r.length;o++)if(v=r[o],v!==selectedOscrElt){var C=v.getBoundingClientRect(),k=(C[d]-g[p])*m,E=Math.max(C[y],g[y])-Math.min(C[h],g[h]);0>k&&(k+=b.width),0>E&&(E=0);var w=k+3*E;w<f&&(f=w,x=v)}x&&showFocusIndicator(e,x)}else{for(var S=1/0*m,o=0,T;o<r.length;o++){var v=r[o],C=v.getBoundingClientRect();C[d]*m<S*m&&(S=C[d],T=v)}T&&showFocusIndicator(e,T)}}if(onlineSpectatorId){var I=handleSpectatorInput(t);return!1===I&&render(),I}var z=getGameAction(t);if(oPlayers[0])switch(z){case"up":oPlayers[0].speedinc=1;var B=document.getElementById("decompte0");return 1<B.innerHTML&&updateEngineSound(carEngine2),!1;case"left":return oPlayers[0].rotincdir=getMirrorFactor(),!1;case"right":return oPlayers[0].rotincdir=-getMirrorFactor(),!1;}oPlayers[1]&&("up_p2"===z?oPlayers[1].speedinc=1:"left_p2"===z?oPlayers[1].rotincdir=getMirrorFactor():"right_p2"===z?oPlayers[1].rotincdir=-getMirrorFactor():void 0)};var selectedOscrElt,focusIndicator;document.onkeyup=function(t){if(!onlineSpectatorId){var e=getGameAction(t);oPlayers[0]&&("up"===e?(oPlayers[0].speedinc=0,updateEngineSound(carEngine)):"left"===e?oPlayers[0].rotincdir=0:"right"===e?oPlayers[0].rotincdir=0:void 0),oPlayers[1]&&("up_p2"===e?oPlayers[1].speedinc=0:"left_p2"===e?oPlayers[1].rotincdir=0:"right_p2"===e?oPlayers[1].rotincdir=0:void 0)}},String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t});var defaultGameOptions={team:!1,manualTeams:!1,friendlyFire:!1,nbTeams:2,teamOpts:0,localScore:!1,friendly:!1,minPlayers:2,maxPlayers:12,cc:150,mirror:!1,itemDistrib:0,ptDistrib:0,cpu:!1,cpuCount:2,cpuLevel:0,cpuNames:null,cpuChars:null,timeTrial:!1,noBumps:!1,noJump:!1,noRd:!1,doubleItems:!0},ccInterpolations=[[0,0],[50,.7],[100,.85],[150,1],[200,1.5],[1e3,10]],dRestHandlers={},isMobileCache=!!(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)),myPersosCache,startMusicHandler,onlineSpectatorState,pollingGamepadsHandler;if(formulaire=document.forms.modes,formulaire.dataset?formulaire.dataset.disabled="":formulaire.dataset={},window.gamePadEventListener&&(window.removeEventListener("gamepadconnected",window.gamePadEventListener),window.gamePadEventListener=void 0),clearInterval(gamepadMenuEventsHandler),gamepadMenuEventsHandler=void 0,refreshGameControls()||(window.gamePadEventListener=refreshGameControls,window.addEventListener("gamepadconnected",window.gamePadEventListener)),pause)isSingle&&!isOnline?choose(1):null==fInfos.map?selectMapScreen():loadMap();else{addOption("pSize",toLanguage("Screen Size","Taille de l'&eacute;cran"),"vSize","screenscale",[[4,toLanguage("Very small","Tr&egrave;s petite")],[6,toLanguage("Small","Petite")],[8,toLanguage("Medium","Moyenne")],[10,toLanguage("Large","Large")],[12,toLanguage("Very large","Tr&egrave;s large")],[-1,toLanguage("Full (F11)","Plein (F11)")],[-2,toLanguage("Custom...","Personnalis\xE9...")]],+$mkScreen.dataset.lastsc||iScreenScale),addScreenScaleOption(iScreenScale),addOption("pMusic",toLanguage("Music","Musique"),"vMusic","music",[[0,toLanguage("Off","D&eacute;sactiv&eacute;e")],[1,toLanguage("On","Activ&eacute;e")]],bMusic),addOption("pSfx",toLanguage("Sound effects","Bruitages"),"vSfx","sfx",[[0,toLanguage("Off","D&eacute;sactiv&eacute;s")],[1,toLanguage("On","Activ&eacute;s")]],iSfx),addOption("pFps",toLanguage("Framerate","FPS"),"vFps","fps",[[1,"15 FPS"],[2,"30 FPS"],[4,"60 FPS"],[-2,toLanguage("More...","Plus...")]],iFps),addFpsOption(iFps),selectMainPage(),formulaire.screenscale.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setScreenScale(e)},formulaire.music.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setMusic(e)},formulaire.sfx.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setSfx(e)},formulaire.fps.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setFps(e)},window.fsevent||(window.fsevent=function(t){if(122==t.keyCode){t.preventDefault();var e=iScreenScale;return iScreenScale=+formulaire.screenscale.value,formulaire.screenscale.value=-1,formulaire.screenscale.onchange(),formulaire.dataset.disabled&&(iScreenScale=e),!1}},window.addEventListener("keydown",window.fsevent)),"undefined"==typeof course&&(course="");var $commandes=document.getElementById("commandes");$commandes&&(!$commandes.dataset&&($commandes.dataset={}),10>$commandes.innerHTML.length&&($commandes.dataset.hasCommands=1),$commandes.dataset.hasCommands&&displayCommands()),isFirstLoad&&(isFirstLoad=!1,hasChallenges()&&(initSessionStorage(),xhr("getClSelected.php",null,function(e){if(!e)return!0;try{e=JSON.parse(e)}catch(t){return!0}if(e.id)for(var t in challenges)for(var n in challenges[t])for(var l=challenges[t][n],o=l.list,a=0,s;a<o.length;a++)if(s=o[a],s.id==e.id){if(!clSelected&&!s.succeeded){if(clSelected=s,clSelected.trackType=t,clSelected.trackId=n,clSelected.autoset=e.autoset,localStorage.removeItem("itemset."+getItemMode()),!course&&clSelected.autoset.course){var r=oContainers[0].childNodes[0];r&&(r.innerHTML="",oContainers[0].removeChild(r),course=clSelected.autoset.course,selectPlayerScreen(0))}showClSelectedPopup()}return!0}return!0})))}window.MarioKartControl={setQuality:function(e){setQuality(e)},setScreenScale:function(e){setScreenScale(e)},setMusic:function(e){setMusic(e)},setSfx:function(e){setSfx(e)},setFps:function(e){setFps(e)}}}var tag=document.createElement("script");tag.src="https://www.youtube.com/iframe_api";var firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag);